---
title: "Excess mortality: 2010-2020 weekly & monthly BfS data & `surveillance` package"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

options(scipen=999)
set.seed(12345)

library(pacman)
p_load(tidyverse, scales, surveillance)

options(max.print = "75")
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Years

```{r}
year <- 2016
date_min <- as.Date(paste0(as.character(year), "-01-01"))
date_max <- as.Date(paste0(as.character(year), "-12-31"))
```

<!-- ----------------------------------------------------- -->

# Gold(ish) standard

```{r echo=FALSE,eval=FALSE, out.width='100%'}
path <- paste0("./data/BfS/orig_plots/", as.character(year), ".png")
knitr::include_graphics(path)
```

![](../data/BfS/orig_plots/2016.png)
<!-- ----------------------------------------------------- -->

# Data 

## Weekly number of deaths, 2010-2020

Prepared in `03.Rmd`.  Collapsing age groups. 

```{r}
bfs_web_deaths_weekly <- read_rds("data/BfS/bfs_web_deaths_weekly_2010-2019.Rds")  %>% 
  bind_rows(read_rds("data/BfS/bfs_web_deaths_weekly_2020-2021.Rds") %>%
              filter(Ending <= as.Date("2020-12-31"))) %>% 
  group_by(Year, Week, Ending) %>% 
  summarise(NumberOfDeaths = sum(NumberOfDeaths),
            Expected = sum(Expected)) %>% 
  ungroup() %>% 
  mutate(Excess_expected = NumberOfDeaths - Expected)
```

### All available expected

```{r echo=FALSE}
bfs_web_deaths_weekly %>% 
  ggplot(aes(x = Ending)) +
  geom_line(aes(y = Expected), colour = "darkorchid") + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") +
  theme_minimal()
```

### Deaths and expected 5 years prior

```{r echo=FALSE}
bfs_web_deaths_weekly %>% 
  filter(Year >= year - 5 & Year <= year) %>% 
  ggplot(aes(x = Ending)) +
  geom_rect(aes(xmin = date_min, xmax = date_max, 
                ymin = -Inf, ymax = Inf), alpha = 0.005, inherit.aes = FALSE) +
  geom_line(aes(y = NumberOfDeaths)) + 
  geom_line(aes(y = Expected), colour = "darkorchid") + 
  # geom_vline(aes(xintercept = date_min), colour = "darkgreen") + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") +
  theme_minimal()
```

## Yearly totals of excess deaths

Calculated from weekly data aggregating `NumberOfDeaths` and `Expected`.

```{r}
excess_2015_2020 <- bfs_web_deaths_weekly %>% 
  filter(Year >= year) %>% 
  mutate(Excess_expected = NumberOfDeaths - Expected) %>% 
  group_by(Year) %>% 
  summarise(Excess_expected = sum(Excess_expected)) %>% 
  ungroup()
```

```{r echo=FALSE}
ggplot(excess_2015_2020) + 
  geom_col(aes(x = factor(Year), y = Excess_expected)) + 
  theme_minimal() + xlab("") + ylab("Excess deaths")
```

## Monthly number of deaths, 2010-2020

Prepared in `02.Rmd`.  

```{r}
# bfs_web_pop_yearly <- read_rds("data/BfS/bfs_web_pop_yearly.Rds") 

bfs_web_deaths_monthly <- read_rds("data/BfS/bfs_web_deaths_monthly.Rds") %>% 
  filter(Year >= 2010) %>% 
  select(-deaths_year) # %>% left_join(bfs_web_pop_yearly)

# rm(bfs_web_pop_yearly)
```

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  filter(Year >= year - 5 & Year <= year) %>% 
  ggplot(aes(x = Date)) +
  geom_rect(aes(xmin = date_min, xmax = date_max,
                ymin = -Inf, ymax = Inf), alpha = 0.005) +
  geom_line(aes(y = deaths_month)) + 
  # geom_vline(aes(xintercept = date_min), colour = "darkgreen") + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma) +
  theme_minimal() + 
  xlab("") + ylab("Deaths")
```

## `sts` data structure

Package works with `sts` - *surveillance time series* objects.  

### Weekly data

```{r}
deaths_weekly_sts <- sts(observed = bfs_web_deaths_weekly$NumberOfDeaths,
                         epoch = as.numeric(bfs_web_deaths_weekly$Ending),
                         start = c(2010, 1), 
                         epochAsDate = TRUE)
```

```{r eval=FALSE, include=FALSE}
# We have one year with 53 not 52 weeks!

bfs_web_deaths_weekly %>% 
  filter(Week == 53)

as.numeric(as.Date("2016-01-03"))

zoo::as.Date(max(deaths_weekly_sts@epoch)) == max(bfs_web_deaths_weekly$Ending)
```

### Monthly data

Not using population to match results from BfS.

```{r}
deaths_monthly_sts <- sts(observed = bfs_web_deaths_monthly$deaths_month,
                          epoch = as.numeric(bfs_web_deaths_monthly$Date),
                          start = c(2010, 1), 
                          frequency = 12,
                          epochAsDate = TRUE,
                          multinomialTS = TRUE)
```


```{r eval=FALSE, include=FALSE}
zoo::as.Date(max(deaths_monthly_sts@epoch)) == max(bfs_web_deaths_monthly$Date)
```

### "Analysis year" indicator 

Also selecting indices of observations for periods of interest.

```{r}
# analysis_month <- which(isoWeekYear(epoch(deaths_monthly_sts))$ISOYear == year)
analysis_month <- which(bfs_web_deaths_monthly$Year == year)
# analysis_week <- which(isoWeekYear(epoch(deaths_weekly_sts))$ISOYear == year)
analysis_week <- which(bfs_web_deaths_weekly$Year == year)
```

<!-- ----------------------------------------------------- -->

# Excess deaths calculations

## Monthly {.tabset}

### Improved method

```{r}
control2 <- list(range = analysis_month, 
                 noPeriods = 10, b = 4, w = 2,
                 weightsThreshold = 2.58, 
                 pastWeeksNotIncluded = 2,
                 # pastWeeksNotIncluded = 12, # if previous year has sth going on?
                 pThresholdTrend = 1, 
                 thresholdMethod = "nbPlugin")

noufaily_monthly <- farringtonFlexible(deaths_monthly_sts, control2)
```

```{r echo=FALSE}
par(mar = c(2, 4, 1, 1))
plot(noufaily_monthly, main = "", legend.opts = list(x = "bottomright"))
```

### Original method

```{r}
control1 <- list(range = analysis_month, 
                 noPeriods = 1, b = 4, w = 2,
                 weightsThreshold = 1, 
                 pastWeeksNotIncluded = 2,
                 # pastWeeksNotIncluded = 12, # if previous year has sth going on?
                 pThresholdTrend = 0.05, 
                 thresholdMethod = "delta")

farrington_monthly <- farringtonFlexible(deaths_monthly_sts, control1)
```

```{r echo=FALSE}
plot(farrington_monthly, main = "", legend.opts = list(x = "bottomright"))
```

## Weekly  {.tabset}

### Improved method

```{r}
control2 <- list(range = analysis_week, 
                 noPeriods = 10, b = 4, w = 3,
                 weightsThreshold = 2.58, 
                 pastWeeksNotIncluded = 3,
                 # pastWeeksNotIncluded = 53, # if previous year has sth going on?
                 pThresholdTrend = 1, 
                 thresholdMethod = "nbPlugin")

noufaily_weekly <- farringtonFlexible(deaths_weekly_sts, control2)
```

```{r echo=FALSE}
par(mar = c(2, 4, 1, 1))
plot(noufaily_weekly, main = "", legend.opts = list(x = "bottomright"))
```

### Original method

```{r}
control1 <- list(range = analysis_week, 
                 noPeriods = 1, b = 4, w = 3,
                 weightsThreshold = 1, 
                 pastWeeksNotIncluded = 26,
                 # pastWeeksNotIncluded = 53, # if previous year has sth going on?
                 pThresholdTrend = 0.05, 
                 thresholdMethod = "delta")

farrington_weekly <- farringtonFlexible(deaths_weekly_sts, control1)
```

```{r echo=FALSE}
plot(farrington_weekly, main = "", legend.opts = list(x = "bottomright"))
```

<!-- ----------------------------------------------------- -->

# Comparing excess deaths totals

Calculating excess in BfS data by subtracting `NumberOfDeaths` from `...method...@control$expected`.

## Weekly  {.tabset}

```{r include=FALSE}
ymin = min(
  min(subset(bfs_web_deaths_weekly, Year == year, select = Excess_expected)),
  # min(noufaily_weekly@observed - noufaily_weekly@upperbound[ ,1]),
  # min(farrington_weekly@observed - farrington_weekly@upperbound[ ,1])
  min(noufaily_weekly@observed - noufaily_weekly@control$expected[ ,1]),
  min(farrington_weekly@observed - farrington_weekly@control$expected[ ,1])
)

ymax = max(
  max(subset(bfs_web_deaths_weekly, Year == year, select = Excess_expected)),
  # max(noufaily_weekly@observed - noufaily_weekly@upperbound[ ,1]),
  # max(farrington_weekly@observed - farrington_weekly@upperbound[ ,1])
  max(noufaily_weekly@observed - noufaily_weekly@control$expected[ ,1]),
  max(farrington_weekly@observed - farrington_weekly@control$expected[ ,1])
)
```

### Improved method

```{r echo=FALSE}
noufaily_weekly_res <- bfs_web_deaths_weekly %>% 
  filter(Year == year) %>% 
  select(Week, Excess_expected) %>% 
  rename(BfS = Excess_expected, Time = Week) %>% 
  # mutate(noufaily_weekly = noufaily_weekly@observed - noufaily_weekly@upperbound[ ,1]) %>% 
  mutate(noufaily_weekly = noufaily_weekly@observed - noufaily_weekly@control$expected[ ,1]) %>% 
  pivot_longer(BfS:noufaily_weekly, 
               names_to = "Source",
               values_to = "Excess_deaths") 

noufaily_weekly_res %>% 
  ggplot(mapping = aes(x = Time)) +
  geom_col(aes(y = Excess_deaths), width = 1, fill = "#af8dc3") +
  facet_grid(vars(Source)) +
  ylim(ymin, ymax) +
  labs(x = "", y = "Weekly excess deaths") +
  theme_bw() 
```

### Original method

```{r echo=FALSE}
farrington_weekly_res <- bfs_web_deaths_weekly %>% 
  filter(Year == year) %>% 
  select(Week, Excess_expected) %>% 
  rename(BfS = Excess_expected, Time = Week) %>% 
  # mutate(farrington_weekly = farrington_weekly@observed - farrington_weekly@upperbound[ ,1]) %>% 
  mutate(farrington_weekly = farrington_weekly@observed - farrington_weekly@control$expected[ ,1]) %>% 
  pivot_longer(BfS:farrington_weekly, 
               names_to = "Source",
               values_to = "Excess_deaths") 

farrington_weekly_res %>% 
  ggplot(mapping = aes(x = Time)) +
  geom_col(aes(y = Excess_deaths), width = 1, fill = "#af8dc3") +
  facet_grid(vars(Source)) +
  ylim(ymin, ymax) +
  labs(x = "", y = "Weekly excess deaths") +
  theme_bw() 
```

## Monthly  {.tabset}

```{r include=FALSE}
ymin = min(
  # min(noufaily_monthly@observed - noufaily_monthly@upperbound[ ,1]),
  # min(farrington_monthly@observed - farrington_monthly@upperbound[ ,1])
  min(noufaily_monthly@observed - noufaily_monthly@control$expected[ ,1]),
  min(farrington_monthly@observed - farrington_monthly@control$expected[ ,1])
)

ymax = max(
  # max(noufaily_monthly@observed - noufaily_monthly@upperbound[ ,1]),
  # max(farrington_monthly@observed - farrington_monthly@upperbound[ ,1])
  max(noufaily_monthly@observed - noufaily_monthly@control$expected[ ,1]),
  max(farrington_monthly@observed - farrington_monthly@control$expected[ ,1])
)
```

### Improved method

```{r echo=FALSE}
noufaily_monthly_res <- bfs_web_deaths_monthly %>% 
  filter(Year == year) %>% 
  select(Month) %>% 
  rename(Time = Month) %>% 
  # mutate(Excess_deaths = noufaily_monthly@observed - noufaily_monthly@upperbound[ ,1]) %>% 
  mutate(Excess_deaths = noufaily_monthly@observed[1:12, ] - noufaily_monthly@control$expected[1:12 ,1],
         Source = "noufaily_monthly") 

noufaily_monthly_res %>% 
  ggplot(mapping = aes(x = factor(Time))) +
  geom_col(aes(y = Excess_deaths), width = 1, fill = "#af8dc3") +
  ylim(ymin, ymax) +
  labs(x = "", y = "Monthly excess deaths") +
  theme_bw() 
```

### Original method

```{r echo=FALSE}
farrington_monthly_res <- bfs_web_deaths_monthly %>% 
  filter(Year == year) %>% 
  select(Month) %>% 
  rename(Time = Month) %>% 
  # mutate(Excess_deaths = farrington_monthly@observed - farrington_monthly@upperbound[ ,1]) %>% 
  mutate(Excess_deaths = farrington_monthly@observed[1:12, ] - farrington_monthly@control$expected[1:12 ,1],
         Source = "farrington_monthly") 

farrington_monthly_res %>% 
  ggplot(mapping = aes(x = factor(Time))) +
  geom_col(aes(y = Excess_deaths), width = 1, fill = "#af8dc3") +
  ylim(ymin, ymax) +
  labs(x = "", y = "Monthly excess deaths") +
  theme_bw() 
```

## Yearly comparison

```{r echo=FALSE}
compare <- bind_rows(noufaily_weekly_res, 
                     farrington_weekly_res %>% filter(Source != "BfS"),
                     noufaily_monthly_res, 
                     farrington_monthly_res) %>% 
  group_by(Source) %>% 
  summarise(Excess_deaths = round(sum(Excess_deaths))) %>%
  ungroup() 

compare %>% 
  ggplot() + 
  geom_col(aes(x = Source, y = Excess_deaths), fill = "#af8dc3") +
  labs(x = "", y = "Yearly excess deaths") +
  theme_bw() 
```

# Computing Environment

`r mu$session()`



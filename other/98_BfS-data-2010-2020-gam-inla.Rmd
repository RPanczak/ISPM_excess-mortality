---
title: "Excess mortality: 2010-2020 monthly BfS data & regression(s) approach"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

options(scipen=999)
set.seed(12345)

library(pacman)
p_load(tidyverse, lubridate, scales, magrittr,
       slider, 
       ciTools, 
       mgcv, gratia, nlme,
       INLA)

options(max.print = "75")
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Years

```{r}
year <- 2020

year_from <- year - 10
date_from <- ymd(paste0(as.character(year_from), "-01-01"))

year_reg <- year - 1
date_reg <- ymd(paste0(as.character(year_reg), "-01-01"))

date_min <- ymd(paste0(as.character(year), "-01-01"))
date_max <- ymd(paste0(as.character(year), "-12-31"))
# to extend
# date_max <- ymd(paste0(as.character(year + 1), "-03-01"))

# definitions of pandemic years
# 1919 only spring so maybe out?
# choose 1957 or 1958!
# not sure 1968 1969

flu_years <- c(1890, 
               1918, 1919, 
               1957, 1958, 
               1968, 1969, 
               1977, 1978, 1979, 
               2009, 
               2010, 
               2020)
```

<!-- ----------------------------------------------------- -->

# Data 

## Monthly number of deaths, 2010-2020. 

Prepared in `02.Rmd`.  

```{r}
# bfs_pop_yearly <- read_rds("data/BfS/bfs_pop_yearly.Rds")

bfs_deaths_month <- read_rds("data/BfS/bfs_deaths_month.Rds") %>% 
  filter(Year >= 2010) %>% 
  # left_join(bfs_pop_yearly) %>% 
  # mutate(flu_year = ifelse(Year %in% flu_years, 1, 0),
  #        not = 1 - flu_year) %>% 
  mutate(
    si_one = sin(2*pi*Month/12),
    si_two = sin(4*pi*Month/12),
    co_one = cos(2*pi*Month/12),
    co_two = cos(4*pi*Month/12)) %>% 
  mutate(Time = row_number()) %>% 
  relocate(Time)

# with(bfs_deaths_month, table(flu_year, not))

# rm(bfs_pop_yearly)
```

```{r echo=FALSE}
bfs_deaths_month %>% 
  filter(Year <= year) %>% 
  ggplot(aes(x = Date)) +
  geom_rect(aes(xmin = date_min, xmax = date_max, 
                ymin = -Inf, ymax = Inf), 
            fill = "#7fc97f", alpha = 0.01, inherit.aes = FALSE) +
  geom_rect(aes(xmin = date_from, xmax = date_min, 
                ymin = -Inf, ymax = Inf), 
            fill = "#fdc086", alpha = 0.01, inherit.aes = FALSE) +
  geom_line(aes(y = Deaths)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma) +
  theme_minimal() + 
  xlab("") + ylab("Deaths")
```

## Outcome

```{r echo=FALSE}
bfs_deaths_month %>% 
  filter(Year <= year_reg) %>% 
  ggplot(aes(Deaths)) +
  geom_histogram() +
  theme_minimal()
```

<!-- ----------------------------------------------------- -->

# Regression approach

## Data

Separating analysis from prediction

```{r}
reg_deaths_month <- bfs_deaths_month %>% 
  filter(Year <= year_reg)

pred_deaths_month <- bfs_deaths_month %>% 
  filter(Year == year)
```

## Marcel's solution

Without pop offset

```{r}
summary(mz_month <- glm(Deaths ~ Month + 
                            si_one + si_two + co_one + co_two, 
                          family = "poisson", data = reg_deaths_month))

pred_deaths_month %<>%
  add_pi(mz_month, names = c("mz_lpi", "mz_upi"), 
         yhatName = "mz_fit", nSims = 20000) %>% 
  as_tibble()
```

```{r echo=FALSE}
pred_deaths_month %>% 
  filter(Year >= year - 5) %>% 
  ggplot(aes(x = Date)) +
  geom_ribbon(aes(ymin = mz_lpi, ymax = mz_upi), alpha = 0.1) + 
  geom_line(aes(y = mz_fit)) +
  geom_line(aes(y = Deaths), color = "#beaed4", size = 1) + 
  scale_y_continuous(labels = comma) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") +
  theme_minimal()
```

## GAM

Following info from [here](https://fromthebottomoftheheap.net/2014/05/09/modelling-seasonal-data-with-gam/)

```{r}
ctrl <- list(niterEM = 0, msVerbose = TRUE, optimMethod = "L-BFGS-B")
```

```{r}
bs = "cs"
k = 6

summary(gam_month0 <- gamm(Deaths ~ 
                               s(Time, bs = bs, k = k) + 
                               s(Month, bs = "cc", k = 12),
                             family = "poisson", data = reg_deaths_month))

# acf(resid(gam_month0$lme), lag.max = 36, main = "ACF")
# pacf(resid(gam_month0$lme), lag.max = 36, main = "pACF")

summary(gam_month1 <- gamm(Deaths ~ 
                               s(Time, bs = bs, k = k) + 
                               s(Month, bs = "cc", k = 12),
                             correlation = corARMA(form = ~ 1 | Year, p = 1),
                             family = "poisson", data = reg_deaths_month,
                             control = ctrl))

summary(gam_month2 <- gamm(Deaths ~ 
                               s(Time, bs = bs, k = k) + 
                               s(Month, bs = "cc", k = 12),
                             correlation = corARMA(form = ~ 1 | Year, p = 2),
                             family = "poisson", data = reg_deaths_month,
                             control = ctrl))

summary(gam_month3 <- gamm(Deaths ~ 
                               s(Time, bs = bs, k = k) + 
                               s(Month, bs = "cc", k = 12),
                             correlation = corARMA(form = ~ 1 | Year, p = 3),
                             family = "poisson", data = reg_deaths_month,
                             control = ctrl))

# anova.lme(gam_month0$lme, gam_month1$lme, gam_month2$lme, gam_month3$lme)
AIC(gam_month0$lme, gam_month1$lme, gam_month2$lme, gam_month3$lme)
BIC(gam_month0$lme, gam_month1$lme, gam_month2$lme, gam_month3$lme)
```

```{r}
draw(gam_month1$gam) 
appraise(gam_month1$gam)

# comp <- compare_smooths(gam_month1, gam_month_2)
# draw(comp)
```

```{r}
predict <- predict(gam_month1$gam, pred_deaths_month, 
                   type = "response", se.fit = TRUE)

pred_deaths_month$gam_fit <- predict$fit
pred_deaths_month$gam_se <- predict$se.fit
```


```{r}
pred_deaths_month %>% 
  ggplot(aes(x = Date)) +
  # geom_ribbon(aes(ymin = gam_lci, ymax = gam_uci), alpha = 0.1) + 
  geom_line(aes(y = gam_fit)) +
  geom_line(aes(y = Deaths), color = "#beaed4", size = 1) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") +
  theme_minimal()
```

```{r}
pred_deaths_month %>% 
  filter(Year == year) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = mz_fit)) +
  geom_line(aes(y = gam_fit), color = "#beaed4", size = 1) + 
  scale_x_date(date_breaks = "2 months", date_labels = "%b") +
  ylab("REG vs GAM") +  xlab("") +
  theme_minimal()
```

### Comparing excess deaths totals

```{r}
pred_deaths_month %>% 
  filter(Year == year) %>% 
  summarise(NumberOfDeaths = sum(Deaths), 
            exc_mz = round(NumberOfDeaths - sum(mz_fit)),
            exc_gam = round(NumberOfDeaths - sum(gam_fit)))
```

## INLA

### Data

Separating analysis from prediction

```{r}
reg_deaths_month <- bfs_deaths_month %>% 
  filter(Date <= date_max) %>% 
  mutate(deaths_month_inla = ifelse(Year == 2020, NA, Deaths))
```

### Setup

```{r echo=TRUE, results='hide'}
# Jeffreys prior 
a1 <- 5e-5
b1 <- 5e-5
lgprior1 <- list(prec = list(param = c(a1, b1)))

# Gelman prior
a2 <- -0.5
b2 <- 5e-5
lgprior2 <- list(prec = list(param = c(a2, b2)))

# iid prior 
# SchrÃ¶dle & Held 2010 & Blangiardo et al 2013
a0 <- 1
b0 <- 0.1
prior.nu <- list(prec = list(param = c(a0, b0)))

# intercept & fixed
inla.set.control.fixed.default() 
# intercept ~ N(0,0) 
# other fixed effects ~ N(0, 0.001) 

# where the format is N(mean, precision) 
# precision = inverse of the variance. 

# PC prior
U <- 1
hyper.prec = list(theta = list(
  prior = "pc.prec",
  param = c(U, 0.01)
))
# scaling
inla.setOption(scale.model.default = TRUE)
```

### Models

```{r}
mod <- inla(deaths_month_inla ~ 1 + 
               f(Time, model = "rw1", hyper = hyper.prec, constr = FALSE) + 
               f(Month, model = "rw1", hyper = hyper.prec, constr = FALSE), 
             family = "poisson", 
             control.compute = list(dic= TRUE, waic = TRUE, cpo = TRUE),  
             data = reg_deaths_month)

plot(mod)

bfs_deaths_month$inla_fit <- exp(mod$summary.fitted.values[, c("0.5quant")])

bfs_deaths_month %>% 
  filter(Year == year) %>%
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Deaths)) +
  # geom_line(aes(y = mz_fit)) +
  geom_line(aes(y = inla_fit), color = "#beaed4", size = 1) + 
  scale_x_date(date_breaks = "2 months", date_labels = "%b") +
  ylab("REG vs GAM") +  xlab("") +
  theme_minimal()
```

### Comparing excess deaths totals

```{r}
bfs_deaths_month %>% 
  filter(Year == year) %>% 
  summarise(NumberOfDeaths = sum(Deaths), 
            # exc_mz = round(NumberOfDeaths - sum(mz_fit)),
            # exc_gam = round(NumberOfDeaths - sum(gam_fit)),
            exc_inla = round(NumberOfDeaths - sum(inla_fit))
            )
```


# Computing Environment

`r mu$session()`



---
title: "Excess mortality"
subtitle: "1900-2020 monthly Spanish data & regression approach"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, lubridate, scales, magrittr, slider)
```

```{r knit-setup, include = FALSE}
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Data 

Monthly number of deaths, **1900-2020**.

Prepared in `02.Rmd`.  

```{r eval=FALSE, include=FALSE}
deaths_monthly <- bind_rows(
  read_rds("data/INE/es_deaths_month.Rds") %>% 
    mutate(source = "INE") %>% 
    filter(Year < 2020),
  
  read_rds("data/mortality_org/stmf_month.Rds") %>% 
    filter(Country == "Spain") %>% 
    filter(Year == 2020) %>% 
    select(-Country) %>% 
    mutate(source = "STMF") %>% 
    mutate(Deaths = as.integer(round(Deaths)))
) 
```

```{r}
deaths_monthly <- read_rds("data/INE/es_deaths_month.Rds")
```

## Years

```{r}
year_smooth <- 5

year_from <- min(deaths_monthly$Year)

year_reg <- year_from + year_smooth

year_max <- 2020
```

## Pandemics

```{r}
flu_years_hc <- c(1918, 2020)

flu_years_hc_affected <- c(seq(1918 + 1, 1918 + year_smooth))

flu_years <- c(1918, 1957, 1968, 1977, 2009, 2020)

flu_years_affected <- c(flu_years_hc_affected,
                        seq(1957 + 1, 1957 + year_smooth),
                        seq(1968 + 1, 1968 + year_smooth),
                        seq(1977 + 1, 1977 + year_smooth),
                        seq(2009 + 1, 2009 + year_smooth))
```

## Other vars

```{r}
deaths_monthly %<>% 
  mutate(Year = as.integer(Year),
         Deaths = as.integer(round(Deaths)),
         Population = as.integer(round(Population))) %>% 
  mutate(flu_year_hc = ifelse(Year %in% flu_years_hc, 1, 0),
         flu_year_hc_affected = ifelse(Year %in% flu_years_hc_affected, 1, 0),
         deaths_flu_year_hc = ifelse(Year %in% flu_years_hc, NA, Deaths),
         flu_year = ifelse(Year %in% flu_years, 1, 0),
         flu_year_affected = ifelse(Year %in% flu_years_affected, 1, 0),
         deaths_flu_year = ifelse(Year %in% flu_years, NA, Deaths),
         si_one = sin(2*pi*Month/12),
         si_two = sin(4*pi*Month/12),
         co_one = cos(2*pi*Month/12),
         co_two = cos(4*pi*Month/12)) 
```

## Two pandemics {.tabset}

### 1918

```{r echo=FALSE}
deaths_monthly %>% 
  filter(Year >= 1917 & Year <= 1921) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Deaths)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 165000)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths")
```

### 2020

```{r echo=FALSE}
deaths_monthly %>% 
  filter(Year >= 2016) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Deaths)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 165000)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths")
```

## With denominator {.tabset}

### 1918

```{r echo=FALSE}
deaths_monthly %>% 
  filter(Year >= 1917 & Year <= 1921) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = (Deaths / Population) * 100000)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 800)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths / 100k")
```

### 2020 

```{r echo=FALSE}
deaths_monthly %>% 
  filter(Year >= 2016) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = (Deaths / Population) * 100000)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 800)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths / 100k")
```

## 5-year medians {.tabset}

```{r}
deaths_monthly %<>% 
  arrange(Month, Year) %>% 
  mutate(median =             slide_dbl(Deaths, 
                                        stats::median, na.rm = TRUE, 
                                        .before = year_smooth, .after = -1, .complete = TRUE),
         median_flu_year_hc = slide_dbl(deaths_flu_year_hc, 
                                        stats::median, na.rm = TRUE,
                                        .before = year_smooth, .after = -1, .complete = TRUE),
         median_flu_year =    slide_dbl(deaths_flu_year, 
                                        stats::median, na.rm = TRUE, 
                                        .before = year_smooth, .after = -1, .complete = TRUE),
  ) %>% 
  arrange(Year, Month)
```

### Impact of 1918 

```{r echo=FALSE}
deaths_monthly %>% 
  filter(Year >= 1918 & Year <= 1920) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Deaths), colour = "grey60") + 
  geom_line(aes(y = median), colour = "green") + 
  geom_line(aes(y = median_flu_year), colour = "purple") +
  geom_line(aes(y = median_flu_year_hc), colour = "orange") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") +
  theme_minimal()
```

### Impact of 1957

```{r echo=FALSE}
deaths_monthly %>% 
  filter(Year >= 1957 & Year <= 1958) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Deaths), colour = "grey60") + 
  geom_line(aes(y = median), colour = "green") + 
  geom_line(aes(y = median_flu_year), colour = "purple") +
  geom_line(aes(y = median_flu_year_hc), colour = "orange") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") +
  theme_minimal()
```

<!-- ----------------------------------------------------- -->

# Marcel's regression approach

## CI via bootstrap

Method from https://statcompute.wordpress.com/2015/12/20/prediction-intervals-for-poisson-regression/

```{r}
p_load(doParallel, foreach)

registerDoParallel(cores = 4)

boot_pi <- function(model, pdata, n, p) {
  odata <- model$data
  lp <- (1 - p) / 2
  up <- 1 - lp
  seeds <- round(runif(n, 1, 1000), 0)
  boot_y <- foreach(i = 1:n, .combine = rbind) %dopar% {
    set.seed(seeds[i])
    bdata <- odata[sample(seq(nrow(odata)), size = nrow(odata), replace = TRUE), ]
    bpred <- predict(update(model, data = bdata), type = "response", newdata = pdata)
    rpois(length(bpred), lambda = bpred)
  }
  boot_ci <- t(apply(boot_y, 2, quantile, c(lp, up)))
  return(data.frame(pred = predict(model, newdata = pdata, type = "response"), 
                    lower = boot_ci[, 1], upper = boot_ci[, 2]))
}
```

## Looping over years

Analyses using 10 previous years.  
With three different inclusions depending on pandemic / flu years

```{r results='hide'}
for (YEAR in year_reg:year_max) {
  
  print(paste("Analysing year", YEAR))
  
  reg_data <- deaths_monthly %>% 
    filter(Year >= YEAR - year_smooth & Year < YEAR) 
  
  pred_data <- deaths_monthly %>% 
    filter(Year == YEAR) %>%
    mutate(
      fit = NA_real_,
      lpi = NA_real_,
      upi = NA_real_,
      fit_flu_hc = NA_real_,
      lpi_flu_hc = NA_real_,
      upi_flu_hc = NA_real_,
      fit_flu = NA_real_,
      lpi_flu = NA_real_,
      upi_flu = NA_real_)
  
  # summary(reg_data$Year)
  # summary(pred_data$Year)
  
  # all data
  summary(monthly <- glm(Deaths ~ Year + 
                           si_one + si_two + co_one + co_two, 
                         offset = log(Population),
                         data = reg_data, 
                         family = "poisson"))
  
  predict <- boot_pi(monthly, pred_data, 1000, 0.99)
  
  pred_data %<>%
    mutate(
      fit = predict$pred,
      lpi = predict$lower,
      upi = predict$upper,
      fit_flu_hc = predict$pred,
      lpi_flu_hc = predict$lower,
      upi_flu_hc = predict$upper,
      fit_flu = predict$pred,
      lpi_flu = predict$lower,
      upi_flu = predict$upper
    )
  
  # flu hc excluded
  if (YEAR %in% flu_years_hc_affected) {
    
    print(paste("    >> Extra analyses for hc flu year exclusions"))
    
    summary(monthly_flu_hc <- glm(deaths_flu_year_hc ~ Year + 
                                    si_one + si_two + co_one + co_two, 
                                  offset = log(Population),
                                  data = reg_data, 
                                  family = "poisson"))
    
    predict_flu_hc <- boot_pi(monthly_flu_hc, pred_data, 1000, 0.99)
    
    pred_data %<>%
      mutate(
        fit_flu_hc = predict_flu_hc$pred,
        lpi_flu_hc = predict_flu_hc$lower,
        upi_flu_hc = predict_flu_hc$upper
      )
  }
  
  # all flu excluded
  if (YEAR %in% flu_years_affected) {
    
    print(paste("    >> Extra analyses for flu year exclusions"))
    
    summary(monthly_flu <- glm(deaths_flu_year ~ Year + 
                                 si_one + si_two + co_one + co_two, 
                               offset = log(Population),
                               data = reg_data, 
                               family = "poisson"))
    
    predict_flu <- boot_pi(monthly_flu, pred_data, 1000, 0.99)
    
    pred_data %<>%
      mutate(
        fit_flu = predict_flu$pred,
        lpi_flu = predict_flu$lower,
        upi_flu = predict_flu$upper
      )
  } 
  
  if (YEAR == year_reg) {
    es_expected_deaths_monthly <- pred_data
  } else {
    es_expected_deaths_monthly <- bind_rows(es_expected_deaths_monthly, pred_data)
  }
}

rm(predict, predict_flu_hc, predict_flu, pred_data, reg_data, YEAR)
write_rds(es_expected_deaths_monthly, "data/es_expected_deaths_monthly.Rds")
```

```{r include=FALSE}
p_unload(doParallel, foreach)
# es_expected_deaths_monthly <- read_rds("data/es_expected_deaths_monthly.Rds")
```

## Two predictions

```{r echo=FALSE}
mort_plot <- function(plot_Year, extremes_remove = FALSE) {
  
  plot_data <- es_expected_deaths_monthly %>% 
    filter(Year >= plot_Year - 1 & Year <= plot_Year + 1)
  
  max <- plot_data %>% 
    summarise(Deaths = max(Deaths),
              lpi = max(lpi),
              upi = max(upi),
              median = max(median),
              lpi_flu = max(lpi_flu),
              upi_flu = max(upi_flu),
              median_flu_year = max(median_flu_year)) %>% 
    rowwise() %>% 
    mutate(max = max(c(Deaths, lpi, upi, median, lpi_flu, upi_flu, median_flu_year)))
  
  if (extremes_remove == FALSE) {
    
    plot_data %>% 
      ggplot(aes(x = Date)) +
      geom_rect(aes(xmin = as.Date(paste0(plot_Year, "-01-01")), 
                    xmax = as.Date(paste0(plot_Year, "-12-31")), 
                    ymin = -Inf, ymax = Inf), 
                fill = "#ffffbf", alpha = 0.01, inherit.aes = FALSE) +    
      geom_ribbon(aes(ymin = lpi, ymax = upi), alpha = 0.1) + 
      geom_line(aes(y = fit), colour = "grey50") +
      geom_line(aes(y = median), colour = "#2c7bb6") + 
      geom_line(aes(y = Deaths), color = "#d7191c", size = 1) + 
      scale_y_continuous(labels = comma, limits = c(0, max$max)) +
      scale_x_date(date_breaks = "4 months", date_labels = "%b") +
      xlab("") + ylab("Observed, 10y median & predicted deaths") +
      labs(caption = "Includes extreme years",
           title = paste(as.character(plot_Year - 1), "-",
                         as.character(plot_Year + 1))) +
      theme_minimal()
    
  } else if (extremes_remove == TRUE) {
    
    plot_data %>% 
      ggplot(aes(x = Date)) +
      geom_rect(aes(xmin = as.Date(paste0(plot_Year, "-01-01")), 
                    xmax = as.Date(paste0(plot_Year, "-12-31")), 
                    ymin = -Inf, ymax = Inf), 
                fill = "#ffffbf", alpha = 0.01, inherit.aes = FALSE) +   
      geom_ribbon(aes(ymin = lpi_flu, ymax = upi_flu), alpha = 0.1) + 
      geom_line(aes(y = fit_flu), colour = "grey50") +
      geom_line(aes(y = median_flu_year), colour = "#2c7bb6") + 
      geom_line(aes(y = Deaths), color = "#d7191c", size = 1) + 
      scale_y_continuous(labels = comma, limits = c(0, max$max)) +
      scale_x_date(date_breaks = "4 months", date_labels = "%b") +
      xlab("") + ylab("Observed, 10y median & predicted deaths") +
      labs(caption = "Excludes extreme years",
           title = paste(as.character(plot_Year - 1), "-",
                         as.character(plot_Year + 1))) +
      theme_minimal()
  }
}
```

### 1918 {.tabset}

#### With extremes

```{r echo=FALSE}
mort_plot(1918) 
```

#### Without extremes

```{r echo=FALSE}
mort_plot(1918, extremes_remove = TRUE) 
```

### 1957 {.tabset}

#### With extremes

```{r echo=FALSE}
mort_plot(1957) 
```

#### Without extremes

```{r echo=FALSE}
mort_plot(1957, extremes_remove = TRUE) 
```

### 2020 

```{r echo=FALSE}
mort_plot(2020) 
```


# Computing Environment

`r mu$session()`



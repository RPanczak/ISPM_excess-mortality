---
title: "Excess mortality: combining three countries"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
  code_folding: show
self_contained: true
highlight: pygments
editor_options: 
  chunk_output_type: console
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

options(scipen=999)
set.seed(12345)

library(pacman)
p_load(tidyverse, scales, magrittr)

options(max.print = "75")
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Data 

```{r}
expected_deaths_monthly <- bind_rows(
  ch_expected_deaths_monthly <- read_rds("data/ch_expected_deaths_monthly.Rds") %>% 
    mutate(Country = "Switzerland") %>% relocate(Country),
  se_expected_deaths_monthly <- read_rds("data/se_expected_deaths_monthly.Rds") %>% 
    mutate(Country = "Sweden") %>% relocate(Country),
  es_expected_deaths_monthly <- read_rds("data/es_expected_deaths_monthly.Rds") %>% 
    mutate(Country = "Spain") %>% relocate(Country)
)

write_rds(expected_deaths_monthly, "data/expected_deaths_monthly.Rds")
haven::write_dta(expected_deaths_monthly, "data/expected_deaths_monthly.dta")

unlink("data/ch_expected_deaths_monthly.Rds") 
unlink("data/se_expected_deaths_monthly.Rds") 
unlink("data/es_expected_deaths_monthly.Rds") 
```

# Figure 1

## Crude

```{r}
expected_deaths_monthly %>% 
  ggplot(aes(x = Date, y = deaths)) +
  geom_col() +
  facet_grid(vars(Country), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 1L, suffix = "K", scale = 1e-4)) +
  theme_minimal() +
  ylab("") + xlab("Deaths") +
  ggtitle("Monthly number of deaths")
```

## Per population

```{r}
expected_deaths_monthly %>% 
  ggplot(aes(x = Date, y = (deaths/pop)*10000)) +
  geom_line() +
  facet_grid(vars(Country), scales = "free_y") + 
  theme_minimal() +
  ylab("") + xlab("Deaths / 10,000 population") +
  ggtitle("Monthly number of deaths")
```

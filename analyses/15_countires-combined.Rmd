---
title: "Excess mortality"
subtitle: "Combining three countries"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
  code_folding: show
self_contained: true
highlight: pygments
editor_options: 
  chunk_output_type: console
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, scales, patchwork, kableExtra)
```

```{r knit-setup, include = FALSE}
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Data 

```{r eval=FALSE, include=FALSE}
# country specific
ch_expected_deaths_monthly <- read_rds("data/ch_expected_deaths_monthly.Rds") %>% 
  mutate(Country = "Switzerland") %>% relocate(Country),
se_expected_deaths_monthly <- read_rds("data/se_expected_deaths_monthly.Rds") %>% 
  mutate(Country = "Sweden") %>% relocate(Country),
es_expected_deaths_monthly <- read_rds("data/es_expected_deaths_monthly.Rds") %>% 
  mutate(Country = "Spain") %>% relocate(Country)

# together
expected_deaths_monthly <- bind_rows(
  read_rds("data/ch_expected_deaths_monthly.Rds") %>% 
    mutate(Country = "Switzerland") %>% relocate(Country),
  read_rds("data/se_expected_deaths_monthly.Rds") %>% 
    mutate(Country = "Sweden") %>% relocate(Country),
  read_rds("data/es_expected_deaths_monthly.Rds") %>% 
    mutate(Country = "Spain") %>% relocate(Country)
)

write_rds(expected_deaths_monthly, "data/expected_deaths_monthly.Rds")
haven::write_dta(expected_deaths_monthly, "data/expected_deaths_monthly.dta")

# unlink("data/ch_expected_deaths_monthly.Rds")
# unlink("data/se_expected_deaths_monthly.Rds")
# unlink("data/es_expected_deaths_monthly.Rds")
```

```{r}
expected_deaths_monthly <- read_rds("data/expected_deaths_monthly.Rds") %>% 
  mutate(Pandemic = case_when(
    (Year >= 1889 & Year <= 1892) ~ 1890,
    (Year >= 1917 & Year <= 1920) ~ 1918,
    (Year >= 1956 & Year <= 1959) ~ 1957,
    (Year >= 2019 & Year <= 2020) ~ 2020
  ))
```

# Figure 1 - diffs

## Monthly 

```{r echo=FALSE}
hline_pandemic <- expected_deaths_monthly %>% 
  filter(Year == 2020) %>% 
  group_by(Country) %>% 
  summarise(yintercept = max(deaths - fit_flu_hc)) %>% 
  ungroup()

expected_deaths_monthly %>% 
  mutate(Y = deaths - fit_flu_hc,
         Difference = ifelse(deaths > fit_flu_hc, "More", "Less")) %>% 
  ggplot(aes(x = Date)) +
  geom_hline(data = hline_pandemic, aes(yintercept = yintercept), 
             colour = "#984ea3", size = 0.25) +
  geom_hline(yintercept = 0, colour = "grey80") +
  geom_col(aes(y = Y, fill = Difference)) +
  scale_x_date(date_labels = "%Y",
               breaks = c(as.Date("1860-01-01"), 
                          as.Date("1890-01-01"),
                          as.Date("1918-01-01"),
                          as.Date("1957-01-01"),
                          as.Date("1968-01-01"),
                          as.Date("1977-01-01"),
                          as.Date("2009-01-01"),
                          as.Date("2020-01-01")),
               limits = c(as.Date("1860-01-01") - 100, 
                          as.Date("2020-12-31"))) +
  scale_fill_manual(values = c("#67A9CF", "#EF8A62")) +  
  facet_grid(vars(Country), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 1L, suffix = "K", scale = 1e-4)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey40"),
        axis.ticks = element_line()) +
  xlab("") + ylab("Difference observed - expected") +
  guides(fill = guide_legend(reverse = TRUE)) +
  ggtitle("Monthly number of deaths")

ggsave("paper/diffs.png", dpi = 300, width = 297, height = 210, units = "mm")
```

## Yearly 

```{r echo=FALSE}
hline_pandemic <- expected_deaths_monthly %>% 
  filter(Year == 2020) %>% 
  group_by(Country) %>% 
  summarise(deaths = sum(deaths),
            fit_flu_hc = sum(fit_flu_hc),
            yintercept = max(deaths - fit_flu_hc)) %>% 
  ungroup()

expected_deaths_monthly %>% 
  group_by(Country, Year) %>% 
  summarise(deaths = sum(deaths),
            fit_flu_hc = sum(fit_flu_hc)) %>% 
  ungroup() %>% 
  mutate(Y = deaths - fit_flu_hc,
         Difference = ifelse(deaths > fit_flu_hc, "More", "Less")) %>% 
  ggplot(aes(x = Year)) +
  geom_hline(data = hline_pandemic, aes(yintercept = yintercept), 
             colour = "#984ea3", size = 0.25, linetype = "dashed") +
  geom_hline(yintercept = 0, colour = "grey80") +
  geom_col(aes(y = Y, fill = Difference)) +
  scale_x_continuous(
    breaks = c(1860, 1890, 1918, 1957, 1968, 1977, 2009, 2020),
    limits = c(1860-1, 2020+1)) +
  scale_fill_manual(values = c("#67A9CF", "#EF8A62")) +  
  facet_grid(vars(Country), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 1L, suffix = "K", scale = 1e-4)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey40"),
        axis.ticks = element_line()) +
  xlab("") + ylab("Difference observed - expected") +
  guides(fill = guide_legend(reverse = TRUE)) +
  ggtitle("Yearly number of deaths")

ggsave("paper/diffs_year.png", dpi = 300, width = 297, height = 210, units = "mm")
```

# Figure 2 - four pandemics

## Absolute

```{r}
focus_years <- c(1890, 1918, 1957, 2020)

# plot_years <- c(seq(1890 - 1, 1890 + 2),
#                 seq(1918 - 1, 1918 + 2),
#                 seq(1957 - 1, 1957 + 2),
#                 seq(2020 - 1, 2020 + 2))

for(country in unique(expected_deaths_monthly$Country)) { 
  
  print(paste0("Plotting ", country))
  
  max <- expected_deaths_monthly %>% 
    filter(Country == country) %>% 
    filter(!is.na(Pandemic)) %>% 
    summarise(deaths = max(deaths),
              lpi_flu_hc = max(lpi_flu_hc),
              upi_flu_hc = max(upi_flu_hc)) %>% 
    rowwise() %>% 
    mutate(max = max(c(deaths, lpi_flu_hc, upi_flu_hc))) %>% 
    ungroup()
  
  print(paste0("Max for x is ", max$max))
  
  for(year in focus_years) {
    
    # skip Spain oldest - no data
    if(year == 1890 & country == "Spain") {
      next
    }
    
    print(paste0("    Year ", year))
    
    plot_data <- expected_deaths_monthly %>% 
      filter(Country == country) %>% 
      filter(Pandemic == year)
    
    name <- paste(country, year, sep = "_")
    
    if (year == 2020) {
      my_title = paste0(country, ": ", 
                        as.character(year - 1), "-", as.character(year))
    } else {
      my_title = paste0(country, ": ", 
                        as.character(year - 1), "-", as.character(year + 2))
    }
  
    # sync breaks across plots
    my_breaks = plot_data$Date[seq(1, nrow(plot_data), 6)]
  
    plot <- plot_data %>% 
      ggplot(aes(x = Date)) +
      geom_rect(xmin = as.Date(paste0(year, "-01-01")),
                xmax = as.Date(paste0(year, "-12-31")),
                ymin = -Inf, ymax = Inf, 
                fill = "#ffffbf", alpha = 0.01, inherit.aes = FALSE) +
      geom_ribbon(aes(ymin = lpi_flu_hc, ymax = upi_flu_hc), alpha = 0.1) + 
      geom_line(aes(y = fit_flu_hc), colour = "grey50") +
      # geom_line(aes(y = median_flu_year), colour = "#2c7bb6") + 
      geom_line(aes(y = deaths), color = "#d7191c", size = 0.5) + 
      scale_x_date(breaks = my_breaks, date_labels = "%b") +
      xlab("") + 
      # ylab("Observed, 10y median & predicted deaths") +
      ylab("Observed & predicted deaths") +
      # labs(caption = "Excludes extreme years") +
      ggtitle(my_title) +
      scale_y_continuous(limits = c(0, max$max),
                         labels = label_number(accuracy = 0.1, suffix = "K", 
                                               scale = 1e-4)) +
      theme_bw() +
      theme(plot.title = element_text(size = 10),
            axis.text.x = element_text(size = 8),
            axis.title.y = element_text(size = 9),
            axis.text.y = element_text(size = 8))
    
    assign(name, plot)
  }
}

plot_spacer() + Spain_1918 + Spain_1957 + Spain_2020 +  
  Sweden_1890 + Sweden_1918 + Sweden_1957 + Sweden_2020 +
  Switzerland_1890 + Switzerland_1918 + Switzerland_1957 + Switzerland_2020 +
  plot_layout(widths = rep(c(2, 2, 2, 1), 3)) +
  plot_layout(ncol = 4) 

ggsave("paper/four_pndemics.png", dpi = 300, width = 297, height = 210, units = "mm")
```

## Percent

```{r}
plot_years <- c(seq(1890 - 1, 1890 + 2),
                seq(1918 - 1, 1918 + 2),
                seq(1957 - 1, 1957 + 2),
                seq(2020 - 1, 2020 + 2))

plot_data <- expected_deaths_monthly %>% 
  filter(Year %in% plot_years) %>% 
  mutate(Percent = ((deaths - fit_flu_hc) / fit_flu_hc),
         Difference = ifelse(deaths > fit_flu_hc, "More", "Less")) %>% 
  group_by(Country, Pandemic) %>% 
  mutate(time = row_number()) %>% 
  ungroup()

plot_data %>% 
  ggplot(aes(x = time)) +
  geom_hline(yintercept = 0, colour = "grey60") +
  geom_vline(xintercept = 13, colour = "grey80") +
  geom_vline(xintercept = 24, colour = "grey80") +
  geom_rect(xmin = as.Date(paste0(year, "-01-01")),
            xmax = as.Date(paste0(year, "-12-31")),
            ymin = -Inf, ymax = Inf,
            fill = "#ffffbf", alpha = 0.01, inherit.aes = FALSE) +
  geom_col(aes(y = Percent, fill = Difference), size = 0.5) +
  facet_grid(vars(Country), vars(Pandemic), scales = "free_x") + 
  scale_x_continuous(limits = c(min(plot_data$time)-1, max(plot_data$time)+1),
                     breaks = c(1, 13, 24, 36, 48), 
                     labels = c("-12m", "Start", "End", "+12m", "+24m")) +
  xlab("") + 
  ylab("% above predicted deaths") +
  ggtitle("Excess deaths as % of observed") +
  scale_y_continuous(labels = percent) +
  scale_fill_manual(values = c("#67A9CF", "#EF8A62")) +  
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_line(), 
        panel.grid.minor.y = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey40")) 

ggsave("paper/four_pndemics_perc.png", dpi = 300, width = 297, height = 210, units = "mm")
```

# Table 1

```{r}
pandemic_year <- c("1890","1918","1957","2020")

table_1 <- expected_deaths_monthly %>%
  select(Country,Year, deaths, pop, fit_flu_hc) %>%
  filter(Year %in% pandemic_year)%>%
  group_by(Year, Country) %>%
  summarise(Expected_Mortality = round(sum(fit_flu_hc), 0),
            Deaths_num = sum(deaths),
            Cum_excess_death = round(sum(deaths)-sum(fit_flu_hc), 0),
            Percent_excess_death = round((Cum_excess_death/Expected_Mortality)*100, 1))%>%
  ungroup()

openxlsx::write.xlsx(table_1,"paper/table1.xlsx", row.names = FALSE)
```

```{r echo=FALSE}
table_1 %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)
```

# Appendix 

```{r eval=FALSE}
## Crude
expected_deaths_monthly %>% 
  ggplot(aes(x = Date, y = deaths)) +
  geom_col() +
  geom_rect(xmin = as.Date(paste0(1890, "-01-01")),
            xmax = as.Date(paste0(1890, "-12-31")),
            ymin = 0, ymax = Inf,
            fill = "#d7191c", alpha = 0.01, inherit.aes = FALSE) +
  geom_rect(xmin = as.Date(paste0(1918, "-01-01")),
            xmax = as.Date(paste0(1918, "-12-31")),
            ymin = 0, ymax = Inf,
            fill = "#d7191c", alpha = 0.01, inherit.aes = FALSE) +
  geom_rect(xmin = as.Date(paste0(1957, "-01-01")),
            xmax = as.Date(paste0(1957, "-12-31")),
            ymin = 0, ymax = Inf,
            fill = "#d7191c", alpha = 0.01, inherit.aes = FALSE) +
  geom_rect(xmin = as.Date(paste0(2020, "-01-01")),
            xmax = as.Date(paste0(2020, "-12-31")),
            ymin = 0, ymax = Inf,
            fill = "#d7191c", alpha = 0.01, inherit.aes = FALSE) +
  facet_grid(vars(Country), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 1L, suffix = "K", scale = 1e-4)) +
  theme_minimal() +
  xlab("") + ylab("Deaths") +
  ggtitle("Monthly number of deaths")
```

```{r eval=FALSE}
## Per pop
expected_deaths_monthly %>% 
  ggplot(aes(x = Date, y = (deaths/pop)*10000, colour = Country)) +
  geom_line() +
  theme_minimal() +
  xlab("") + ylab("Deaths / 10,000 population") +
  ggtitle("Monthly number of deaths")
```

## Deaths per population

```{r echo=FALSE}
expected_deaths_monthly %>% 
  ggplot(aes(x = Date, y = (deaths/pop)*10000)) +
  geom_rect(xmin = as.Date(paste0(1890, "-01-01")),
            xmax = as.Date(paste0(1890, "-12-31")),
            ymin = 0, ymax = Inf,
            fill = "#d7191c", alpha = 0.01, inherit.aes = FALSE) +
  geom_rect(xmin = as.Date(paste0(1918, "-01-01")),
            xmax = as.Date(paste0(1918, "-12-31")),
            ymin = 0, ymax = Inf,
            fill = "#d7191c", alpha = 0.01, inherit.aes = FALSE) +
  geom_rect(xmin = as.Date(paste0(1957, "-01-01")),
            xmax = as.Date(paste0(1957, "-12-31")),
            ymin = 0, ymax = Inf,
            fill = "#d7191c", alpha = 0.01, inherit.aes = FALSE) +
  geom_rect(xmin = as.Date(paste0(2020, "-01-01")),
            xmax = as.Date(paste0(2020, "-12-31")),
            ymin = 0, ymax = Inf,
            fill = "#d7191c", alpha = 0.01, inherit.aes = FALSE) + 
  facet_grid(vars(Country), scales = "free_y") + 
  geom_line() +
  theme_minimal() +
  xlab("") + ylab("Deaths / 10,000 population") +
  ggtitle("Monthly number of deaths")
```

## Country panel

### Switzerland

```{r echo=FALSE}
extra_labs <- c("Deaths", "Deaths / 10,000", "Population")
names(extra_labs) <- c("deaths", "deaths_pop", "pop")

expected_deaths_monthly %>% 
  filter(Country == "Switzerland") %>%
  select(Date, deaths, pop) %>% 
  mutate(deaths_pop = (deaths/pop)*10000) %>% 
  pivot_longer(-Date) %>% 
  ggplot(aes(x = Date, y = value)) +
  geom_rect(xmin = as.Date(paste0(1890, "-01-01")),
            xmax = as.Date(paste0(1890, "-12-31")),
            ymin = 0, ymax = Inf,
            fill = "#d7191c", alpha = 0.01, inherit.aes = FALSE) +
  geom_rect(xmin = as.Date(paste0(1918, "-01-01")),
            xmax = as.Date(paste0(1918, "-12-31")),
            ymin = 0, ymax = Inf,
            fill = "#d7191c", alpha = 0.01, inherit.aes = FALSE) +
  geom_rect(xmin = as.Date(paste0(1957, "-01-01")),
            xmax = as.Date(paste0(1957, "-12-31")),
            ymin = 0, ymax = Inf,
            fill = "#d7191c", alpha = 0.01, inherit.aes = FALSE) +
  geom_rect(xmin = as.Date(paste0(2020, "-01-01")),
            xmax = as.Date(paste0(2020, "-12-31")),
            ymin = 0, ymax = Inf,
            fill = "#d7191c", alpha = 0.01, inherit.aes = FALSE) + 
  facet_grid(vars(name), scales = "free_y",
             labeller = labeller(name = extra_labs)) + 
  geom_line() +
  theme_minimal() +
  xlab("") + ylab("Variable count") +
  ggtitle("Monthly number of deaths, population and deaths per 10,000")
```

## Impact of extremes

Using 1918 pandemic as an example of impacton estimates from 1919 - 1923.  
Estimates with extreme year (red) and without (blue).  
Converge after 5 year smoothing window stops having effect (ie. in 1924).  

### Figure 

```{r echo=FALSE}
expected_deaths_monthly %>% 
  # filter(Country == "Spain") %>% 
  filter(Year >= 1918 & Year <= 1924) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = deaths), colour = "grey60") + 
  geom_ribbon(aes(ymin = lpi, ymax = upi), 
              alpha = 0.1, fill = "#EF8A62") + 
  geom_line(aes(y = fit), colour = "#EF8A62") +
  geom_ribbon(aes(ymin = lpi_flu_hc, ymax = upi_flu_hc), 
              alpha = 0.1, fill = "#67A9CF") + 
  geom_line(aes(y = fit_flu_hc), colour = "#67A9CF") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y", minor_breaks = NULL) +
  # coord_cartesian(ylim = c(NA, 100000)) + 
  xlab("") + ylab("Number of deaths") + 
  facet_grid(vars(Country), scales = "free_y") + 
  theme_minimal()
```

### Table 

Using 1918 pandemic as an example of impact on estimates from 1919.   

```{r echo=FALSE}
table_data <- expected_deaths_monthly %>% 
  # filter(Country == "Spain") %>% 
  filter(Year >= 1919 & Year <= 1919) %>% 
  select(Country, Month, deaths, fit, fit_flu_hc) %>% 
  mutate(fit = round(fit),
         fit_diff = fit - deaths,
         fit_flu_hc = round(fit_flu_hc),
         fit_flu_hc_diff = fit_flu_hc - deaths) %>% 
  relocate(fit_diff, .after = fit) %>% 
  relocate(fit_flu_hc_diff, .after = fit_flu_hc)  

table_data%>% 
  kbl(col.names = c("Country", "Month", "Observed", 
                    "Predicted", "Difference",
                    "Predicted", "Difference")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  column_spec(5, color = ifelse(table_data$fit_diff > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  column_spec(7, color = ifelse(table_data$fit_flu_hc_diff > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  row_spec(1, italic = FALSE) %>% 
  add_header_above(c(" " = 3, "Including 1918" = 2, "Excluding 1918" = 2)) %>%
  # collapse not working; issue filled on github
  collapse_rows(columns = 1, valign = "top")
```

## Impact of fit vs CI

### Fit vs. LPI vs. UPI

```{r echo=FALSE}
focus_years <- c(1890, 1918, 1957, 2009, 2020)

table_data <- expected_deaths_monthly %>% 
  filter(Country == "Switzerland") %>%
  filter(Year %in% focus_years) %>% 
  group_by(Year) %>% 
  summarize(deaths = sum(deaths),
            fit = round(sum(fit)),
            fit_diff = fit - deaths,
            lpi = round(sum(lpi)),
            lpi_diff = lpi - deaths, 
            upi = round(sum(upi)),
            upi_diff = upi - deaths) %>% 
  relocate(lpi_diff, .after = lpi) %>% 
  relocate(upi_diff, .after = upi)  

table_data%>% 
  kbl(col.names = c("Year", "Observed", 
                    "Predicted", "Difference",
                    "Predicted", "Difference",
                    "Predicted", "Difference")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  column_spec(4, color = ifelse(table_data$fit_diff > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  column_spec(6, color = ifelse(table_data$lpi_diff > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  column_spec(8, color = ifelse(table_data$upi_diff > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  row_spec(1, italic = FALSE) %>% 
  add_header_above(c(" " = 2, "Fit" = 2, "LPI" = 2, "UPI" = 2)) %>%
  # collapse not working; issue filled on github
  collapse_rows(columns = 1, valign = "top")
```

### 2015 & 2020

Comparing BfS and our method for two years.  

```{r echo=FALSE}
focus_years <- c(2010, 2015, 2020)
```

```{r eval=FALSE,echo=FALSE}
p_load(aweek, wktmo)
# in case proper monthly redistribution is needed?
# !!! unfinished !!!
# needs 2020...
bfs_2015 <- read_rds("data/BfS/bfs_web_deaths_weekly_2010-2019.Rds") %>%
  filter(Year == 2015) %>%
  select(-Ending) %>%
  mutate(Starting = get_date(week = Week, year = Year, start = "Monday"))

# ... and 65+
bfs <- bind_rows(
  
  weekToMonth(bfs_2015[bfs_2015$Age == "0-64", ]$NumberOfDeaths,
              datStart = "29-12-2014", wkMethod = "ISO") 
  
) %>% 
  separate(yearMonth, c("Year", "Month"), convert = TRUE) %>% 
  filter(Year %in% focus_years) %>% 
  rename(deaths_month = value) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date)

p_unload(aweek, wktmo)
```

```{r echo=FALSE}
# ignoring first & last week problems
compare <- bind_rows(
  
  bind_rows(
    read_rds("data/BfS/bfs_web_deaths_weekly_2010-2019.Rds"),
    read_rds("data/BfS/bfs_web_deaths_weekly_2020-2021.Rds")) %>% 
    filter(Year %in% focus_years) %>% 
    # select(-Ending) %>% 
    # mutate(
    #   # Week2 = get_aweek(week = Week, year = Year, 
    #   #                   start = "Monday", week_start = "Monday"),
    #   Starting = aweek::get_date(week = Week, year = Year, 
    #                       start = "Monday")) %>% 
    mutate(Expected_diff = Expected - NumberOfDeaths,
           lowerB_diff = lowerB - NumberOfDeaths,
           upperB_diff = upperB - NumberOfDeaths) %>%
    group_by(Year) %>% 
    summarise(NumberOfDeaths = sum(NumberOfDeaths),
              Expected = sum(Expected),
              Expected_diff = sum(Expected_diff),
              lowerB = sum(lowerB), 
              lowerB_diff = sum(lowerB_diff),
              upperB = sum(upperB),
              upperB_diff = sum(upperB_diff)) %>%
    ungroup() %>% 
    mutate(Method = "BfS"),
  
  expected_deaths_monthly %>% 
    filter(Country == "Switzerland") %>%
    filter(Year %in% focus_years) %>% 
    mutate(Expected_diff = fit - deaths,
           lowerB_diff = lpi - deaths, 
           upperB_diff = upi - deaths) %>% 
    group_by(Year) %>% 
    summarize(NumberOfDeaths = sum(deaths),
              Expected = round(sum(fit)),
              Expected_diff = round(sum(Expected_diff)),
              lowerB = round(sum(lpi)),
              lowerB_diff = round(sum(lowerB_diff)), 
              upperB = round(sum(upi)),
              upperB_diff = round(sum(upperB_diff))) %>% 
    ungroup() %>% 
    mutate(Method = "Our estimates")
) %>% 
  relocate(lowerB_diff, .after = lowerB) %>% 
  relocate(upperB_diff, .after = upperB) %>%
  relocate(Year, Method) %>% 
  arrange(Year, Method)

compare %>% 
  kbl(col.names = c("Year", "Method", "Observed", 
                    "Predicted", "Difference",
                    "Predicted", "Difference",
                    "Predicted", "Difference")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  column_spec(5, color = ifelse(compare$Expected_diff > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  column_spec(7, color = ifelse(compare$lowerB_diff > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  column_spec(9, color = ifelse(compare$upperB_diff > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  row_spec(1, italic = FALSE) %>% 
  add_header_above(c(" " = 3, "Fit" = 2, "LPI" = 2, "UPI" = 2)) %>%
  # collapse not working; issue filled on github
  collapse_rows(columns = 1, valign = "top")
```


<!-- ----------------------------------------------------- -->

# Alt Viz

## Stacked

```{r echo=FALSE}
expected_deaths_monthly %>% 
  # filter(Country == "Switzerland") %>%
  mutate(Year = as.integer(Year),
         Month = as.integer(Month)) %>% 
  ggplot(aes(x = Month)) +
  geom_line(aes(y = deaths, group = Year, color = Year), alpha = 0.5) + 
  scale_x_continuous(breaks = seq(1, 12, 2)) +
  scale_color_viridis_c() +
  xlab("Month") + ylab("Observed deaths") +
  facet_grid(vars(Country), scales = "free_y") + 
  theme_minimal() 

expected_deaths_monthly %>% 
  mutate(Year = as.integer(Year),
         Month = as.integer(Month)) %>% 
  ggplot(aes(x = Month)) +
  geom_line(aes(y = median_flu_year, group = Year, color = Year), alpha = 0.5) + 
  scale_x_continuous(breaks = seq(1, 12, 2)) +
  scale_color_viridis_c() +
  xlab("Month") + ylab("Median 10y deaths") +
  facet_grid(vars(Country), scales = "free_y") + 
  theme_minimal()

expected_deaths_monthly %>% 
  mutate(Year = as.integer(Year),
         Month = as.integer(Month)) %>% 
  ggplot(aes(x = Month)) +
  geom_line(aes(y = fit_flu, group = Year, color = Year), alpha = 0.5) + 
  scale_x_continuous(breaks = seq(1, 12, 2)) +
  scale_color_viridis_c() +
  xlab("Month") + ylab("Observed deaths") +
  facet_grid(vars(Country), scales = "free_y") + 
  theme_minimal()
```

## Diffs 2

```{r echo=FALSE}
expected_deaths_monthly %>% 
  filter(Year >= 1915 & Year <= 1919) %>% 
  select(Country, Date, deaths, fit_flu) %>% 
  mutate(From = pmin(deaths, fit_flu),
         To = pmax(deaths, fit_flu),
         Difference = ifelse(deaths > fit_flu, "More", "Less")) %>% 
  ggplot(aes(x = Date)) +
  # geom_line(aes(y = fit_flu), color = "grey80") + 
  geom_linerange(aes(ymin = From, ymax = To, color = Difference), size = 1) + 
  scale_y_continuous(labels = comma) +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
  scale_colour_manual(values = c("#67A9CF", "#EF8A62")) +  
  xlab("Year") + ylab("Difference observed expected") +
  facet_grid(vars(Country), scales = "free_y") + 
  theme_minimal()

expected_deaths_monthly %>% 
  filter(Year >= 2016) %>%
  select(Country, Date, deaths, fit_flu) %>% 
  mutate(From = pmin(deaths, fit_flu),
         To = pmax(deaths, fit_flu),
         Difference = ifelse(deaths > fit_flu, "More", "Less")) %>% 
  ggplot(aes(x = Date)) +
  # geom_line(aes(y = fit_flu), color = "grey80") + 
  geom_linerange(aes(ymin = From, ymax = To, color = Difference), size = 1) + 
  scale_y_continuous(labels = comma) +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
  scale_colour_manual(values = c("#67A9CF", "#EF8A62")) +  
  xlab("Year") + ylab("Difference observed expected") +
  facet_grid(vars(Country), scales = "free_y") + 
  theme_minimal()
```

<!-- ## Animate -->

```{r eval=FALSE, message=FALSE, include=FALSE}
p_load(gganimate)

p <- expected_deaths_monthly %>% 
  mutate(Year = as.integer(Year),
         Month = as.integer(Month)) %>% 
  ggplot(aes(x = Month)) +
  geom_ribbon(aes(ymin = lpi_flu, ymax = upi_flu), fill = "#2c7bb6", alpha = 0.1) +
  geom_line(aes(y = fit_flu), colour = "#2c7bb6") +
  # geom_line(aes(y = median_flu_year), colour = "firebrick") + 
  geom_line(aes(y = deaths), color = "#d7191c", size = 1) + 
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = seq(1, 12, 2)) +
  xlab("Month") + ylab("Observed vs. predicted deaths") +
  labs(title = "Year: {closest_state}") +
  theme_minimal() +
  transition_states(Year, transition_length = 1, state_length = 1) +
  ease_aes('linear')  

animate(p, fps = 1)

anim_save("res/mort_anim.gif")

p_unload(gganimate)
```

<!-- ![](../res/mort_anim.gif) -->
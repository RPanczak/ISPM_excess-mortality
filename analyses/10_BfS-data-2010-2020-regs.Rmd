---
title: "Excess mortality"
subtitle: "2010-2020 weekly vs. monthly BfS data"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen=999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, lubridate, scales, magrittr,
       slider, ciTools)
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Years

```{r}
year <- 2020

year_from <- year - 10
date_from <- ymd(paste0(as.character(year_from), "-01-01"))

year_reg <- year - 1
date_reg <- ymd(paste0(as.character(year_reg), "-01-01"))

date_min <- ymd(paste0(as.character(year), "-01-01"))
date_max <- ymd(paste0(as.character(year), "-12-31"))
# to extend
# date_max <- ymd(paste0(as.character(year + 1), "-03-01"))

flu_years_hc <- c(1890, 1918, 2020)

flu_years_hc_affected <- c(seq(1890 + 1, 1890 + 10),
                           seq(1918 + 1, 1918 + 10))

flu_years <- c(1890, 1918, 1957, 1968, 1977, 2009, 2020)

flu_years_affected <- c(flu_years_hc_affected,
                        seq(1957 + 1, 1957 + 10),
                        seq(1968 + 1, 1968 + 10),
                        seq(1977 + 1, 1977 + 10),
                        seq(2009 + 1, 2009 + 10))

```

<!-- ----------------------------------------------------- -->

# Gold(ish) standard

```{r echo=FALSE,eval=FALSE, out.width='100%'}
path <- paste0("./data/BfS/orig_plots/", as.character(year), ".png")
knitr::include_graphics(path)
```

![](../data/BfS/orig_plots/2020.png)

<!-- ----------------------------------------------------- -->

# Data 

## Weekly number of deaths, 2010-2020

Prepared in `03.Rmd`.  Collapsing age groups. 

```{r}
bfs_web_deaths_weekly <- read_rds("data/BfS/bfs_web_deaths_weekly_2010-2019.Rds")  %>% 
  bind_rows(read_rds("data/BfS/bfs_web_deaths_weekly_2020-2021.Rds") %>%
              filter(Ending <= date_max)) %>% 
  group_by(Year, Week, Ending) %>% 
  summarise(NumberOfDeaths = sum(NumberOfDeaths),
            Expected = sum(Expected)) %>% 
  ungroup() %>% 
  mutate(Excess_expected = NumberOfDeaths - Expected,
         si_one = sin(2*pi*Week/(365.25/7)),
         si_two = sin(2*pi*Week/((365.25/2)/7)),
         co_one = cos(2*pi*Week/(365.25/7)),
         co_two = cos(2*pi*Week/((365.25/2)/7))) %>% 
  mutate(Time = row_number()) %>% 
  relocate(Time)
```

4 harmonic variables  

```{r}
bfs_web_deaths_weekly %>% 
  filter(Year >= 2018) %>% 
  select(si_one, co_one) %>% 
  mutate(row = row_number()) %>% 
  pivot_longer(-row) %>% 
  ggplot() +
  geom_line(aes(row, value, color = name)) +
  xlab("") +
  theme_minimal()
```

```{r}
bfs_web_deaths_weekly %>% 
  filter(Year >= 2018) %>% 
  select(si_two, co_two) %>% 
  mutate(row = row_number()) %>% 
  pivot_longer(-row) %>% 
  ggplot() +
  geom_line(aes(row, value, color = name)) +
  xlab("") +
  theme_minimal()
```

```{r echo=FALSE}
bfs_web_deaths_weekly %>% 
  filter(Year <= year) %>% 
  ggplot(aes(x = Ending)) +
  geom_rect(aes(xmin = date_min, xmax = date_max, 
                ymin = -Inf, ymax = Inf), 
            fill = "#7fc97f", alpha = 0.01, inherit.aes = FALSE) +
  geom_rect(aes(xmin = date_from, xmax = date_min, 
                ymin = -Inf, ymax = Inf), 
            fill = "#fdc086", alpha = 0.01, inherit.aes = FALSE) +
  geom_line(aes(y = NumberOfDeaths)) + 
  geom_line(aes(y = Expected), colour = "#beaed4", size = 1, alpha = 0.75) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") +
  theme_minimal()
```

## Yearly totals of excess deaths

Calculated from weekly BfS data aggregating `NumberOfDeaths` and `Expected` (not `uperB`!).

```{r}
excess_deaths <- bfs_web_deaths_weekly %>% 
  filter(Year >= year_from) %>% 
  mutate(Excess_expected = NumberOfDeaths - Expected) %>% 
  group_by(Year) %>% 
  summarise(Excess_expected = sum(Excess_expected)) %>% 
  ungroup()
```

```{r echo=FALSE}
ggplot(excess_deaths) + 
  geom_col(aes(x = factor(Year), y = Excess_expected)) + 
  theme_minimal() + xlab("") + ylab("Excess deaths")
```

## Monthly number of deaths, 2010-2020

Prepared in `02.Rmd`.  

```{r}
# bfs_web_pop_yearly <- read_rds("data/BfS/bfs_web_pop_yearly.Rds")

bfs_web_deaths_monthly <- read_rds("data/BfS/bfs_web_deaths_monthly.Rds") %>% 
  filter(Year >= 2010) %>% 
  # left_join(bfs_web_pop_yearly) %>% 
  # mutate(flu_year = ifelse(Year %in% flu_years, 1, 0),
  #        not = 1 - flu_year) %>% 
  mutate(
    si_one = sin(2*pi*Month/12),
    si_two = sin(4*pi*Month/12),
    co_one = cos(2*pi*Month/12),
    co_two = cos(4*pi*Month/12)) %>% 
  mutate(Time = row_number()) %>% 
  relocate(Time)

# with(bfs_web_deaths_monthly, table(flu_year, not))

# rm(bfs_web_pop_yearly)
```

4 harmonic variables

```{r}
bfs_web_deaths_monthly %>% 
  filter(Year >= 2018) %>% 
  select(si_one, co_one) %>% 
  mutate(row = row_number()) %>% 
  pivot_longer(-row) %>% 
  ggplot() +
  geom_line(aes(row, value, color = name)) +
  xlab("") +
  theme_minimal()
```

```{r}
bfs_web_deaths_monthly %>% 
  filter(Year >= 2018) %>% 
  select(si_two, co_two) %>% 
  mutate(row = row_number()) %>% 
  pivot_longer(-row) %>% 
  ggplot() +
  geom_line(aes(row, value, color = name)) +
  xlab("") +
  theme_minimal()
```

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  filter(Year <= year) %>% 
  ggplot(aes(x = Date)) +
  geom_rect(aes(xmin = date_min, xmax = date_max, 
                ymin = -Inf, ymax = Inf), 
            fill = "#7fc97f", alpha = 0.01, inherit.aes = FALSE) +
  geom_rect(aes(xmin = date_from, xmax = date_min, 
                ymin = -Inf, ymax = Inf), 
            fill = "#fdc086", alpha = 0.01, inherit.aes = FALSE) +
  geom_line(aes(y = deaths_month)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma) +
  theme_minimal() + 
  xlab("") + ylab("Deaths")
```

## 5-year mean and medians

### Weekly 

```{r}
bfs_web_deaths_weekly %<>% 
  arrange(Week, Year) %>% 
  group_by(Week) %>% 
  mutate(mean_5y   = slide_dbl(NumberOfDeaths, mean, 
                               na.rm = TRUE, .complete = TRUE,
                               .before = 5, .after = -1),
         median_5y = slide_dbl(NumberOfDeaths, median, 
                               na.rm = TRUE, .complete = TRUE,
                               .before = 5, .after = -1)) %>% 
  ungroup() %>% 
  arrange(Year, Week) %>%
  filter(Ending >= date_from)
```

```{r echo=FALSE}
bfs_web_deaths_weekly %>% 
  filter(Year >= year - 5 & Year <= year) %>%
  ggplot(aes(x = Ending)) +
  geom_rect(aes(xmin = date_min, xmax = date_max, 
                ymin = -Inf, ymax = Inf), alpha = 0.005, inherit.aes = FALSE) +
  geom_line(aes(y = NumberOfDeaths), colour = "grey40") + 
  geom_line(aes(y = Expected), colour = "#beaed4") + 
  geom_line(aes(y = median_5y), colour = "firebrick") + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") +
  theme_minimal()
```

**PS:** Notice the gap on week 53 (end 2015 / beg 2016) illustrating **problem of week 53**!

```{r echo=FALSE}
bfs_web_deaths_weekly %>% 
  filter(Year >= year & Year <= year) %>%
  ggplot(aes(x = Ending)) +
  geom_line(aes(y = NumberOfDeaths), colour = "grey40") + 
  geom_line(aes(y = Expected), colour = "#beaed4") + 
  geom_line(aes(y = median_5y), colour = "firebrick") + 
  scale_x_date(date_breaks = "2 months", date_labels = "%b") +
  xlab("") +
  theme_minimal()
```

### Monthly 

```{r}
bfs_web_deaths_monthly %<>% 
  arrange(Month, Year) %>% 
  group_by(Month) %>% 
  mutate(mean_5y   = slide_dbl(deaths_month, mean, 
                               na.rm = TRUE, .complete = TRUE,
                               .before = 5, .after = -1),
         median_5y = slide_dbl(deaths_month, median, 
                               na.rm = TRUE, .complete = TRUE,
                               .before = 5, .after = -1)) %>% 
  ungroup() %>% 
  arrange(Year, Month) %>% 
  filter(Date >= date_from)
```

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  filter(Year >= year - 5 & Year <= year) %>%
  ggplot(aes(x = Date)) +
  geom_rect(aes(xmin = date_min, xmax = date_max, 
                ymin = -Inf, ymax = Inf), alpha = 0.005, inherit.aes = FALSE) +
  geom_line(aes(y = deaths_month), colour = "grey40") + 
  geom_line(aes(y = median_5y), colour = "firebrick") + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") +
  theme_minimal()
```

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  filter(Year >= year & Year <= year) %>%
  ggplot(aes(x = Date)) +
  geom_line(aes(y = deaths_month), colour = "grey40") + 
  geom_line(aes(y = median_5y), colour = "firebrick") + 
  scale_x_date(date_breaks = "2 months", date_labels = "%b") +
  xlab("") +
  theme_minimal()
```

<!-- ----------------------------------------------------- -->

# Seasonality

### Weekly data

```{r}
dcmp <- bfs_web_deaths_monthly %>%
  tsibble::as_tsibble(index = Time) %>% 
  filter(Year < year) %>% 
  fabletools::model(feasts::STL(deaths_month ~ season(window = Inf)))

# fabletools::components(dcmp)
fabletools::components(dcmp) %>% 
  autoplot()
```

### Monthly data

```{r}
dcmp <- bfs_web_deaths_monthly %>%
  tsibble::as_tsibble(index = Time) %>% 
  filter(Year < year) %>% 
  fabletools::model(feasts::STL(deaths_month ~ season(window = Inf)))

# fabletools::components(dcmp)
fabletools::components(dcmp) %>% 
  autoplot()
```

<!-- ----------------------------------------------------- -->

# Outcome

### Weekly data

```{r echo=FALSE}
bfs_web_deaths_weekly %>% 
  filter(Year <= year_reg) %>% 
  ggplot(aes(NumberOfDeaths)) +
  geom_histogram(binwidth = 10) +
  theme_minimal()
```

### Monthly data

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  filter(Year <= year_reg) %>% 
  ggplot(aes(deaths_month)) +
  geom_histogram(binwidth = 50) +
  theme_minimal()
```

<!-- ----------------------------------------------------- -->

# Marcel's regression approach

## Data

```{r}
reg_deaths_weekly <- bfs_web_deaths_weekly %>% 
  filter(Year >= 2015) %>% 
  filter(Year <= year_reg) 

pred_deaths_weekly <- bfs_web_deaths_weekly # %>% filter(Year > year_reg)

reg_deaths_monthly <- bfs_web_deaths_monthly %>% 
  filter(Year >= 2015) %>% 
  filter(Year <= year_reg)

pred_deaths_monthly <- bfs_web_deaths_monthly # %>% filter(Year > year_reg)
```

## Weekly data

```{r}
summary(mz_weekly <- glm(NumberOfDeaths ~ Week + 
                           si_one + si_two + co_one + co_two, 
                         family = "poisson", data = reg_deaths_weekly))

pred_deaths_weekly %<>%
  add_pi(mz_weekly, 
         names = c("mz_lpi", "mz_upi"), 
         yhatName = "mz_fit", 
         nSims = 20000) %>% 
  as_tibble()
```

```{r eval=FALSE, include=FALSE}
ggplot(pred_deaths_weekly, aes(x = Ending)) +
  geom_ribbon(aes(ymin = mz_lci, ymax = mz_uci), alpha = 0.1) + 
  geom_line(aes(y = mz_fit)) +
  geom_line(aes(y = NumberOfDeaths), color = "#beaed4", size = 1) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") + ylab("Observed, mean & predicted deaths") +
  theme_minimal()
```

```{r echo=FALSE}
pred_deaths_weekly %>% 
  ggplot(aes(x = Ending)) +
  geom_line(aes(y = NumberOfDeaths), color = "#beaed4", size = 0.5) + 
  geom_line(aes(y = median_5y), colour = "firebrick") +
  geom_ribbon(aes(ymin = mz_lpi, ymax = mz_upi), alpha = 0.1) + 
  geom_line(aes(y = mz_fit)) +
  scale_y_continuous(labels = comma) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") + ylab("Observed, 5y median & predicted deaths") +
  theme_minimal()
```

```{r echo=FALSE}
pred_deaths_weekly %>% 
  filter(Year >= year) %>% 
  ggplot(aes(x = Ending)) +
  geom_line(aes(y = NumberOfDeaths), color = "#beaed4", size = 1) + 
  geom_line(aes(y = median_5y), colour = "firebrick") + 
  geom_ribbon(aes(ymin = mz_lpi, ymax = mz_upi), alpha = 0.1) + 
  geom_line(aes(y = mz_fit)) +
  scale_y_continuous(labels = comma) +
  scale_x_date(date_breaks = "2 months", date_labels = "%b") +
  xlab("") + ylab("Observed, 5y median & predicted deaths") +
  theme_minimal()
```

## Monthly data

```{r}
summary(mz_monthly <- glm(deaths_month ~ Month + 
                            si_one + si_two + co_one + co_two, 
                          family = "poisson", data = reg_deaths_monthly))

pred_deaths_monthly %<>%
  add_pi(mz_monthly, 
         names = c("mz_lpi", "mz_upi"), 
         yhatName = "mz_fit", 
         nSims = 20000) %>% 
  as_tibble()
```

```{r echo=FALSE}
pred_deaths_monthly %>% 
  ggplot(aes(x = Date)) +
  geom_ribbon(aes(ymin = mz_lpi, ymax = mz_upi), alpha = 0.1) + 
  geom_line(aes(y = mz_fit)) +
  geom_line(aes(y = median_5y), colour = "firebrick") + 
  geom_line(aes(y = deaths_month), color = "#beaed4", size = 1) + 
  scale_y_continuous(labels = comma) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") + ylab("Observed, 5y median & predicted deaths") +
  theme_minimal()
```

```{r echo=FALSE}
pred_deaths_monthly %>% 
  filter(Year >= year) %>% 
  ggplot(aes(x = Date)) +
  geom_ribbon(aes(ymin = mz_lpi, ymax = mz_upi), alpha = 0.1) + 
  geom_line(aes(y = mz_fit)) +
  geom_line(aes(y = median_5y), colour = "firebrick") + 
  geom_line(aes(y = deaths_month), color = "#beaed4", size = 1) + 
  scale_y_continuous(labels = comma) +
  scale_x_date(date_breaks = "2 months", date_labels = "%b") +
  xlab("") + ylab("Observed, 5y median & predicted deaths") +
  theme_minimal()
```

<!-- ----------------------------------------------------- -->

# Comparing excess deaths totals

BfS estimates:

```{r}
excess_deaths %>% 
  filter(Year == year)
```

Estimated from weekly data:

```{r}
pred_deaths_weekly %>% 
  filter(Year == year) %>% 
  summarise(NumberOfDeaths = sum(NumberOfDeaths), 
            deaths_pred_weekly = sum(mz_fit),
            Excess = round(NumberOfDeaths - deaths_pred_weekly))
```

Estimated from monthly data:

```{r}
pred_deaths_monthly %>% 
  filter(Year == year) %>% 
  summarise(NumberOfDeaths = sum(deaths_month), 
            deaths_pred_monthly = sum(mz_fit),
            Excess = round(NumberOfDeaths - deaths_pred_monthly))
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`



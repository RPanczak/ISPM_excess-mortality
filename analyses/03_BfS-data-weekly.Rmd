---
title: "Excess mortality: weekly BAG data"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

options(scipen=999)
set.seed(12345)

library(pacman)
p_load(tidyverse, readxl, scales, janitor, kableExtra)

options(max.print = "75")
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# BfS - "Mortality, causes of death" chapter

[Overview of data](https://www.bfs.admin.ch/bfs/en/home/statistics/health/state-health/mortality-causes-death.html)

## Weekly number of deaths, 2010-2019

```{r eval=FALSE}
# download.file(url = "https://www.bfs.admin.ch/bfsstatic/dam/assets/12607335/master",
#               destfile = "data-raw/BfS/ts-e-14.03.04.03-wr_ZR.csv",
#               method = "curl")

weekly_2010_2019 <- read_delim("data-raw/BfS/ts-e-14.03.04.03-wr_ZR.csv", ";",
                               escape_double = FALSE, 
                               col_types = cols(CY = col_integer(), 
                                                Week = col_integer(), 
                                                Ending = col_date(format = "%d.%m.%Y"), 
                                                NumberOfDeaths = col_integer(), 
                                                Expected = col_integer(), 
                                                lowerB = col_integer(), 
                                                upperB = col_integer(), 
                                                Excess = col_integer()), 
                               trim_ws = TRUE) %>% 
  rename(Year = CY) %>% 
  filter(!is.na(Year))

write_rds(weekly_2010_2019, "data/BfS/bfs_web_deaths_weekly_2010-2019.Rds")
haven::write_dta(weekly_2010_2019, "data/BfS/bfs_web_deaths_weekly_2010-2019.dta")
```

```{r include=FALSE}
weekly_2010_2019 <- read_rds("data/BfS/bfs_web_deaths_weekly_2010-2019.Rds") 
```

Last five years

```{r echo=FALSE}
weekly_2010_2019 %>% 
  filter(Year >= 2015) %>% 
  ggplot(aes(x = Ending)) +
  # geom_vline(aes(xintercept = as.Date("2020-02-24"))) +
  geom_ribbon(aes(ymin = lowerB, ymax = upperB, fill = Age), alpha = 0.1) +
  geom_line(aes(y = Expected, group = Age), colour = "gray60") + 
  geom_line(aes(y = NumberOfDeaths, colour = Age)) + 
  theme_minimal()
```

## Weekly number of deaths, 2020-2021

```{r eval=FALSE}
download.file(url = "https://www.bfs.admin.ch/bfsstatic/dam/assets/17544965/master",
              destfile = "data-raw/BfS/ts-e-14.03.04.03-wr.csv",
              method = "curl")

weekly_2020_2021 <- read_delim("data-raw/BfS/ts-e-14.03.04.03-wr.csv", 
                               ";", escape_double = FALSE, 
                               col_types = cols(Year = col_integer(), 
                                                Week = col_integer(), 
                                                Ending = col_date(format = "%d.%m.%Y"), 
                                                NoDeaths_EP = col_double(), 
                                                Expected = col_double(), 
                                                LowerB = col_double(), 
                                                UpperB = col_double(), 
                                                Diff = col_double()), 
                               trim_ws = TRUE, na = c(".")) %>% 
  rename(NumberOfDeaths = NoDeaths_EP,
         lowerB = LowerB, upperB = UpperB,
         Excess = Diff) %>% 
  filter(!is.na(Year))

write_rds(weekly_2020_2021, "data/BfS/bfs_web_deaths_weekly_2020-2021.Rds")
haven::write_dta(weekly_2020_2021, "data/BfS/bfs_web_deaths_weekly_2020-2021.dta")
```

```{r include=FALSE}
weekly_2020_2021 <- read_rds("data/BfS/bfs_web_deaths_weekly_2020-2021.Rds")
```

```{r echo=FALSE}
weekly_2020_2021 %>% 
  filter(Ending < Sys.Date()) %>% 
  ggplot(aes(x = Ending)) +
  # geom_vline(aes(xintercept = as.Date("2020-02-24"))) +
  geom_ribbon(aes(ymin = lowerB, ymax = upperB, fill = Age), alpha = 0.1) +
  geom_line(aes(y = Expected, group = Age), colour = "gray60") + 
  geom_line(aes(y = NumberOfDeaths, colour = Age)) + 
  theme_minimal()
```

```{r eval=FALSE}
# projected goes on; with a funny dip at the end?
weekly_2020_2021 %>% 
  filter(Ending >= as.Date("2020-11-01")) %>% 
  ggplot(aes(x = Ending)) +
  # geom_vline(aes(xintercept = as.Date("2020-02-24"))) +
  geom_ribbon(aes(ymin = lowerB, ymax = upperB, fill = Age), alpha = 0.1) +
  geom_line(aes(y = Expected, group = Age), colour = "gray60") + 
  geom_line(aes(y = NumberOfDeaths, colour = Age)) + 
  theme_minimal()
```

## Yearly totals of excess deaths

```{r}
excess_2010_2020 <- weekly_2010_2019 %>% 
  bind_rows(weekly_2020_2021 %>% filter(Ending <= as.Date("2020-12-31"))) %>% 
  mutate(Excess_expected = NumberOfDeaths - Expected) %>% 
  # mutate(Excess_upperB = NumberOfDeaths - upperB) %>% 
  # group_by(Year, Age) %>% 
  group_by(Year) %>% 
  summarise(Excess_expected = sum(Excess_expected)) %>% 
  # summarise(Excess_upperB = sum(Excess_upperB)) %>% 
  ungroup()
```

```{r echo=FALSE}
write_rds(excess_2010_2020, "data/BfS/excess_2010_2020.Rds")
haven::write_dta(excess_2010_2020, "data/BfS/excess_2010_2020.dta")

ggplot(excess_2010_2020) + 
  geom_col(aes(x = factor(Year), y = Excess_expected)) + 
  theme_minimal() + xlab("") + ylab("Excess deaths")
```


# BfS - "Population" chapter

2019
canton
https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/tables.assetdetail.17004426.html
gr
https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/tables.assetdetail.17004450.html

Docs in `ts-q-01.04.02.01.30-APPENDIX.xlsx`

2020 
canon
https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/tables.assetdetail.15464210.html
gr
https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/tables.assetdetail.15464206.html

Docs in `ts-q-01.04.02.01.30-2020-APPENDIX.xlsx`

2021
canton
https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/tables.assetdetail.13187299.html
gr
https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/tables.assetdetail.13187304.html

Docs in `ts-q-01.04.02.01.30-2021-APPENDIX.xlsx`

## Deaths per week by 5-year age group, sex and canton

```{r eval=FALSE}
download.file(url = "https://www.bfs.admin.ch/bfsstatic/dam/assets/13187299/master",
              destfile = "data-raw/BfS/weekly_canton_age5_2000-2019.csv", 
              method = "curl")

download.file(url = "https://www.bfs.admin.ch/bfsstatic/dam/assets/15464210/master",
              destfile = "data-raw/BfS/weekly_canton_age5_2020.csv", 
              method = "curl")

download.file(url = "https://www.bfs.admin.ch/bfsstatic/dam/assets/17004426/master",
              destfile = "data-raw/BfS/weekly_canton_age5_2021.csv", 
              method = "curl")
```

```{r}
weekly_canton_age5_2000_2019 <- read_delim("data-raw/BfS/weekly_canton_age5_2000-2019.csv", ";", escape_double = FALSE, col_types = cols(OBS_VALUE = col_integer()), trim_ws = TRUE)

weekly_canton_age5_2020 <- read_delim("data-raw/BfS/weekly_canton_age5_2020.csv", ";", escape_double = FALSE, col_types = cols(OBS_VALUE = col_integer()), trim_ws = TRUE)

weekly_canton_age5_2021 <- read_delim("data-raw/BfS/weekly_canton_age5_2021.csv", ";", escape_double = FALSE, col_types = cols(OBS_VALUE = col_integer()), trim_ws = TRUE)
```

<!-- ----------------------------------------------------- -->

# BfS - MOMO

BfS [Mortality monitoring (MOMO)](https://www.experimental.bfs.admin.ch/expstat/en/home/innovative-methods/momo.html) 

## Deaths in NUTS2-regions, age group 0 - 64 years, 2020-2021

```{r eval=FALSE}
download.file(url = "https://www.experimental.bfs.admin.ch/bfsstatic/dam/assets/16584743/master",
              destfile = "data-raw/BfS/momo_nuts_0-64_2020-2021.csv", 
              method = "curl")
```

## Deaths in NUTS2-regions, age group 65 years and older, 2020-2021

```{r eval=FALSE}
download.file(url = "https://www.experimental.bfs.admin.ch/bfsstatic/dam/assets/16584737/master",
              destfile = "data-raw/BfS/momo_nuts_65_2020-2021.csv", 
              method = "curl")
```

## Weekly deaths 2020-2021 for 26 cantons and 2 age groups

```{r eval=FALSE}
download.file(url = "https://www.experimental.bfs.admin.ch/bfsstatic/dam/assets/16584735/master",
              destfile = "data-raw/BfS/momo_canton_age-bin_2020-2021.csv", 
              method = "curl")
```

<!-- ----------------------------------------------------- -->

# Pops 

[Permanent resident population by age, category of citizenship and sex, 1999-2019](https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/tables.assetdetail.14367976.html) (*it actually should say 2010-2019*!)

```{r}
p_2019 <- read_excel("data-raw/BfS/je-e-01.02.03.03.xlsx", 
                     sheet = "2019", skip = 3) %>% 
  remove_empty() %>% 
  clean_names() %>% 
  filter(!is.na(x2)) %>% 
  select(x1:x80) %>% 
  rename(sex = x1,
         total = x2) %>% 
  filter(sex %in% c("Female", "Male")) %>% 
  group_by(sex) %>% 
  summarise_all(list(sum)) %>% 
  ungroup() %>% 
  pivot_longer(-sex, names_to = "age_group", values_to = "population") %>% 
  filter(age_group != "total") %>% 
  mutate(age_bin = case_when(
    age_group == "x0_19" ~ "0-64",
    age_group == "x20_39" ~ "0-64",
    age_group == "x40_64" ~ "0-64",
    TRUE ~ "65+")) %>% 
  group_by(sex, age_bin) %>% 
  summarise(population = sum(population)) %>% 
  ungroup() %>% 
  mutate(year = 2019) %>% 
  relocate(year)
```

<!-- ----------------------------------------------------- -->

# Comparing to STMF

Until April, all seems to be fine:

```{r}
bfs_stmf <- left_join(
  
  weekly_2020_2021 %>% 
    filter(Ending <= as.Date("2021-05-23")) %>% 
    group_by(Year, Week) %>%
    summarise(NumberOfDeaths = sum(NumberOfDeaths)) %>% 
    ungroup(),
  
  read_rds("data/mortality_org/stmf.Rds") %>% 
    filter(CountryCode == "CHE")
  
) %>% 
  mutate(diff = NumberOfDeaths - Deaths)

ggplot(bfs_stmf, aes(x = Week_start, y = diff)) + 
  geom_hline(yintercept = 0, color = "darkorchid") +
  geom_vline(xintercept = as.Date("2021-04-01"), color = "orange") +
  geom_line() + 
  theme_bw() +
  xlab("") + ylab("Weekly difference in number of deaths") 

ggplot(bfs_stmf, aes(x = Week_start, y = diff / NumberOfDeaths)) + 
  geom_hline(yintercept = 0, color = "darkorchid") +
  geom_vline(xintercept = as.Date("2021-04-01"), color = "orange") +
  geom_line() + 
  theme_bw() +
  xlab("") + ylab("Weekly difference in number of deaths") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`
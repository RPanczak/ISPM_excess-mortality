---
title: "Excess mortality"
subtitle: "Weekly BfS data"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, readxl, scales, janitor, kableExtra)
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# BfS 

*Mortality, causes of death* chapter. [Overview of data](https://www.bfs.admin.ch/bfs/en/home/statistics/health/state-health/mortality-causes-death.html).  

## Weekly number of deaths, 2010-2019

```{r eval=FALSE}
# download.file(url = "https://www.bfs.admin.ch/bfsstatic/dam/assets/12607335/master",
#               destfile = "data-raw/BfS/ts-e-14.03.04.03-wr_ZR.csv",
#               method = "curl")

week_2010_2019 <- read_delim("data-raw/BfS/ts-e-14.03.04.03-wr_ZR.csv", ";",
                             escape_double = FALSE, 
                             col_types = cols(CY = col_integer(), 
                                              Week = col_integer(), 
                                              Ending = col_date(format = "%d.%m.%Y"), 
                                              NumberOfDeaths = col_integer(), 
                                              Expected = col_integer(), 
                                              lowerB = col_integer(), 
                                              upperB = col_integer(), 
                                              Excess = col_integer()), 
                             trim_ws = TRUE) %>% 
  rename(Year = CY) %>% 
  filter(!is.na(Year))

write_rds(week_2010_2019, "data/BfS/deaths_week_2010-2019.Rds")
```

```{r include=FALSE}
week_2010_2019 <- read_rds("data/BfS/deaths_week_2010-2019.Rds") 
```

Last five years with two age groups

```{r echo=FALSE}
week_2010_2019 %>% 
  filter(Year >= 2015) %>% 
  ggplot(aes(x = Ending)) +
  # geom_vline(aes(xintercept = as.Date("2020-02-24"))) +
  geom_ribbon(aes(ymin = lowerB, ymax = upperB, fill = Age), alpha = 0.1) +
  geom_line(aes(y = Expected, group = Age), colour = "gray60") + 
  geom_line(aes(y = NumberOfDeaths, colour = Age)) + 
  theme_minimal()
```

## Weekly number of deaths, 2020-2021

```{r eval=FALSE}
download.file(url = "https://www.bfs.admin.ch/bfsstatic/dam/assets/17824496/master",
              destfile = "data-raw/BfS/ts-e-14.03.04.03-wr.csv",
              method = "curl")

zip(zipfile = "data-raw/BfS/ts-e-14.03.04.03-wr.zip", 
    files = "data-raw/BfS/ts-e-14.03.04.03-wr.csv")

file.remove("data-raw/BfS/ts-e-14.03.04.03-wr.csv")

week_2020_2021 <- read_delim("data-raw/BfS/ts-e-14.03.04.03-wr.zip", 
                             ";", escape_double = FALSE, 
                             col_types = cols(Year = col_integer(), 
                                              Week = col_integer(), 
                                              Ending = col_date(format = "%d.%m.%Y"), 
                                              NoDeaths_EP = col_double(), 
                                              Expected = col_double(), 
                                              LowerB = col_double(), 
                                              UpperB = col_double(), 
                                              Diff = col_double()), 
                             trim_ws = TRUE, na = c(".")) %>% 
  rename(NumberOfDeaths = NoDeaths_EP,
         lowerB = LowerB, upperB = UpperB,
         Excess = Diff) %>% 
  filter(!is.na(Year))

write_rds(week_2020_2021, "data/BfS/deaths_week_2020-2021.Rds")
```

```{r include=FALSE}
week_2020_2021 <- read_rds("data/BfS/deaths_week_2020-2021.Rds")
```

```{r echo=FALSE}
week_2020_2021 %>% 
  filter(Ending < Sys.Date()) %>% 
  ggplot(aes(x = Ending)) +
  # geom_vline(aes(xintercept = as.Date("2020-02-24"))) +
  geom_ribbon(aes(ymin = lowerB, ymax = upperB, fill = Age), alpha = 0.1) +
  geom_line(aes(y = Expected, group = Age), colour = "gray60") + 
  geom_line(aes(y = NumberOfDeaths, colour = Age)) + 
  theme_minimal()
```

```{r echo=FALSE,eval=FALSE}
# projected goes on; with a funny dip at the end?
week_2020_2021 %>% 
  filter(Ending >= as.Date("2020-11-01")) %>% 
  ggplot(aes(x = Ending)) +
  # geom_vline(aes(xintercept = as.Date("2020-02-24"))) +
  geom_ribbon(aes(ymin = lowerB, ymax = upperB, fill = Age), alpha = 0.1) +
  geom_line(aes(y = Expected, group = Age), colour = "gray60") + 
  geom_line(aes(y = NumberOfDeaths, colour = Age)) + 
  theme_minimal()
```

## Yearly totals of excess deaths

```{r}
excess_2010_2020 <- week_2010_2019 %>% 
  bind_rows(week_2020_2021 %>% filter(Ending <= as.Date("2020-12-31"))) %>% 
  mutate(Excess_expected = NumberOfDeaths - Expected) %>% 
  # mutate(Excess_upperB = NumberOfDeaths - upperB) %>% 
  # group_by(Year, Age) %>% 
  group_by(Year) %>% 
  summarise(Excess_expected = sum(Excess_expected)) %>% 
  # summarise(Excess_upperB = sum(Excess_upperB)) %>% 
  ungroup()
```

```{r echo=FALSE}
write_rds(excess_2010_2020, "data/BfS/excess_2010_2020.Rds")

ggplot(excess_2010_2020) + 
  geom_col(aes(x = factor(Year), y = Excess_expected)) + 
  theme_minimal() + xlab("") + ylab("Excess deaths")
```

<!-- ----------------------------------------------------- -->

# Comparing BfS to STMF {.tabset}

Data from 2020 onwards, weekly resolution.  

```{r}
bfs_stmf <- left_join(
  
  week_2020_2021 %>% 
    filter(Ending <= as.Date("2021-05-23")) %>% 
    group_by(Year, Week) %>%
    summarise(NumberOfDeaths = sum(NumberOfDeaths)) %>% 
    ungroup(),
  
  read_rds("data/mortality_org/stmf_week.Rds") %>% 
    filter(Country == "Switzerland")
  
) %>% 
  mutate(diff = NumberOfDeaths - Deaths)
```

Until May, all seems to be OKish, except some end of the year correction (?):

## Absolute 

```{r}
ggplot(bfs_stmf, aes(x = Week_start, y = diff)) + 
  geom_hline(yintercept = 0, color = "darkorchid") +
  geom_vline(xintercept = as.Date("2021-05-01"), color = "orange") +
  geom_line() + 
  theme_bw() +
  xlab("") + ylab("Weekly absolute difference in number of deaths")
```

# Percentages 

```{r}
ggplot(bfs_stmf, aes(x = Week_start, y = diff / NumberOfDeaths)) + 
  geom_hline(yintercept = 0, color = "darkorchid") +
  geom_vline(xintercept = as.Date("2021-05-01"), color = "orange") +
  geom_line() + 
  theme_bw() +
  xlab("") + ylab("Weekly % difference in number of deaths") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`
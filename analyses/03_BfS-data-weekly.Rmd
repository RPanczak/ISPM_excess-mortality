---
title: "Excess mortality: weekly BAG data"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

options(scipen=999)
set.seed(12345)

library(pacman)
p_load(tidyverse, scales, janitor, kableExtra)

options(max.print = "75")
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Weekly data

[Overview of data](https://www.bfs.admin.ch/bfs/en/home/statistics/health/state-health/mortality-causes-death.html)

## Weekly number of deaths, 2010-2019

```{r eval=FALSE}
download.file(url = 'https://www.bfs.admin.ch/bfsstatic/dam/assets/12607335/master',
              destfile = 'data-raw/BfS/weekly_CH_2010-2019.csv',
              method = 'curl')

weekly_2010_2019 <- read_delim("data-raw/BfS/weekly_CH_2010-2019.csv", ";", escape_double = FALSE, 
                               col_types = cols(CY = col_integer(), 
                                                Week = col_integer(), 
                                                Ending = col_date(format = "%d.%m.%Y"), 
                                                NumberOfDeaths = col_integer(), 
                                                Expected = col_integer(), 
                                                lowerB = col_integer(), upperB = col_integer(), 
                                                Excess = col_integer()), 
                               trim_ws = TRUE) %>% 
  rename(Year = CY) %>% 
  filter(!is.na(Year))

write_rds(weekly_2010_2019, "data/BfS/weekly_CH_2010-2019.Rds")
```

```{r include=FALSE}
weekly_2010_2019 <- read_rds("data/BfS/weekly_CH_2010-2019.Rds") 
```

Last five years

```{r echo=FALSE}
weekly_2010_2019 %>% 
  filter(Year >= 2015) %>% 
  ggplot(aes(x = Ending)) +
  # geom_vline(aes(xintercept = as.Date("2020-02-24"))) +
  geom_ribbon(aes(ymin = lowerB, ymax = upperB, fill = Age), alpha = 0.1) +
  geom_line(aes(y = Expected, group = Age), colour = "gray60") + 
  geom_line(aes(y = NumberOfDeaths, colour = Age)) + 
  theme_minimal()
```

## Weekly number of deaths, 2020-2021

```{r eval=FALSE}
download.file(url = 'https://www.bfs.admin.ch/bfsstatic/dam/assets/16584731/master',
              destfile = 'data-raw/BfS/weekly_CH_2020-2021.csv',
              method = 'curl')

weekly_2020_2021 <- read_delim("data-raw/BfS/weekly_CH_2020-2021.csv", 
                               ";", escape_double = FALSE, 
                               col_types = cols(Year = col_integer(), 
                                                Week = col_integer(), 
                                                Ending = col_date(format = "%d.%m.%Y"), 
                                                NoDeaths_EP = col_integer(), 
                                                Expected = col_integer(), 
                                                LowerB = col_integer(), UpperB = col_integer(), 
                                                Diff = col_integer()), 
                               trim_ws = TRUE) %>% 
  rename(NumberOfDeaths = NoDeaths_EP,
         lowerB = LowerB, upperB = UpperB,
         Excess = Diff) %>% 
  filter(!is.na(Year))

write_rds(weekly_2020_2021, "data/BfS/weekly_CH_2020-2021.Rds")
```

```{r include=FALSE}
weekly_2020_2021 <- read_rds("data/BfS/weekly_CH_2020-2021.Rds")
```

```{r echo=FALSE}
weekly_2020_2021 %>% 
  filter(Ending < Sys.Date()) %>% 
  ggplot(aes(x = Ending)) +
  # geom_vline(aes(xintercept = as.Date("2020-02-24"))) +
  geom_ribbon(aes(ymin = lowerB, ymax = upperB, fill = Age), alpha = 0.1) +
  geom_line(aes(y = Expected, group = Age), colour = "gray60") + 
  geom_line(aes(y = NumberOfDeaths, colour = Age)) + 
  theme_minimal()
```

## Deaths per week by 5-year age group, sex and canton

```{r eval=FALSE}
download.file(url = "https://www.bfs.admin.ch/bfsstatic/dam/assets/16584733/master",
              destfile = "data-raw/BfS/weekly_canton_age5_2020-2021.csv", 
              method = "curl")
```

Docs in `ts-q-01.04.02.01.30-2020-2021-APPENDIX.xlsx` 

```{r}
weekly_canton_age5_2020_2021 <- read_delim("data-raw/BfS/weekly_canton_age5_2020-2021.csv", ";", escape_double = FALSE, col_types = cols(OBS_VALUE = col_integer()), trim_ws = TRUE)
```

## Deaths per week by 5-year age group, sex and major region

```{r eval=FALSE}
download.file(url = "https://www.bfs.admin.ch/bfsstatic/dam/assets/16584751/master",
              destfile = "data-raw/BfS/weekly_gros_age5_2020-2021.csv", 
              method = "curl")
```

Docs in `ts-q-01.04.02.01.31-2020-2021-APPENDIX.xlsx`

```{r}
weekly_gros_age5_2020_2021 <- read_delim("data-raw/BfS/weekly_gros_age5_2020-2021.csv", ";", escape_double = FALSE, col_types = cols(OBS_VALUE = col_integer()), trim_ws = TRUE)
```

<!-- ----------------------------------------------------- -->

# MOMO

BfS [Mortality monitoring (MOMO)](https://www.experimental.bfs.admin.ch/expstat/en/home/innovative-methods/momo.html) 

## Deaths in NUTS2-regions, age group 0 - 64 years, 2020-2021

```{r eval=FALSE}
download.file(url = "https://www.experimental.bfs.admin.ch/bfsstatic/dam/assets/16584743/master",
              destfile = "data-raw/BfS/momo_nuts_0-64_2020-2021.csv", 
              method = "curl")
```

## Deaths in NUTS2-regions, age group 65 years and older, 2020-2021

```{r eval=FALSE}
download.file(url = "https://www.experimental.bfs.admin.ch/bfsstatic/dam/assets/16584737/master",
              destfile = "data-raw/BfS/momo_nuts_65_2020-2021.csv", 
              method = "curl")
```

## Weekly deaths 2020-2021 for 26 cantons and 2 age groups

```{r eval=FALSE}
download.file(url = "https://www.experimental.bfs.admin.ch/bfsstatic/dam/assets/16584735/master",
              destfile = "data-raw/BfS/momo_canton_age-bin_2020-2021.csv", 
              method = "curl")
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`
---
title: "Excess mortality joint modelling"
subtitle: "Example of 2020"
author: "Julien Riou & Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

# install.packages(c(“StanHeaders”, “rstan”), type = “source”)

library(pacman)
p_load(tidyverse, 
       lubridate, 
       scales, 
       magrittr, 
       doParallel, 
       foreach, 
       rstan)

# file.sources = list.files(path="../R/",pattern="fn_",full.names = TRUE)
file.sources = list.files(path="R",pattern="fn_",full.names = TRUE)
sapply(file.sources, source, .GlobalEnv)

set.seed(12345)
options(scipen = 999)
theme_set(theme_minimal())
registerDoParallel(cores = parallel::detectCores())
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

```{r knit-setup, include = FALSE}
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)
mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Data 

## Population data 

```{r}
ch_pop_year <- read_rds("data/BfS/bfs_pop_year.Rds") %>% 
  filter((Year >= 2015 & Year <= 2020)) %>% 
  mutate(Population = round((pop_jan + pop_dec) / 2)) %>% 
  select(-pop_jan, -pop_dec) %>%
  mutate(Population=round(Population)) %>% 
  bind_rows(
    
    read_rds("data/BfS/bfs_pop_2020.Rds") %>% 
      select(Year, Total) %>% 
      summarise(Year = first(Year),
                Population = sum(Total))
  )

ch_pop_age_sex <- read_rds("data/mortality_org/hmd_ch_pop_age_sex.Rds") %>% 
  filter((Year >= 2015 & Year <= 2019)) %>% 
  dplyr::select(-Country,-Total) %>%
  pivot_longer(cols=c("Female","Male"), names_to = "Sex") %>%
  mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                       include.lowest = TRUE,
                       right=FALSE,
                       labels=c("0-9","10-19","20-29","30-39","40-49",
                                "50-59","60-69","70-79","80-89","90+"))) %>%
  group_by(Year, Sex, Age_cat) %>%
  summarise(Population=sum(value)) %>%
  dplyr::mutate(Age_cat=factor(Age_cat)) %>%
  ungroup()  %>%
  mutate(Population=round(Population)) %>% 
  bind_rows(
    
    read_rds("data/BfS/bfs_pop_2020.Rds") %>%
      pivot_longer(cols=c("Female","Male"), names_to = "Sex") %>%
      mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                           include.lowest = TRUE,
                           right=FALSE,
                           labels=c("0-9","10-19","20-29","30-39","40-49",
                                    "50-59","60-69","70-79","80-89","90+"))) %>%
      group_by(Year, Sex, Age_cat) %>%
      summarise(Population=sum(value)) %>%
      dplyr::mutate(Age_cat=factor(Age_cat)) %>%
      ungroup()  %>%
      mutate(Population=round(Population))
    
  )
```


## Monthly deaths

Counts of total deaths per month over the period 2015-2020. 

```{r}
deaths_monthly <- 
  read_rds("data/BfS/bfs_deaths_month.Rds") %>% 
  filter((Year >= 2015 & Year <= 2020))

deaths_monthly %<>% 
  left_join(ch_pop_year) 

rm(ch_pop_year)

ggplot(deaths_monthly) +
  geom_line(aes(x=Date,y=Deaths/Population*1000), colour="darkgrey") +
  geom_point(aes(x=Date,y=Deaths/Population*1000), colour="darkgrey", fill="white", shape=21, size=1.8) +
  labs(x="Time", y="Deaths per 1,000 population")
```

## Yearly deaths by sex and age group

Counts of deaths by sex and age group are only available yearly, not monthly.
We consider 10-year age bands, and group together ages 90 and older.

```{r}
deaths_yearly_age_sex <- read_rds("data/mortality_org/hmd_deaths_age_sex.Rds") %>% 
  filter(Country == "Switzerland") %>% 
  filter((Year >= 2015 & Year <= 2018)) %>% 
  bind_rows(
    read_rds("data/BfS/bfs_deaths_age_sex.Rds")
  )

deaths_yearly_age_sex %<>%
  pivot_longer(c("Female", "Male"), names_to = "Sex") %>%
  mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                       include.lowest = TRUE,
                       right=FALSE,
                       labels=c("0-9","10-19","20-29","30-39","40-49",
                                "50-59","60-69","70-79","80-89","90+"))) %>%
  group_by(Year, Sex, Age_cat) %>%
  summarise(Deaths = sum(value)) %>%
  ungroup() %>%
  left_join(ch_pop_age_sex)

rm(ch_pop_age_sex)

ggplot(deaths_yearly_age_sex) +
  geom_line(aes(x=Year,y=Deaths/Population*1000,colour=Age_cat)) +
  geom_point(aes(x=Year,y=Deaths/Population*1000,colour=Age_cat), fill="white", shape=21, size=1.8) +
  labs(x="Time", y="Deaths per 1,000 population") +
  facet_wrap(~Sex,ncol=1) +
  scale_color_brewer(palette = "RdYlBu", direction = -1) +
  scale_y_log10()
```

<!-- ----------------------------------------------------- -->

# Total monthly deaths

Estimating expected for 2020, using data from 2015-2019.

```{r}
expected_2020 = fn_global_serfling(2020, deaths_monthly)

fn_plot_global_serfling(expected_2020, title="Expected deaths for 2020", ylim=c(0,10000))
```


# Total monthly deaths, Stan version

```{r}
expected_2020_stan = fn_global_serfling_stan(2020, deaths_monthly)

fn_plot_global_serfling(expected_2020, title="Expected deaths for 2020", ylim=c(0,10000))

fn_plot_global_serfling(expected_2020_stan, title="Expected deaths for 2020 (stan)", ylim=c(0,10000))
```


# Total monthly deaths, Stan and negative binomial version

```{r}
expected_2020_nb_stan = fn_global_serfling_nb_stan(2020, deaths_monthly)

fn_plot_global_serfling(expected_2020, title="Expected deaths for 2020", ylim=c(0,10000))

fn_plot_global_serfling(expected_2020_nb_stan, title="Expected deaths for 2020 (nb, stan)", ylim=c(0,10000))
```

# Total monthly deaths by age group

```{r}
expected_2020_age_nb_stan = fn_age_serfling_nb_stan(2020, deaths_monthly, deaths_yearly_age_sex)

fn_plot_global_serfling(expected_2020_nb_stan, title="Expected deaths for 2020 (nb, stan)", ylim=c(0,10000))

fn_plot_global_serfling(expected_2020_age_nb_stan, title="Expected deaths for 2020 (nb, age, stan)", ylim=c(0,10000))
```

In addition to before, we can now examine expected deaths (and compute excess) by age group for a particular year.

```{r}
fn_plot_age_serfling(expected_2020_age_nb_stan, title="Expected deaths by age group for 2020", ylim=c(0,30000))
```


# Comparison of expected deaths from different solutions

## Monthly expected

```{r}
compare = bind_rows(
  bind_cols(1:12, 
            expected_2020$pred_total_deaths$Deaths, 
            rep("0 obs", 12)),
  bind_cols(1:12,
            expected_2020$pred_total_deaths$pred, 
            rep("1 serfling", 12)),
  bind_cols(1:12,
            expected_2020_stan$pred_total_deaths$pred, 
            rep("2 stan", 12)),
  bind_cols(1:12,
            expected_2020_nb_stan$pred_total_deaths$pred, 
            rep("3 nb_stan", 12)),
  bind_cols(1:12,
            expected_2020_age_nb_stan$pred_total_deaths$pred, 
            rep("4 age_nb_stan", 12))
) %>% 
  rename(Month = `...1`,
         Estimate = `...2`,
         Model = `...3`)

compare %>% 
  ggplot(aes(x = Month, y = Estimate, col = Model, group = Model)) +
  geom_line()

compare %>% 
  filter(Model != "0 obs") %>% 
  ggplot(aes(x = Month, y = Estimate, col = Model, group = Model)) +
  geom_line()
```


## Monthly comparison of excess from old approach

```{r}
classic = read_rds("data/ch_expected_deaths_monthly.Rds") %>% 
  filter(Year == 2020) %>% 
  mutate(excess_classic = Deaths - fit) %>% 
  select(Month, Deaths, excess_classic) %>% 
  bind_cols(age = expected_2020_age_nb_stan$pred_total_deaths$pred) %>% 
  mutate(excess_age = Deaths - age)

classic %>% 
  ggplot(aes(x = Month)) +
  geom_line(aes(x = Month, y = excess_classic), col = "black", size = 2, alpha = .5) +
  geom_line(aes(x = Month, y = excess_age), col = "red", size = .5) +
  ylab("Excess deaths")

classic %>% 
  ggplot(aes(x = Month)) +
  geom_col(aes(x = Month, y = excess_classic - excess_age)) +
  ylab("Excess deaths diff")

classic %>% 
  ggplot(aes(x = Month)) +
  geom_col(aes(x = Month, y = (excess_classic - excess_age) / excess_classic)) +
  ylab("Excess deaths % diff")

classic %>% 
  select(Month, starts_with("excess_"))
```


## Yearly total with precision

```{r}
compare_year = bind_rows(
  
  bind_cols("1 Observed", 
            NA_real_, sum(expected_2020$pred_total_deaths$Deaths), NA_real_),
  
  bind_cols("2 Classic", 
            NA_real_, sum(classic$excess_classic), NA_real_),
  
  bind_cols("3 stan", 
            expected_2020_stan$pred_total_deaths$excess_year_lower[1], 
            expected_2020_stan$pred_total_deaths$excess_year[1],
            expected_2020_stan$pred_total_deaths$excess_year_upper[1]),
  
  bind_cols("4 nb_stan", 
            expected_2020_nb_stan$pred_total_deaths$excess_year_lower[1], 
            expected_2020_nb_stan$pred_total_deaths$excess_year[1],
            expected_2020_nb_stan$pred_total_deaths$excess_year_upper[1]),
  
  bind_cols("5 age_nb_stan", 
            expected_2020_age_nb_stan$pred_total_deaths$excess_year_lower[1], 
            expected_2020_age_nb_stan$pred_total_deaths$excess_year[1],
            expected_2020_age_nb_stan$pred_total_deaths$excess_year_upper[1]),
  
) %>% 
  rename(Model = `...1`,
         LCI = `...2`,
         Estimate = `...3`,
         UCI = `...4`)

compare_year %>% 
  filter(Model != "1 Observed") %>% 
  ggplot(aes(x = Model, y = Estimate)) +
  geom_col() +
  geom_linerange(aes(ymin = LCI, ymax = UCI)) 

compare_year %>% 
  filter(Model != "1 Observed")
```
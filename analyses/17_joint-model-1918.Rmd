---
title: "Excess mortality joint modelling"
subtitle: "Example of 1918 & 1919"
author: "Julien Riou & Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

# install.packages(c(“StanHeaders”, “rstan”), type = “source”)

library(pacman)
p_load(tidyverse, 
       lubridate, 
       scales, 
       magrittr, 
       doParallel, 
       foreach, 
       rstan)

file.sources = list.files(path="../R",pattern="fn_",full.names = TRUE)
sapply(file.sources, source, .GlobalEnv)

set.seed(12345)
options(scipen = 999)
theme_set(theme_minimal())
registerDoParallel(cores = parallel::detectCores())
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

```{r knit-setup, include = FALSE}
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)
mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Data 

## Population data 

```{r}
bfs_pop_year <- read_rds("data/BfS/bfs_pop_year.Rds") %>% 
  filter((Year >= 1913 & Year <= 1919)) %>% 
  mutate(Population = round((pop_jan + pop_dec) / 2)) %>% 
  select(-pop_jan, -pop_dec) %>%
  mutate(Population=round(Population))

bfs_pop_year_age_sex <- read_rds("data/mortality_org/hmd_ch_pop_age_sex.Rds") %>% 
  filter((Year >= 1913 & Year <= 1919)) %>%
  dplyr::select(-Country,-Total) %>%
  pivot_longer(cols=c("Female","Male"), names_to = "Sex") %>%
  mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                       include.lowest = TRUE,
                       right=FALSE,
                       labels=c("0-9","10-19","20-29","30-39","40-49",
                                "50-59","60-69","70-79","80-89","90+"))) %>%
  group_by(Year, Sex, Age_cat) %>%
  summarise(Population=sum(value)) %>%
  dplyr::mutate(Age_cat=factor(Age_cat)) %>%
  ungroup()  %>%
  mutate(Population=round(Population))
```


## Monthly deaths

Counts of total deaths per month over the period 1913-1919. The population is averaged
over each year.

```{r}
deaths_monthly <- 
  read_rds("data/BfS/bfs_deaths_month.Rds") %>% 
  filter((Year >= 1913 & Year <= 1919))

deaths_monthly %<>% 
  left_join(bfs_pop_year) 

rm(bfs_pop_year)

ggplot(deaths_monthly) +
  geom_line(aes(x=Date,y=Deaths/Population*1000), colour="darkgrey") +
  geom_point(aes(x=Date,y=Deaths/Population*1000), colour="darkgrey", fill="white", shape=21, size=1.8) +
  labs(x="Time", y="Deaths per 1,000 population")
```

## Yearly deaths by sex and age group

Counts of deaths by sex and age group are only available yearly, not monthly.
We consider 10-year age bands, and group together ages 90 and older.

```{r}
deaths_yearly_age_sex <- read_rds("data/mortality_org/hmd_deaths_age_sex.Rds") %>% 
  filter(Country == "Switzerland") %>% 
  filter((Year >= 1913 & Year <= 1919))

deaths_yearly_age_sex %<>%
  pivot_longer(c("Female", "Male"), names_to = "Sex") %>%
  mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                       include.lowest = TRUE,
                       right=FALSE,
                       labels=c("0-9","10-19","20-29","30-39","40-49",
                                "50-59","60-69","70-79","80-89","90+"))) %>%
  group_by(Year, Sex, Age_cat) %>%
  summarise(Deaths = sum(value)) %>%
  ungroup() %>%
  left_join(bfs_pop_year_age_sex)

rm(bfs_pop_year_age_sex)

ggplot(deaths_yearly_age_sex) +
  geom_line(aes(x=Year,y=Deaths/Population*1000,colour=Age_cat)) +
  geom_point(aes(x=Year,y=Deaths/Population*1000,colour=Age_cat), fill="white", shape=21, size=1.8) +
  labs(x="Time", y="Deaths per 1,000 population") +
  facet_wrap(~Sex,ncol=1) +
  scale_y_log10()
```

## Yearly pops with age breakdown

```{r}
pop_yearly_age_sex <- read_rds("data/mortality_org/hmd_ch_pop_age_sex.Rds") %>% 
  filter((Year >= 1913 & Year <= 1919))

# # if pivot? or age cats? are needed
# pop_yearly_age_sex %<>% 
#   pivot_longer(c("Female", "Male"), names_to = "Sex") %>% 
#   mutate(Age_cat = cut(Age, seq(0, 110, 10), 
#                        include.lowest = TRUE)) %>% 
#   group_by(Year, Sex, Age_cat) %>% 
#   summarise(Population = sum(value)) %>% 
#   ungroup()
```

<!-- ----------------------------------------------------- -->

# Total monthly deaths

We first model total mortality per month. We use a Serfling model, a Poisson regression model with a periodic component. To estimate the expected mortality on each month of year $t$, we fit the model on the previous five years and compute monthly point estimates of counts of deaths together with 99% prediction intervals (see function `fn_boot_pi.R`).

## Expected total monthly deaths for 1918

We start with 1918, using data from 1913-1917.

```{r}
expected_1918 = fn_global_serfling(1918, deaths_monthly)

fn_plot_global_serfling(expected_1918, title="Expected deaths for 1918", ylim=c(0,12000))
```

## Expected total monthly deaths for 1919

Now for 1919, using data from 1914-1918.

```{r}
expected_1919 = fn_global_serfling(1919, deaths_monthly)

fn_plot_global_serfling(expected_1919, title="Expected deaths for 1919", ylim=c(0,12000))
```

## Expected total monthly deaths for 1919, ignoring 1918

We repeat the analysis for 1919, excluding the year 1918 because of exceptional mortality due to the flu pandemic.

```{r}
expected_1919_without_1918 = fn_global_serfling(1919, deaths_monthly, ignore_year = 1918)

fn_plot_global_serfling(expected_1919_without_1918, title="Expected deaths for 1919, ignoring 1918", ylim=c(0,12000))
```


# Total monthly deaths, Stan version

We replicate the previous analysis in Stan.

## Expected total monthly deaths for 1918

```{r}
expected_1918_stan = fn_global_serfling_stan(1918, deaths_monthly)

fn_plot_global_serfling(expected_1918, title="Expected deaths for 1918", ylim=c(0,12000))

fn_plot_global_serfling(expected_1918_stan, title="Expected deaths for 1918 (stan)", ylim=c(0,12000))
```

## Expected total monthly deaths for 1919

```{r}
expected_1919_stan = fn_global_serfling_stan(1919, deaths_monthly)

fn_plot_global_serfling(expected_1919, title="Expected deaths for 1919", ylim=c(0,12000))

fn_plot_global_serfling(expected_1919_stan, title="Expected deaths for 1919 (stan)", ylim=c(0,12000))
```

## Expected total monthly deaths for 1919, ignoring 1918

```{r}
expected_1919_without_1918_stan = fn_global_serfling_stan(1919, deaths_monthly, ignore_year = 1918)

fn_plot_global_serfling(expected_1919_without_1918, title="Expected deaths for 1919, ignoring 1918", ylim=c(0,12000))

fn_plot_global_serfling(expected_1919_without_1918_stan, title="Expected deaths for 1919, ignoring 1918 (stan)", ylim=c(0,12000))
```


# Total monthly deaths, Stan and negative binomial version

We observe too narrow prediction intervals with the Stan implementation. 
It's unclear to me why, I have an intuition that the bootstrap actually
accounts for overdispersion? 
A simple solution is to use a negative binomial likelihood instead of the Poisson in the Stan implementation.

## Expected total monthly deaths for 1918

```{r}
expected_1918_nb_stan = fn_global_serfling_nb_stan(1918, deaths_monthly)

fn_plot_global_serfling(expected_1918, title="Expected deaths for 1918", ylim=c(0,12000))

fn_plot_global_serfling(expected_1918_nb_stan, title="Expected deaths for 1918 (nb, stan)", ylim=c(0,12000))
```

## Expected total monthly deaths for 1919

```{r}
expected_1919_nb_stan = fn_global_serfling_nb_stan(1919, deaths_monthly)

fn_plot_global_serfling(expected_1919, title="Expected deaths for 1919", ylim=c(0,12000))

fn_plot_global_serfling(expected_1919_nb_stan, title="Expected deaths for 1919 (nb, stan)", ylim=c(0,12000))
```

## Expected total monthly deaths for 1919, ignoring 1918

```{r}
expected_1919_without_1918_nb_stan = fn_global_serfling_nb_stan(1919, deaths_monthly, ignore_year = 1918)

fn_plot_global_serfling(expected_1919_without_1918, title="Expected deaths for 1919, ignoring 1918 (stan)", ylim=c(0,12000))

fn_plot_global_serfling(expected_1919_without_1918_nb_stan, title="Expected deaths for 1919, ignoring 1918 (nb, stan)", ylim=c(0,12000))
```

Now the prediction intervals seem larger. I'm not sure why, I don't understand how the 
bootstrap really works in that context, maybe we can discuss?


# Total monthly deaths by age group

Anyway, now is the implementation by age group. In a first model, every age group has
a different intercept (alpha) for mortality, but then the evolution by year (linear trend) and by month (sinusoidals) is the same (so `beta_year` and `beta_periodic` are the same). 
We estimate the number of deaths in each age group for each year and each month (latent variable), then sum by month and year to fit to the total deaths per month (with a negative binomial) and sum by age group and year to fit to the yearly deaths by age group (with a multinomial).

## Expected total monthly deaths for 1918

```{r}
expected_1918_age_nb_stan = fn_age_serfling_nb_stan(1918, deaths_monthly, deaths_yearly_age_sex)

fn_plot_global_serfling(expected_1918_nb_stan, title="Expected deaths for 1918 (nb, stan)", ylim=c(0,12000))

fn_plot_global_serfling(expected_1918_age_nb_stan, title="Expected deaths for 1918 (nb, age, stan)", ylim=c(0,12000))
```

In addition to before, we can now examine expected deaths (and compute excess) by age group for a particular year.

```{r}
fn_plot_age_serfling(expected_1918_age_nb_stan, title="Expected deaths by age group for 1918", ylim=c(0,12000))
```

## Expected total monthly deaths for 1919

```{r}
expected_1919_age_nb_stan = fn_age_serfling_nb_stan(1919, deaths_monthly, deaths_yearly_age_sex)

fn_plot_global_serfling(expected_1919, title="Expected deaths for 1919", ylim=c(0,12000))

fn_plot_global_serfling(expected_1919_nb_stan, title="Expected deaths for 1919 (nb, stan)", ylim=c(0,12000))

# ylim should be 15000 to capture all
fn_plot_age_serfling(expected_1919_age_nb_stan, title="Expected deaths by age group for 1919 (nb, age, stan)", ylim=c(0,12000))
```

## Expected total monthly deaths for 1919, ignoring 1918

```{r}
expected_1919_without_1918_age_nb_stan = fn_age_serfling_nb_stan(1919, deaths_monthly, ignore_year = 1918, deaths_yearly_age_sex)

fn_plot_global_serfling(expected_1919_without_1918, title="Expected deaths for 1919, ignoring 1918 (nb, stan)", ylim=c(0,12000))

fn_plot_global_serfling(expected_1919_without_1918_age_nb_stan, title="Expected deaths for 1919, ignoring 1918 (nb, age, stan)", ylim=c(0,12000))

fn_plot_age_serfling(expected_1919_without_1918_age_nb_stan, title="Expected deaths by age group for 1918 (nb, age, stan)", ylim=c(0,12000))
```

This is where I stopped for now. We can discuss extensions, in particular:

* allow for the periodic component to shift, so that we don't force the maximum to be in March

* allow different yearly slopes by age group, or different seasonality by age group

* also stratify by sex

* other methods for seasonality, eg gaussian processes.


# Comparison of expected deaths from different solutions

## Monthly expected

```{r}
compare = bind_rows(
  bind_cols(1:12, 
            expected_1918$pred_total_deaths$Deaths, 
            rep("0 obs", 12)),
  bind_cols(1:12,
            expected_1918$pred_total_deaths$pred, 
            rep("1 serfling", 12)),
  bind_cols(1:12,
            expected_1918_stan$pred_total_deaths$pred, 
            rep("2 stan", 12)),
  bind_cols(1:12,
            expected_1918_nb_stan$pred_total_deaths$pred, 
            rep("3 nb_stan", 12)),
  bind_cols(1:12,
            expected_1918_age_nb_stan$pred_total_deaths$pred, 
            rep("4 age_nb_stan", 12))
) %>% 
  rename(Month = `...1`,
         Estimate = `...2`,
         Model = `...3`)

compare %>% 
  ggplot(aes(x = Month, y = Estimate, col = Model, group = Model)) +
  geom_line()

compare %>% 
  filter(Model != "0 obs") %>% 
  ggplot(aes(x = Month, y = Estimate, col = Model, group = Model)) +
  geom_line()
```


## Monthly comparison of excess from old approach

```{r}
classic = read_rds("data/ch_expected_deaths_monthly.Rds") %>% 
  filter(Year == 1918) %>% 
  mutate(excess_classic = Deaths - fit) %>% 
  select(Month, Deaths, excess_classic) %>% 
  bind_cols(age = expected_1918_age_nb_stan$pred_total_deaths$pred) %>% 
  mutate(excess_age = Deaths - age)

classic %>% 
  ggplot(aes(x = Month)) +
  geom_line(aes(x = Month, y = excess_classic), col = "black", size = 2, alpha = .5) +
  geom_line(aes(x = Month, y = excess_age), col = "red", size = .5) +
  ylab("Excess deaths")

classic %>% 
  ggplot(aes(x = Month)) +
  geom_col(aes(x = Month, y = excess_classic - excess_age)) +
  ylab("Excess deaths diff")

classic %>% 
  ggplot(aes(x = Month)) +
  geom_col(aes(x = Month, y = (excess_classic - excess_age) / excess_classic)) +
  ylab("Excess deaths % diff")

classic %>% 
select(Month, starts_with("excess_"))
```


## Yearly total with precision

```{r}
compare_year = bind_rows(
  
  bind_cols("1 Observed", 
            NA_real_, sum(expected_1918$pred_total_deaths$Deaths), NA_real_),
  
  bind_cols("2 Classic", 
            NA_real_, sum(classic$excess_classic), NA_real_),
  
  bind_cols("3 stan", 
            expected_1918_stan$pred_total_deaths$excess_year_lower[1], 
            expected_1918_stan$pred_total_deaths$excess_year[1],
            expected_1918_stan$pred_total_deaths$excess_year_upper[1]),
  
  bind_cols("4 nb_stan", 
            expected_1918_nb_stan$pred_total_deaths$excess_year_lower[1], 
            expected_1918_nb_stan$pred_total_deaths$excess_year[1],
            expected_1918_nb_stan$pred_total_deaths$excess_year_upper[1]),
  
  bind_cols("5 age_nb_stan", 
            expected_1918_age_nb_stan$pred_total_deaths$excess_year_lower[1], 
            expected_1918_age_nb_stan$pred_total_deaths$excess_year[1],
            expected_1918_age_nb_stan$pred_total_deaths$excess_year_upper[1]),
  
) %>% 
  rename(Model = `...1`,
         LCI = `...2`,
         Estimate = `...3`,
         UCI = `...4`)

compare_year %>% 
  filter(Model != "1 Observed") %>% 
  ggplot(aes(x = Model, y = Estimate)) +
  geom_col() +
  geom_linerange(aes(ymin = LCI, ymax = UCI)) 

compare_year %>% 
  filter(Model != "1 Observed")
```
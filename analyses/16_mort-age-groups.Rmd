---
title: "Excess mortality"
subtitle: "Changing age profile of deaths across pandemics"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, scales)
```

```{r knit-setup, include = FALSE}
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Data 

[The Human Mortality Database](https://www.mortality.org/) `1x1` data.  

**Covering period to 2019/2018 only!**  

Supplemented by country specific datasets for latest years.  

Grouping age to 5-year age bands.  

<!-- Grouping age to: `<1, 1-4, 5-19, 20-39, 40-59, 60-79, >=80`.   -->

```{r}
deaths_age_sex <- bind_rows(
  read_rds("data/mortality_org/hmd_deaths_age_sex.Rds"),
  
  read_rds("data/SCB/se_deaths_age_sex_2019.Rds") %>% 
    filter(Year == 2020),
  
  read_rds("data/INE/es_deaths_age_sex_2019.Rds"),
  
  read_rds("data/BfS/ch_deaths_age_sex_2019.Rds")
) %>% 
  select(-Female, -Male) %>% 
  mutate(Age = ifelse(Age == "110+", "111", Age),
         Age = as.numeric(Age), 
         # Age_group = cut(Age, 
         # breaks = c(0, 1, 5, 20, 40, 60, 80, 112),
         # # labels = c("<1", "1-4", "5-19", "20-39", "40-59", "60-79","80+"), 
         # right=FALSE), 
         Age_group = cut(Age, 
                         breaks = c(seq(0, 90, 5), 113), 
                         # labels = c("0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80+")), 
                         right=FALSE)
  ) %>%
  group_by(Country, Year, Age_group) %>% 
  summarise(Deaths = sum(Total)) %>% 
  ungroup() 
```

## Pandemics 

```{r}
pandemic_years <- c(1890, 1918, 1957, 2020)

analysis_years <- c(seq(1890 - 10, 1890),
                    seq(1918 - 10, 1918),
                    seq(1957 - 10, 1957),
                    seq(2020 - 10, 2020))

previous_years <- c(seq(1890 - 10, 1890 - 1),
                    seq(1918 - 10, 1918 - 1),
                    seq(1957 - 10, 1957 - 1),
                    seq(2020 - 10, 2020 - 1))

previous <- pandemic_years - 1
```

```{r echo=FALSE}
data <- 
  deaths_age_sex %>% 
  filter(Year %in% analysis_years) %>% 
  mutate(Type = ifelse(Year %in% previous_years, "Previous", "")) %>% 
  mutate(Type = ifelse(Year %in% pandemic_years, "Pandemic", Type)) %>%  
  arrange(Country, Year, Age_group) %>% 
  mutate(Pandemic = ifelse(Year %in% pandemic_years, Year, NA)) %>% 
  fill(Pandemic, .direction = "up")
```

<!-- ----------------------------------------------------- -->

# Vizualizations

## Pandemics compared to last 10 years

```{r echo=FALSE}
ggplot(data = data %>% filter(Type == "Previous"),
       aes(x = Age_group, y = Deaths)) + 
  # geom_boxplot(aes(colour = Age_group, weight = pop_scaled), varwidth = TRUE) +
  geom_boxplot(aes(colour = Age_group)) +
  geom_line(data = data %>% filter(Type == "Pandemic"), aes(group = Year)) +
  facet_grid(rows = vars(Country), cols = vars(Pandemic), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 0.1, suffix = "K", scale = 1e-4)) +
  scale_color_viridis_d() +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Age group") + labs(colour = "Age")

ggsave("paper/age_groups.png", dpi = 300, width = 297, height = 210, units = "mm")
```

```{r echo=FALSE}
ggplot(data = data %>% filter(Type == "Previous"),
       aes(x = Age_group, y = Deaths)) + 
  geom_line(aes(colour = Age_group, group = Year)) +
  geom_point(data = data %>% filter(Type == "Pandemic"), aes(group = Year)) +
  facet_grid(rows = vars(Country), cols = vars(Pandemic), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 0.1, suffix = "K", scale = 1e-4)) +
  scale_color_viridis_d() +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Age group")
```

```{r echo=FALSE}
ggplot(data = data %>% filter(Type == "Previous"),
       aes(x = Age_group, y = Deaths)) + 
  geom_jitter(aes(colour = Age_group, group = Year)) +
  geom_line(data = data %>% filter(Type == "Pandemic"), aes(group = Year)) +
  facet_grid(rows = vars(Country), cols = vars(Pandemic), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 0.1, suffix = "K", scale = 1e-4)) +
  scale_color_viridis_d() +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Age group")
```

## Pandemics compared to last year

```{r}
data_year <- left_join(
  
  data %>% 
    filter(Type == "Pandemic") %>% 
    select(-Year, - Type) %>% 
    rename(Deaths_pandemic = Deaths),
  
  data %>% 
    filter(Year %in% previous) %>% 
    select(-Year, - Type) %>% 
    rename(Deaths_previous = Deaths)
  
) %>% 
  mutate(Exc = Deaths_pandemic - Deaths_previous,
         Exc_perc = (Deaths_pandemic - Deaths_previous) / Deaths_previous)
```

### Absolute

```{r}
ggplot(data = data_year,
       aes(x = Age_group, y = Exc)) + 
  geom_col() +
  facet_grid(rows = vars(Country), cols = vars(Pandemic), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 0.1, suffix = "K", scale = 1e-4)) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Age group") + 
  ylab("Absolute difference in deaths to previous year")
```

### Relative

```{r}
ggplot(data = data_year,
       aes(x = Age_group, y = Exc_perc)) + 
  geom_col() +
  facet_grid(rows = vars(Country), cols = vars(Pandemic)) + 
  scale_y_continuous(labels = percent) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Age group") + 
  ylab("% difference in deaths to previous year")
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`



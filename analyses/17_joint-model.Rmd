---
title: "Excess mortality: HMD & country data"
subtitle: "Joint modelling example"
author: "Julien Rioux & Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, lubridate, scales, magrittr, 
       doParallel, foreach)

registerDoParallel(cores = 4)
```

```{r knit-setup, include = FALSE}
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Data 

## Monthly deaths with yearly pops

```{r}
deaths_monthly <- 
  read_rds("data/BfS/bfs_deaths_month.Rds") %>% 
  # filter((Year >= 1913 & Year <= 1918) | (Year >= 2015 & Year <= 2020))
  filter((Year >= 1913 & Year <= 1919))

bfs_pop_year <- read_rds("data/BfS/bfs_pop_year.Rds") %>% 
  filter((Year >= 1913 & Year <= 1919)) %>% 
  mutate(Population = round((pop_jan + pop_dec) / 2)) %>% 
  select(-pop_jan, -pop_dec)

# heavy hitter years - deaths will not be sued
flu_years_hc <- c(1918)

flu_years_hc_affected <- seq(1918 + 1, 1918 + 5)

deaths_monthly %<>% 
  left_join(bfs_pop_year) %>%
  mutate(flu_year_hc = ifelse(Year %in% flu_years_hc, 1, 0),
         flu_year_hc_affected = ifelse(Year %in% flu_years_hc_affected, 1, 0),
         deaths_flu_year_hc = ifelse(Year %in% flu_years_hc, NA, Deaths),
         Population = ifelse(Year >= 2020, pop_2020_pred, Population),
         si_one = sin(2*pi*Month/12),
         si_two = sin(4*pi*Month/12),
         co_one = cos(2*pi*Month/12),
         co_two = cos(4*pi*Month/12)) %>% 
  mutate(Deaths = as.integer(round(Deaths))) %>% 
  mutate(Population = as.integer(round(Population)))

rm(bfs_pop_year, flu_years_hc, flu_years_hc_affected)
```

## Yearly deaths with age breakdown

```{r}
deaths_yearly_age_sex <- read_rds("data/mortality_org/hmd_deaths_age_sex.Rds") %>% 
  filter(Country == "Switzerland") %>% 
  filter((Year >= 1913 & Year <= 1919))

# # if pivot? or age cats? are needed
# deaths_yearly_age_sex %<>% 
#   pivot_longer(c("Female", "Male"), names_to = "Sex") %>% 
#   mutate(Age_cat = cut(Age, seq(0, 110, 10), 
#                        include.lowest = TRUE)) %>% 
#   group_by(Year, Sex, Age_cat) %>% 
#   summarise(Deaths = sum(value)) %>% 
#   ungroup()
```

## Yearly pops with age breakdown

```{r}
pop_yearly_age_sex <- read_rds("data/mortality_org/hmd_ch_pop_age_sex.Rds") %>% 
  filter((Year >= 1913 & Year <= 1919))

# # if pivot? or age cats? are needed
# pop_yearly_age_sex %<>% 
#   pivot_longer(c("Female", "Male"), names_to = "Sex") %>% 
#   mutate(Age_cat = cut(Age, seq(0, 110, 10), 
#                        include.lowest = TRUE)) %>% 
#   group_by(Year, Sex, Age_cat) %>% 
#   summarise(Population = sum(value)) %>% 
#   ungroup()
```

<!-- ----------------------------------------------------- -->

# Serfling

## CI via bootstrap

Method from https://statcompute.wordpress.com/2015/12/20/prediction-intervals-for-poisson-regression/

```{r}
boot_pi <- function(model, pdata, n, p) {
  odata <- model$data
  lp <- (1 - p) / 2
  up <- 1 - lp
  seeds <- round(runif(n, 1, 1000), 0)
  boot_y <- foreach(i = 1:n, .combine = rbind) %dopar% {
    set.seed(seeds[i])
    bdata <- odata[sample(seq(nrow(odata)), size = nrow(odata), replace = TRUE), ]
    bpred <- predict(update(model, data = bdata), type = "response", newdata = pdata)
    rpois(length(bpred), lambda = bpred)
  }
  boot_ci <- t(apply(boot_y, 2, quantile, c(lp, up)))
  return(data.frame(pred = predict(model, newdata = pdata, type = "response"), 
                    lower = boot_ci[, 1], upper = boot_ci[, 2]))
}
```

## Calculating expected for 1918

```{r}
reg_data <- deaths_monthly %>% 
  filter(Year >= 1918 - 5 & Year < 1918) 

pred_1918 <- deaths_monthly %>% 
  filter(Year == 1918) %>%
  mutate(
    fit = NA_real_,
    lpi = NA_real_,
    upi = NA_real_,
    fit_flu_hc = NA_real_,
    lpi_flu_hc = NA_real_,
    upi_flu_hc = NA_real_
  )

# summary(reg_data$Year)
# summary(pred_data$Year)

# using all data
summary(monthly <- glm(Deaths ~ Year + 
                         si_one + si_two + co_one + co_two, 
                       offset = log(Population),
                       data = reg_data, 
                       family = "poisson"))

predict <- boot_pi(monthly, pred_1918, 1000, 0.99)

pred_1918 %<>%
  mutate(
    fit = predict$pred,
    lpi = predict$lower,
    upi = predict$upper
  )

rm(predict, reg_data)
```

## Calculating expected for 1919  {.tabset}

```{r}
reg_data <- deaths_monthly %>% 
  filter(Year >= 1919 - 5 & Year < 1919) 

pred_1919 <- deaths_monthly %>% 
  filter(Year == 1919) %>%
  mutate(
    fit = NA_real_,
    lpi = NA_real_,
    upi = NA_real_,
    fit_flu_hc = NA_real_,
    lpi_flu_hc = NA_real_,
    upi_flu_hc = NA_real_
  )
```

### Using all data 

That takes into account data from 1918 which are heavily influencing

```{r}
# using all data
summary(monthly <- glm(Deaths ~ Year + 
                         si_one + si_two + co_one + co_two, 
                       offset = log(Population),
                       data = reg_data, 
                       family = "poisson"))

predict <- boot_pi(monthly, pred_1919, 1000, 0.99)

pred_1919 %<>%
  mutate(
    fit = predict$pred,
    lpi = predict$lower,
    upi = predict$upper
  )

rm(predict)
```


### Using restricted data

In this case that means we simply assign `NA` to deaths in `1918`

```{r}
summary(monthly_flu_hc <- glm(deaths_flu_year_hc ~ Year + 
                                si_one + si_two + co_one + co_two, 
                              offset = log(Population),
                              data = reg_data, 
                              family = "poisson"))

predict_flu_hc <- boot_pi(monthly_flu_hc, pred_1919, 1000, 0.99)

pred_1919 %<>%
  mutate(
    fit_flu_hc = predict_flu_hc$pred,
    lpi_flu_hc = predict_flu_hc$lower,
    upi_flu_hc = predict_flu_hc$upper
  )

rm(predict_flu_hc, reg_data)
```

## Results

```{r echo=FALSE}
mort_plot <- function(plot_data, plot_year, extremes_remove = FALSE) {
  
  plot_data <- plot_data %>% 
    filter(Year >= plot_year - 1 & Year <= plot_year + 1)
  
  max <- plot_data %>% 
    summarise(Deaths = max(Deaths),
              upi = max(upi),
              upi_flu_hc = max(upi_flu_hc)
    ) %>% 
    rowwise() %>% 
    mutate(max = max(c(Deaths, upi, upi_flu_hc)))
  
  if (extremes_remove == FALSE) {
    
    plot_data %>% 
      ggplot(aes(x = Date)) +
      geom_rect(aes(xmin = as.Date(paste0(plot_year, "-01-01")), 
                    xmax = as.Date(paste0(plot_year, "-12-31")), 
                    ymin = -Inf, ymax = Inf), 
                fill = "#ffffbf", alpha = 0.01, inherit.aes = FALSE) +    
      geom_ribbon(aes(ymin = lpi, ymax = upi), alpha = 0.1) + 
      geom_line(aes(y = fit), colour = "grey50") +
      geom_line(aes(y = Deaths), color = "#d7191c", size = 1) + 
      scale_y_continuous(labels = comma, limits = c(0, max$max)) +
      scale_x_date(date_breaks = "4 months", date_labels = "%b") +
      xlab("") + ylab("Observed & predicted deaths") +
      labs(caption = "Excludes extreme years",
           title = paste(as.character(plot_year ))) +
      theme_minimal()
    
  } else if (extremes_remove == TRUE) {
    
    plot_data %>% 
      ggplot(aes(x = Date)) +
      geom_rect(aes(xmin = as.Date(paste0(plot_year, "-01-01")), 
                    xmax = as.Date(paste0(plot_year, "-12-31")), 
                    ymin = -Inf, ymax = Inf), 
                fill = "#ffffbf", alpha = 0.01, inherit.aes = FALSE) +   
      geom_ribbon(aes(ymin = lpi_flu_hc, ymax = upi_flu_hc), alpha = 0.1) + 
      geom_line(aes(y = fit_flu_hc), colour = "grey50") +
      geom_line(aes(y = Deaths), color = "#d7191c", size = 1) + 
      scale_y_continuous(labels = comma, limits = c(0, max$max)) +
      scale_x_date(date_breaks = "4 months", date_labels = "%b") +
      xlab("") + ylab("Observed & predicted deaths") +
      labs(caption = "Excludes extreme years",
           title = paste(as.character(plot_year ))) +
      theme_minimal()
  }
}
```

### 1918 

```{r echo=FALSE}
mort_plot(pred_1918, 1918) 
```

### 1919 {.tabset}

#### With extremes

```{r echo=FALSE}
mort_plot(pred_1919, 1919) 
```

#### Without extremes

```{r echo=FALSE}
mort_plot(pred_1919, 1919, extremes_remove = TRUE) 
```

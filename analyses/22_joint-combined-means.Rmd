---
title: "Excess mortality"
subtitle: "Final outputs for paper and appendix"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
  code_folding: show
self_contained: true
highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, magrittr, scales, patchwork, kableExtra)
```

```{r knit-setup, include = FALSE}
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

```{r include=FALSE}
# Data 
pandemic_year <- c("1890", "1918", "1957", "2020")

merge_mort <- function(data){
  
  data %>% 
    mutate(Pandemic = case_when(
      (Year >= 1889 & Year <= 1892) ~ 1890,
      (Year >= 1917 & Year <= 1920) ~ 1918,
      (Year >= 1956 & Year <= 1959) ~ 1957,
      (Year >= 2019 & Year <= 2020) ~ 2020
    )) %>% 
    relocate(Country)
}

results_month <- merge_mort(bind_rows(
  read_rds("data/outputs_2021-08-02-local/All_results_month.Rds"),
  read_rds("data/outputs_2021-08-02-local/Switzerland_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Sweden_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Spain_results_month.Rds")
)) %>% 
  filter(Model == "Age Serfling (Stan, NB)") %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  arrange(Country, Year, Month) %>% 
  relocate(Country, Year, Month, Date)


results_month_pand <- merge_mort(bind_rows(
  read_rds("data/outputs_2021-08-02-local/All_results_month_pand.Rds"),
  read_rds("data/outputs_2021-08-02-local/Switzerland_results_month_pand.Rds"),
  read_rds("data/outputs_2021-08-02-local/Sweden_results_month_pand.Rds"),
  read_rds("data/outputs_2021-08-02-local/Spain_results_month_pand.Rds")
)) %>%
  filter(Model == "Age Serfling (Stan, NB, pandemic)") %>%
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>%
  arrange(Country, Year, Month)

results_year <- merge_mort(bind_rows(
  read_rds("data/outputs_2021-08-02-local/Switzerland_results_year.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Sweden_results_year.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Spain_results_year.Rds")
)) %>% 
  filter(Model == "Age Serfling (Stan, NB)") %>% 
  arrange(Country, Year)

results_age <- merge_mort(bind_rows(
  read_rds("data/outputs_2021-08-02-local/Switzerland_results_age.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Sweden_results_age.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Spain_results_age.Rds")
)) %>% 
  filter(Model == "Age Serfling (Stan, NB)") %>% 
  arrange(Country, Year)

pops <- read_rds("data/deaths_monthly.Rds") %>% 
  filter(Month == 1) %>% 
  select(Year, Country, Population)
```

<!-- ----------------------------------------------------- -->

# Paper outputs

## Table 1

```{r echo=FALSE}
table_1 <- 
  
  left_join(
    
    pops %>% 
      filter(Year %in% pandemic_year) %>% 
      select(Year, Country, Population), 
    
    results_month %>% 
      filter(Year %in% pandemic_year) %>%
      group_by(Country, Year) %>% 
      summarise(Observed = sum(Deaths),
                Expected = sum(pred)
      ) %>% 
      ungroup()
    
  ) %>% 
  left_join(
    
    results_year %>%
      select(Country, Year, excess_year, excess_year_lower, excess_year_upper) %>%
      filter(Year %in% pandemic_year) %>%
      rename(Excess = excess_year,
             Excess_lci = excess_year_lower, Excess_uci = excess_year_upper)
    
  ) %>% 
  mutate(Percent_excess = 
           percent(Excess / Expected, accuracy = 0.1),
         Percent_lci = 
           percent(Excess_lci / Expected, accuracy = 0.1),
         Percent_uci = 
           percent(Excess_uci / Expected, accuracy = 0.1)) %>% 
  relocate(Year, Country, Population, Observed, Expected, 
           starts_with("Excess"), starts_with("Percent")) %>% 
  arrange(Year, Country)

openxlsx::write.xlsx(table_1, "paper/Table_1.xlsx", 
                     row.names = FALSE, overwrite = TRUE)
```

```{r echo=FALSE}
table_1 %>% 
  kbl(align = "rlrrrrrrrr") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)
```

## Figure 1

Monthly absolute estimates of excess.  

```{r echo=FALSE}
hline_pandemic <- results_month %>% 
  filter(Year == 2020) %>% 
  group_by(Country) %>% 
  summarise(yintercept = max(excess_month)) %>% 
  ungroup()

vline_pandemic <- tibble(Date=c(as.Date("1890-01-01"),
                                as.Date("1918-01-01"),
                                as.Date("1957-01-01"),
                                as.Date("1968-01-01"),
                                as.Date("1977-01-01"),
                                as.Date("2009-01-01"),
                                as.Date("2020-01-01"))) 

results_month %>% 
  mutate(Difference = ifelse(excess_month > 0, "More than expected", "Fewer than expected")) %>% 
  ggplot(aes(x = Date)) +
  geom_vline(data = vline_pandemic, 
             aes(xintercept = Date+365/2), 
             size = 2, colour = "#ffffbf", alpha = .7) +
  geom_hline(data = hline_pandemic, 
             aes(yintercept = yintercept), 
             colour = "#984ea3", size = 0.25) +
  geom_col(aes(y = excess_month, fill = Difference, colour = Difference), width = 1) +
  geom_hline(yintercept = 0, linetype = 2, size = 0.25) +
  scale_x_date(date_labels = "%Y",
               breaks = seq(as.Date("1860-01-01"), as.Date("2020-12-31"), "10 years"),
               limits = c(as.Date("1855-01-01"), 
                          as.Date("2020-12-31")), 
               expand = c(0.01, 0)) +
  scale_fill_manual(values = c("#67A9CF", "#EF8A62")) +  
  scale_color_manual(values = c("#67A9CF", "#EF8A62"), guide = "none") +
  facet_grid(vars(Country), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 1, suffix = "K", scale = 1e-3)) +
  theme_bw() +
  theme(legend.position = c(.12, .95),
        legend.background = element_blank()) +
  labs(x = "Year",y = "Monthly excess deaths", fill = NULL) +
  guides(fill = guide_legend(reverse = TRUE)) 

rm(hline_pandemic)

ggsave("paper/Figure_1.png", dpi = 300, width = 297, height = 210, units = "mm")
```


## Figure 2 

Zooming to pandemics to explore absolute excess with CrI.  

```{r echo=FALSE, message=FALSE}
focus_years <- c(1890, 1918, 1957, 2020)

for(country in unique(results_month$Country)) {
  
  # print(paste0("Plotting ", country))
  
  max <- results_month %>%
    filter(Country == country) %>%
    filter(!is.na(Pandemic)) %>%
    summarise(Deaths = max(Deaths),
              lower = max(lower),
              upper = max(upper)) %>%
    rowwise() %>%
    mutate(max = max(c(Deaths, lower, upper))) %>%
    ungroup()
  
  # print(paste0("Max for x is ", max$max))
  
  for(year in focus_years) {
    
    # skip Spain oldest - no data
    if(year == 1890 & country == "Spain") {
      next
    }
    
    # print(paste0("    Year ", year))
    
    plot_data <- results_month %>%
      filter(Country == country) %>%
      filter(Pandemic == year)
    
    name <- paste(country, year, sep = "_")
    
    if (year == 1890 & country != "Spain") {
      my_title = paste0(country, ": ",
                        as.character(year - 1), "-", as.character(year))
    } else if (year == 1918 & country == "Spain") {
      my_title = paste0(country, ": ",
                        as.character(year - 1), "-", as.character(year + 2))
    } else if (year == 2020) {
      my_title = paste0(as.character(year - 1), "-", as.character(year))
    } else {
      my_title = paste0(as.character(year - 1), "-", as.character(year + 2))
    }    
    
    # sync breaks across plots
    my_breaks = plot_data$Date[seq(1, nrow(plot_data), 6)]
    
    plot <- plot_data %>%
      ggplot(aes(x = Date)) +
      geom_rect(xmin = as.Date(paste0(year, "-01-01")),
                xmax = as.Date(paste0(year, "-12-31")),
                ymin = -Inf, ymax = Inf,
                fill = "#ffffbf", alpha = 0.01, inherit.aes = FALSE) +
      geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1) +
      geom_line(aes(y = pred), colour = "grey50") +
      geom_line(aes(y = Deaths), color = "#EF8A62", size = 0.5) +
      scale_x_date(date_breaks = "1 year", date_labels = "%Y", expand = c(0, 0)) +
      xlab("Year") +
      ylab("Deaths") +
      ggtitle(my_title) +
      scale_y_continuous(limits = c(0, max$max),
                         labels = label_number(accuracy = 1, suffix = "K", scale = 1e-3)) +
      theme_bw() +
      theme(plot.title = element_text(size = 9),
            axis.title.y = element_text(size = 8),
            axis.text.y = element_text(size = 8),
            axis.title.x = element_text(size = 8),
            axis.text.x = element_text(size = 8),
            plot.margin = margin(0, 0, 0, 0))
    
    assign(name, plot)
  }
}

Switzerland_1890 + Switzerland_1918 + Switzerland_1957 + Switzerland_2020 +
  Sweden_1890 + Sweden_1918 + Sweden_1957 + Sweden_2020 +
  plot_spacer() + Spain_1918 + Spain_1957 + Spain_2020 +
  plot_layout(widths = rep(c(2, 2, 2, 1), 3)) +
  plot_layout(ncol = 4) + 
  theme(plot.margin = margin(0, 0, 0, 0))


ggsave("paper/Figure_2.png", dpi = 300, width = 297, height = 210, units = "mm")

rm(Spain_1918, Spain_1957, Spain_2020,
   Sweden_1890, Sweden_1918, Sweden_1957, Sweden_2020,
   Switzerland_1890, Switzerland_1918, Switzerland_1957, Switzerland_2020,
   focus_years, max)
```

```{r echo=FALSE, eval=FALSE}
focus_years <- c(1890, 1918, 1957, 2020)

shown_years = NULL
for(i in focus_years) {
  shown_years = bind_rows(shown_years,
                          tibble(Year=(i-2):(i+2),
                                 focus_year=i,
                                 shown_years=paste0(i-2,"-",min(2020,i+2))))
}
# shown_years %<>% filter(Year <= 2020)

gg = results_month %>%
  mutate(Country = fct_relevel(factor(Country), "Switzerland", "Sweden", "Spain")) %>% 
  left_join(shown_years) %>%
  filter(!is.na(shown_years)) %>%
  ggplot() +
  geom_rect(aes(xmin = as.Date(paste0(focus_year, "-01-01")),
                xmax = as.Date(paste0(focus_year, "-12-31")),
                ymin = -Inf, ymax = Inf), 
            fill = "#ffffbf", alpha = 0.05) +
  geom_ribbon(aes(x=Date,ymin=lower,ymax=upper), alpha=0.1) +
  geom_line(aes(x=Date,y=pred)) +
  geom_line(aes(x=Date,y=Deaths),colour="#EF8A62") +
  geom_point(data=shown_years,aes(x=as.Date(paste0(Year, "-01-01")),y=0),colour="transparent") +
  facet_grid(Country ~ shown_years, scales="free") +
  scale_y_continuous(labels = label_number(accuracy = 1, suffix = "K", 
                                           scale = 1e-3)) +
  theme_bw()+
  theme(plot.margin = margin(0.5, 0.5, 0, 0))+
  labs(x="Year",y="Montly deaths")

gg
require(grid)
g_data_grob = ggplotGrob(gg)


## remove unused facets
idx <- which(g_data_grob$layout$name %in% c("panel-3-1"))
for (i in idx) g_data_grob$grobs[[i]] <- nullGrob()

## move y axis right
# axis-l-1 needs to move 1 columns to the right
idx <- which(g_data_grob$layout$name %in% c("axis-l-3"))
g_data_grob$layout[idx, c("l", "r")] <- g_data_grob$layout[idx, c("l", "r")] + 2

## move x axis up

grid.newpage()
grid.draw(g_data_grob)

# ggsave("paper/Figure_2.png", dpi = 300, width = 297, height = 210, units = "mm")
```

## Figure 3

Age differences across major pandemics

```{r echo=FALSE}
pandemic_years <- c(1890, 1918, 1957, 2020)
deaths_yearly_age_sex <- read_rds("data/deaths_yearly_age_sex.Rds")

results_age %>% 
  filter(Year %in% pandemic_years) %>%
  mutate(Age_cat2=as.numeric(Age_cat)) %>%
  left_join(deaths_yearly_age_sex) %>%
  ggplot() +
  geom_pointrange(aes(x=Age_cat2,
                      y=excess_year/pred,
                      ymin=excess_year_lower/pred,
                      ymax=excess_year_upper/pred,
                      colour=factor(Country))) +
  geom_line(aes(x=Age_cat2,
                y=excess_year/pred,
                colour=factor(Country))) +
  geom_hline(yintercept=0,linetype=2) +
  facet_wrap(~Year,nrow=1) +
  scale_x_continuous(labels=unique(as.character(results_age$Age_cat)),
                     breaks=1:10) +
  scale_y_continuous(labels= label_number(accuracy = 1, suffix = "%", scale = 100)) +
  theme_bw() +
  scale_colour_manual(values=c("darkgoldenrod1","dodgerblue","firebrick2")) +
  # coord_cartesian(ylim=c(-0.02,.07)) +
  labs(x="Year",y="Montly deaths") +
  theme(legend.position = c(.1,.85),
        legend.background = element_blank(),
        axis.text.x = element_text(angle=45,hjust=1),
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x="Age group",y="Excess deaths (in proportion of expected)",
       colour="Country")

ggsave("paper/Figure_3.png", dpi = 300, width = 297, height = 150, units = "mm")
```

<!-- ----------------------------------------------------- -->

# Appendix 

## Table S1

Comparing estimates of excess from different methods

```{r echo=FALSE}
table_s1 <- bind_rows(
  
  # needs all models
  
  # global serfling model without CrI
  read_rds("data/outputs_2021-08-02-local/All_results_month.Rds") %>% 
    select(Country, Year, Model, excess_month) %>% 
    group_by(Country, Year, Model) %>% 
    summarise(excess_year = sum(excess_month)) %>% 
    ungroup() %>% 
    mutate(excess_year_lower = NA_real_,
           excess_year_upper = NA_real_),
  
  # remaining three
  bind_rows(
    read_rds("data/outputs_2021-08-02-local/Switzerland_results_year.Rds"), 
    read_rds("data/outputs_2021-08-02-local/Sweden_results_year.Rds"), 
    read_rds("data/outputs_2021-08-02-local/Spain_results_year.Rds")
  ) %>% 
    select(Country, Year, Model, starts_with("excess_"))
  
) %>% 
  filter(Year %in% c(pandemic_years, pandemic_years - 1, pandemic_years + 1)) %>% 
  arrange(Country, Year, Model) %>% 
  # mutate(Model = str_remove(Model, fixed(" (Stan, NB)"))) %>% 
  pivot_wider(names_from = Model, 
              values_from = starts_with("excess_"),
              names_sort = FALSE) %>% 
  relocate(Country, Year,
           `excess_year_Global Serfling`, 
           `excess_year_lower_Global Serfling`, 
           `excess_year_upper_Global Serfling`,
           `excess_year_Global Serfling (Stan, NB)`, 
           `excess_year_lower_Global Serfling (Stan, NB)`,
           `excess_year_upper_Global Serfling (Stan, NB)`,
           `excess_year_Age Serfling (Stan, NB)`, 
           `excess_year_lower_Age Serfling (Stan, NB)`, 
           `excess_year_upper_Age Serfling (Stan, NB)`) %>% 
  select(-`excess_year_lower_Global Serfling`, -`excess_year_upper_Global Serfling`,
  )
```

```{r echo=FALSE}
table_s1 %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)

openxlsx::write.xlsx(table_s1, "paper/Table_S1.xlsx", 
                     row.names = FALSE, overwrite = TRUE)
```

## Figure S1 

Yearly estimates of excess

```{r echo=FALSE}
hline_pandemic <- results_year %>% 
  filter(Year == 2020) %>% 
  group_by(Country) %>% 
  summarise(yintercept = max(excess_year)) %>% 
  ungroup()

results_year %>% 
  mutate(Difference = ifelse(excess_year > 0, "More than expected", "Less than expected")) %>% 
  ggplot(aes(x = Year)) +
  geom_hline(data = hline_pandemic, aes(yintercept = yintercept), 
             colour = "#984ea3", size = 0.25, linetype = "dashed") +
  geom_hline(yintercept = 0, colour = "grey80") +
  geom_col(aes(y = excess_year, fill = Difference)) +
  scale_x_continuous(
    breaks = c(1860, 1890, 1918, 1957, 1968, 1977, 2009, 2020),
    limits = c(1856-1, 2020+1),
    expand = c(0, 0)) +
  scale_fill_manual(values = c("#67A9CF", "#EF8A62")) +  
  facet_grid(vars(Country), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 1L, suffix = "K", scale = 1e-4)) +
  theme_bw() +
  theme(
    #panel.grid.major = element_blank(), 
    # panel.grid.minor = element_blank(),
    panel.background = element_blank(), 
    axis.line = element_line(colour = "grey40"),
    axis.ticks = element_line(),
    legend.position = c(.10, .95),
    legend.background = element_blank(),
    legend.title = element_blank()) +
  xlab("") + ylab("Yearly excess deaths") +
  guides(fill = guide_legend(reverse = TRUE)) 

rm(hline_pandemic)

ggsave("paper/Figure_S1.png", dpi = 300, width = 297, height = 210, units = "mm")
```

## Figure S2

Zooming to pandemics to explore % of excess

```{r echo=FALSE}
plot_years <- c(seq(1890 - 1, 1890 + 2),
                seq(1918 - 1, 1918 + 2),
                seq(1957 - 1, 1957 + 2),
                seq(2020 - 1, 2020 + 2))

plot_data <- results_month %>% 
  filter(Year %in% plot_years) %>% 
  mutate(Percent = (excess_month / pred),
         Difference = ifelse(Percent > 0, "More", "Less")) %>% 
  group_by(Country, Pandemic) %>% 
  mutate(time = row_number()) %>% 
  ungroup()

plot_data %>% 
  mutate(xmin = as.Date(paste0(Pandemic, "-01-01")),
         xmax = as.Date(paste0(Pandemic, "-12-31"))) %>% 
  ggplot(aes(x = time)) +
  geom_hline(yintercept = 0, colour = "grey60") +
  geom_vline(xintercept = 13, colour = "grey80") +
  geom_vline(xintercept = 24, colour = "grey80") +
  geom_rect(aes(xmin = 13, xmax = 24,
            ymin = -Inf, ymax = Inf),
            fill = "#ffffbf", alpha = 0.01, inherit.aes = FALSE) +
  geom_col(aes(y = Percent, fill = Difference), size = 0.5) +
  facet_grid(vars(Country), vars(Pandemic), scales = "free") + 
  scale_x_continuous(limits = c(min(plot_data$time)-1, max(plot_data$time)+1),
                     breaks = c(1, 13, 24, 36, 48), 
                     labels = c("-12m", "Start", "End", "+12m", "+24m")) +
  xlab("") + 
  ylab("% above predicted Deaths") +
  ggtitle("Excess deaths as % of observed") +
  scale_y_continuous(labels = percent) +
  scale_fill_manual(values = c("#67A9CF", "#EF8A62")) +  
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_line(), 
        panel.grid.minor.y = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey40")) 

ggsave("paper/Figure_S2.png", dpi = 300, width = 297, height = 210, units = "mm")

rm(plot_years)
```

## Figure S3

Impact of extremes: using 1918 pandemic as an example of impact on estimates from 1919 - 1923.  
Estimates with extreme year (blue) and without (red).  
Converge after 5 year smoothing window stops having effect (ie. in 1924).  

### Figure 

```{r echo=FALSE}
extreme_data <- 
  left_join(
    
    results_month %>% 
      select(Country, Year, Month, Date, Deaths, pred, lower, upper),
    
    results_month_pand %>% 
      select(Country, Year, Month, pred, lower, upper) %>% 
      rename(pred_pand = pred,
             lower_pand = lower, upper_pand = upper)
    
  ) %>% 
  filter(Year >= 1918 & Year <= 1924) 

extreme_data %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Deaths), colour = "grey60") + 
  # with pandemics
  geom_ribbon(aes(ymin = lower_pand, ymax = upper_pand),
              alpha = 0.1, fill = "#67A9CF") +
  geom_line(aes(y = pred_pand), colour = "#67A9CF") +
  # without
  geom_ribbon(aes(ymin = lower, ymax = upper), 
              alpha = 0.1, fill = "#EF8A62") + 
  geom_line(aes(y = pred), colour = "#EF8A62") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y", minor_breaks = NULL) +
  # coord_cartesian(ylim = c(NA, 100000)) + 
  xlab("") + ylab("Number of Deaths") + 
  facet_grid(vars(Country), scales = "free_y") + 
  theme_minimal()

ggsave("paper/Figure_S3.png", dpi = 300, width = 297, height = 210, units = "mm")
```

### Table 

Using 1918 pandemic as an example of impact on estimates from 1919.   

```{r echo=FALSE}
extreme_data %<>% 
  filter(Year == 1919) %>% 
  select(-lower, -upper, -lower_pand, -upper_pand, 
         -Date, -Year) %>% 
  mutate(diff_1 = Deaths - pred,
         diff_2 = Deaths - pred_pand) %>% 
  relocate(diff_1, .after = pred) 

extreme_data %>% 
  kbl(col.names = c("Country", "Month", "Observed", 
                    "Predicted", "Difference",
                    "Predicted (pandemic)", "Difference")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  column_spec(5, color = ifelse(extreme_data$diff_1 > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  column_spec(7, color = ifelse(extreme_data$diff_2 > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  row_spec(1, italic = FALSE) %>% 
  add_header_above(c(" " = 3, "Including 1918" = 2, "Excluding 1918" = 2)) %>%
  # collapse not working; issue filled on github
  collapse_rows(columns = 1, valign = "top")
```

## Pandemic compared to last year {.tabset}

```{r echo=FALSE}
pandemic_years <- c(1890, 1918, 1957, 2020)

analysis_years <- c(seq(1890 - 10, 1890),
                    seq(1918 - 10, 1918),
                    seq(1957 - 10, 1957),
                    seq(2020 - 10, 2020))

previous_years <- c(seq(1890 - 10, 1890 - 1),
                    seq(1918 - 10, 1918 - 1),
                    seq(1957 - 10, 1957 - 1),
                    seq(2020 - 10, 2020 - 1))

age_plot_data <- 
  results_age %>% 
  filter(Year %in% analysis_years) %>% 
  mutate(Type = ifelse(Year %in% previous_years, "Previous", "")) %>% 
  mutate(Type = ifelse(Year %in% pandemic_years, "Pandemic", Type)) %>%  
  arrange(Country, Year, Age_cat) %>% 
  mutate(Pandemic = ifelse(Year %in% pandemic_years, Year, NA)) %>% 
  fill(Pandemic, .direction = "up") 

previous <- pandemic_years - 1

data_year <- left_join(
  
  age_plot_data %>% 
    filter(Type == "Pandemic") %>% 
    select(Pandemic, Year, Country, Age_cat, Deaths) %>% 
    rename(Deaths_pandemic = Deaths),
  
  age_plot_data %>% 
    filter(Year %in% previous) %>% 
    select(Pandemic, Year, Country, Age_cat, Deaths) %>% 
    rename(Deaths_previous = Deaths) %>% 
    mutate(Year = Year + 1)
  
) %>% 
  mutate(Exc = Deaths_pandemic - Deaths_previous,
         Exc_perc = (Deaths_pandemic - Deaths_previous) / Deaths_previous)

```

### Absolute

```{r echo=FALSE}
ggplot(data = data_year,
       aes(x = Age_cat, y = Exc)) + 
  geom_col() +
  facet_grid(rows = vars(Country), cols = vars(Pandemic), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 0.1, suffix = "K", scale = 1e-4)) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Age group") + 
  ylab("Absolute difference in deaths to previous year")
```

### Relative

```{r echo=FALSE}
ggplot(data = data_year,
       aes(x = Age_cat, y = Exc_perc)) + 
  geom_col() +
  facet_grid(rows = vars(Country), cols = vars(Pandemic)) + 
  scale_y_continuous(labels = percent) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Age group") + 
  ylab("% difference in deaths to previous year")
```

## Comparing to BfS estimates

Data from BfS prepared in `03`. No CI included in comparisons since different age groups are used.  

```{r echo=FALSE}
excess_2010_2020 <- 
  left_join(
    # official counts
    read_rds("data/BfS/excess_2010_2020.Rds") %>% 
      rename(Excess_BfS = Excess_expected),
    
    # our estimates
    results_year %>% 
      filter(Country == "Switzerland") %>% 
      select(Year, excess_year) %>% 
      rename(Excess_modelled = excess_year)
  ) %>% 
  mutate(Difference = Excess_modelled - Excess_BfS)
```

```{r echo=FALSE}
excess_2010_2020 %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE) %>% 
  column_spec(4, color = ifelse(excess_2010_2020$Difference > 0, 
                                "#EF8A62", "#67A9CF"))
```

<!-- ----------------------------------------------------- -->

# Model diagnostics

## Rhat

Check that all values <1.1

```{r}
summary(results_month[results_month$Model != "Global Serfling", ]$Rhat) 
```

## ESS

Check that all effective sample sizes are large

```{r}
summary(results_month[results_month$Model != "Global Serfling", ]$n_eff) 
```

## Model agreement

Example of last year  

```{r echo=FALSE}
bind_rows(
  read_rds("data/outputs_2021-08-02-local/All_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Switzerland_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Sweden_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Spain_results_month.Rds")
) %>%  
  filter(Year == 2020) %>% 
  ggplot() +
  geom_pointrange(aes(x=Month, y=excess_month, 
                      ymin=excess_month_lower, ymax=excess_month_upper,
                      colour=Model),
                  position=position_dodge(.8)) +
  facet_grid(Country~Year, scales="free")
```

And 1918  

```{r echo=FALSE}
bind_rows(
  read_rds("data/outputs_2021-08-02-local/All_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Switzerland_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Sweden_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Spain_results_month.Rds")
) %>%  
  filter(Year == 1918) %>% 
  ggplot() +
  geom_pointrange(aes(x=Month, y=excess_month, 
                      ymin=excess_month_lower, ymax=excess_month_upper,
                      colour=Model),
                  position=position_dodge(.8)) +
  facet_grid(Country~Year, scales="free")
```

## Check age

```{r echo=FALSE}
results_age %>% 
  filter(Year >= 2010) %>% 
  ggplot() +
  geom_pointrange(aes(x=Year, y=excess_year,
                      ymin=excess_year_lower, ymax=excess_year_upper),
                  position=position_dodge(.8)) +
  facet_grid(Country~Age_cat)
```

```{r echo=FALSE}
results_age %>% 
  filter(Year >= 1914 & Year <= 1922) %>% 
  ggplot() +
  geom_pointrange(aes(x=Year, y=excess_year,
                      ymin=excess_year_lower, ymax=excess_year_upper),
                  position=position_dodge(.8)) +
  facet_grid(Country~Age_cat)
```

<!-- ----------------------------------------------------- -->

```{r echo=FALSE, eval=FALSE}
# Alt Fig 3
ggplot(data = age_plot_data %>% 
         filter(Type == "Previous"),
       aes(x = Age_cat)) + 
  
  # observed from previous decade
  geom_boxplot(aes(y = Deaths,
                   fill = "grey"), 
               color = "grey", alpha = 0.25) +
  geom_jitter(aes(y = Deaths), 
              color = "black", size = 0.5, alpha = 0.5) +
  
  # modelled 67A9CF
  geom_ribbon(data = age_plot_data %>% 
                filter(Type == "Pandemic"),
              aes(ymin = lower, ymax = upper, group = Year), 
              alpha = 0.1, fill = "#67A9CF") + 
  geom_line(data = age_plot_data %>% 
              filter(Type == "Pandemic"),
            aes(y = pred, group = Year, colour = "#67A9CF")) +
  
  # observed EF8A62
  geom_line(data = age_plot_data %>% 
              filter(Type == "Pandemic"), 
            aes(y = Deaths, group = Year,
                colour = "#EF8A62")) +
  
  facet_grid(rows = vars(Country), cols = vars(Pandemic), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 0.1, suffix = "K", scale = 1e-4)) +
  scale_fill_manual(name = NULL,
                    values = c("grey" = "grey"), 
                    labels = c("Observed \n(Last \n10 years)"), 
                    guide = "legend") +  
  scale_colour_manual(name = "Deaths",
                      values = c("#67A9CF" = "#67A9CF",
                                 "#EF8A62" = "#EF8A62"), 
                      labels = c("Expected \n(Last \n5 years)",
                                 "Observed"), 
                      guide = "legend") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey40"),
        axis.ticks = element_line(),
        axis.text.x = element_text(angle = 90)) +
  xlab("Age group") + labs(colour = "Age group") +
  guides(fill = guide_legend(order = 2),
         colour = guide_legend(order = 1))

# ggsave("paper/Figure_3.png", dpi = 300, width = 297, height = 210, units = "mm")
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`
---
title: "Excess mortality"
subtitle: "Final outputs for paper and appendix"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
  code_folding: show
self_contained: true
highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, magrittr, scales, patchwork, kableExtra)
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

```{r include=FALSE}
# Data 
pandemic_year <- c("1890", "1918", "1957", "2020", "2021")

merge_mort <- function(data){
  
  data %>% 
    mutate(Pandemic = case_when(
      (Year >= 1889 & Year <= 1892) ~ 1890,
      (Year >= 1917 & Year <= 1920) ~ 1918,
      (Year >= 1956 & Year <= 1959) ~ 1957,
      (Year >= 2019 & Year <= 2021) ~ 2020
    )) %>% 
    relocate(Country) %>% 
    mutate(Country = fct_relevel(factor(Country), "Switzerland", "Sweden", "Spain"))
}

results_month <- merge_mort(bind_rows(
  read_rds("data/outputs_2021-08-02-local/All_results_month.Rds"),
  read_rds("data/outputs_2021-08-02-local/Switzerland_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Sweden_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Spain_results_month.Rds"),
  read_rds("data/outputs_2021-08-25/All_results_month.Rds"),
  read_rds("data/outputs_2021-08-25/Switzerland_results_month.Rds"), 
  read_rds("data/outputs_2021-08-25/Sweden_results_month.Rds"), 
  read_rds("data/outputs_2021-08-25/Spain_results_month.Rds")
)) %>% 
  filter(Model == "Age Serfling (Stan, NB)") %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  arrange(Country, Year, Month) %>% 
  relocate(Country, Year, Month, Date)

results_month_pand <- merge_mort(bind_rows(
  read_rds("data/outputs_2021-08-02-local/All_results_month_pand.Rds"),
  read_rds("data/outputs_2021-08-02-local/Switzerland_results_month_pand.Rds"),
  read_rds("data/outputs_2021-08-02-local/Sweden_results_month_pand.Rds"),
  read_rds("data/outputs_2021-08-02-local/Spain_results_month_pand.Rds"),
  read_rds("data/outputs_2021-08-25/All_results_month_pand.Rds"),
  read_rds("data/outputs_2021-08-25/Switzerland_results_month_pand.Rds"),
  read_rds("data/outputs_2021-08-25/Sweden_results_month_pand.Rds"),
  read_rds("data/outputs_2021-08-25/Spain_results_month_pand.Rds")
)) %>%
  filter(Model == "Age Serfling (Stan, NB, pandemic)") %>%
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>%
  arrange(Country, Year, Month)

results_year <- merge_mort(bind_rows(
  read_rds("data/outputs_2021-08-02-local/Switzerland_results_year.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Sweden_results_year.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Spain_results_year.Rds"),
  read_rds("data/outputs_2021-08-25/Switzerland_results_year.Rds"), 
  read_rds("data/outputs_2021-08-25/Sweden_results_year.Rds"), 
  read_rds("data/outputs_2021-08-25/Spain_results_year.Rds")
)) %>% 
  filter(Model == "Age Serfling (Stan, NB)") %>% 
  arrange(Country, Year)

results_age <- merge_mort(bind_rows(
  read_rds("data/outputs_2021-08-02-local/Switzerland_results_age.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Sweden_results_age.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Spain_results_age.Rds"),
  read_rds("data/outputs_2021-08-25/Switzerland_results_age.Rds"), 
  # read_rds("data/outputs_2021-08-25/Sweden_results_age.Rds"), 
  read_rds("data/outputs_2021-08-25/Spain_results_age.Rds")
)) %>% 
  filter(Model == "Age Serfling (Stan, NB)") %>% 
  arrange(Country, Year)

pops <- read_rds("data/deaths_monthly.Rds") %>% 
  filter(Month == 1) %>% 
  select(Year, Country, Population)
```

<!-- ----------------------------------------------------- -->

# Paper outputs

## Table 1

```{r echo=FALSE}
table_1 <- 
  
  left_join(
    
    pops %>% 
      filter(Year %in% pandemic_year) %>% 
      select(Year, Country, Population), 
    
    results_month %>% 
      filter(Year %in% pandemic_year) %>%
      group_by(Country, Year) %>% 
      summarise(Observed = sum(Deaths),
                Expected = sum(pred)
      ) %>% 
      ungroup()
    
  ) %>% 
  left_join(
    
    results_year %>%
      select(Country, Year, excess_year, excess_year_lower, excess_year_upper) %>%
      filter(Year %in% pandemic_year) %>%
      rename(Excess = excess_year,
             Excess_lci = excess_year_lower, Excess_uci = excess_year_upper)
    
  ) %>% 
  mutate(Percent_excess = 
           percent(Excess / Expected, accuracy = 0.1),
         Percent_lci = 
           percent(Excess_lci / Expected, accuracy = 0.1),
         Percent_uci = 
           percent(Excess_uci / Expected, accuracy = 0.1)) %>% 
  relocate(Year, Country, Population, Observed, Expected, 
           starts_with("Excess"), starts_with("Percent")) %>% 
  mutate(excess_cri = str_c("(", Excess_lci, ", ", Excess_uci, ")")) %>% 
  relocate(excess_cri, .after = Excess) %>% 
  select(-Excess_lci, -Excess_uci) %>% 
  mutate(percent_cri = str_c("(", Percent_lci, ", ", Percent_uci, ")")) %>% 
  relocate(percent_cri, .after = Percent_excess) %>% 
  select(-Percent_lci, -Percent_uci) %>% 
  arrange(Year, desc(Country))

openxlsx::write.xlsx(table_1, "paper/Table_1.xlsx", 
                     row.names = FALSE, overwrite = TRUE)
```

```{r echo=FALSE}
table_1 %>% 
  filter(!(Country == "Sweden" & Year == 2021)) %>% 
  select(-Year) %>% 
  kbl(align = "lrrrrrrr",
      col.names = c("Country", "Population", 
                    "Observed", "Expected", 
                    "No.", "95% CrI", 
                    "%", "95% CrI")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  add_header_above(c(" " = 4, 
                     "Excess" = 2, "% excess" = 2)) %>% 
  pack_rows("1890", 1, 2) %>%
  pack_rows("1918", 3, 5) %>% 
  pack_rows("1957", 6, 8) %>% 
  pack_rows("2020", 9, 11) %>% 
  pack_rows("2021", 12, 13) %>% 
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)
```

## Figure 1

Monthly absolute estimates of excess.  

```{r echo=FALSE}
hline_pandemic <- results_month %>% 
  filter(Year >= 2020) %>% 
  group_by(Country) %>% 
  summarise(yintercept = max(excess_month)) %>% 
  ungroup() 

vline_pandemic <- tibble(Date=c(as.Date("1890-01-01"),
                                as.Date("1918-01-01"),
                                as.Date("1957-01-01"),
                                as.Date("1968-01-01"),
                                as.Date("1977-01-01"),
                                as.Date("2009-01-01"),
                                as.Date("2020-01-01"))) 

results_month %>% 
  mutate(Difference = ifelse(excess_month > 0, "More than expected", "Fewer than expected")) %>% 
  ggplot(aes(x = Date)) +
  geom_vline(data = vline_pandemic, 
             aes(xintercept = Date+365/2), 
             size = 2, colour = "grey90") +
  geom_hline(data = hline_pandemic, 
             aes(yintercept = yintercept), 
             colour = "#984ea3", size = 0.25) +
  geom_col(aes(y = excess_month, fill = Difference, colour = Difference), width = 1) +
  geom_hline(yintercept = 0, linetype = 2, size = 0.25) +
  scale_x_date(date_labels = "%Y",
               breaks = seq(as.Date("1860-01-01"), as.Date("2020-12-31"), "10 years"),
               limits = c(as.Date("1855-01-01"), 
                          as.Date("2021-07-01")), 
               expand = c(0.01, 0)) +
  scale_fill_manual(values = c("#67A9CF", "#EF8A62")) +  
  scale_color_manual(values = c("#67A9CF", "#EF8A62"), guide = "none") +
  facet_grid(Country~., scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 1, suffix = "K", scale = 1e-3)) +
  theme_bw() +
  theme(legend.position = c(.12, .95),
        legend.background = element_blank(),
        plot.margin = margin(0.5, 0.5, 0, 0))+
  labs(x = "Year",y = "Monthly excess deaths", fill = NULL) +
  guides(fill = guide_legend(reverse = TRUE)) 

rm(hline_pandemic)

ggsave("paper/Figure_1.png", dpi = 300, width = 190, height = 140, units = "mm")
```

## Figure 2 

Zooming to pandemics to explore absolute excess with CrI.  

```{r echo=FALSE}
focus_years <- c(1890, 1918, 1957, 2020)

shown_years = NULL
for(i in focus_years) {
  shown_years = bind_rows(shown_years,
                          tibble(Year=(i-2):(i+2),
                                 focus_year=i,
                                 shown_years=paste0(i-2,"-",min(2020,i+2))))
}
shown_years %<>% filter(Year <= 2021) %>% 
  mutate(shown_years = ifelse(shown_years == "2018-2020", 
                              "2018-2021", shown_years))
gg = results_month %>%
  bind_rows(
    read_rds("data/deaths_monthly.Rds") %>% 
      filter(Country == "Sweden" & Year == 2021 & Month < 7) %>% 
      select(Country, Year, Month, Date, Deaths)
  ) %>% 
  left_join(shown_years) %>%
  filter(!is.na(shown_years)) %>%
  mutate(Country = fct_relevel(factor(Country), 
                               "Switzerland", "Sweden", "Spain"), 
         Difference = ifelse(Deaths > pred, "More than expected", "Fewer than expected")) %>% 
  filter(!is.na(Difference)) %>%
    mutate(focus_year1 = as.Date(paste0(focus_year, "-01-01")),
         focus_year2 = as.Date(paste0(focus_year, "-12-31")),
         focus_year2 = if_else(focus_year==2020,as.Date(paste0(focus_year+1, "-06-30")),focus_year2)) %>%

  ggplot() +
  geom_rect(aes(xmin = focus_year1,
                xmax = focus_year2,
                ymin = -Inf, ymax = Inf), 
            fill = "grey90") +
  geom_col(aes(x=Date,y=Deaths,fill=Difference,color=Difference)) +
  geom_ribbon(aes(x=Date,ymin=lower,ymax=upper),fill="aquamarine3",alpha=.5) +
  geom_line(aes(x=Date,y=pred),colour="aquamarine4") +
  geom_point(data=shown_years,aes(x=as.Date(paste0(Year, "-01-01")),y=0),colour="transparent") +
  facet_grid(Country ~ shown_years,scales="free", spac="free_x") +
  scale_y_continuous(labels = label_number(accuracy = 1, suffix = "K", 
                                           scale = 1e-3)) +
  scale_x_date(date_breaks="2 years",date_labels = "%Y") +
  scale_fill_manual(values = c("#67A9CF", "#EF8A62"),
                    name = "Monthly deaths") +  
  scale_color_manual(values = c("#67A9CF", "#EF8A62"), guide = "none") +
  theme_bw()+
  theme(plot.margin = margin(0.5, 0.5, 0, 0),
        legend.position = c(.08, .12))+
  labs(x="Year",y="Monthly deaths")

# gg

require(grid)
g_data_grob = ggplotGrob(gg)

# View(g_data_grob$layout)
# gtable::gtable_show_layout(ggplotGrob(gg)) 

## remove unused facets
idx <- which(g_data_grob$layout$name %in% c("panel-3-1"))
for (i in idx) g_data_grob$grobs[[i]] <- nullGrob()

## move y axis right
# axis-l-1 needs to move 1 column to the right
idx <- which(g_data_grob$layout$name %in% c("axis-l-3"))
g_data_grob$layout[idx, c("l", "r")] <- g_data_grob$layout[idx, c("l", "r")] + 2

## move x axis up
# axis-b-1 needs to move 1 column up
idx <- which(g_data_grob$layout$name %in% c("axis-b-1"))
g_data_grob$layout[idx, c("t")] <- g_data_grob$layout[idx, c("t")] - 2

grid.newpage()
grid.draw(g_data_grob)

gg = ggplotify::as.ggplot(g_data_grob)

ggsave(plot = gg, "paper/Figure_2a.png", dpi = 300, width =  190, height = 140, units = "mm")
```

```{r echo=FALSE}
focus_years <- c(1890, 1918, 1957, 2020)

shown_years = NULL
for(i in focus_years) {
  shown_years = bind_rows(shown_years,
                          tibble(Year=(i-2):(i+2),
                                 focus_year=i,
                                 shown_years=paste0(i-2,"-",min(2020,i+2))))
}
shown_years %<>% filter(Year <= 2021) %>% 
  mutate(shown_years = ifelse(shown_years == "2018-2020", 
                              "2018-2021", shown_years))

gg = results_month %>%
  bind_rows(
    read_rds("data/deaths_monthly.Rds") %>% 
      filter(Country == "Sweden" & Year == 2021 & Month < 7) %>% 
      select(Country, Year, Month, Date, Deaths)
  ) %>% 
  left_join(shown_years) %>%
  filter(!is.na(shown_years)) %>%
  mutate(Country = fct_relevel(factor(Country), "Switzerland", "Sweden", "Spain")) %>% 
  filter(!(Country=="Sweden" & Year==2021)) %>%
  mutate(focus_year1 = as.Date(paste0(focus_year, "-01-01")),
         focus_year2 = as.Date(paste0(focus_year, "-12-31")),
         focus_year2 = if_else(focus_year==2020,as.Date(paste0(focus_year+1, "-06-30")),focus_year2)) %>%
  ggplot() +
  geom_rect(aes(xmin = focus_year1,
                xmax = focus_year2,
                ymin = -Inf, ymax = Inf), 
            fill = "grey90") +
  geom_ribbon(aes(x=Date,ymin=lower,ymax=upper),fill="aquamarine3",alpha=.5) +
  geom_line(aes(x=Date,y=pred),colour="aquamarine4") +
  geom_line(aes(x=Date,y=Deaths),colour="#EF8A62",size=0.5) +
  geom_point(data=shown_years,aes(x=as.Date(paste0(Year, "-01-01")),y=0),colour="transparent") +
  facet_grid(Country ~ shown_years,scales="free", spac="free_x") +
  scale_y_continuous(labels = label_number(accuracy = 1, suffix = "K", 
                                           scale = 1e-3)) +
  scale_x_date(date_breaks="2 years",date_labels = "%Y") +
  theme_bw()+
  theme(plot.margin = margin(0.5, 0.5, 0, 0))+
  labs(x="Year",y="Monthly deaths")

# gg

require(grid)
g_data_grob = ggplotGrob(gg)

# View(g_data_grob$layout)
# gtable::gtable_show_layout(ggplotGrob(gg)) 

## remove unused facets
idx <- which(g_data_grob$layout$name %in% c("panel-3-1"))
for (i in idx) g_data_grob$grobs[[i]] <- nullGrob()

## move y axis right
# axis-l-1 needs to move 1 column to the right
idx <- which(g_data_grob$layout$name %in% c("axis-l-3"))
g_data_grob$layout[idx, c("l", "r")] <- g_data_grob$layout[idx, c("l", "r")] + 2

## move x axis up
# axis-b-1 needs to move 1 column up
idx <- which(g_data_grob$layout$name %in% c("axis-b-1"))
g_data_grob$layout[idx, c("t")] <- g_data_grob$layout[idx, c("t")] - 2

grid.newpage()
grid.draw(g_data_grob)

gg = ggplotify::as.ggplot(g_data_grob)

ggsave(plot = gg, "paper/Figure_2b.png", dpi = 300, width =  190, height = 140, units = "mm")
```


```{r echo=FALSE}
pandemic_years <- c(1890, 1918, 1957, 2020, 2021)

results_month %>% 
  filter(Year %in% pandemic_years) %>%
  ggplot() +
  geom_pointrange(aes(x=Month,
                      y=excess_month/pred,
                      ymin=excess_month_lower/pred,
                      ymax=excess_month_upper/pred,
                      colour=factor(Country))) +
  geom_line(aes(x=Month,
                y=excess_month/pred,
                colour=factor(Country))) +
  geom_hline(yintercept=0,linetype=2) +
  facet_grid(.~Year,scale="free_x",spac="free_x") +
  scale_y_continuous(labels= label_number(accuracy = 1, suffix = "%", scale = 100)) +
  theme_bw() +
  scale_colour_manual(values=c("darkgoldenrod1","dodgerblue","firebrick2")) +
  scale_x_continuous(breaks=seq(1,12,by=2),
                     labels=c("Jan.","March","May","July","Sept.","Nov.")) +
  theme(legend.position = c(.1,.8),
        legend.background = element_blank(),
        axis.text.x = element_text(angle=45,hjust=1),
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x="Month",y="Excess deaths (relatively to expected)",
       colour="Country")
ggsave(plot = gg, "paper/Figure_2c.png", dpi = 300, width =  190, height = 140, units = "mm")
```


```{r echo=FALSE}
focus_years <- c(1890, 1918, 1957, 2020, 2021)

shown_years = NULL
for(i in focus_years) {
  shown_years = bind_rows(shown_years,
                          tibble(Year=(i-5):(i),
                                 focus_year=i,
                                 shown_years=paste0(i-5,"-",i)))
}
shown_years %<>% filter(Year <= 2021) %>% 
  mutate(shown_years = ifelse(shown_years == "2018-2020", 
                              "2018-2021", shown_years))

gg = results_month %>%
  bind_rows(
    read_rds("data/deaths_monthly.Rds") %>% 
      filter(Country == "Sweden" & Year == 2021 & Month < 7) %>% 
      select(Country, Year, Month, Date, Deaths)
  ) %>% 
  left_join(shown_years) %>%
  filter(!is.na(shown_years)) %>%
  mutate(Country = fct_relevel(factor(Country), "Switzerland", "Sweden", "Spain")) %>% 
  filter(!(Country=="Sweden" & Year==2021)) %>%
  mutate(pandyear=ifelse(Year %in% c(1890, 1918, 1957, 2020, 2021),"Pandemic year","Normal year")) %>%
  mutate(lower=ifelse(Year==focus_year,lower,NA),
         upper=ifelse(Year==focus_year,upper,NA)) %>%
  ggplot() +
  geom_ribbon(aes(x=Month,ymin=lower,ymax=upper,group=Year),fill="aquamarine3",alpha=.5) +
  geom_line(aes(x=Month,y=Deaths,group=Year,colour=pandyear,size=pandyear)) +
  geom_point(aes(x=Month,y=Deaths,group=Year,colour=pandyear,size=pandyear)) +
  # geom_line(aes(x=Month,y=Deaths,group=Year),colour="#EF8A62",size=0.5) +
  geom_point(data=shown_years,aes(x=1,y=0),colour="transparent") +
  facet_grid(Country ~ shown_years,scales="free", spac="free_x") +
  scale_y_continuous(labels = label_number(accuracy = 1, suffix = "K", 
                                           scale = 1e-3)) +
  scale_x_continuous(breaks=seq(1,12,by=2),
                     labels=c("Jan.","March","May","July","Sept.","Nov.")) +
  scale_size_manual(values=c(.2,.8),guide=FALSE) +
  scale_colour_manual(values=c("grey20","#EF8A62"),guide=FALSE) +
    theme_bw()+
  theme(plot.margin = margin(0.5, 0.5, 0, 0))+
  labs(x="Year",y="Monthly deaths")

gg

require(grid)
g_data_grob = ggplotGrob(gg)

# View(g_data_grob$layout)
# gtable::gtable_show_layout(ggplotGrob(gg)) 

## remove unused facets
idx <- which(g_data_grob$layout$name %in% c("panel-3-1"))
for (i in idx) g_data_grob$grobs[[i]] <- nullGrob()

## move y axis right
# axis-l-1 needs to move 1 column to the right
idx <- which(g_data_grob$layout$name %in% c("axis-l-3"))
g_data_grob$layout[idx, c("l", "r")] <- g_data_grob$layout[idx, c("l", "r")] + 2

## move x axis up
# axis-b-1 needs to move 1 column up
idx <- which(g_data_grob$layout$name %in% c("axis-b-1"))
g_data_grob$layout[idx, c("t")] <- g_data_grob$layout[idx, c("t")] - 2

grid.newpage()
grid.draw(g_data_grob)

gg = ggplotify::as.ggplot(g_data_grob)

ggsave(plot = gg, "paper/Figure_2d.png", dpi = 300, width =  190, height = 140, units = "mm")
```



## Figure 3

Age differences across major pandemics

```{r echo=FALSE}
pandemic_years <- c(1890, 1918, 1957, 2020, 2021)

deaths_yearly_age_sex <- read_rds("data/deaths_yearly_age_sex.Rds")

results_age %>% 
  filter(Year %in% pandemic_years) %>%
  mutate(Age_cat2=as.numeric(Age_cat)) %>%
  left_join(deaths_yearly_age_sex) %>%
  ggplot() +
  geom_pointrange(aes(x=Age_cat2,
                      y=excess_year/pred,
                      ymin=excess_year_lower/pred,
                      ymax=excess_year_upper/pred,
                      colour=factor(Country))) +
  geom_line(aes(x=Age_cat2,
                y=excess_year/pred,
                colour=factor(Country))) +
  geom_hline(yintercept=0,linetype=2) +
  facet_wrap(~Year,nrow=1) +
  scale_x_continuous(labels=unique(as.character(results_age$Age_cat)),
                     breaks=1:10) +
  scale_y_continuous(labels= label_number(accuracy = 1, suffix = "%", scale = 100)) +
  theme_bw() +
  scale_colour_manual(values=c("darkgoldenrod1","dodgerblue","firebrick2")) +
  # coord_cartesian(ylim=c(-0.02,.07)) +
  labs(x="Year",y="Montly deaths") +
  theme(legend.position = c(.1,.8),
        legend.background = element_blank(),
        axis.text.x = element_text(angle=45,hjust=1),
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x="Age group",y="Excess deaths (relatively to expected)",
       colour="Country")

ggsave("paper/Figure_3.png", dpi = 300, width = 200, height = 100, units = "mm")
```

<!-- ----------------------------------------------------- -->

# Appendix 

## Table S1

Comparing estimates of excess from different methods

```{r echo=FALSE}
pandemic_years <- c(1890, 1918, 1957, 2020, 2021)

table_s1 <- bind_rows(
  
  # needs all models
  
  # global serfling model without CrI
  read_rds("data/outputs_2021-08-02-local/All_results_month.Rds") %>% 
    select(Country, Year, Model, excess_month) %>% 
    group_by(Country, Year, Model) %>% 
    summarise(excess_year = sum(excess_month)) %>% 
    ungroup() %>% 
    mutate(excess_year_lower = NA_real_,
           excess_year_upper = NA_real_),
  
  # 2021
  read_rds("data/outputs_2021-08-25/All_results_month.Rds") %>% 
    select(Country, Year, Model, excess_month) %>% 
    group_by(Country, Year, Model) %>% 
    summarise(excess_year = sum(excess_month, na.rm = TRUE)) %>% 
    ungroup() %>% 
    mutate(excess_year_lower = NA_real_,
           excess_year_upper = NA_real_),
  
  # remaining three
  bind_rows(
    read_rds("data/outputs_2021-08-02-local/Switzerland_results_year.Rds"), 
    read_rds("data/outputs_2021-08-02-local/Sweden_results_year.Rds"), 
    read_rds("data/outputs_2021-08-02-local/Spain_results_year.Rds"),
    
    read_rds("data/outputs_2021-08-25/Switzerland_results_year.Rds"), 
    read_rds("data/outputs_2021-08-25/Sweden_results_year.Rds"), 
    read_rds("data/outputs_2021-08-25/Spain_results_year.Rds")
  ) %>% 
    select(Country, Year, Model, starts_with("excess_"))
  
) %>% 
  filter(Year %in% c(pandemic_years, pandemic_years - 1, pandemic_years + 1)) %>% 
  arrange(desc(Country), Year, Model) %>% 
  # mutate(Model = str_remove(Model, fixed(" (Stan, NB)"))) %>% 
  pivot_wider(names_from = Model, 
              values_from = starts_with("excess_"),
              names_sort = FALSE) %>% 
  relocate(Country, Year,
           `excess_year_Global Serfling`, 
           `excess_year_lower_Global Serfling`, 
           `excess_year_upper_Global Serfling`,
           `excess_year_Global Serfling (Stan, NB)`, 
           `excess_year_lower_Global Serfling (Stan, NB)`,
           `excess_year_upper_Global Serfling (Stan, NB)`,
           `excess_year_Age Serfling (Stan, NB)`, 
           `excess_year_lower_Age Serfling (Stan, NB)`, 
           `excess_year_upper_Age Serfling (Stan, NB)`) %>% 
  select(-`excess_year_lower_Global Serfling`, -`excess_year_upper_Global Serfling`,
  )
```

```{r echo=FALSE}
table_s1 %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  # add_header_above(c(" " = 1, "Group 1" = 2, "Group 2" = 2, "Group 3" = 2)) %>%
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)

openxlsx::write.xlsx(table_s1, "paper/Table_S1.xlsx", 
                     row.names = FALSE, overwrite = TRUE)
```

## Figure S1 

Yearly estimates of excess; **2021 not included since not full year**.  

```{r echo=FALSE}
hline_pandemic <- results_year %>% 
  filter(Year == 2020) %>% 
  group_by(Country) %>% 
  summarise(yintercept = max(excess_year)) %>% 
  ungroup()

vline_pandemic <- tibble(Year=c(1890,1918,1957,1968,1977,2009,2020)) 

results_year %>% 
  mutate(Difference = ifelse(excess_year > 0, "More than expected", "Less than expected")) %>% 
  ggplot(aes(x = Year)) +
  geom_vline(data = vline_pandemic, 
             aes(xintercept = Year), 
             size = 3, colour = "grey90", alpha = 0.7) +  
  geom_hline(data = hline_pandemic, aes(yintercept = yintercept), 
             colour = "#984ea3", size = 0.25) +
  geom_hline(yintercept = 0, colour = "grey80") +
  geom_col(aes(y = excess_year, fill = Difference)) +
  scale_x_continuous(
    breaks = c(1860, 1890, 1918, 1957, 1968, 1977, 2009, 2020),
    limits = c(1856-1, 2020+1),
    expand = c(0, 0)) +
  scale_fill_manual(values = c("#67A9CF", "#EF8A62")) +  
  facet_grid(vars(Country), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 1L, suffix = "K", scale = 1e-4)) +
  theme_bw() +
  theme(
    # panel.grid.major = element_blank(), 
    # panel.grid.minor = element_blank(),
    panel.background = element_blank(), 
    axis.line = element_line(colour = "grey40"),
    axis.ticks = element_line(),
    legend.position = c(.10, .95),
    legend.background = element_blank(),
    legend.title = element_blank(),
    plot.margin = margin(0.5, 0.5, 0, 0)) +
  xlab("") + ylab("Yearly excess deaths") +
  guides(fill = guide_legend(reverse = TRUE)) 

rm(vline_pandemic, hline_pandemic)

ggsave("paper/Figure_S1.png", dpi = 300, width = 190, height = 140, units = "mm")
```

## Figure S2

Zooming to pandemics to explore % of excess

```{r echo=FALSE}
plot_years <- c(seq(1890 - 1, 1890 + 2),
                seq(1918 - 1, 1918 + 2),
                seq(1957 - 1, 1957 + 2),
                seq(2020 - 1, 2020 + 2))

plot_data <- results_month %>% 
  bind_rows(
    read_rds("data/deaths_monthly.Rds") %>% 
      filter(Country == "Sweden" & Year == 2021 & Month < 7) %>% 
      select(Country, Year, Month, Date, Deaths)
  ) %>% 
  filter(Year %in% plot_years) %>% 
  mutate(Percent = (excess_month / pred),
         Difference = ifelse(Percent > 0, "More", "Less"),
         Country = fct_relevel(factor(Country), 
                               "Switzerland", "Sweden", "Spain")) %>% 
  group_by(Country, Pandemic) %>% 
  mutate(time = row_number()) %>% 
  ungroup() %>% 
  filter(!is.na(Pandemic))

plot_data %>% 
  mutate(xmin = as.Date(paste0(Pandemic, "-01-01")),
         xmax = as.Date(paste0(Pandemic, "-12-31"))) %>% 
  ggplot(aes(x = time)) +
  geom_hline(yintercept = 0, colour = "grey60") +
  geom_vline(xintercept = 13, colour = "grey80") +
  geom_vline(xintercept = 24, colour = "grey80") +
  geom_rect(aes(xmin = 13, xmax = 24,
                ymin = -Inf, ymax = Inf),
            fill = "grey90", alpha = 0.7, inherit.aes = FALSE) +
  geom_col(aes(y = Percent, fill = Difference), size = 0.5) +
  facet_grid(vars(Country), vars(Pandemic), scales = "free") + 
  scale_x_continuous(limits = c(min(plot_data$time)-1, max(plot_data$time)+1),
                     breaks = c(1, 13, 24, 36, 48), 
                     labels = c("-12m", "Start", "End", "+12m", "+24m")) +
  xlab("") + 
  ylab("% above predicted Deaths") +
  ggtitle("Excess deaths as % of observed") +
  scale_y_continuous(labels = percent) +
  scale_fill_manual(values = c("#67A9CF", "#EF8A62")) +  
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_line(), 
        panel.grid.minor.y = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey40"),
        plot.margin = margin(0.5, 0.5, 0, 0)) 

ggsave("paper/Figure_S2.png", dpi = 300, width = 297, height = 210, units = "mm")

rm(plot_years)
```

## Figure S3

Impact of extremes: using 1918 pandemic as an example of impact on estimates from 1919 - 1923.  
Estimates with extreme year (blue) and without (red).  
Converge after 5 year smoothing window stops having effect (ie. in 1924).  

### Figure 1918

```{r echo=FALSE}
extreme_data <- 
  left_join(
    
    results_month %>% 
      select(Country, Year, Month, Date, Deaths, pred, lower, upper),
    
    results_month_pand %>% 
      select(Country, Year, Month, pred, lower, upper) %>% 
      rename(pred_pand = pred,
             lower_pand = lower, upper_pand = upper)
    
  ) %>% 
  filter(Year >= 1918 & Year <= 1924) 

extreme_data %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Deaths), colour = "grey60") + 
  # with pandemics
  geom_ribbon(aes(ymin = lower_pand, ymax = upper_pand),
              alpha = 0.1, fill = "#67A9CF") +
  geom_line(aes(y = pred_pand), colour = "#67A9CF") +
  # without
  geom_ribbon(aes(ymin = lower, ymax = upper), 
              alpha = 0.1, fill = "#EF8A62") + 
  geom_line(aes(y = pred), colour = "#EF8A62") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  # coord_cartesian(ylim = c(NA, 100000)) + 
  xlab("") + ylab("Number of Deaths") + 
  facet_grid(vars(Country), scales = "free_y") + 
  theme_bw() + 
  theme(plot.margin = margin(0.5, 0.5, 0, 0))

ggsave("paper/Figure_S3a.png", dpi = 300, width = 297, height = 210, units = "mm")
```

### Table 1918

Using 1918 pandemic as an example of impact on estimates from 1919.   

```{r echo=FALSE}
extreme_data %<>% 
  filter(Year == 1919) %>% 
  select(-lower, -upper, -lower_pand, -upper_pand, 
         -Date, -Year) %>% 
  mutate(diff_1 = Deaths - pred,
         diff_2 = Deaths - pred_pand) %>% 
  relocate(diff_1, .after = pred) 

extreme_data %>% 
  kbl(col.names = c("Country", "Month", "Observed", 
                    "Predicted", "Difference",
                    "Predicted (pandemic)", "Difference")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  column_spec(5, color = ifelse(extreme_data$diff_1 > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  column_spec(7, color = ifelse(extreme_data$diff_2 > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  row_spec(1, italic = FALSE) %>% 
  add_header_above(c(" " = 3, "Including 1918" = 2, "Excluding 1918" = 2)) %>%
  # collapse not working; issue filled on github
  collapse_rows(columns = 1, valign = "top")
```

### Figure 2020

```{r echo=FALSE}
extreme_data <- 
  left_join(
    
    results_month %>% 
      select(Country, Year, Month, Date, Deaths, pred, lower, upper),
    
    results_month_pand %>% 
      select(Country, Year, Month, pred, lower, upper) %>% 
      rename(pred_pand = pred,
             lower_pand = lower, upper_pand = upper)
    
  ) %>% 
  filter(Year >= 2020) %>% 
  filter(Country != "Sweden")

extreme_data %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Deaths), colour = "grey60") + 
  # with pandemics
  geom_ribbon(aes(ymin = lower_pand, ymax = upper_pand),
              alpha = 0.1, fill = "#67A9CF") +
  geom_line(aes(y = pred_pand), colour = "#67A9CF") +
  # without
  geom_ribbon(aes(ymin = lower, ymax = upper), 
              alpha = 0.1, fill = "#EF8A62") + 
  geom_line(aes(y = pred), colour = "#EF8A62") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  # coord_cartesian(ylim = c(NA, 100000)) + 
  xlab("") + ylab("Number of Deaths") + 
  facet_grid(vars(Country), scales = "free_y") + 
  theme_bw() + 
  theme(plot.margin = margin(0.5, 0.5, 0, 0))

ggsave("paper/Figure_S3b.png", dpi = 300, width = 297, height = 210, units = "mm")
```

### Table 2021

Using 2021 pandemic as an example of impact on estimates from 2020   

```{r echo=FALSE}
extreme_data %<>% 
  filter(Year == 2021) %>% 
  select(-lower, -upper, -lower_pand, -upper_pand, 
         -Date, -Year) %>% 
  mutate(diff_1 = Deaths - pred,
         diff_2 = Deaths - pred_pand) %>% 
  relocate(diff_1, .after = pred) %>% 
  filter(Country != "Sweden")

extreme_data %>% 
  kbl(col.names = c("Country", "Month", "Observed", 
                    "Predicted", "Difference",
                    "Predicted (pandemic)", "Difference")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  column_spec(5, color = ifelse(extreme_data$diff_1 > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  column_spec(7, color = ifelse(extreme_data$diff_2 > 0, 
                                "#EF8A62", "#67A9CF")) %>% 
  row_spec(1, italic = FALSE) %>% 
  add_header_above(c(" " = 3, "Including 1918" = 2, "Excluding 1918" = 2)) %>%
  # collapse not working; issue filled on github
  collapse_rows(columns = 1, valign = "top")
```

## Pandemic compared to last year {.tabset}

**2021 not included yet since not a full year!**  

```{r echo=FALSE}
pandemic_years <- c(1890, 1918, 1957, 2020)

analysis_years <- c(seq(1890 - 10, 1890),
                    seq(1918 - 10, 1918),
                    seq(1957 - 10, 1957),
                    seq(2020 - 10, 2020))

previous_years <- c(seq(1890 - 10, 1890 - 1),
                    seq(1918 - 10, 1918 - 1),
                    seq(1957 - 10, 1957 - 1),
                    seq(2020 - 10, 2020 - 1))

age_plot_data <- 
  results_age %>% 
  filter(Year %in% analysis_years) %>% 
  mutate(Type = ifelse(Year %in% previous_years, "Previous", "")) %>% 
  mutate(Type = ifelse(Year %in% pandemic_years, "Pandemic", Type)) %>%  
  arrange(Country, Year, Age_cat) %>% 
  mutate(Pandemic = ifelse(Year %in% pandemic_years, Year, NA)) %>% 
  fill(Pandemic, .direction = "up") 

previous <- pandemic_years - 1

data_year <- left_join(
  
  age_plot_data %>% 
    filter(Type == "Pandemic") %>% 
    select(Pandemic, Year, Country, Age_cat, Deaths) %>% 
    rename(Deaths_pandemic = Deaths),
  
  age_plot_data %>% 
    filter(Year %in% previous) %>% 
    select(Pandemic, Year, Country, Age_cat, Deaths) %>% 
    rename(Deaths_previous = Deaths) %>% 
    mutate(Year = Year + 1)
  
) %>% 
  mutate(Exc = Deaths_pandemic - Deaths_previous,
         Exc_perc = (Deaths_pandemic - Deaths_previous) / Deaths_previous)

```

### Absolute

```{r echo=FALSE}
ggplot(data = data_year,
       aes(x = Age_cat, y = Exc)) + 
  geom_col() +
  facet_grid(rows = vars(Country), cols = vars(Pandemic), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 0.1, suffix = "K", scale = 1e-4)) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Age group") + 
  ylab("Absolute difference in deaths to previous year")
```

### Relative

```{r echo=FALSE}
ggplot(data = data_year,
       aes(x = Age_cat, y = Exc_perc)) + 
  geom_col() +
  facet_grid(rows = vars(Country), cols = vars(Pandemic)) + 
  scale_y_continuous(labels = percent) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Age group") + 
  ylab("% difference in deaths to previous year")
```

## Comparing to BfS estimates

Data from BfS prepared in `03`. No CI included in comparisons since different age groups are used.  

```{r echo=FALSE}
excess_2010_2020 <- 
  left_join(
    # official counts
    read_rds("data/BfS/excess_2010_2020.Rds") %>% 
      rename(Excess_BfS = Excess_expected),
    
    # our estimates
    results_year %>% 
      filter(Country == "Switzerland") %>% 
      select(Year, excess_year) %>% 
      rename(Excess_modelled = excess_year)
  ) %>% 
  mutate(Difference = Excess_modelled - Excess_BfS)
```

```{r echo=FALSE}
excess_2010_2020 %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE) %>% 
  column_spec(4, color = ifelse(excess_2010_2020$Difference > 0, 
                                "#EF8A62", "#67A9CF"))
```

<!-- ----------------------------------------------------- -->

# Model diagnostics

## Rhat

Check that all values <1.1

```{r}
summary(results_month[results_month$Model != "Global Serfling", ]$Rhat) 
```

## ESS

Check that all effective sample sizes are large

```{r}
summary(results_month[results_month$Model != "Global Serfling", ]$n_eff) 
```

## Model agreement

Example of last year  

```{r echo=FALSE}
bind_rows(
  read_rds("data/outputs_2021-08-02-local/All_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Switzerland_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Sweden_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Spain_results_month.Rds")
) %>%  
  filter(Year == 2020) %>% 
  ggplot() +
  geom_pointrange(aes(x=Month, y=excess_month, 
                      ymin=excess_month_lower, ymax=excess_month_upper,
                      colour=Model),
                  position=position_dodge(.8)) +
  facet_grid(Country~Year, scales="free")
```

And 1918  

```{r echo=FALSE}
bind_rows(
  read_rds("data/outputs_2021-08-02-local/All_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Switzerland_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Sweden_results_month.Rds"), 
  read_rds("data/outputs_2021-08-02-local/Spain_results_month.Rds")
) %>%  
  filter(Year == 1918) %>% 
  ggplot() +
  geom_pointrange(aes(x=Month, y=excess_month, 
                      ymin=excess_month_lower, ymax=excess_month_upper,
                      colour=Model),
                  position=position_dodge(.8)) +
  facet_grid(Country~Year, scales="free")
```

## Check age

```{r echo=FALSE}
results_age %>% 
  filter(Year >= 2010) %>% 
  ggplot() +
  geom_pointrange(aes(x=Year, y=excess_year,
                      ymin=excess_year_lower, ymax=excess_year_upper),
                  position=position_dodge(.8)) +
  facet_grid(Country~Age_cat)
```

```{r echo=FALSE}
results_age %>% 
  filter(Year >= 1914 & Year <= 1922) %>% 
  ggplot() +
  geom_pointrange(aes(x=Year, y=excess_year,
                      ymin=excess_year_lower, ymax=excess_year_upper),
                  position=position_dodge(.8)) +
  facet_grid(Country~Age_cat)
```

<!-- ----------------------------------------------------- -->

```{r echo=FALSE, eval=FALSE}
# Alt Fig 3
ggplot(data = age_plot_data %>% 
         filter(Type == "Previous"),
       aes(x = Age_cat)) + 
  
  # observed from previous decade
  geom_boxplot(aes(y = Deaths,
                   fill = "grey"), 
               color = "grey", alpha = 0.25) +
  geom_jitter(aes(y = Deaths), 
              color = "black", size = 0.5, alpha = 0.5) +
  
  # modelled 67A9CF
  geom_ribbon(data = age_plot_data %>% 
                filter(Type == "Pandemic"),
              aes(ymin = lower, ymax = upper, group = Year), 
              alpha = 0.1, fill = "#67A9CF") + 
  geom_line(data = age_plot_data %>% 
              filter(Type == "Pandemic"),
            aes(y = pred, group = Year, colour = "#67A9CF")) +
  
  # observed EF8A62
  geom_line(data = age_plot_data %>% 
              filter(Type == "Pandemic"), 
            aes(y = Deaths, group = Year,
                colour = "#EF8A62")) +
  
  facet_grid(rows = vars(Country), cols = vars(Pandemic), scales = "free_y") + 
  scale_y_continuous(labels = label_number(accuracy = 0.1, suffix = "K", scale = 1e-4)) +
  scale_fill_manual(name = NULL,
                    values = c("grey" = "grey"), 
                    labels = c("Observed \n(Last \n10 years)"), 
                    guide = "legend") +  
  scale_colour_manual(name = "Deaths",
                      values = c("#67A9CF" = "#67A9CF",
                                 "#EF8A62" = "#EF8A62"), 
                      labels = c("Expected \n(Last \n5 years)",
                                 "Observed"), 
                      guide = "legend") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey40"),
        axis.ticks = element_line(),
        axis.text.x = element_text(angle = 90)) +
  xlab("Age group") + labs(colour = "Age group") +
  guides(fill = guide_legend(order = 2),
         colour = guide_legend(order = 1))

# ggsave("paper/Figure_3.png", dpi = 300, width = 297, height = 210, units = "mm")
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`
---
title: "Excess mortality: monthly data & `surveillance` package"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

options(scipen=999)
set.seed(12345)

library(pacman)
p_load(tidyverse, scales, kableExtra, surveillance)

options(max.print = "75")
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Monthly number of deaths, 1877 onwards

```{r include=FALSE}
bfs_web_pop_yearly <- read_rds("data/BfS/bfs_web_pop_yearly.Rds") %>% 
  filter(year >= 1877)

bfs_web_deaths_monthly <- read_rds("data/BfS/bfs_web_deaths_monthly.Rds") %>% 
  filter(year >= 1877) %>% 
  select(-deaths_year) %>% 
  left_join(bfs_web_pop_yearly)

rm(bfs_web_pop_yearly)
```

Population is available till 2019 only. 2020 figures are borrowed from COVID mionitoring website from BAG and described in `00.Rmd`. 

```{r}
population <- read_rds("data/BAG/population.rds") %>% 
  filter(canton != "FL")

sum(population$Population)

bfs_web_deaths_monthly <- bfs_web_deaths_monthly %>% 
  mutate(pop_dec = if_else(year == 2020, sum(population$Population), pop_dec))

rm(population)
```

Deaths per 100k

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  # filter(Year >= 2015) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = (deaths_month/pop_dec) * 100000)) + 
  theme_minimal() + 
  scale_y_continuous(labels = comma) +
  ylab("") + xlab("Deaths per 100k")
```

# Data structure

Package works with `srs` - *surveillance time series* objects.  

In contrast to solution from `05.Rmd` we now use proper dates & population denominator

```{r}
deaths_sts <- sts(observed = bfs_web_deaths_monthly$deaths_month,
                  epoch = as.numeric(bfs_web_deaths_monthly$date),
                  start = c(1877, 1), 
                  frequency = 12,
                  population = as.matrix(bfs_web_deaths_monthly$pop_dec),
                  epochAsDate = TRUE,
                  multinomialTS = TRUE)
```

Also selecting indices of observations for periods of interest.

```{r}
in1890 <- which(bfs_web_deaths_monthly$date >= as.Date("1889-12-01") & 
                  bfs_web_deaths_monthly$date <= as.Date("1891-01-01"))

in1918 <- which(bfs_web_deaths_monthly$date >= as.Date("1918-06-01") & 
                  bfs_web_deaths_monthly$date <= as.Date("1919-06-01"))

in1968 <- which(bfs_web_deaths_monthly$date >= as.Date("1967-12-01") & 
                  bfs_web_deaths_monthly$date <= as.Date("1969-06-01"))

in2015 <- which(bfs_web_deaths_monthly$date >= as.Date("2014-12-01") & 
                  bfs_web_deaths_monthly$date <= as.Date("2016-06-01"))

in2020 <- which(bfs_web_deaths_monthly$date >= as.Date("2020-01-01"))
```

# Two methods 

## 1890 {.tabset}

### `farringtonFlexible` improved method

```{r}
control2 <- list(range = in1890, 
                 noPeriods = 10, b = 10, w = 2,
                 weightsThreshold = 2.58, 
                 pastWeeksNotIncluded = 2,
                 pThresholdTrend = 1, 
                 thresholdMethod = "nbPlugin")

noufaily <- farringtonFlexible(deaths_sts, control2)
```

```{r echo=FALSE}
plot(noufaily, main = "", legend.opts = list(x = "topright"))
```

### `farringtonFlexible` original method

```{r}
control1 <- list(range = in1890, 
                 noPeriods = 1, b = 10, w = 2,
                 weightsThreshold = 1, 
                 pastWeeksNotIncluded = 2,
                 pThresholdTrend = 0.05, 
                 thresholdMethod = "nbPlugin")

farrington <- farringtonFlexible(deaths_sts, control1)
```

```{r echo=FALSE}
plot(farrington, main = "", legend.opts = list(x = "topright"))
```

## 1918 {.tabset}

### `farringtonFlexible` improved method

```{r}
control2 <- list(range = in1918, 
                 noPeriods = 10, b = 10, w = 2,
                 weightsThreshold = 2.58, 
                 pastWeeksNotIncluded = 2,
                 pThresholdTrend = 1, 
                 thresholdMethod = "nbPlugin")

noufaily <- farringtonFlexible(deaths_sts, control2)
```

```{r echo=FALSE}
plot(noufaily, main = "", legend.opts = list(x = "topright"))
```

### `farringtonFlexible` original method

```{r}
control1 <- list(range = in1918, 
                 noPeriods = 1, b = 10, w = 2,
                 weightsThreshold = 1, 
                 pastWeeksNotIncluded = 2,
                 pThresholdTrend = 0.05, 
                 thresholdMethod = "nbPlugin")

farrington <- farringtonFlexible(deaths_sts, control1)
```

```{r echo=FALSE}
plot(farrington, main = "", legend.opts = list(x = "topright"))
```

### `boda` method

```{r}
control_boda <- list(range = in1918, 
                     X = NULL, trend = TRUE, season = TRUE, 
                     prior = "iid", alpha = 0.025, 
                     mc.munu = 10000, mc.y = 1000)

boda <- boda(deaths_sts, control = control_boda)
```

```{r echo=FALSE}
plot(boda, main = "", legend.opts = list(x = "topleft"))
```

### Comparing 'alarms' of different methods


`combineSTS` function is available [here](https://r-forge.r-project.org/scm/viewvc.php/pkg/vignettes/monitoringCounts.Rnw?view=markup&root=surveillance&sortby=author&pathrev=2292)  


```{r}
combineSTS <- function(stsList) {
  epoch <- as.numeric(epoch(stsList[[1]]))
  observed <- NULL
  alarm <- NULL
  for (i in 1:length(stsList)) {
    observed <- cbind(observed,observed(stsList[[i]]))
    alarm <- cbind(alarm,alarms(stsList[[i]]))
  }
  colnames(observed) <- colnames(alarm) <- names(stsList)
  res <- sts(epoch=as.numeric(epoch), epochAsDate=TRUE,
             observed=observed, alarm=alarm)
  return(res)
}

compare <- combineSTS(list(boda = boda, farrington = farrington, farringtonFlexible = noufaily))

# might need tinkering with margins
# par(mar = c(4, 8, 2.1, 2))

plot(compare, type = alarm ~ time)
```

## 1968 {.tabset}

### `farringtonFlexible` improved method

```{r}
control2 <- list(range = in1968, 
                 noPeriods = 10, b = 10, w = 2,
                 weightsThreshold = 2.58, 
                 pastWeeksNotIncluded = 2,
                 pThresholdTrend = 1, 
                 thresholdMethod = "nbPlugin")

noufaily <- farringtonFlexible(deaths_sts, control2)
```

```{r echo=FALSE}
plot(noufaily, main = "", legend.opts = list(x = "topright"))
```

### `farringtonFlexible` original method

```{r}
control1 <- list(range = in1968, 
                 noPeriods = 1, b = 10, w = 2,
                 weightsThreshold = 1, 
                 pastWeeksNotIncluded = 2,
                 pThresholdTrend = 0.05, 
                 thresholdMethod = "nbPlugin")

farrington <- farringtonFlexible(deaths_sts, control1)
```

```{r echo=FALSE}
plot(farrington, main = "", legend.opts = list(x = "topright"))
```

## 2015 {.tabset}

### `farringtonFlexible` improved method

```{r}
control2 <- list(range = in2015, 
                 noPeriods = 10, b = 10, w = 2,
                 weightsThreshold = 2.58, 
                 pastWeeksNotIncluded = 2,
                 pThresholdTrend = 1, 
                 thresholdMethod = "nbPlugin")

noufaily <- farringtonFlexible(deaths_sts, control2)
```

```{r echo=FALSE}
plot(noufaily, main = "", legend.opts = list(x = "topright"))
```

### `farringtonFlexible` original method

```{r}
control1 <- list(range = in2015, 
                 noPeriods = 1, b = 10, w = 2,
                 weightsThreshold = 1, 
                 pastWeeksNotIncluded = 2,
                 pThresholdTrend = 0.05, 
                 thresholdMethod = "nbPlugin")

farrington <- farringtonFlexible(deaths_sts, control1)
```

```{r echo=FALSE}
plot(farrington, main = "", legend.opts = list(x = "topright"))
```

## 2020 {.tabset}

### `farringtonFlexible` improved method

```{r}
control2 <- list(range = in2020, 
                 noPeriods = 10, b = 10, w = 2,
                 weightsThreshold = 2.58, 
                 pastWeeksNotIncluded = 2,
                 pThresholdTrend = 1, 
                 thresholdMethod = "nbPlugin")

noufaily <- farringtonFlexible(deaths_sts, control2)
```

```{r echo=FALSE}
plot(noufaily, main = "", legend.opts = list(x = "topleft"))
```

### `farringtonFlexible` original method

```{r}
control1 <- list(range = in2020, 
                 noPeriods = 1, b = 10, w = 2,
                 weightsThreshold = 1, 
                 pastWeeksNotIncluded = 2,
                 pThresholdTrend = 0.05, 
                 thresholdMethod = "nbPlugin")

farrington <- farringtonFlexible(deaths_sts, control1)
```

```{r echo=FALSE}
plot(farrington, main = "", legend.opts = list(x = "topleft"))
```

```{r eval=FALSE, include=FALSE}
noufaily@epoch
noufaily@freq
noufaily@start
noufaily@state
noufaily@alarm
noufaily@observed
noufaily@upperbound

noufaily@observed - noufaily@upperbound

noufaily@control$score
noufaily@control$pvalue
noufaily@control$expected
noufaily@control$score
```



<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`
---
title: "Excess mortality: weekly & monthly BfS data & `surveillance` package in 2015"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

options(scipen=999)
set.seed(12345)

library(pacman)
p_load(tidyverse, scales, surveillance)

options(max.print = "75")
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html

combineSTS <- function(stsList) {
  epoch <- as.numeric(epoch(stsList[[1]]))
  observed <- NULL
  alarm <- NULL
  for (i in 1:length(stsList)) {
    observed <- cbind(observed,observed(stsList[[i]]))
    alarm <- cbind(alarm,alarms(stsList[[i]]))
  }
  colnames(observed) <- colnames(alarm) <- names(stsList)
  res <- sts(epoch=as.numeric(epoch), epochAsDate=TRUE,
             observed=observed, alarm=alarm)
  return(res)
}
```

<!-- ----------------------------------------------------- -->

# 2015

We choose 2015 as a year to test different approaches to calculate excess deaths due to unusually high flu and summer heatwave deaths.

![](../misc/2015.png)
[Graph source](https://www.bfs.admin.ch/bfs/en/home/statistics/health/state-health/mortality-causes-death.assetdetail.317313.html).  
[Press release](https://www.bfs.admin.ch/bfs/en/home/statistics/health/state-health/mortality-causes-death.assetdetail.3742838.html).  

<!-- ----------------------------------------------------- -->

# Data 

## Monthly number of deaths, 1877 onwards

Prepared in `02.Rmd`.  

```{r include=FALSE}
bfs_web_pop_yearly <- read_rds("data/BfS/bfs_web_pop_yearly.Rds") 

bfs_web_deaths_monthly <- read_rds("data/BfS/bfs_web_deaths_monthly.Rds") %>% 
  filter(year >= 1877) %>% 
  filter(year <= 2016) %>% 
  select(-deaths_year) %>% 
  left_join(bfs_web_pop_yearly)

```

Deaths per 100k

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  filter(year >= 2014) %>%
  ggplot(aes(x = date)) +
  geom_rect(aes(xmin = as.Date("2015-01-01"), xmax = as.Date("2015-12-31"), 
                ymin = -Inf, ymax = Inf), alpha = 0.005) +
  geom_line(aes(y = (deaths_month/pop_dec) * 100000)) + 
  theme_minimal() + 
  scale_y_continuous(labels = comma) +
  xlab("") + ylab("Deaths per 100k")
```

## Weekly number of deaths, 2010 onwards

Prepared in `03.Rmd`.  

**We need pops split by binary age!**  

```{r echo=FALSE}
weekly_2010_2019 <- read_rds("data/BfS/weekly_CH_2010-2019.Rds") %>% 
  filter(Year <= 2016)
# left_join(bfs_web_pop_yearly, by = c("Year" = "year"))

weekly_2010_2019 %>% 
  filter(Year >= 2014) %>%
  filter(Year <= 2016) %>% 
  ggplot(aes(x = Ending)) +
  geom_rect(aes(xmin = as.Date("2015-01-01"), xmax = as.Date("2015-12-31"), 
                ymin = -Inf, ymax = Inf), alpha = 0.005, inherit.aes = FALSE) +
  geom_ribbon(aes(ymin = lowerB, ymax = upperB, fill = Age), alpha = 0.1) +
  geom_line(aes(y = Expected, group = Age), colour = "gray60") + 
  geom_line(aes(y = NumberOfDeaths, colour = Age)) + 
  theme_minimal()
```

<!-- ----------------------------------------------------- -->

# `sts` data structure

Package works with `sts` - *surveillance time series* objects.  

## Monthly data

Not using population to match results from BfS.

```{r}
deaths_monthly_sts <- sts(observed = bfs_web_deaths_monthly$deaths_month,
                          epoch = as.numeric(bfs_web_deaths_monthly$date),
                          start = c(1877, 1), 
                          frequency = 12,
                          # population = as.matrix(bfs_web_deaths_monthly$pop_dec),
                          epochAsDate = TRUE,
                          multinomialTS = TRUE)
```

## Weekly data

Splitting age group to separate series.  

No pops yet!

```{r}
deaths_weekly_65 <- weekly_2010_2019 %>% 
  filter(Age == "65+") %>% 
  select(-Age)

# deaths_weekly_65_sts <- sts(deaths_weekly_65$NumberOfDeaths, 
#                      start = c(2010, 1), 
#                      freq = 52)

deaths_weekly_65_sts <- sts(observed = deaths_weekly_65$NumberOfDeaths,
                            epoch = as.numeric(deaths_weekly_65$Ending),
                            start = c(2010, 1), 
                            epochAsDate = TRUE)
```

```{r}
deaths_weekly_0 <- weekly_2010_2019 %>% 
  filter(Age == "0-64") %>% 
  select(-Age)

# deaths_weekly_0_sts <- sts(deaths_weekly_0$NumberOfDeaths, 
#                      start = c(2010, 1), 
#                      freq = 52)

deaths_weekly_0_sts <- sts(observed = deaths_weekly_0$NumberOfDeaths,
                           epoch = as.numeric(deaths_weekly_0$Ending),
                           start = c(2010, 1), 
                           epochAsDate = TRUE)
```

## 2015 indicator 

Also selecting indices of observations for periods of interest.

```{r}
in2015month <- which(isoWeekYear(epoch(deaths_monthly_sts))$ISOYear == 2015)

in2015week0age <- which(isoWeekYear(epoch(deaths_weekly_0_sts))$ISOYear == 2015)

in2015week65age <- which(isoWeekYear(epoch(deaths_weekly_65_sts))$ISOYear == 2015)
```

# Three methods

## Monthly 0+ {.tabset}

### Improved method

```{r}
control2 <- list(range = in2015month, 
                 noPeriods = 10, b = 5, w = 2,
                 weightsThreshold = 2.58, 
                 pastWeeksNotIncluded = 2,
                 pThresholdTrend = 1, 
                 thresholdMethod = "nbPlugin")

noufaily <- farringtonFlexible(deaths_monthly_sts, control2)
```

```{r echo=FALSE}
par(mar = c(2, 4, 1, 1))
plot(noufaily, main = "", legend.opts = list(x = "bottomright"))
```

### Original method

```{r}
control1 <- list(range = in2015month, 
                 noPeriods = 1, b = 5, w = 2,
                 weightsThreshold = 1, 
                 pastWeeksNotIncluded = 2,
                 pThresholdTrend = 0.05, 
                 thresholdMethod = "nbPlugin")

farrington <- farringtonFlexible(deaths_monthly_sts, control1)
```

```{r echo=FALSE}
plot(farrington, main = "", legend.opts = list(x = "bottomright"))
```

### Comparing 'alarms'

```{r}
compare <- combineSTS(list(
  Farrington = farrington, 
  Noufaily = noufaily))

par(mar = c(4, 5, 2.1, 2))
plot(compare, type = alarm ~ time)
```

## Weekly 0-64  {.tabset}

`b = 5` not possible!

### Improved method

```{r}
control2 <- list(range = in2015week0age, 
                 noPeriods = 10, b = 4, w = 3,
                 weightsThreshold = 2.58, 
                 pastWeeksNotIncluded = 3,
                 pThresholdTrend = 1, 
                 thresholdMethod = "nbPlugin")

noufaily_weekly_0 <- farringtonFlexible(deaths_weekly_0_sts, control2)
```

```{r echo=FALSE}
par(mar = c(2, 4, 1, 1))
plot(noufaily_weekly_0, main = "", legend.opts = list(x = "bottomright"))
```

### Original method

```{r}
control1 <- list(range = in2015week0age, 
                 noPeriods = 1, b = 4, w = 3,
                 weightsThreshold = 1, 
                 pastWeeksNotIncluded = 26,
                 pThresholdTrend = 0.05, 
                 thresholdMethod = "nbPlugin")

farrington_weekly_0 <- farringtonFlexible(deaths_weekly_0_sts, control1)
```

```{r echo=FALSE}
plot(farrington_weekly_0, main = "", legend.opts = list(x = "bottomright"))
```

### Comparing 'alarms'

```{r}
compare <- combineSTS(list(
  Farrington = farrington_weekly_0, 
  Noufaily = noufaily_weekly_0))

par(mar = c(4, 5, 2.1, 2))
plot(compare, type = alarm ~ time)
```

## Weekly 65+  {.tabset}

### Improved method

```{r}
control2 <- list(range = in2015week65age, 
                 noPeriods = 10, b = 4, w = 3,
                 weightsThreshold = 2.58, 
                 pastWeeksNotIncluded = 3,
                 pThresholdTrend = 1, 
                 thresholdMethod = "nbPlugin")

noufaily_weekly_65 <- farringtonFlexible(deaths_weekly_65_sts, control2)
```

```{r echo=FALSE}
par(mar = c(2, 4, 1, 1))
plot(noufaily_weekly_65, main = "", legend.opts = list(x = "bottomright"))
```

### Original method

```{r}
control1 <- list(range = in2015week65age, 
                 noPeriods = 1, b = 4, w = 3,
                 weightsThreshold = 1, 
                 pastWeeksNotIncluded = 26,
                 pThresholdTrend = 0.05, 
                 thresholdMethod = "nbPlugin")

farrington_weekly_65 <- farringtonFlexible(deaths_weekly_65_sts, control1)
```

```{r echo=FALSE}
plot(farrington_weekly_65, main = "", legend.opts = list(x = "bottomright"))
```

### Comparing 'alarms'

```{r}
compare <- combineSTS(list(
  Farrington = farrington_weekly_65, 
  Noufaily = noufaily_weekly_65))

par(mar = c(4, 8, 2.1, 2))
plot(compare, type = alarm ~ time)
```

<!-- ----------------------------------------------------- -->

```{r eval=FALSE, include=FALSE}
# extracting elements from results
noufaily_weekly_0@epoch
noufaily_weekly_0@freq
noufaily_weekly_0@start
noufaily_weekly_0@state
noufaily_weekly_0@alarm
noufaily_weekly_0@observed
noufaily_weekly_0@upperbound

noufaily_weekly_0@observed - noufaily_weekly_0@upperbound

noufaily_weekly_0@control$score
noufaily_weekly_0@control$pvalue
noufaily_weekly_0@control$expected
noufaily_weekly_0@control$score
```

# Comparing excess deaths

Calculating excess in BfS data by subtracting `NumberOfDeaths` from `upperB`.

Bfs in purple, our calculations in green; black line indicates difference. 

## Weekly 0-64  {.tabset}

### Improved method

```{r echo=FALSE}
deaths_weekly_0 %>% 
  filter(Year == 2015) %>% 
  select(-Expected, -lowerB, -Year, - Week) %>% 
  mutate(excess_bfs = Excess - upperB,
         excess_calc = noufaily_weekly_0@observed - noufaily_weekly_0@upperbound[ ,1]) %>% 
  mutate(excess_calc = ifelse(excess_calc <= 0, NA, excess_calc * -1)) %>% 
  ggplot(mapping = aes(x = Ending)) +
  geom_col(aes(y = excess_bfs), fill = "#af8dc3") +
  geom_col(aes(y = excess_calc), fill = "#7fbf7b") +
  geom_line(aes(y = (excess_bfs + excess_calc) *-1)) +
  ylim(-20, 10) +
  labs(x = "", y = "Excess deaths") +
  theme_bw() 
```

### Original method

```{r echo=FALSE}
deaths_weekly_0 %>% 
  filter(Year == 2015) %>% 
  select(-Expected, -lowerB, -Year, - Week) %>% 
  mutate(excess_bfs = Excess - upperB,
         excess_calc = farrington_weekly_0@observed - farrington_weekly_0@upperbound[ ,1]) %>% 
  mutate(excess_calc = ifelse(excess_calc <= 0, NA, excess_calc * -1)) %>% 
  ggplot(mapping = aes(x = Ending)) +
  geom_col(aes(y = excess_bfs), fill = "#af8dc3") +
  geom_col(aes(y = excess_calc), fill = "#7fbf7b") +
  geom_line(aes(y = (excess_bfs + excess_calc) *-1)) +
  ylim(-20, 10) +
  labs(x = "", y = "Excess deaths") +
  theme_bw() 
```

## Weekly 65+  {.tabset}

### Improved method

```{r echo=FALSE}
deaths_weekly_65 %>% 
  filter(Year == 2015) %>% 
  select(-Expected, -lowerB, -Year, - Week) %>% 
  mutate(excess_bfs = Excess - upperB,
         excess_calc = noufaily_weekly_65@observed - noufaily_weekly_65@upperbound[ ,1]) %>% 
  mutate(excess_calc = ifelse(excess_calc <= 0, NA, excess_calc * -1)) %>% 
  ggplot(mapping = aes(x = Ending)) +
  geom_col(aes(y = excess_bfs), fill = "#af8dc3") +
  geom_col(aes(y = excess_calc), fill = "#7fbf7b") +
  geom_line(aes(y = (excess_bfs + excess_calc) *-1)) +
  ylim(-300, 300) +
  labs(x = "", y = "Excess deaths") +
  theme_bw() 
```

### Original method

```{r echo=FALSE}
deaths_weekly_65 %>% 
  filter(Year == 2015) %>% 
  select(-Expected, -lowerB, -Year, - Week) %>% 
  mutate(excess_bfs = Excess - upperB,
         excess_calc = farrington_weekly_65@observed - farrington_weekly_65@upperbound[ ,1]) %>% 
  mutate(excess_calc = ifelse(excess_calc <= 0, NA, excess_calc * -1)) %>% 
  ggplot(mapping = aes(x = Ending)) +
  geom_col(aes(y = excess_bfs), fill = "#af8dc3") +
  geom_col(aes(y = excess_calc), fill = "#7fbf7b") +
  geom_line(aes(y = (excess_bfs + excess_calc) *-1)) +
  ylim(-300, 300) +
  labs(x = "", y = "Excess deaths") +
  theme_bw() 
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`



---
title: "Excess mortality: 1877-2020 monthly BfS data & regression approach"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

options(scipen=999)
set.seed(12345)

library(pacman)
p_load(tidyverse, lubridate, scales, magrittr, slider)

options(max.print = "75")
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

```{r}
# first method for CI
# https://fromthebottomoftheheap.net/2017/05/01/glm-prediction-intervals-i/
# https://fromthebottomoftheheap.net/2017/05/01/glm-prediction-intervals-ii/

# second method for CI
# https://statcompute.wordpress.com/2015/12/20/prediction-intervals-for-poisson-regression/
p_load(doParallel, foreach)

registerDoParallel(cores = 4)

boot_pi <- function(model, pdata, n, p) {
  odata <- model$data
  lp <- (1 - p) / 2
  up <- 1 - lp
  seeds <- round(runif(n, 1, 1000), 0)
  boot_y <- foreach(i = 1:n, .combine = rbind) %dopar% {
    set.seed(seeds[i])
    bdata <- odata[sample(seq(nrow(odata)), size = nrow(odata), replace = TRUE), ]
    bpred <- predict(update(model, data = bdata), type = "response", newdata = pdata)
    rpois(length(bpred), lambda = bpred)
  }
  boot_ci <- t(apply(boot_y, 2, quantile, c(lp, up)))
  return(data.frame(pred = predict(model, newdata = pdata, type = "response"), 
                    lower = boot_ci[, 1], upper = boot_ci[, 2]))
}
```

<!-- ----------------------------------------------------- -->

# Data 

Monthly number of deaths, **1877-2020**.

Prepared in `02.Rmd`.  

```{r}
bfs_web_deaths_monthly <- read_rds("data/BfS/bfs_web_deaths_monthly.Rds") %>% 
  filter(type == "monthly") %>% 
  select(-type, -deaths_year) %>% 
  rename(deaths = deaths_month)
```

## Years

```{r}
year_from <- min(bfs_web_deaths_monthly$Year)

date_from <- ymd(paste0(as.character(year_from), "-01-01"))

year_reg <- year_from + 10
date_reg <- ymd(paste0(as.character(year_reg), "-01-01"))

year_max <- 2019
date_max <- ymd(paste0(as.character(year_reg), "-01-01"))
```

## Pandemics

```{r}
flu_years_hc <- c(1890, 1918, 2020)

flu_years_hc_affected <- c(seq(1890 + 1, 1890 + 10),
                           seq(1918 + 1, 1918 + 10))

flu_years <- c(1890, 1918, 1957, 1968, 1977, 2009, 2020)

flu_years_affected <- c(flu_years_hc_affected,
                        seq(1957 + 1, 1957 + 10),
                        seq(1968 + 1, 1968 + 10),
                        seq(1977 + 1, 1977 + 10),
                        seq(2009 + 1, 2009 + 10))
```

## Pops

Data till 2019 - taking mean from jan & dec values.

```{r}
bfs_web_pop_yearly <- read_rds("data/BfS/bfs_web_pop_yearly.Rds") %>% 
  filter(Year >= min(bfs_web_deaths_monthly$Year)) %>% 
  mutate(pop = round((pop_jan + pop_dec) / 2)) %>% 
  select(-pop_jan, -pop_dec)
```

2020 simply predicted using pops from last 10 years

```{r}
(pop_2020_pred <- predict(
  lm(pop ~ Year, 
     data = bfs_web_pop_yearly %>% filter(Year >= 2010)),
  new = tibble(Year = 2020)))
```

## Together

```{r}
bfs_web_deaths_monthly %<>% 
  left_join(bfs_web_pop_yearly) %>%
  mutate(flu_year_hc = ifelse(Year %in% flu_years_hc, 1, 0),
         flu_year_hc_affected = ifelse(Year %in% flu_years_hc_affected, 1, 0),
         deaths_flu_year_hc = ifelse(Year %in% flu_years_hc, NA, deaths),
         flu_year = ifelse(Year %in% flu_years, 1, 0),
         flu_year_affected = ifelse(Year %in% flu_years_affected, 1, 0),
         deaths_flu_year = ifelse(Year %in% flu_years, NA, deaths),
         pop = ifelse(Year == 2020, pop_2020_pred, pop),
         si_one = sin(2*pi*Month/12),
         si_two = sin(4*pi*Month/12),
         co_one = cos(2*pi*Month/12),
         co_two = cos(4*pi*Month/12)) 

rm(bfs_web_pop_yearly)
```

## 4 harmonic variables

```{r}
bfs_web_deaths_monthly %>% 
  filter(Year >= 2018) %>% 
  select(si_one, co_one) %>% 
  mutate(row = row_number()) %>% 
  pivot_longer(-row) %>% 
  ggplot() +
  geom_line(aes(row, value, color = name)) +
  xlab("") +
  theme_minimal()
```

```{r}
bfs_web_deaths_monthly %>% 
  filter(Year >= 2018) %>% 
  select(si_two, co_two) %>% 
  mutate(row = row_number()) %>% 
  pivot_longer(-row) %>% 
  ggplot() +
  geom_line(aes(row, value, color = name)) +
  xlab("") +
  theme_minimal()
```

## Three pandemics

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  filter(Year >= 1887 & Year <= 1891) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = deaths)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 11000)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths")

bfs_web_deaths_monthly %>% 
  filter(Year >= 1915 & Year <= 1919) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = deaths)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 11000)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths")

bfs_web_deaths_monthly %>% 
  filter(Year >= 2016) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = deaths)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 11000)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths")
```

## With denominator  

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  filter(Year >= 1887 & Year <= 1891) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = (deaths /pop) * 100000)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 325)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths / 100k")

bfs_web_deaths_monthly %>% 
  filter(Year >= 1915 & Year <= 1919) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = (deaths /pop) * 100000)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 325)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths / 100k")

bfs_web_deaths_monthly %>% 
  filter(Year >= 2016) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = (deaths /pop) * 100000)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 325)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths / 100k")
```

## 5- & 10-year medians

```{r}
bfs_web_deaths_monthly %<>% 
  arrange(Month, Year) %>% 
  group_by(Month) %>% 
  mutate(median =             slide_dbl(deaths, mean, 
                                        na.rm = TRUE, .before = 10, .complete = TRUE),
         median_flu_year_hc = slide_dbl(deaths_flu_year_hc, mean, 
                                        na.rm = TRUE, .before = 10, .complete = TRUE), 
         median_flu_year =    slide_dbl(deaths_flu_year, mean, 
                                        na.rm = TRUE, .before = 10, .complete = TRUE)
  ) %>% 
  ungroup() %>% 
  arrange(Year, Month)
```

Impact of 1957 on 1958

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  filter(Year >= 1956 & Year <= 1958) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = deaths), colour = "grey60") + 
  geom_line(aes(y = median), colour = "green") + 
  geom_line(aes(y = median_flu_year), colour = "purple") +
  geom_line(aes(y = median_flu_year_hc), colour = "orange") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") +
  theme_minimal()
```

## Seasonality

```{r}
dcmp <- bfs_web_deaths_monthly %>%
  mutate(Time = row_number()) %>% 
  tsibble::as_tsibble(index = Time) %>% 
  fabletools::model(feasts::STL((deaths/pop)*100000 ~ season(window = Inf)))

# fabletools::components(dcmp)

fabletools::components(dcmp) %>% 
  autoplot()
```

## Outcome

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  ggplot(aes(deaths)) +
  geom_histogram(binwidth = 50) +
  theme_minimal()
```

<!-- ----------------------------------------------------- -->

# Marcel's regression approach

```{r}
reg_data <- bfs_web_deaths_monthly %>% 
  filter(Year >= year_from & Year < year_reg) 

pred_data <- bfs_web_deaths_monthly %>% 
  filter(Year == year_reg) %>%
  mutate(
    fit = NA_real_,
    lpi = NA_real_,
    upi = NA_real_,
    fit_flu_hc = NA_real_,
    lpi_flu_hc = NA_real_,
    upi_flu_hc = NA_real_,
    fit_flu = NA_real_,
    lpi_flu = NA_real_,
    upi_flu = NA_real_)

# summary(reg_data$Year)
# summary(pred_data$Year)

# all data
summary(monthly <- glm(deaths ~ Year + 
                         si_one + si_two + co_one + co_two, 
                       offset = log(pop),
                       data = reg_data, 
                       family = "poisson"))

predict <- boot_pi(monthly, pred_data, 1000, 0.95)

pred_data %<>%
  mutate(
    fit = predict$pred,
    lpi = predict$lower,
    upi = predict$upper
  )

# flu hc excluded
summary(monthly_flu_hc <- glm(deaths_flu_year_hc ~ Year + 
                                si_one + si_two + co_one + co_two, 
                              offset = log(pop),
                              data = reg_data, 
                              family = "poisson"))

predict_flu_hc <- boot_pi(monthly_flu_hc, pred_data, 1000, 0.95)

pred_data %<>%
  mutate(
    fit_flu_hc = predict_flu_hc$pred,
    lpi_flu_hc = predict_flu_hc$lower,
    upi_flu_hc = predict_flu_hc$upper
  )

# all flu excluded
summary(monthly_flu <- glm(deaths_flu_year ~ Year + 
                             si_one + si_two + co_one + co_two, 
                           offset = log(pop),
                           data = reg_data, 
                           family = "poisson"))

predict_flu <- boot_pi(monthly_flu, pred_data, 1000, 0.95)

pred_data %<>%
  mutate(
    fit_flu = predict_flu$pred,
    lpi_flu = predict_flu$lower,
    upi_flu = predict_flu$upper
    )
```

## Two predictions

### 1919 {.tabset}

#### With extremes

```{r echo=FALSE}
max <- pred_data %>% 
  filter(Year == 1919) %>% 
  summarise(lpi = max(lpi),
            upi = max(upi),
            median = max(median),
            lpi_flu_hc = max(lpi_flu_hc),
            upi_flu_hc = max(upi_flu_hc),
            median_flu_year_hc = max(median_flu_year_hc)) %>% 
  rowwise() %>% 
  mutate(max = max(c(lpi, upi, median, lpi_flu_hc, upi_flu_hc, median_flu_year_hc)))

pred_data %>% 
  filter(Year == 1919) %>% 
  ggplot(aes(x = Date)) +
  geom_ribbon(aes(ymin = lpi, ymax = upi), alpha = 0.1) + 
  geom_line(aes(y = fit), colour = "grey50") +
  geom_line(aes(y = median), colour = "firebrick") + 
  geom_line(aes(y = deaths), color = "purple", size = 1) + 
  scale_y_continuous(labels = comma, limits = c(0, max$max)) +
  scale_x_date(date_breaks = "2 months", date_labels = "%b") +
  xlab("") + ylab("Observed, 10y median & predicted deaths") +
  ggtitle(as.character(year_reg)) +
  theme_minimal()
```

#### Without extremes

```{r echo=FALSE}
pred_data %>% 
  filter(Year == 1919) %>% 
  ggplot(aes(x = Date)) +
  geom_ribbon(aes(ymin = lpi_flu_hc, ymax = upi_flu_hc), alpha = 0.1) + 
  geom_line(aes(y = fit_flu_hc), colour = "grey50") +
  geom_line(aes(y = median_flu_year_hc), colour = "firebrick") + 
  geom_line(aes(y = deaths), color = "purple", size = 1) + 
  scale_y_continuous(labels = comma, limits = c(0, max$max)) +
  scale_x_date(date_breaks = "2 months", date_labels = "%b") +
  xlab("") + ylab("Observed, 10y median & predicted deaths") +
  ggtitle(as.character(year_reg)) +
  theme_minimal()
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`



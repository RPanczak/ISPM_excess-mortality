---
title: "Excess mortality: 1877-2020 monthly BfS data & regression approach"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

options(scipen=999)
set.seed(12345)

library(pacman)
p_load(tidyverse, lubridate, scales, magrittr, slider)

options(max.print = "75")
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# Data 

Monthly number of deaths, **1877-2020**.

Prepared in `02.Rmd`.  

```{r}
bfs_web_deaths_monthly <- read_rds("data/BfS/bfs_web_deaths_monthly.Rds") %>% 
  filter(type == "monthly") %>% 
  select(-type, -deaths_year) %>% 
  rename(deaths = deaths_month)
```

## Years

```{r}
year_from <- min(bfs_web_deaths_monthly$Year)

year_reg <- year_from + 10

year_max <- 2020
```

## Pandemics

```{r}
flu_years_hc <- c(1890, 1918, 2020)

flu_years_hc_affected <- c(seq(1890 + 1, 1890 + 10),
                           seq(1918 + 1, 1918 + 10))

flu_years <- c(1890, 1918, 1957, 1968, 1977, 2009, 2020)

flu_years_affected <- c(flu_years_hc_affected,
                        seq(1957 + 1, 1957 + 10),
                        seq(1968 + 1, 1968 + 10),
                        seq(1977 + 1, 1977 + 10),
                        seq(2009 + 1, 2009 + 10))
```

## Pops

Data till 2019 - taking mean from jan & dec values.

```{r}
bfs_web_pop_yearly <- read_rds("data/BfS/bfs_web_pop_yearly.Rds") %>% 
  filter(Year >= min(bfs_web_deaths_monthly$Year)) %>% 
  mutate(pop = round((pop_jan + pop_dec) / 2)) %>% 
  select(-pop_jan, -pop_dec)
```

2020 simply predicted using pops from last 10 years

```{r}
(pop_2020_pred <- predict(
  lm(pop ~ Year, 
     data = bfs_web_pop_yearly %>% filter(Year >= 2010)),
  new = tibble(Year = 2020)))
```

## Together

```{r}
bfs_web_deaths_monthly %<>% 
  left_join(bfs_web_pop_yearly) %>%
  mutate(flu_year_hc = ifelse(Year %in% flu_years_hc, 1, 0),
         flu_year_hc_affected = ifelse(Year %in% flu_years_hc_affected, 1, 0),
         deaths_flu_year_hc = ifelse(Year %in% flu_years_hc, NA, deaths),
         flu_year = ifelse(Year %in% flu_years, 1, 0),
         flu_year_affected = ifelse(Year %in% flu_years_affected, 1, 0),
         deaths_flu_year = ifelse(Year %in% flu_years, NA, deaths),
         pop = ifelse(Year == 2020, pop_2020_pred, pop),
         si_one = sin(2*pi*Month/12),
         si_two = sin(4*pi*Month/12),
         co_one = cos(2*pi*Month/12),
         co_two = cos(4*pi*Month/12)) 

rm(bfs_web_pop_yearly)
```

## 4 harmonic variables

```{r}
bfs_web_deaths_monthly %>% 
  filter(Year >= 2018) %>% 
  select(si_one, co_one) %>% 
  mutate(row = row_number()) %>% 
  pivot_longer(-row) %>% 
  ggplot() +
  geom_line(aes(row, value, color = name)) +
  xlab("") +
  theme_minimal()
```

```{r}
bfs_web_deaths_monthly %>% 
  filter(Year >= 2018) %>% 
  select(si_two, co_two) %>% 
  mutate(row = row_number()) %>% 
  pivot_longer(-row) %>% 
  ggplot() +
  geom_line(aes(row, value, color = name)) +
  xlab("") +
  theme_minimal()
```

## Three pandemics

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  filter(Year >= 1887 & Year <= 1891) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = deaths)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 11000)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths")

bfs_web_deaths_monthly %>% 
  filter(Year >= 1915 & Year <= 1919) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = deaths)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 11000)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths")

bfs_web_deaths_monthly %>% 
  filter(Year >= 2016) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = deaths)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 11000)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths")
```

## With denominator  

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  filter(Year >= 1887 & Year <= 1891) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = (deaths /pop) * 100000)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 325)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths / 100k")

bfs_web_deaths_monthly %>% 
  filter(Year >= 1915 & Year <= 1919) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = (deaths /pop) * 100000)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 325)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths / 100k")

bfs_web_deaths_monthly %>% 
  filter(Year >= 2016) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = (deaths /pop) * 100000)) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(labels = comma, limits = c(0, 325)) +
  theme_minimal() + 
  xlab("") + ylab("Deaths / 100k")
```

## 5- & 10-year medians

```{r}
bfs_web_deaths_monthly %<>% 
  arrange(Month, Year) %>% 
  mutate(median =             slide_dbl(deaths, 
                                        stats::median, na.rm = TRUE, 
                                        .before = 10, .after = -1, .complete = TRUE),
         median_flu_year_hc = slide_dbl(deaths_flu_year_hc, 
                                        stats::median, na.rm = TRUE,
                                        .before = 10, .after = -1, .complete = TRUE),
         median_flu_year =    slide_dbl(deaths_flu_year, 
                                        stats::median, na.rm = TRUE, 
                                        .before = 10, .after = -1, .complete = TRUE),
  ) %>% 
  arrange(Year, Month)
```

Impact of 1957 on 1958

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  filter(Year >= 1957 & Year <= 1958) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = deaths), colour = "grey60") + 
  geom_line(aes(y = median), colour = "green") + 
  geom_line(aes(y = median_flu_year), colour = "purple") +
  geom_line(aes(y = median_flu_year_hc), colour = "orange") +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("") +
  theme_minimal()
```

## Seasonality

```{r}
dcmp <- bfs_web_deaths_monthly %>%
  mutate(Time = row_number()) %>% 
  tsibble::as_tsibble(index = Time) %>% 
  fabletools::model(feasts::STL((deaths/pop)*100000 ~ season(window = Inf)))

# fabletools::components(dcmp)

fabletools::components(dcmp) %>% 
  autoplot()
rm(dcmp)
```

## Outcome

```{r echo=FALSE}
bfs_web_deaths_monthly %>% 
  ggplot(aes(deaths)) +
  geom_histogram(binwidth = 50) +
  theme_minimal()
```

<!-- ----------------------------------------------------- -->

# Marcel's regression approach

## CI via bootstrap

Method from https://statcompute.wordpress.com/2015/12/20/prediction-intervals-for-poisson-regression/

```{r}
p_load(doParallel, foreach)

registerDoParallel(cores = 4)

boot_pi <- function(model, pdata, n, p) {
  odata <- model$data
  lp <- (1 - p) / 2
  up <- 1 - lp
  seeds <- round(runif(n, 1, 1000), 0)
  boot_y <- foreach(i = 1:n, .combine = rbind) %dopar% {
    set.seed(seeds[i])
    bdata <- odata[sample(seq(nrow(odata)), size = nrow(odata), replace = TRUE), ]
    bpred <- predict(update(model, data = bdata), type = "response", newdata = pdata)
    rpois(length(bpred), lambda = bpred)
  }
  boot_ci <- t(apply(boot_y, 2, quantile, c(lp, up)))
  return(data.frame(pred = predict(model, newdata = pdata, type = "response"), 
                    lower = boot_ci[, 1], upper = boot_ci[, 2]))
}
```

## Looping over years

Analyses using 10 previous years.  
With three different inclusions depending on pandemic / flu years

```{r eval=FALSE}
for (YEAR in year_reg:year_max){
  
  print(paste("Analysing year", YEAR))
  
  reg_data <- bfs_web_deaths_monthly %>% 
    filter(Year >= YEAR - 10 & Year < YEAR) 
  
  pred_data <- bfs_web_deaths_monthly %>% 
    filter(Year == YEAR) %>%
    mutate(
      fit = NA_real_,
      lpi = NA_real_,
      upi = NA_real_,
      fit_flu_hc = NA_real_,
      lpi_flu_hc = NA_real_,
      upi_flu_hc = NA_real_,
      fit_flu = NA_real_,
      lpi_flu = NA_real_,
      upi_flu = NA_real_)
  
  # summary(reg_data$Year)
  # summary(pred_data$Year)
  
  # all data
  summary(monthly <- glm(deaths ~ Year + 
                           si_one + si_two + co_one + co_two, 
                         offset = log(pop),
                         data = reg_data, 
                         family = "poisson"))
  
  predict <- boot_pi(monthly, pred_data, 1000, 0.95)
  
  pred_data %<>%
    mutate(
      fit = predict$pred,
      lpi = predict$lower,
      upi = predict$upper,
      fit_flu_hc = predict$pred,
      lpi_flu_hc = predict$lower,
      upi_flu_hc = predict$upper,
      fit_flu = predict$pred,
      lpi_flu = predict$lower,
      upi_flu = predict$upper
    )
  
  # flu hc excluded
  if (YEAR %in% flu_years_hc_affected) {
    
    print(paste("    >> Extra analyses for hc flu year exclusions"))
    
    summary(monthly_flu_hc <- glm(deaths_flu_year_hc ~ Year + 
                                    si_one + si_two + co_one + co_two, 
                                  offset = log(pop),
                                  data = reg_data, 
                                  family = "poisson"))
    
    predict_flu_hc <- boot_pi(monthly_flu_hc, pred_data, 1000, 0.95)
    
    pred_data %<>%
      mutate(
        fit_flu_hc = predict_flu_hc$pred,
        lpi_flu_hc = predict_flu_hc$lower,
        upi_flu_hc = predict_flu_hc$upper
      )
  }
  
  # all flu excluded
  if (YEAR %in% flu_years_affected) {
    
    print(paste("    >> Extra analyses for flu year exclusions"))
    
    summary(monthly_flu <- glm(deaths_flu_year ~ Year + 
                                 si_one + si_two + co_one + co_two, 
                               offset = log(pop),
                               data = reg_data, 
                               family = "poisson"))
    
    predict_flu <- boot_pi(monthly_flu, pred_data, 1000, 0.95)
    
    pred_data %<>%
      mutate(
        fit_flu = predict_flu$pred,
        lpi_flu = predict_flu$lower,
        upi_flu = predict_flu$upper
      )
  } 
  
  if (YEAR == year_reg) {
    expected_deaths_monthly <- pred_data
  } else {
    expected_deaths_monthly <- bind_rows(expected_deaths_monthly, pred_data)
  }
}

rm(predict, predict_flu_hc, predict_flu, pred_data, reg_data, YEAR)
write_rds(expected_deaths_monthly, "data/expected_deaths_monthly.Rds")
```

```{r include=FALSE}
p_unload(doParallel, foreach)
expected_deaths_monthly <- read_rds("data/expected_deaths_monthly.Rds")
```

## Two predictions

```{r echo=FALSE}
mort_plot <- function(plot_Year, extremes = FALSE) {
  
  plot_data <- expected_deaths_monthly %>% 
    filter(Year >= plot_Year - 1 & Year <= plot_Year + 1)
  
  max <- plot_data %>% 
    summarise(deaths = max(deaths),
              lpi = max(lpi),
              upi = max(upi),
              median = max(median),
              lpi_flu = max(lpi_flu),
              upi_flu = max(upi_flu),
              median_flu_year = max(median_flu_year)) %>% 
    rowwise() %>% 
    mutate(max = max(c(deaths, lpi, upi, median, lpi_flu, upi_flu, median_flu_year)))
  
  if (extremes == FALSE) {
    
    plot_data %>% 
      ggplot(aes(x = Date)) +
      geom_rect(aes(xmin = as.Date(paste0(plot_Year, "-01-01")), 
                    xmax = as.Date(paste0(plot_Year, "-12-31")), 
                    ymin = -Inf, ymax = Inf), 
                fill = "purple", alpha = 0.01, inherit.aes = FALSE) +    
      geom_ribbon(aes(ymin = lpi, ymax = upi), alpha = 0.1) + 
      geom_line(aes(y = fit), colour = "grey50") +
      geom_line(aes(y = median), colour = "firebrick") + 
      geom_line(aes(y = deaths), color = "purple", size = 1) + 
      scale_y_continuous(labels = comma, limits = c(0, max$max)) +
      scale_x_date(date_breaks = "4 months", date_labels = "%b") +
      xlab("") + ylab("Observed, 10y median & predicted deaths") +
      labs(caption = "Includes extreme years",
           title = paste(as.character(plot_Year - 1), "-",
                         as.character(plot_Year + 1))) +
      theme_minimal()
    
  } else if (extremes == TRUE) {
    
    plot_data %>% 
      ggplot(aes(x = Date)) +
      geom_rect(aes(xmin = as.Date(paste0(plot_Year, "-01-01")), 
                    xmax = as.Date(paste0(plot_Year, "-12-31")), 
                    ymin = -Inf, ymax = Inf), 
                fill = "purple", alpha = 0.01, inherit.aes = FALSE) +   
      geom_ribbon(aes(ymin = lpi_flu, ymax = upi_flu), alpha = 0.1) + 
      geom_line(aes(y = fit_flu), colour = "grey50") +
      geom_line(aes(y = median_flu_year), colour = "firebrick") + 
      geom_line(aes(y = deaths), color = "purple", size = 1) + 
      scale_y_continuous(labels = comma, limits = c(0, max$max)) +
      scale_x_date(date_breaks = "4 months", date_labels = "%b") +
      xlab("") + ylab("Observed, 10y median & predicted deaths") +
      labs(caption = "Excludes extreme years",
           title = paste(as.character(plot_Year - 1), "-",
                         as.character(plot_Year + 1))) +
      theme_minimal()
  }
}
```

### 1890 {.tabset}

#### With extremes

```{r echo=FALSE}
mort_plot(1890) 
```

#### Without extremes

```{r echo=FALSE}
mort_plot(1890, extremes = TRUE) 
```

### 1918 {.tabset}

#### With extremes

```{r echo=FALSE}
mort_plot(1918) 
```

#### Without extremes

```{r echo=FALSE}
mort_plot(1918, extremes = TRUE) 
```

### 1957 {.tabset}

#### With extremes

```{r echo=FALSE}
mort_plot(1957) 
```

#### Without extremes

```{r echo=FALSE}
mort_plot(1957, extremes = TRUE) 
```

### 2020 {.tabset}

#### With extremes

```{r echo=FALSE}
mort_plot(2020) 
```

#### Without extremes

```{r echo=FALSE}
mort_plot(2020, extremes = TRUE) 
```

<!-- ----------------------------------------------------- -->

# Alt Viz

## Animate

```{r message=FALSE, include=FALSE}
p_load(gganimate)

p <- expected_deaths_monthly %>% 
  mutate(Year = as.integer(Year),
         Month = as.integer(Month)) %>% 
  ggplot(aes(x = Month)) +
  geom_ribbon(aes(ymin = lpi_flu, ymax = upi_flu), alpha = 0.1) +
  geom_line(aes(y = fit_flu), colour = "grey50") +
  # geom_line(aes(y = median_flu_year), colour = "firebrick") + 
  geom_line(aes(y = deaths), color = "purple", size = 1) + 
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = seq(1, 12, 2)) +
  xlab("Month") + ylab("Observed vs. predicted deaths") +
  labs(title = "Year: {closest_state}") +
  theme_minimal() +
  transition_states(Year, transition_length = 1, state_length = 1) +
  ease_aes('linear')  

animate(p, fps = 1)

anim_save("data/mort_anim.gif")

p_unload(gganimate)
```

![](../data/mort_anim.gif)

## Stacked

```{r echo=FALSE}
expected_deaths_monthly %>% 
  mutate(Year = as.integer(Year),
         Month = as.integer(Month)) %>% 
  ggplot(aes(x = Month)) +
  geom_line(aes(y = deaths, group = Year, color = Year), alpha = 0.5) + 
  scale_y_continuous(labels = comma, limits = c(3000, 11000)) +
  scale_x_continuous(breaks = seq(1, 12, 2)) +
  scale_color_viridis_c() +
  xlab("Month") + ylab("Observed deaths") +
  theme_minimal()

expected_deaths_monthly %>% 
  mutate(Year = as.integer(Year),
         Month = as.integer(Month)) %>% 
  ggplot(aes(x = Month)) +
  geom_line(aes(y = median_flu_year, group = Year, color = Year), alpha = 0.5) + 
  scale_y_continuous(labels = comma, limits = c(3000, 11000)) +
  scale_x_continuous(breaks = seq(1, 12, 2)) +
  scale_color_viridis_c() +
  xlab("Month") + ylab("Median 10y deaths") +
  theme_minimal()

expected_deaths_monthly %>% 
  mutate(Year = as.integer(Year),
         Month = as.integer(Month)) %>% 
  ggplot(aes(x = Month)) +
  geom_line(aes(y = fit_flu, group = Year, color = Year), alpha = 0.5) + 
  scale_y_continuous(labels = comma, limits = c(3000, 11000)) +
  scale_x_continuous(breaks = seq(1, 12, 2)) +
  scale_color_viridis_c() +
  xlab("Month") + ylab("Observed deaths") +
  theme_minimal()
```

## Diffs

```{r echo=FALSE}
expected_deaths_monthly %>% 
  # filter(Year >= 1887 & Year <= 1891) %>% 
  select(Date, deaths, fit_flu) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = deaths - fit_flu)) +
  scale_y_continuous(labels = comma) +
  scale_x_date(date_breaks = "10 years", date_labels = "%Y") +
  scale_colour_manual(values = c("#67A9CF", "#EF8A62")) +  
  xlab("Year") + ylab("Difference observed expected") +
  theme_minimal()
```

```{r echo=FALSE}
expected_deaths_monthly %>% 
  filter(Year >= 1887 & Year <= 1891) %>% 
  select(Date, deaths, fit_flu) %>% 
  mutate(From = pmin(deaths, fit_flu),
         To = pmax(deaths, fit_flu),
         Difference = ifelse(deaths > fit_flu, "More", "Less")) %>% 
  ggplot(aes(x = Date)) +
  # geom_line(aes(y = fit_flu), color = "grey80") + 
  geom_linerange(aes(ymin = From, ymax = To, color = Difference), size = 1) + 
  scale_y_continuous(labels = comma, limits = c(3000, 11000)) +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
  scale_colour_manual(values = c("#67A9CF", "#EF8A62")) +  
  xlab("Year") + ylab("Difference observed expected") +
  theme_minimal()

expected_deaths_monthly %>% 
  filter(Year >= 1915 & Year <= 1919) %>% 
  select(Date, deaths, fit_flu) %>% 
  mutate(From = pmin(deaths, fit_flu),
         To = pmax(deaths, fit_flu),
         Difference = ifelse(deaths > fit_flu, "More", "Less")) %>% 
  ggplot(aes(x = Date)) +
  # geom_line(aes(y = fit_flu), color = "grey80") + 
  geom_linerange(aes(ymin = From, ymax = To, color = Difference), size = 1) + 
  scale_y_continuous(labels = comma, limits = c(3000, 11000)) +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
  scale_colour_manual(values = c("#67A9CF", "#EF8A62")) +  
  xlab("Year") + ylab("Difference observed expected") +
  theme_minimal()

expected_deaths_monthly %>% 
  filter(Year >= 2016) %>%
  select(Date, deaths, fit_flu) %>% 
  mutate(From = pmin(deaths, fit_flu),
         To = pmax(deaths, fit_flu),
         Difference = ifelse(deaths > fit_flu, "More", "Less")) %>% 
  ggplot(aes(x = Date)) +
  # geom_line(aes(y = fit_flu), color = "grey80") + 
  geom_linerange(aes(ymin = From, ymax = To, color = Difference), size = 1) + 
  scale_y_continuous(labels = comma, limits = c(3000, 11000)) +
  scale_x_date(date_breaks = "2 years", date_labels = "%Y") +
  scale_colour_manual(values = c("#67A9CF", "#EF8A62")) +  
  xlab("Year") + ylab("Difference observed expected") +
  theme_minimal()
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`



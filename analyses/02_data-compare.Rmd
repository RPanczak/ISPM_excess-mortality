---
title: "Excess mortality: data preparation"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

set.seed(12345)
options(scipen=999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, magrittr, janitor, scales, 
       readxl, haven, 
       kableExtra,
       aweek, wktmo)
```

```{r knit-setup, include = FALSE}
knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# HMD

[The Human Mortality Database](https://www.mortality.org/) data. 

```{r eval=FALSE}
p_load(HMDHFDplus)

password <- readr::read_file("secrets/HMD.txt")

# CH
# pop
hmd_ch_pop_raw <- readHMDweb(CNTRY = "CHE", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_pop_raw, "data-raw/mortality_org/hmd_ch_pop_raw.Rds")
write_dta(hmd_ch_pop_raw, "data-raw/mortality_org/hmd_ch_pop_raw.dta")

# deaths
hmd_ch_deaths_raw <- readHMDweb(CNTRY = "CHE", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_deaths_raw, "data-raw/mortality_org/hmd_ch_deaths_raw.Rds")
write_dta(hmd_ch_deaths_raw, "data-raw/mortality_org/hmd_ch_deaths_raw.dta")

hmd_ch_deaths <- hmd_ch_deaths_raw %>% 
  select(Year, Total) %>% 
  group_by(Year) %>% 
  summarise(deaths_year = sum(Total)) %>% 
  ungroup() %>% 
  as_tibble()

write_rds(hmd_ch_deaths, "data/mortality_org/hmd_ch_deaths.Rds")
write_dta(hmd_ch_deaths, "data/mortality_org/hmd_ch_deaths.dta")

# ES
# pop
# 1975 problem resolved in #45
hmd_es_pop_raw <- readHMDweb(CNTRY = "ESP", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble() %>% 
  mutate(Year = ifelse(Year == "1975+", 1975, Year)) %>% 
  filter(Year != "1975-") %>% 
  mutate(Year = as.numeric(Year))

write_rds(hmd_es_pop_raw, "data-raw/mortality_org/hmd_es_pop_raw.Rds")
write_dta(hmd_es_pop_raw, "data-raw/mortality_org/hmd_es_pop_raw.dta")

# deaths
hmd_es_deaths_raw <- readHMDweb(CNTRY = "ESP", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_es_deaths_raw, "data-raw/mortality_org/hmd_es_deaths_raw.Rds")
write_dta(hmd_es_deaths_raw, "data-raw/mortality_org/hmd_es_deaths_raw.dta")

hmd_es_deaths <- hmd_es_deaths_raw %>% 
  select(Year, Total) %>% 
  group_by(Year) %>% 
  summarise(deaths_year = sum(Total)) %>% 
  as_tibble()

write_rds(hmd_es_deaths, "data/mortality_org/hmd_es_deaths.Rds")
write_dta(hmd_es_deaths, "data/mortality_org/hmd_es_deaths.dta")

# SE
# pop
hmd_se_pop_raw <- readHMDweb(CNTRY = "SWE", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_se_pop_raw, "data-raw/mortality_org/hmd_se_pop_raw.Rds")
write_dta(hmd_se_pop_raw, "data-raw/mortality_org/hmd_se_pop_raw.dta")

# deaths
hmd_se_deaths_raw <- readHMDweb(CNTRY = "SWE", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_se_deaths_raw, "data-raw/mortality_org/hmd_se_deaths_raw.Rds")
write_dta(hmd_se_deaths_raw, "data-raw/mortality_org/hmd_se_deaths_raw.dta")

hmd_se_deaths <- hmd_se_deaths_raw %>% 
  select(Year, Total) %>% 
  group_by(Year) %>% 
  summarise(deaths_year = sum(Total)) %>% 
  as_tibble()

write_rds(hmd_se_deaths, "data/mortality_org/hmd_se_deaths.Rds")
write_dta(hmd_se_deaths, "data/mortality_org/hmd_se_deaths.dta")

p_unload(HMDHFDplus)
```

## Deaths CH

```{r include=FALSE}
hmd_ch_deaths <- read_rds("data/mortality_org/hmd_ch_deaths.Rds")
```

Available only yearly but for one year age bands & separate by sex. Time from `r min(hmd_ch_deaths$Year)` to `r max(hmd_ch_deaths$Year)`.

```{r echo=FALSE}
ggplot(hmd_ch_deaths, aes(x = Year)) +
  geom_line(aes(y = deaths_year)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

## Pops CH

Similarly, population data is aggregated by year. 

```{r include=FALSE}
hmd_ch_pop_raw <- read_rds("data-raw/mortality_org/hmd_ch_pop_raw.Rds")

hmd_ch_pop_year <- hmd_ch_pop_raw %>% 
  select(Year, Total) %>% 
  group_by(Year) %>% 
  summarise(pop_year = sum(Total)) %>% 
  as_tibble()

write_rds(hmd_ch_pop_year, "data/mortality_org/hmd_ch_pop_year.Rds")
```

```{r echo=FALSE}
ggplot(hmd_ch_pop_year, aes(x = Year)) +
  geom_line(aes(y = pop_year/1000000)) +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]") +
  scale_y_continuous(labels = comma)
```

Advantage of data is availability of age bands (1 year!)

```{r echo=FALSE}
hmd_ch_pop_raw %>% 
  filter(Year == 1876 | Year == 2019) %>% 
  select(Year, Age, Female, Male) %>% 
  rename(year = Year, age = Age) %>% 
  pivot_longer(c("Female", "Male"), names_to = "sex") %>% 
  mutate(age = if_else(age == "110+", "110", age)) %>% 
  mutate(age = as.numeric(age)) %>% 
  mutate(age_cat = cut(age, seq(0, 110, 5), include.lowest = TRUE)) %>% 
  group_by(year, sex, age_cat) %>% 
  summarise(pop = sum(value)) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = ifelse(test = sex == "Male", yes = -pop, no = pop), 
                       y = age_cat, fill = sex)) +
  geom_col(width = 1) +
  lemon::scale_x_symmetric(labels = abs) +
  labs(x = "Population", y = "Age") +
  facet_grid(vars(year)) +
  theme_bw() +
  scale_fill_brewer(palette = "Set1")
```

## Deaths ES

```{r include=FALSE}
hmd_es_deaths <- read_rds("data/mortality_org/hmd_es_deaths.Rds")
```

Available yearly from `r min(hmd_es_deaths$Year)` to `r max(hmd_es_deaths$Year)`.

```{r echo=FALSE}
ggplot(hmd_es_deaths, aes(x = Year)) +
  geom_line(aes(y = deaths_year)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

## Deaths SE

```{r include=FALSE}
hmd_se_deaths <- read_rds("data/mortality_org/hmd_se_deaths.Rds")
```

Available yearly from `r min(hmd_se_deaths$Year)` to `r max(hmd_se_deaths$Year)`.

```{r echo=FALSE}
ggplot(hmd_se_deaths, aes(x = Year)) +
  geom_line(aes(y = deaths_year)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

<!-- ----------------------------------------------------- -->
# HMD - STMF data series

Short-term Mortality Fluctuations weekly dataset to cover 2020 data

## Weekly

```{r eval=FALSE}
download.file(url = "https://www.mortality.org/Public/STMF/Outputs/stmf.csv",
              destfile = "data-raw/mortality_org/stmf.csv",
              method = "curl")

download.file(url = "https://www.mortality.org/Public/STMF_DOC/STMFmetadata.pdf",
              destfile = "data-raw/mortality_org/STMFmetadata.pdf",
              method = "curl")

download.file(url = "https://www.mortality.org/Public/STMF_DOC/STMFNote.pdf",
              destfile = "data-raw/mortality_org/STMFNote.pdf",
              method = "curl")

stmf <- read_csv("data-raw/mortality_org/stmf.csv", 
                 col_types = cols(Year = col_integer(), 
                                  Week = col_integer(), 
                                  Split = col_integer(), 
                                  SplitSex = col_integer(), 
                                  Forecast = col_integer()), 
                 skip = 1) %>% 
  filter(CountryCode %in% c("CHE", "ESP", "SWE")) %>% 
  filter(Sex == "b") %>% 
  select(CountryCode, Year, Week, DTotal) %>% 
  rename(Deaths = DTotal) %>%  
  mutate(Week2 = get_aweek(week = Week, year = Year, 
                           start = "Monday", week_start = "Monday"),
         Week_start = get_date(week = Week, year = Year, 
                               start = "Monday")) %>% 
  relocate(Week2, Week_start, .after = Week)

write_rds(stmf, "data/mortality_org/stmf.Rds")
write_dta(stmf, "data/mortality_org/stmf.dta")
```

```{r}
stmf <- read_rds("data/mortality_org/stmf.Rds")
```

```{r echo=FALSE}
stmf %>% 
  filter(Year >= 2020) %>% 
  ggplot(aes(x = Week_start)) +
  geom_line(aes(y = Deaths, group = CountryCode, color = CountryCode)) +
  theme_bw() +
  xlab("") + ylab("Weekly number of deaths")
```

## Monthly

Weeks converted to months using [weekToMonth](https://rdrr.io/cran/wktmo/man/weekToMonth.html) function from `wktmo` package. 

```{r}
stmf %<>% 
  filter(Year == 2020)

stmf_month <- bind_rows(
  
  weekToMonth(stmf[stmf$CountryCode == "CHE", ]$Deaths, 
              datStart = "30-12-2019", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Switzerland"),
  
  weekToMonth(stmf[stmf$CountryCode == "ESP", ]$Deaths, 
              datStart = "30-12-2019", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Spain"),
  
  weekToMonth(stmf[stmf$CountryCode == "SWE", ]$Deaths, 
              datStart = "30-12-2019", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Sweden") 
  
) %>% 
  separate(yearMonth, c("Year", "Month"), convert = TRUE) %>% 
  filter(Year == 2020) %>% 
  rename(deaths_month = value) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Country, Year, Month, Date)

write_rds(stmf_month, "data/mortality_org/stmf_month.Rds")
write_dta(stmf_month, "data/mortality_org/stmf_month.dta")
```

```{r echo=FALSE}
stmf_month %>% 
  ggplot(aes(x = Date)) +
  geom_col(aes(y = deaths_month)) +
  facet_grid(rows = vars(Country), scales = "free_y") +
  theme_bw() +
  xlab("") + ylab("Monthly number of deaths")
```

## Yearly

```{r}
stmf_month %>% 
  group_by(Country) %>% 
  summarise(deaths_year = round(sum(deaths_month))) %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)
```

<!-- ----------------------------------------------------- -->
# Switzerland 

## BfS

### Deaths 

Historical data from [Todesfälle nach Monat und Sterblichkeit seit 1803](https://www.bfs.admin.ch/bfs/de/home/statistiken/kataloge-datenbanken/daten.assetdetail.14387168.html).

Using data since 1877 only where monthly registration starts.  
With important update from @Kaspar **covering missing months between 1886 and 1900**!

```{r message=FALSE, warning=FALSE, eval=FALSE}
bfs_web_deaths_yearly <- read_xlsx("data-raw/BfS/px-x-0102020206_111_20210223-102443.xlsx", 
                         skip = 2, na = "...") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(year = x1) %>% 
  filter(!is.na(todesfalle_total)) %>% 
  select(year:todesfalle_im_dezember) %>% 
  mutate(year = as.numeric(year)) %>% 
  rename(Year = year) %>% 
  select(Year, todesfalle_total) %>% 
  rename(deaths_year = todesfalle_total)

bfs_web_deaths_monthly <- read_xlsx("data-raw/BfS/Todesf_n_Monat_seit_1877_DEM_2.xlsx") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Year = jahr) %>% 
  pivot_longer(!Year, names_to = "Month", values_to = "deaths_month") %>% 
  mutate(Month = as.numeric(str_replace(Month, fixed("m"), "")))  %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) 

write_rds(bfs_web_deaths_monthly, "data/BfS/bfs_web_deaths_monthly.Rds")
write_dta(bfs_web_deaths_monthly, "data/BfS/bfs_web_deaths_monthly.dta")

write_rds(bfs_web_deaths_yearly, "data/BfS/bfs_web_deaths_yearly.Rds")
write_dta(bfs_web_deaths_yearly, "data/BfS/bfs_web_deaths_yearly.dta")
```

```{r include=FALSE}
bfs_web_deaths_yearly <- read_rds("data/BfS/bfs_web_deaths_yearly.Rds")
bfs_web_deaths_monthly <- read_rds("data/BfS/bfs_web_deaths_monthly.Rds")
```

Yearly deaths for period 1803 to 1876; monthly deaths thereafter.

```{r echo=FALSE}
ggplot(data = bfs_web_deaths_monthly, 
       aes(x = Date)) +
  geom_line(aes(y = deaths_month)) +
  theme_bw() +
  xlab("") + ylab("Monthly number of deaths")
```

### Pops 

[Demographic balance of the permanent resident population, 1861-2019](https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/tables.assetdetail.13707412.html)

```{r}
bfs_web_pop_yearly <- read_xlsx("data-raw/BfS/su-e-01.02.04.05.xlsx", 
                                na = "...", skip = 1) %>% 
  remove_empty(c("rows", "cols")) %>%
  clean_names() %>% 
  rename(Year = x1, pop_jan = population_on_2, pop_dec = population_on_11) %>% 
  filter(!is.na(Year)) %>% 
  filter(!is.na(pop_jan)) %>% 
  mutate(Year = if_else(Year == "2010 7", "2010", Year),
         Year = as.numeric(Year), 
         pop_jan = as.numeric(pop_jan),
         pop_dec = as.numeric(pop_dec)) %>% 
  select(Year, starts_with("pop_"))

write_rds(bfs_web_pop_yearly, "data/BfS/bfs_web_pop_yearly.Rds")
write_dta(bfs_web_pop_yearly, "data/BfS/bfs_web_pop_yearly.dta")
```

```{r echo=FALSE}
ggplot(bfs_web_pop_yearly, aes(x = Year)) +
  geom_line(aes(y = pop_dec/1000000)) +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]") +
  scale_y_continuous(labels = comma)
```

## Comparison - pops

### BfS web vs HMD

```{r}
compare <- left_join(
  bfs_web_pop_yearly, 
  hmd_ch_pop_year) %>% 
  mutate(diff1 = pop_jan - pop_year) %>% 
  mutate(diff2 = pop_dec - pop_year)
```

Summary of differences between BfS figures (both Jan and Dec) and HMD

```{r}
summary(compare$diff1)
summary(compare$diff2)
```

Timeline of differences between BfS figures and HMD

```{r echo=FALSE}
compare %>% 
  rename(bfs_pop_jan = pop_jan, 
         bfs_pop_dec = pop_dec, 
         hmd_pop_year = pop_year) %>% 
  pivot_longer(bfs_pop_jan:hmd_pop_year) %>% 
  ggplot(aes(x = Year, y = value/1000000, color = name)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]")
```

Difference between Jan pop from BfS and yearly pop from HMD

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = pop_jan - pop_year)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

Difference between Dec pop from BfS and yearly pop from HMD

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = pop_dec - pop_year)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

## Comparison - deaths

### Yearly vs. monthly figures

```{r}
bfs_web_deaths_monthly %>% 
  filter(!is.na(deaths_month)) %>% 
  group_by(Year) %>% 
  summarize(deaths_summed = sum(deaths_month)) %>% 
  ungroup() %>% 
  left_join(bfs_web_deaths_yearly) %>% 
  filter(deaths_year != deaths_summed) %>% 
  nrow()
```

There are no years where summed monthly data differ from "official" yearly sums.

### BfS vs HMD

```{r}
compare <- left_join(
  bfs_web_deaths_yearly %>% 
    rename(deaths_year_bfs = deaths_year), 
  hmd_ch_deaths %>% 
    rename(deaths_year_hmd = deaths_year)) %>% 
  mutate(diff = deaths_year_bfs - deaths_year_hmd)
```

Summary of differences between BfS figures and HMD

```{r}
summary(compare$diff)
```

Timeline of differences between BfS figures and HMD

```{r echo=FALSE}
ggplot(compare, aes(x = Year, y = diff)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly difference in number of deaths")
```

<!-- ----------------------------------------------------- -->

# Spain

```{r}
spain_pop <- read_xlsx("data-raw/INE/Spain_Population.xlsx") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Year = year) %>% 
  rename(population = prados_de_la_escosura2020_july) %>% 
  select(Year, population)

spain_deaths_monthly <- read_xlsx("data-raw/INE/Spain.xlsx") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Year = jahr) %>% 
  pivot_longer(!Year, names_to = "Month", values_to = "deaths_month") %>% 
  mutate(Month = as.numeric(str_replace(Month, fixed("m"), "")))  %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) %>% 
  left_join(spain_pop)

write_rds(spain_deaths_monthly, "data/INE/spain_deaths_monthly.Rds")
write_dta(spain_deaths_monthly, "data/INE/spain_deaths_monthly.dta")
```

## Deaths monthly

```{r echo=FALSE}
spain_deaths_monthly %>% 
  ggplot(aes(x = Date, y = deaths_month)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Monthly deaths")
```

## Population yearly

```{r echo=FALSE}
spain_pop %>% 
  ggplot(aes(x = Year, y = population)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population")

rm(spain_pop)
```

<!-- ----------------------------------------------------- -->

# Sweden

```{r}
sweden_pop <- read_xlsx("data-raw/SCB/be0101_tab9utveng1749-2020.xlsx",
                        skip = 4) %>% 
  remove_empty() %>% 
  clean_names() %>% 
  select(year, population) %>% 
  filter(!is.na(population)) %>% 
  mutate(year = ifelse(year == "20001)", 2000, year),
         year = as.numeric(year)) %>% 
  rename(Year = year) 

sweden_deaths_monthly <- read_csv("data-raw/SCB/000000NF_20210315-164930.csv",
                                  skip = 2) %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Month_txt = month) %>% 
  filter(Month_txt != "Unknown") %>% 
  select(-sex) %>% 
  pivot_longer(!Month_txt, names_to = "Year", values_to = "deaths_month") %>% 
  group_by(Year, Month_txt) %>% 
  summarise(deaths_month = sum(deaths_month)) %>% 
  ungroup() %>% 
  mutate(Year = as.numeric(str_replace(Year, fixed("x"), "")),
         Month = match(Month_txt, month.name)) %>% 
  select(-Month_txt) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) %>% 
  left_join(sweden_pop) %>% 
  arrange(Year, Month)

write_rds(sweden_deaths_monthly, "data/SCB/sweden_deaths_monthly.Rds")
write_dta(sweden_deaths_monthly, "data/SCB/sweden_deaths_monthly.dta")
```

## Deaths monthly

```{r echo=FALSE}
sweden_deaths_monthly %>% 
  ggplot(aes(x = Date, y = deaths_month)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Monthly deaths")
```

## Population yearly monthly

```{r echo=FALSE}
sweden_pop %>% 
  ggplot(aes(x = Year, y = population)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population")

rm(sweden_pop)
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`
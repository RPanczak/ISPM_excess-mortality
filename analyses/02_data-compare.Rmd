---
title: "Excess mortality"
subtitle: "Data preparation"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, magrittr, janitor, scales, 
       readxl, haven, 
       kableExtra,
       aweek, wktmo)
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# HMD - historical data

[The Human Mortality Database](https://www.mortality.org/) data.  

Available on yearly resolution only but for one year age bands & separate by sex.  

```{r eval=FALSE}
p_load(HMDHFDplus)

password <- readr::read_file("secrets/HMD.txt")

# CH
# pop
hmd_ch_pop_raw <- readHMDweb(CNTRY = "CHE", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_pop_raw, "data-raw/mortality_org/hmd_ch_pop_raw.Rds")

# deaths
hmd_ch_deaths_raw <- readHMDweb(CNTRY = "CHE", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_deaths_raw, "data-raw/mortality_org/hmd_ch_deaths_raw.Rds")

# ES
# pop
# 1975 problem resolved in #45
hmd_es_pop_raw <- readHMDweb(CNTRY = "ESP", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble() %>% 
  mutate(Year = ifelse(Year == "1975+", 1975, Year)) %>% 
  filter(Year != "1975-") %>% 
  mutate(Year = as.numeric(Year))

write_rds(hmd_es_pop_raw, "data-raw/mortality_org/hmd_es_pop_raw.Rds")

# deaths
hmd_es_deaths_raw <- readHMDweb(CNTRY = "ESP", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_es_deaths_raw, "data-raw/mortality_org/hmd_es_deaths_raw.Rds")

# SE
# pop
hmd_se_pop_raw <- readHMDweb(CNTRY = "SWE", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_se_pop_raw, "data-raw/mortality_org/hmd_se_pop_raw.Rds")

# deaths
hmd_se_deaths_raw <- readHMDweb(CNTRY = "SWE", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_se_deaths_raw, "data-raw/mortality_org/hmd_se_deaths_raw.Rds")

p_unload(HMDHFDplus)
```

## Yearly deaths

```{r}
hmd_deaths_age_sex <- 
  bind_rows(
    read_rds("data-raw/mortality_org/hmd_es_deaths_raw.Rds") %>% mutate(Country = "Spain"), 
    read_rds("data-raw/mortality_org/hmd_se_deaths_raw.Rds") %>% mutate(Country = "Sweden"), 
    read_rds("data-raw/mortality_org/hmd_ch_deaths_raw.Rds") %>% mutate(Country = "Switzerland")
  ) %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.integer(Age),
         Female = as.integer(round(Female)),
         Male = as.integer(round(Male)), 
         Total = as.integer(round(Total))) %>% 
  relocate(Country) 

write_rds(hmd_deaths_age_sex, "data/mortality_org/hmd_deaths_age_sex.Rds")

hmd_deaths_year <- hmd_deaths_age_sex %>% 
  group_by(Country, Year) %>%
  summarise(Deaths = as.integer(round(sum(Total)))) %>% 
  ungroup()

write_rds(hmd_deaths_year, "data/mortality_org/hmd_deaths_year.Rds")
```

Sweden has one more year of data than other two countries:   

```{r}
hmd_deaths_age_sex %>% 
  group_by(Country) %>% 
  summarize(Max = max(Year))
```

Yearly totals per country indicating different time frames of data.  

```{r echo=FALSE}
hmd_deaths_year %>%
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Deaths, color = Country)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

Example of age & sex breakdown for Switzerland.

```{r echo=FALSE}
hmd_deaths_age_sex %>% 
  filter(Country == "Switzerland") %>% 
  filter(Year == 1876 | Year == 2018) %>% 
  select(Year, Age, Female, Male) %>% 
  pivot_longer(c("Female", "Male"), names_to = "Sex") %>% 
  mutate(Age_cat = cut(Age, seq(0, 110, 10), 
                       include.lowest = TRUE)) %>% 
  group_by(Year, Sex, Age_cat) %>% 
  summarise(pop = sum(value)) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = ifelse(test = Sex == "Male", 
                                  yes = -pop, no = pop), 
                       y = Age_cat, fill = Sex)) +
  geom_col(width = 1) +
  lemon::scale_x_symmetric(labels = abs) +
  labs(x = "Deaths", y = "Age at death") +
  facet_grid(vars(Year)) +
  theme_bw() +
  scale_fill_brewer(palette = "Set1")
```

## Yearly population

Similarly, population data is available with 1y age bands by year. 

```{r include=FALSE}
hmd_pop_age_sex <- 
  bind_rows(
    read_rds("data-raw/mortality_org/hmd_es_pop_raw.Rds") %>%
      mutate(Country = "Spain"),
    read_rds("data-raw/mortality_org/hmd_se_pop_raw.Rds") %>%
      mutate(Country = "Sweden"),
    read_rds("data-raw/mortality_org/hmd_ch_pop_raw.Rds") %>%
      mutate(Country = "Switzerland")
  ) %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.integer(Age),
         Female = as.integer(round(Female)),
         Male = as.integer(round(Male)), 
         Total = as.integer(round(Total))) %>% 
  relocate(Country) 

write_rds(hmd_pop_age_sex, "data/mortality_org/hmd_pop_age_sex.Rds")

hmd_pop_year <- hmd_pop_age_sex %>% 
  group_by(Country, Year) %>%
  summarise(Population = as.integer(round(sum(Total)))) %>% 
  ungroup()

write_rds(hmd_pop_year, "data/mortality_org/hmd_pop_year.Rds")
```

Again, Sweden has more data - and already includes 2020:  

```{r}
hmd_pop_age_sex %>% 
  group_by(Country) %>% 
  summarize(Max = max(Year))
```

Yearly totals  

```{r echo=FALSE}
hmd_pop_year  %>% 
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Population/1000000, colour = Country)) +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]") +
  scale_y_continuous(labels = comma)
```

Again, age structure is available yearly.  

```{r echo=FALSE}
hmd_pop_age_sex %>% 
  filter(Country == "Switzerland") %>% 
  filter(Year == 1876 | Year == 2019) %>% 
  select(Year, Age, Female, Male) %>% 
  pivot_longer(c("Female", "Male"), names_to = "Sex") %>% 
  mutate(Age_cat = cut(Age, seq(0, 110, 10), 
                       include.lowest = TRUE)) %>% 
  group_by(Year, Sex, Age_cat) %>% 
  summarise(pop = sum(value)) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = ifelse(test = Sex == "Male", 
                                  yes = -pop, no = pop), 
                       y = Age_cat, fill = Sex)) +
  geom_col(width = 1) +
  lemon::scale_x_symmetric(labels = abs) +
  labs(x = "Population", y = "Age") +
  facet_grid(vars(Year)) +
  theme_bw() +
  scale_fill_brewer(palette = "Set1")
```

<!-- ----------------------------------------------------- -->

# HMD - STMF data series

Short-term Mortality Fluctuations weekly dataset to cover 2020 data

```{r eval=FALSE}
download.file(url = "https://www.mortality.org/Public/STMF/Outputs/stmf.csv",
              destfile = "data-raw/mortality_org/stmf_week.csv",
              method = "curl")

zip(zipfile = "data-raw/mortality_org/stmf_week", 
    files = "data-raw/mortality_org/stmf_week.csv")

file.remove("data-raw/mortality_org/stmf_week.csv")

download.file(url = "https://www.mortality.org/Public/STMF_DOC/STMFmetadata.pdf",
              destfile = "data-raw/mortality_org/STMFmetadata.pdf",
              method = "curl")

download.file(url = "https://www.mortality.org/Public/STMF_DOC/STMFNote.pdf",
              destfile = "data-raw/mortality_org/STMFNote.pdf",
              method = "curl")
```

## Weekly

```{r}
stmf_week <- read_csv("data-raw/mortality_org/stmf_week.zip", 
                      col_types = cols(Year = col_integer(), 
                                       Week = col_integer(), 
                                       Split = col_integer(), 
                                       SplitSex = col_integer(), 
                                       Forecast = col_integer()), 
                      skip = 1) %>% 
  filter(CountryCode %in% c("CHE", "ESP", "SWE")) %>% 
  filter(Sex == "b") %>% 
  select(CountryCode, Year, Week, DTotal) %>% 
  rename(Deaths = DTotal) %>%  
  mutate(Week2 = get_aweek(week = Week, year = Year, 
                           start = "Monday", week_start = "Monday"),
         Week_start = get_date(week = Week, year = Year, 
                               start = "Monday"),
         Deaths = as.integer(Deaths)) %>% 
  relocate(Week2, Week_start, .after = Week) %>% 
  mutate(Country = case_when(
    CountryCode == "CHE" ~ "Switzerland",
    CountryCode == "ESP" ~ "Spain",
    CountryCode == "SWE" ~ "Sweden"
  )) %>% select(-CountryCode) %>% relocate(Country)

write_rds(stmf_week, "data/mortality_org/stmf_week.Rds")
```

```{r echo=FALSE}
stmf_week %>% 
  filter(Year >= 2019) %>% 
  ggplot(aes(x = Week_start)) +
  geom_line(aes(y = Deaths, group = Country, color = Country)) +
  theme_bw() +
  xlab("") + ylab("Weekly number of deaths")
```

## Monthly

Weekly data converted to monthly using [weekToMonth](https://rdrr.io/cran/wktmo/man/weekToMonth.html) function from `wktmo` package. 

```{r}
stmf_month <- bind_rows(
  
  weekToMonth(stmf_week[stmf_week$Country == "Switzerland", ]$Deaths, 
              datStart = "03-01-2000", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Switzerland"),
  
  weekToMonth(stmf_week[stmf_week$Country == "Spain", ]$Deaths, 
              datStart = "03-01-2000", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Spain"),
  
  weekToMonth(stmf_week[stmf_week$Country == "Sweden", ]$Deaths, 
              datStart = "03-01-2000", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Sweden") 
  
) %>% 
  separate(yearMonth, c("Year", "Month"), convert = TRUE) %>% 
  rename(Deaths = value) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month)),
         Deaths = as.integer(Deaths)) %>% 
  relocate(Country, Year, Month, Date)

write_rds(stmf_month, "data/mortality_org/stmf_month.Rds")
```

```{r echo=FALSE}
stmf_month %>% 
  filter(Date != as.Date("2021-06-01")) %>%
  filter(Year >= 2019) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Deaths, group = Country, color = Country)) +
  theme_bw() +
  xlab("") + ylab("Monthly number of deaths")
```

*Note: Excluding June 2021.*  

## Yearly totals

Conversions are not perfect!  

Example of 2019+ totals derived from weekly data:

```{r}
left_join(
  stmf_week %>% 
    filter(Year >= 2019) %>% 
    group_by(Country, Year) %>% 
    summarise(Weekly = round(sum(Deaths))) %>% 
    ungroup(),
  
  stmf_month %>% 
    filter(Year >= 2019) %>% 
    group_by(Country, Year) %>% 
    summarise(Monthly = round(sum(Deaths))) %>% 
    ungroup()
) %>% 
  mutate(Difference = Weekly - Monthly,
         Perc_weekly = percent((Weekly - Monthly) / Weekly, accuracy = 0.01)) %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)
```

Showing small imperfections of the `week -> month` transition!

<!-- ----------------------------------------------------- -->

# Switzerland 

## Monthly deaths 

Historical data from [Todesfälle nach Monat und Sterblichkeit seit 1803](https://www.bfs.admin.ch/bfs/de/home/statistiken/kataloge-datenbanken/daten.assetdetail.14387168.html).

Using data since 1877 only where monthly registration starts.  
With important update from @Kaspar **covering missing months between 1886 and 1900**!  

```{r message=FALSE, warning=FALSE}
ch_deaths_year <- read_xlsx("data-raw/BfS/px-x-0102020206_111_20210223-102443.xlsx", 
                            skip = 2, na = "...") %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Year = x1) %>% 
  filter(!is.na(todesfalle_total)) %>% 
  select(Year:todesfalle_im_dezember) %>% 
  select(Year, todesfalle_total) %>% 
  rename(Deaths = todesfalle_total) %>% 
  mutate(Year = as.integer(Year),
         Deaths = as.integer(Deaths))

write_rds(ch_deaths_year, "data/BfS/ch_deaths_year.Rds")

ch_deaths_month <- read_xlsx("data-raw/BfS/Todesf_n_Monat_seit_1877_DEM_2.xlsx") %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Year = jahr) %>% 
  mutate(Year = as.integer(Year)) %>% 
  pivot_longer(!Year, names_to = "Month", values_to = "Deaths") %>% 
  mutate(Month = as.numeric(str_replace(Month, fixed("m"), "")))  %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  mutate(Year = as.integer(Year),
         Month = as.integer(Month),
         Deaths = as.integer(Deaths)) %>% 
  relocate(Year, Month, Date)
```

```{r echo=FALSE}
ggplot(data = ch_deaths_year, 
       aes(x = Year)) +
  geom_line(aes(y = Deaths)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

```{r echo=FALSE}
ggplot(data = ch_deaths_month, 
       aes(x = Date)) +
  geom_line(aes(y = Deaths)) +
  theme_bw() +
  xlab("") + ylab("Monthly number of deaths")
```

## 2019-2020 deaths with age & sex structure

To supplement HMD.  

```{r}
ch_deaths_age_sex_2019 <- read_csv("data-raw/BfS/Lieferung_Staub_2021.csv", 
                                   col_types = cols(KalJahr = col_integer(),
                                                    Alter = col_integer(),
                                                    COUNT = col_integer()), 
                                   trim_ws = TRUE) %>% 
  rename(Year = KalJahr, Age = Alter, Sex = Geschlecht, Deaths = COUNT) %>% 
  pivot_wider(names_from = Sex, values_from = Deaths) %>% 
  rename(Female = F, Male = M) %>% 
  mutate_at(vars(Female:Male), ~replace(., is.na(.), 0)) %>% 
  mutate(Country = "Switzerland",
         Female = as.integer(round(Female)),
         Male = as.integer(round(Male)), 
         Total = Female + Male) %>% 
  relocate(Country)

write_rds(ch_deaths_age_sex_2019, "data/BfS/ch_deaths_age_sex_2019.Rds")
```

## Yearly pops 

[Demographic balance of the permanent resident population, 1861-2019](https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/tables.assetdetail.13707412.html). Population of Jan and Dec averaged.  

```{r}
ch_pop_year <- read_xlsx("data-raw/BfS/su-e-01.02.04.05.xlsx", 
                         na = "...", skip = 1) %>% 
  remove_empty(c("rows", "cols")) %>%
  clean_names() %>% 
  rename(Year = x1, pop_jan = population_on_2, pop_dec = population_on_11) %>%
  filter(!is.na(Year)) %>% 
  filter(!is.na(pop_jan)) %>% 
  mutate(Year = if_else(Year == "2010 7", "2010", Year),
         Year = as.integer(Year), 
         pop_jan = as.integer(pop_jan),
         pop_dec = as.integer(pop_dec)) %>% 
  select(Year, starts_with("pop_"))
```

## Yearly pops 2020 

<!-- 2020 simply `lm` predicted using pops from last 10 years -->

```{r eval=FALSE, include=FALSE}
(pop_2020_pred <- predict(
  lm(Population ~ Year,
     data = ch_pop_year %>% filter(Year >= 2010)),
  new = tibble(Year = 2020)))
```

2020 from [Provisional demographic balance of the permanent resident population 2020 by canton, citizenship (category), sex, age and demographic component](https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/data.assetdetail.16224502.html).     

```{r}
pop_2020 <- pxR::read.px("data-raw/BfS/px-x-0102020000_202.px") %>% 
  as_tibble() %>% remove_empty(c("rows", "cols")) %>% clean_names() %>% 
  filter(demografische_komponente %in% c("Bestand am 1. Januar", "Bestand am 31. Dezember")) %>% 
  filter(alter == "Alter - Total") %>% 
  filter(geschlecht == "Geschlecht - Total") %>% 
  filter(kanton == "Schweiz") %>% 
  filter(staatsangehorigkeit_kategorie == "Staatsangehörigkeit (Kategorie) - Total") %>% 
  select(demografische_komponente, value) %>% 
  pivot_wider(names_from = demografische_komponente, values_from = value) %>% 
  rename(pop_jan = `Bestand am 1. Januar`,
         pop_dec = `Bestand am 31. Dezember`) %>% 
  mutate(pop_jan = as.integer(pop_jan),
         pop_dec = as.integer(pop_dec),
         Year = as.integer(2020)) 

ch_pop_year %<>% 
  bind_rows(pop_2020) %>% 
  mutate(Population = as.integer(round((pop_jan + pop_dec) / 2))) %>% 
  relocate(Year)

write_rds(ch_pop_year, "data/BfS/ch_pop_year.Rds")
rm(pop_2020)

ch_deaths_month %<>% 
  left_join(ch_pop_year %>% select(Year, Population))

write_rds(ch_deaths_month, "data/BfS/ch_deaths_month.Rds")
```

```{r echo=FALSE}
ggplot(ch_pop_year, aes(x = Year)) +
  geom_line(aes(y = Population)) +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]") +
  scale_y_continuous(labels = comma)
```

## 2020 pops with age structure

Using provisional figures linked above. Same as previously mean of Jan and Dec is taken, apart from `0 Jahre` age group where only figures from `31 Dec` are taken (`1st Jan` value is strangely `0` for this group).  

```{r eval=FALSE}
download.file(url = "https://www.bfs.admin.ch/bfsstatic/dam/assets/16224502/master",
              destfile = "data-raw/BfS/px-x-0102020000_202.px",
              method = "curl")
```

```{r}
ch_pop_age_sex_2020 <- pxR::read.px("data-raw/BfS/px-x-0102020000_202.px") %>% 
  as_tibble() %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>%
  # both and mean?
  filter(demografische_komponente %in% c("Bestand am 1. Januar", "Bestand am 31. Dezember")) %>%
  # apart from 0 age!
  filter(! (demografische_komponente == "Bestand am 1. Januar" & alter == "0 Jahre")) %>% 
  # # 1st Jan for all apart from 0?
  # filter(
  #   (demografische_komponente == "Bestand am 1. Januar" &
  #      alter != "0 Jahre") |
  #     (demografische_komponente == "Bestand am 31. Dezember" &
  #        alter == "0 Jahre")) %>%
  # # 31 Dec for everybody?
  # filter(
  #   demografische_komponente == "Bestand am 31. Dezember") %>% 
  filter(alter != "Alter - Total") %>% 
  filter(kanton == "Schweiz") %>% 
  filter(staatsangehorigkeit_kategorie == "Staatsangehörigkeit (Kategorie) - Total") %>% 
  select(-kanton, -jahr, -staatsangehorigkeit_kategorie) %>% 
  group_by(alter, geschlecht) %>% 
  summarise(Population = as.integer(round(mean(value)))) %>% 
  ungroup() %>%   
  mutate(alter = str_replace(alter, fixed(" Jahre"), "")) %>% 
  mutate(alter = str_replace(alter, fixed(" Jahr"), "")) %>% 
  mutate(alter = str_replace(alter, fixed(" und mehr"), "")) %>% 
  mutate(Age = as.integer(alter)) %>% 
  select(-alter) %>% 
  mutate(geschlecht = str_replace(geschlecht, fixed("Geschlecht - "), "")) %>% 
  mutate(geschlecht = str_replace(geschlecht, fixed("Frau"), "Female")) %>% 
  mutate(geschlecht = str_replace(geschlecht, fixed("Mann"), "Male")) %>% 
  pivot_wider(names_from = geschlecht, values_from = Population) %>% 
  mutate(Country = "Switzerland", 
         Year = as.integer(2020)) %>% 
  relocate(Country, Year, Age, Female, Male, Total)

write_rds(ch_pop_age_sex_2020, "data/BfS/ch_pop_age_sex_2020.Rds")
```

<!-- Altarnative source might be [Ständige Wohnbevölkerung nach Geschlecht und Altersklasse, Provisorische Jahresergebnisse, 2016-2020](https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/data.assetdetail.16404495.html). These however holds **Dec** pops only.   -->

```{r eval=FALSE}
download.file(url = "https://www.bfs.admin.ch/bfsstatic/dam/assets/16404495/master",
              destfile = "data-raw/BfS/cc-d-01.02.03.03.xlsx",
              method = "curl")
```

## Comparison - pops

### Totals

BfS vs HMD  

```{r}
compare <- left_join(
  ch_pop_year %>% rename(BfS_pop = Population), 
  hmd_pop_year %>% filter(Country == "Switzerland") %>% rename(HMD_pop = Population)) %>% 
  select(-Country) %>% 
  mutate(diff1 = pop_jan - HMD_pop,
         diff2 = pop_dec - HMD_pop,
         diff3 = BfS_pop - HMD_pop)
```

Difference between **Jan** pop from BfS and **yearly** pop from HMD

```{r}
summary(compare$diff1)
```

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = diff1)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

Difference between **Dec** pop from BfS and **yearly** pop from HMD

```{r}
summary(compare$diff2)
```

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = diff2)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

Difference between **mean** pop from BfS and **yearly** pop from HMD

```{r}
summary(compare$diff3)
```

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = diff3)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

### Age groups

Julien tracked down some weird patterns in Population estimates for 2020.  

Particularly in older age groups we have some serious jumps in N!?  

```{r}
hmd_pop_age_sex %>% 
  filter(Country == "Switzerland") %>% 
  filter(Year >= 2010) %>% 
  mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                       include.lowest = TRUE,
                       right=FALSE,
                       labels=c("0-9","10-19","20-29","30-39","40-49",
                                "50-59","60-69","70-79","80-89","90+"))) %>% 
  group_by(Year, Age_cat) %>% 
  summarise(Population = sum(Total)) %>% 
  ungroup() %>% 
  bind_rows(
    ch_pop_age_sex_2020 %>% 
      mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                           include.lowest = TRUE,
                           right=FALSE,
                           labels=c("0-9","10-19","20-29","30-39","40-49",
                                    "50-59","60-69","70-79","80-89","90+"))) %>% 
      group_by(Year, Age_cat) %>% 
      summarise(Population = sum(Total))
  ) %>% 
  ggplot(
    aes(x = Age_cat, y = Population, 
        fill = factor(Year), factor(Year))) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = comma) +
  theme_bw() +
  scale_fill_viridis_d(option = "E", direction = -1) +
  xlab("") + ylab("Yearly population by age group")
```

## Comparison - deaths

<!-- ### Yearly vs. monthly BfS figures -->

```{r eval=FALSE, include=FALSE}
ch_deaths_month %>% 
  filter(!is.na(Deaths)) %>% 
  group_by(Year) %>% 
  summarize(deaths_summed = sum(Deaths)) %>% 
  ungroup() %>% 
  left_join(ch_deaths_year) %>% 
  filter(Deaths != deaths_summed) %>% 
  nrow()
```

<!-- *There are no years where summed monthly data differ from yearly numbers.* -->

### BfS vs HMD {.tabset}

```{r}
compare <- left_join(
  ch_deaths_year %>% 
    rename(deaths_year_bfs = Deaths), 
  hmd_deaths_year %>% 
    filter(Country == "Switzerland") %>% 
    rename(deaths_year_hmd = Deaths)) %>% 
  mutate(diff = deaths_year_bfs - deaths_year_hmd,
         perc = (deaths_year_bfs - deaths_year_hmd) / deaths_year_bfs)
```

Timeline of differences between yearly BfS and HMD figures. 

#### Absolute

```{r}
summary(compare$diff)
```

```{r echo=FALSE}
ggplot(compare, aes(x = Year, y = diff)) +
  geom_hline(yintercept = 0, colour = "lightblue") +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly difference in number of deaths")
```

#### Percentage

```{r}
summary(compare$perc*100)
```

```{r echo=FALSE}
ggplot(compare, aes(x = Year, y = perc*100)) +
  geom_hline(yintercept = 0, colour = "lightblue") +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly difference in number of deaths")
```

### BfS vs STMF  {.tabset}

Comparing monthly figures - see above for week <> month issues!  

```{r}
compare <- inner_join(
  ch_deaths_month %>% 
    rename(deaths_bfs = Deaths),
  stmf_month %>% 
    filter(Country == "Switzerland") %>% 
    rename(deaths_stmf = Deaths) 
) %>% 
  mutate(diff = deaths_bfs - deaths_stmf,
         perc = (deaths_bfs - deaths_stmf) / deaths_bfs)
```

Summary of differences between monthly BfS and STMF figures. 

#### Absolute

```{r}
summary(compare$diff)
```

```{r echo=FALSE}
ggplot(compare, aes(x = Date, y = diff)) +
  geom_hline(yintercept = 0, colour = "lightblue") +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly difference in number of deaths")
```

#### Percentage

```{r}
summary(compare$perc*100)
```

```{r echo=FALSE}
ggplot(compare, aes(x = Date, y = perc*100)) +
  geom_hline(yintercept = 0, colour = "lightblue") +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly difference in number of deaths")
```

<!-- ----------------------------------------------------- -->

# Spain

## Monthly deaths 

```{r}
es_deaths_month <- read_xlsx("data-raw/INE/Spain.xlsx") %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Year = jahr) %>% 
  pivot_longer(!Year, names_to = "Month", values_to = "Deaths") %>% 
  mutate(Month = as.integer(str_replace(Month, fixed("m"), "")),
         Year = as.integer(Year),
         Deaths = as.integer(round(Deaths)))  %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) 
```

```{r echo=FALSE}
es_deaths_month %>% 
  ggplot(aes(x = Date, y = Deaths)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Monthly deaths")
```

## Yearly pops 

```{r}
es_pop_year <- read_xlsx("data-raw/INE/Spain_population.xlsx") %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Year = year) %>% 
  rename(Population = prados_de_la_escosura2020_july) %>% 
  select(Year, Population) %>% 
  mutate(Year = as.integer(Year),
         Population = as.integer(round(Population)))

write_rds(es_pop_year, "data/INE/es_pop_year.Rds")

es_deaths_month %<>% 
  left_join(es_pop_year)

write_rds(es_deaths_month, "data/INE/es_deaths_month.Rds")
```

```{r echo=FALSE}
es_pop_year %>% 
  ggplot(aes(x = Year, y = Population)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population")
```

### 2019-2020 deaths with age structure

```{r}
es_deaths_age_sex_2019 <- bind_rows(
  
  read_delim("data-raw/INE/Spain2019age.csv",
             delim = ";",
             locale = locale(grouping_mark = "."),
             trim_ws = TRUE) %>% 
    mutate(Year = as.integer(2019)) %>% 
    mutate(Age = word(Edad, 1),
           Age = str_replace(Age, fixed("Menores"), "0"),
           Age = as.integer(Age)
    ) %>% 
    select(Year, Age, Total) %>% 
    mutate(Total = as.integer(round(Total))), 
  
  read_delim("data-raw/INE/Spain2020weeklyage.csv",
                         delim = ";",
                         locale = locale(grouping_mark = "."),
                         trim_ws = TRUE) %>% 
    rename(Edad = `Edad (grupos quinquenales)`) %>% 
    filter(Edad != "Todas las edades") %>% 
    filter(Edad != "No consta") %>% 
    mutate(Year = as.integer(2020)) %>% 
    mutate(Age = str_replace(Edad, fixed("De "), ""),
           Age = word(Age, 1),
           Age = as.integer(Age)
    ) %>% 
    group_by(Year, Age) %>% 
    summarize(Total = as.integer(round(sum(Total)))) %>% 
    ungroup() 
  
) %>% 
  mutate(Country = "Spain") %>% relocate(Country)

write_rds(es_deaths_age_sex_2019, "data/INE/es_deaths_age_sex_2019.Rds")
```

### 2020 pops with age structure

TBD...  

<!-- ----------------------------------------------------- -->

# Sweden

```{r}
se_deaths_month <- read_csv("data-raw/SCB/000000NF_20210315-164930.csv",
                            skip = 2) %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Month_txt = month) %>% 
  filter(Month_txt != "Unknown") %>% 
  select(-sex) %>% 
  pivot_longer(!Month_txt, names_to = "Year", values_to = "Deaths") %>% 
  group_by(Year, Month_txt) %>% 
  summarise(Deaths = sum(Deaths)) %>% 
  ungroup() %>% 
  mutate(Year = as.integer(str_replace(Year, fixed("x"), "")),
         Month = match(Month_txt, month.name),
         Deaths = as.integer(round(Deaths))) %>% 
  select(-Month_txt) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) %>% 
  arrange(Year, Month)
```

## Monthly deaths 

```{r echo=FALSE}
se_deaths_month %>% 
  ggplot(aes(x = Date, y = Deaths)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Monthly deaths")
```

## Yearly pops 

```{r}
se_pop_year <- read_xlsx("data-raw/SCB/be0101_tab9utveng1749-2020.xlsx",
                         skip = 4) %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Population = population) %>% 
  select(year, Population) %>% 
  filter(!is.na(Population)) %>% 
  mutate(year = ifelse(year == "20001)", 2000, year),
         year = as.integer(year),
         Population = as.integer(round(Population))) %>% 
  rename(Year = year) 

write_rds(se_pop_year, "data/SCB/se_pop_year.Rds")

se_deaths_month %<>% 
  left_join(se_pop_year)

write_rds(se_deaths_month, "data/SCB/se_deaths_month.Rds")
```

```{r echo=FALSE}
se_pop_year %>% 
  ggplot(aes(x = Year, y = Population)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population")
```

### 2019-2020 deaths with age & sex structure

```{r}
se_deaths_age_sex_2019 <- read_xlsx("data-raw/SCB/BE0101D9_20210429-200440.xlsx", 
                                    col_types = c("text", "text", "text", "numeric", "numeric"), 
                                    skip = 2) %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  filter(!is.na(x2019)) %>% 
  select(-x1) %>% 
  mutate(x3 = if_else(x3 == "men", "Male", "Female")) %>% 
  fill(x2) %>% 
  pivot_longer(cols = x2019:x2020, names_to = "Year") %>% 
  rename(Age = x2, Sex = x3) %>% 
  mutate(Year = as.integer(str_replace(Year, fixed("x"), "")),
         Age = word(Age, 1),
         Age = str_replace(Age, fixed("100+"), "100"),
         Age = as.integer(Age)) %>% 
  pivot_wider(names_from = Sex, values_from = value) %>% 
  mutate(Male = as.integer(round(Male)),
         Female = as.integer(round(Female))) %>% 
  mutate(Total = Male + Female) %>% 
  arrange(Year, Age) %>% 
  mutate(Country = "Sweden") %>% relocate(Country)

write_rds(se_deaths_age_sex_2019, "data/SCB/se_deaths_age_sex_2019.Rds")
```

### 2020 pops with age structure

HMD already has data for Sweden for 2020.  

```{r}
hmd_pop_age_sex %>% 
  filter(Country == "Sweden") %>% 
  summarize(Max = max(Year))
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`
---
title: "Excess mortality"
subtitle: "Data preparation"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, magrittr, janitor, scales,
       readxl, lubridate, aweek, wktmo,
       kableExtra, lemon)

import::from("pxR", "read.px")
# import::from("lemon", "scale_x_symmetric")
# import::from("wktmo", "weekToMonth")
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# HMD - yearly data with age & sex structure

[The Human Mortality Database](https://www.mortality.org/) is the source of the data.  

Available on yearly resolution only but for one year age bands & separate by sex.  
In order to download the [chunk option](https://yihui.org/knitr/options/) of the code snippet below has to be changed to `eval=TRUE` and a password to user account on mortality.org website stored in plain text file `HMD.txt` in `secrets` directory of the project.  

```{r eval=FALSE}
p_load(HMDHFDplus)

# text file with password or modify password in calls below
password <- readr::read_file("secrets/HMD.txt")

# CH
# pop
hmd_ch_pop_raw <- readHMDweb(CNTRY = "CHE", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_pop_raw, "data-raw/mortality_org/hmd_ch_pop_raw.Rds")

# deaths
hmd_ch_deaths_raw <- readHMDweb(CNTRY = "CHE", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_deaths_raw, "data-raw/mortality_org/hmd_ch_deaths_raw.Rds")

# ES
# pop
# 1975 problem resolved in issue #45
hmd_es_pop_raw <- readHMDweb(CNTRY = "ESP", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble() %>% 
  mutate(Year = ifelse(Year == "1975+", 1975, Year)) %>% 
  filter(Year != "1975-") %>% 
  mutate(Year = as.numeric(Year))

write_rds(hmd_es_pop_raw, "data-raw/mortality_org/hmd_es_pop_raw.Rds")

# deaths
hmd_es_deaths_raw <- readHMDweb(CNTRY = "ESP", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_es_deaths_raw, "data-raw/mortality_org/hmd_es_deaths_raw.Rds")

# SE
# pop
hmd_se_pop_raw <- readHMDweb(CNTRY = "SWE", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_se_pop_raw, "data-raw/mortality_org/hmd_se_pop_raw.Rds")

# deaths
hmd_se_deaths_raw <- readHMDweb(CNTRY = "SWE", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_se_deaths_raw, "data-raw/mortality_org/hmd_se_deaths_raw.Rds")

p_unload(HMDHFDplus)
```

## Yearly deaths

Combining three countries into one dataset.  

```{r}
hmd_deaths_age_sex <- 
  bind_rows(
    read_rds("data-raw/mortality_org/hmd_es_deaths_raw.Rds") %>% mutate(Country = "Spain"), 
    read_rds("data-raw/mortality_org/hmd_se_deaths_raw.Rds") %>% mutate(Country = "Sweden"), 
    read_rds("data-raw/mortality_org/hmd_ch_deaths_raw.Rds") %>% mutate(Country = "Switzerland")
  ) %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Year = as.integer(Year),
         Age = as.integer(Age),
         Female = as.integer(round(Female)),
         Male = as.integer(round(Male)), 
         Total = as.integer(round(Total))) %>% 
  relocate(Country) 

write_rds(hmd_deaths_age_sex, "data/mortality_org/hmd_deaths_age_sex.Rds")
```

Note: Spain has *two years less* of data than other two countries:  

```{r echo=FALSE}
hmd_deaths_age_sex %>% 
  group_by(Country) %>% 
  summarize(Max = max(Year)) 
```

Yearly totals per country indicating different time frames of data.  

```{r}
hmd_deaths_year <- hmd_deaths_age_sex %>% 
  group_by(Country, Year) %>%
  summarise(Deaths = as.integer(round(sum(Total)))) %>% 
  ungroup()

write_rds(hmd_deaths_year, "data/mortality_org/hmd_deaths_year.Rds")
```

```{r echo=FALSE}
hmd_deaths_year %>%
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Deaths, color = Country)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

Example of age & sex breakdown for Switzerland, showing demographic transition and first indication of the effects of pandemics.  

```{r echo=FALSE}
hmd_deaths_age_sex %>% 
  filter(Country == "Switzerland") %>% 
  filter(Year %in% c(1876, 1917, 1918, 2019, 2020)) %>% 
  select(Year, Age, Female, Male) %>% 
  pivot_longer(c("Female", "Male"), names_to = "Sex") %>% 
  mutate(Age_cat = cut(Age, seq(0, 110, 10), 
                       include.lowest = TRUE)) %>% 
  group_by(Year, Sex, Age_cat) %>% 
  summarise(pop = sum(value)) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = ifelse(test = Sex == "Male", 
                                  yes = -pop, no = pop), 
                       y = Age_cat, fill = Sex)) +
  geom_col() +
  scale_x_symmetric(labels = abs) +
  labs(x = "Deaths", y = "Age at death") +
  facet_grid(vars(Year)) +
  theme_bw() +
  scale_fill_brewer(palette = "Set1")
```

## Yearly population

Similarly, population data is available with 1y age bands by year.  

```{r include=FALSE}
hmd_pop_age_sex <- 
  bind_rows(
    read_rds("data-raw/mortality_org/hmd_es_pop_raw.Rds") %>%
      mutate(Country = "Spain"),
    read_rds("data-raw/mortality_org/hmd_se_pop_raw.Rds") %>%
      mutate(Country = "Sweden"),
    read_rds("data-raw/mortality_org/hmd_ch_pop_raw.Rds") %>%
      mutate(Country = "Switzerland")
  ) %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.integer(Age),
         Year = as.integer(Year),
         Female = as.integer(round(Female)),
         Male = as.integer(round(Male)), 
         Total = as.integer(round(Total))) %>% 
  relocate(Country) 

write_rds(hmd_pop_age_sex, "data/mortality_org/hmd_pop_age_sex.Rds")
```

Again, *Spain has less data*:  

```{r echo=FALSE}
hmd_pop_age_sex %>% 
  group_by(Country) %>% 
  summarize(Max = max(Year)) 
```

Yearly totals  

```{r}
hmd_pop_year <- hmd_pop_age_sex %>% 
  group_by(Country, Year) %>%
  summarise(Population = as.integer(round(sum(Total)))) %>% 
  ungroup()

write_rds(hmd_pop_year, "data/mortality_org/hmd_pop_year.Rds")
```

```{r echo=FALSE}
hmd_pop_year  %>% 
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Population/1000000, colour = Country)) +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]") +
  scale_y_continuous(labels = comma)
```

Again, age structure is available on yearly resolution.  

```{r echo=FALSE}
hmd_pop_age_sex %>% 
  filter(Country == "Switzerland") %>% 
  filter(Year %in% c(1876, 2019)) %>% 
  select(Year, Age, Female, Male) %>% 
  pivot_longer(c("Female", "Male"), names_to = "Sex") %>% 
  mutate(Age_cat = cut(Age, seq(0, 110, 10), 
                       include.lowest = TRUE)) %>% 
  group_by(Year, Sex, Age_cat) %>% 
  summarise(pop = sum(value)) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = ifelse(test = Sex == "Male", 
                                  yes = -pop, no = pop), 
                       y = Age_cat, fill = Sex)) +
  geom_col() +
  scale_x_symmetric(labels = abs) +
  labs(x = "Population", y = "Age") +
  facet_grid(vars(Year)) +
  theme_bw() +
  scale_fill_brewer(palette = "Set1")
```

<!-- ----------------------------------------------------- -->

# Switzerland 

## Monthly deaths until 2020

Historical data from [Todesfälle nach Monat und Sterblichkeit seit 1803](https://www.bfs.admin.ch/bfs/de/home/statistiken/kataloge-datenbanken/daten.assetdetail.18584915.html).  

Using data **since 1877 only** when *monthly reporting starts*.  

```{r message=FALSE, warning=FALSE}
ch_deaths_month <- read.px("data-raw/BfS/px-x-0102020206_111.px") %>% 
  as_tibble() %>% remove_empty() %>% clean_names() %>% 
  rename(Year = jahr,
         Deaths = value) %>% 
  mutate(Year = as.numeric(as.character(Year))) %>% 
  filter(Year >= 1877) %>% 
  filter(str_detect(demografisches_merkmal_und_indikator, 'Todesfälle im')) %>% 
  droplevels(.) %>% 
  mutate(Month = rep(seq(1:12), times = nrow(.)/12) ) %>% 
  select(-demografisches_merkmal_und_indikator) %>% 
  mutate(Date = ymd(paste0(Year, "-", Month, "-01")),
         Year = as.integer(Year),
         Deaths = as.integer(Deaths)) %>% 
  relocate(Year, Month, Date)

write_rds(ch_deaths_month, "data/BfS/ch_deaths_month.Rds")
```

## Monthly 2021 deaths 

BfS delivered custom data to supplement first six months of 2021. Merged to dataset covering period until 2020.  

```{r}
ch_deaths_2021 <- read_csv("data-raw/BfS/Lieferung_Staub_2021_MonatsdatenJANbisJUN_Update04NOV21.csv", col_types = cols(TodJahr = col_integer(), TodMonat = col_integer(), Alter = col_integer(), COUNT = col_integer()), trim_ws = TRUE) %>% 
  rename(Year = TodJahr, Month = TodMonat, Deaths = COUNT) %>% 
  filter(Year == 2021) %>% 
  group_by(Year, Month) %>% 
  summarise(Deaths = sum(Deaths)) %>% 
  ungroup() %>% 
  mutate(Date = ymd(paste0(Year, "-", Month, "-01")),
         Deaths = as.integer(round(Deaths))) %>% 
  select(Year, Month, Date, Deaths)

ch_deaths_month %<>% 
  bind_rows(ch_deaths_2021) %>% 
  mutate(Country = "Switzerland") %>% 
  relocate(Country)
```

```{r include=FALSE}
rm(ch_deaths_2021)
```

## Monthly datasets combined 

```{r echo=FALSE}
ggplot(data = ch_deaths_month, 
       aes(x = Date)) +
  geom_line(aes(y = Deaths / 1000)) +
  theme_bw() +
  xlab("") + ylab("Monthly number of deaths [thousand]")
```

## Yearly 2021 deaths with age & sex structure

BfS delivered data to supplement missing six months of 2021.  

```{r}
ch_deaths_age_sex_2021 <- read_csv("data-raw/BfS/Lieferung_Staub_2021_MonatsdatenJANbisJUN_Update04NOV21.csv", col_types = cols(TodJahr = col_integer(), TodMonat = col_integer(), Alter = col_integer(), COUNT = col_integer()), trim_ws = TRUE) %>% 
  rename(Year = TodJahr, Age = Alter, Sex = Geschlecht, Deaths = COUNT) %>% 
  select(-TodMonat) %>% 
  group_by(Year, Age) %>% 
  summarise(Total = sum(Deaths)) %>% 
  ungroup() %>% 
  mutate(Country = "Switzerland",
         Total = as.integer(round(Total))) %>% 
  relocate(Country)
```

<!-- ----------------------------------------------------- -->

# Spain

## Monthly deaths untill 2019

Data from INE [since 1975 here](https://www.ine.es/jaxiT3/Tabla.htm?t=6561&L=1) and [1941-1974 here](https://www.ine.es/jaxiT3/Tabla.htm?t=6563&L=1); data prior to 1940 was transcribed from PDFs available from INE.  

```{r}
es_deaths_month <- read_xlsx("data-raw/INE/Spain.xlsx") %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Year = jahr) %>% 
  pivot_longer(!Year, names_to = "Month", values_to = "Deaths") %>% 
  mutate(Month = as.integer(str_replace(Month, fixed("m"), "")),
         Year = as.integer(Year),
         Deaths = as.integer(round(Deaths)))  %>%
  mutate(Date = ymd(paste0(Year, "-", Month, "-01"))) %>% 
  relocate(Year, Month, Date) %>% 
  filter(Year != 2020)
```

## Monthly 2020 deaths 

2020 update (*still labelled as provisional!*) is from  [here](https://www.ine.es/jaxi/Tabla.htm?path=/t20/e301/provi/l1/&file=02001.px&L=1)

```{r}
source("R/fn_get_death_data_spain.R")

es_2020 <- fn_get_death_data_spain("data-raw/INE/Spain_2020.xlsx") %>%
  gather(., Month, Deaths, January:December, factor_key = TRUE) %>%
  group_by(Month) %>%
  summarize(Deaths = sum(Deaths, na.rm = TRUE)) %>%
  ungroup() %>% 
  mutate(Year = as.integer(2020),
         Deaths = as.integer(Deaths),
         Date = ymd(paste0(Year, Month, "-01")),
         Month = as.integer(Month)) %>% 
  relocate(Year, Month, Date, Deaths)
```

## Monthly 2021 deaths 

2021 data available from [here](https://www.ine.es/en/experimental/defunciones/experimental_defunciones.htm#tablas_resultados).  

Note: data are in weekly format and converted with methods (and caveats!) described above in STMF chapter.  

```{r}
temp <- read_xlsx("data-raw/INE/Spain_2021_death.xlsx", skip = 9) %>%   
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Week = x1) %>% 
  filter(!is.na(de_0_a_4_anos)) %>% 
  mutate(Deaths = rowSums(.[-1])) %>% 
  select(Week, Deaths)

es_2021 <- weekToMonth(rev(temp$Deaths), datStart = "31-12-2018") %>% 
  as_tibble() %>% 
  as_tibble() %>% 
  separate(yearMonth, c("Year", "Month"), convert = TRUE) %>% 
  rename(Deaths = value) %>% 
  mutate(Date = ymd(paste0(Year, "-", Month, "-01")),
         Deaths = as.integer(Deaths)) %>% 
  relocate(Year, Month, Date) %>% 
  filter(Year == 2021) %>% 
  filter(Month <= 6)
```

## Monthly datasets combined 

```{r include=FALSE}
es_deaths_month %<>% 
  bind_rows(es_2020) %>% 
  bind_rows(es_2021) %>% 
  mutate(Country = "Spain") %>% 
  relocate(Country)

rm(es_2020, es_2021, temp); gc()
```

```{r echo=FALSE}
es_deaths_month %>% 
  ggplot(aes(x = Date, y = Deaths)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Monthly deaths")
```

## Yearly 2019-2020 deaths with age structure

INE data to supplement missing 2091-20 years in HMD.  

2019 data available [here](https://www.ine.es/jaxiT3/Tabla.htm?t=6547&L=1) and 2020 data available from [here](https://www.ine.es/jaxi/Tabla.htm?path=/t20/e301/provi/l1/&file=02001.px&L=1).  

```{r}
es_deaths_age_2019_2020 <- bind_rows(
  
  read_delim("data-raw/INE/Spain2019age.csv",
             delim = ";",
             locale = locale(grouping_mark = "."),
             trim_ws = TRUE) %>% 
    mutate(Year = as.integer(2019)) %>% 
    mutate(Age = word(Edad, 1),
           Age = str_replace(Age, fixed("Menores"), "0"),
           Age = as.integer(Age)
    ) %>% 
    select(Year, Age, Total) %>% 
    mutate(Total = as.integer(round(Total))), 
  
  fn_get_death_data_spain("data-raw/INE/Spain_2020.xlsx") %>%
    gather(., Month, Deaths, January:December, factor_key = TRUE) %>%
    group_by(Age) %>%
    dplyr::summarize(Deaths = sum(Deaths, na.rm = TRUE))%>%
    mutate(Year = as.integer(2020),
           Total = as.integer(Deaths)) %>%
    select(Year, Age, Total)
  
) %>% 
  mutate(Country = "Spain") %>% relocate(Country)
```

## Yearly 2021 deaths with age structure

INE data to supplement missing 6 months of 2021 in HMD.  

2021 data available from [here](https://www.ine.es/en/experimental/defunciones/experimental_defunciones.htm#tablas_resultados).  

Note: data are in weekly format and converted with methods (and caveats!) described above in STMF chapter.  

```{r}
temp <- read_xlsx("data-raw/INE/Spain_2021_death.xlsx", skip = 9) %>%   
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Week = x1) %>% 
  filter(!is.na(de_0_a_4_anos))

es_deaths_age_2021 <- bind_rows(
  
  weekToMonth(rev(temp$de_0_a_4_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 0) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_5_a_9_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 5) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_10_a_14_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 10) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_15_a_19_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 15) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_20_a_24_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 20) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_25_a_29_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 25) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_30_a_34_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 30) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_35_a_39_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 35) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_40_a_44_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 40) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_45_a_49_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 45) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_50_a_54_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 50) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_0_a_4_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 0) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_55_a_59_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 55) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_60_a_64_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 60) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_65_a_69_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 65) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_70_a_74_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 70) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_75_a_79_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 75) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_80_a_84_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 80) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_85_a_89_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 85) %>% as_tibble(),
  
  weekToMonth(rev(temp$x90_y_mas_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 90) %>% as_tibble()
  
) %>% 
  as_tibble() %>% 
  mutate(Country = "Spain") %>%
  separate(yearMonth, c("Year", "Month"), convert = TRUE) %>% 
  rename(Total = value) %>% 
  mutate(Total = as.integer(Total)) %>% 
  relocate(Country, Year, Month) %>% 
  filter(Year == 2021) %>% 
  filter(! (Month == 8)) %>% 
  filter(! (Month == 7))

rm(temp)
```

<!-- ----------------------------------------------------- -->

# Sweden

## Monthly deaths untill 2020 

```{r}
se_deaths_month <- read_csv("data-raw/SCB/000000NF_20210315-164930.csv",
                            skip = 2) %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Month_txt = month) %>% 
  filter(Month_txt != "Unknown") %>% 
  select(-sex) %>% 
  pivot_longer(!Month_txt, names_to = "Year", values_to = "Deaths") %>% 
  group_by(Year, Month_txt) %>% 
  summarise(Deaths = sum(Deaths)) %>% 
  ungroup() %>% 
  mutate(Year = as.integer(str_replace(Year, fixed("x"), "")),
         Month = match(Month_txt, month.name),
         Deaths = as.integer(round(Deaths))) %>% 
  select(-Month_txt) %>% 
  mutate(Date = ymd(paste0(Year, "-", Month, "-01"))) %>% 
  relocate(Year, Month, Date) %>% 
  arrange(Year, Month)
```

## Monthly 2021 deaths

[Preliminär statistik över döda (Excel)](https://www.scb.se/hitta-statistik/sverige-i-siffror/manniskorna-i-sverige/doda-i-sverige/) file is available from SCB.  Data are available till October.   

```{r eval=FALSE}
# curl command doesn't work with this URL
# please download manually!
download.file(url = "https://www.scb.se/hitta-statistik/statistik-efter-amne/befolkning/befolkningens-sammansattning/befolkningsstatistik/pong/tabell-och-diagram/preliminar-statistik-over-doda/",
              destfile = "data-raw/SCB/2021-08-23-preliminar_statistik_over_doda_inkl_eng.xlsx",
              method = "curl")
```

```{r}
se_deaths_month_2021 <- read_excel("data-raw/SCB/2021-11-01-preliminar_statistik_over_doda_inkl_eng.xlsx", sheet = "Tabell 10", skip = 10) %>% 
  filter(Region == "Hela riket" & Period == "2021 antal") %>% 
  select(Januari:Oktober) %>% 
  pivot_longer(Januari:Oktober) %>% 
  mutate(Year = 2021,
         Month = 1:10,
         Date = ymd(paste0(Year, "-", Month, "-01")),
         Deaths = as.integer(value)
  ) %>% 
  select(-name, -value) %>% 
  filter(Month <= 6)

se_deaths_month %<>% 
  bind_rows(se_deaths_month_2021) %>% 
  mutate(Country = "Sweden") %>% relocate(Country)

rm(se_deaths_month_2021)
```

## Monthly deaths combined 

```{r echo=FALSE}
se_deaths_month %>% 
  ggplot(aes(x = Date, y = Deaths)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Monthly deaths")
```

<!-- ----------------------------------------------------- -->

# Projected 2020-21 population numbers {.tabset}

```{r}
hmd_pop_age_agg <- hmd_pop_age_sex %>% 
  mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                       include.lowest = TRUE,
                       right = FALSE,
                       labels=c("0-9","10-19","20-29","30-39","40-49",
                                "50-59","60-69","70-79","80-89","90+"))) %>% 
  group_by(Country, Year, Age_cat) %>% 
  summarise(Population = sum(Total)) %>% 
  ungroup()
```

For each year, age, country stratum, linear model is fit using the 2015-2019 data; then prediction is made for 2020 & 2021 years. The gist of this operation is to exclude the effect of pandemic from the population counts in years affected.   

```{r}
# p_load(mgcv)
p_load(splines)
knots <- quantile(seq.int(2010, 2019), p = c(0.25, 0.5, 0.75))

pop_age_2020 <- hmd_pop_age_agg %>% 
  filter(Year >= 2010 & Year <= 2019) %>% 
  group_by(Country, Age_cat) %>% 
  # do(broom::tidy(lm(population ~ year, data = .))) %>% 
  # do(broom::augment(lm(population ~ year, data = .))) %>% 
  # polynomial
  # do(lm(Population ~ poly(Year, 2, raw = TRUE), data = .) %>%
  # spline
  do(lm(Population ~ bs(Year, knots = knots), data = .) %>%
       # GAM     
       # do(gam(Population ~ s(Year), data = .) %>%
       predict(., newdata = tibble(Year = c(2020, 2021))) %>%
       tibble(Year = c(2020, 2021), 
              Population = .)
  ) %>% 
  ungroup() %>% 
  mutate(Population = round(Population)) %>% 
  arrange(Country, Year, Age_cat) %>% 
  relocate(Country, Year, Age_cat, Population)
```

Absolute difference across countries and age groups in 2020:  

```{r echo=FALSE, warning=FALSE}
# Pop Spain 2020 is: "1 July 2020"
es_pop_age_2020 <- 
  read_excel("data-raw/INE/Spain_Population_age-2019.xlsx",
             sheet=1,range="A8:H212") %>%
  slice(., -(1:2)) %>%
  select(1,8) %>%
  rename(Population=`Both sexes...8`) %>%
  filter(!is.na(Population)) %>%
  mutate(Age=0:(nrow(.)-1)) %>%
  select(Age, Population) %>% 
  mutate(Year = as.integer(2020),
         Age = as.integer(Age),
         Population = as.integer(Population),
         Country = "Spain") %>% 
  rename(Total = Population) %>% 
  relocate(Country, Year)

es_pop_age_2021 <- 
  read_excel("data-raw/INE/Spain_Population_age-2019.xlsx",
             sheet=1,range="A8:B212") %>%
  slice(., -(1:2)) %>%
  select(1,2) %>%
  rename(Population=`Both sexes`) %>%
  filter(!is.na(Population)) %>%
  mutate(Age=0:(nrow(.)-1)) %>%
  select(Age, Population) %>% 
  mutate(Year = as.integer(2021),
         Age = as.integer(Age),
         Population = as.integer(Population),
         Country = "Spain") %>% 
  rename(Total = Population) %>% 
  relocate(Country, Year)

bind_rows(
  
  hmd_pop_age_sex %>% 
    filter(Year >= 2020) %>% 
    mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                         include.lowest = TRUE,
                         right = FALSE,
                         labels=c("0-9","10-19","20-29","30-39","40-49",
                                  "50-59","60-69","70-79","80-89","90+"))) %>% 
    group_by(Country, Year, Age_cat) %>% 
    summarise(Population = sum(Total)) %>% 
    ungroup(), 
  
  es_pop_age_2020 %>% 
    mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                         include.lowest = TRUE,
                         right = FALSE,
                         labels=c("0-9","10-19","20-29","30-39","40-49",
                                  "50-59","60-69","70-79","80-89","90+"))) %>% 
    group_by(Country, Year, Age_cat) %>% 
    summarise(Population = sum(Total)) %>% 
    ungroup(),
  
  es_pop_age_2021 %>% 
    mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                         include.lowest = TRUE,
                         right = FALSE,
                         labels=c("0-9","10-19","20-29","30-39","40-49",
                                  "50-59","60-69","70-79","80-89","90+"))) %>% 
    group_by(Country, Year, Age_cat) %>% 
    summarise(Population = sum(Total)) %>% 
    ungroup()
  
) %>% 
  mutate(Source = "HMD") %>% 
  bind_rows(pop_age_2020 %>% 
              mutate(Source = "Estimate")) %>% 
  ggplot(
    aes(x = Age_cat, y = Population / 1000000, 
        fill = factor(Source))) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = comma) +
  theme_bw() +
  scale_fill_viridis_d(option = "E", direction = 1) +
  xlab("Age group") + ylab("Yearly population [millions]") + 
  facet_grid(vars(Country), vars(Year), scales = "free_y")
```

Relative differences in 2020:  

```{r echo=FALSE, warning=FALSE}
bind_rows(
  
  hmd_pop_age_sex %>% 
    filter(Year >= 2020) %>% 
    mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                         include.lowest = TRUE,
                         right = FALSE,
                         labels=c("0-9","10-19","20-29","30-39","40-49",
                                  "50-59","60-69","70-79","80-89","90+"))) %>% 
    group_by(Country, Year, Age_cat) %>% 
    summarise(Population = sum(Total)) %>% 
    ungroup(), 
  
  es_pop_age_2020 %>% 
    mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                         include.lowest = TRUE,
                         right = FALSE,
                         labels=c("0-9","10-19","20-29","30-39","40-49",
                                  "50-59","60-69","70-79","80-89","90+"))) %>% 
    group_by(Country, Year, Age_cat) %>% 
    summarise(Population = sum(Total)) %>% 
    ungroup(),
  
    es_pop_age_2021 %>% 
    mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                         include.lowest = TRUE,
                         right = FALSE,
                         labels=c("0-9","10-19","20-29","30-39","40-49",
                                  "50-59","60-69","70-79","80-89","90+"))) %>% 
    group_by(Country, Year, Age_cat) %>% 
    summarise(Population = sum(Total)) %>% 
    ungroup()
  
) %>% 
  rename(Population_hmd = Population) %>% 
  full_join(pop_age_2020 %>% 
              rename(Population_lm = Population)) %>% 
  mutate(Difference = (Population_lm - Population_hmd) / Population_lm) %>% 
  ggplot(
    aes(x = Age_cat, y = Difference)) +
  geom_col() +
  scale_y_continuous(labels = percent) +
  theme_bw() +
  scale_fill_viridis_d(option = "E", direction = 1) +
  xlab("Age group") + ylab("Population difference between sources") + 
  facet_grid(vars(Country), vars(Year))
```

Example of fit & prediction:

```{r include=FALSE}
data <- bind_rows(
  
  hmd_pop_age_sex %>% 
    filter(Year >= 2010) %>% 
    mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                         include.lowest = TRUE,
                         right = FALSE,
                         labels=c("0-9","10-19","20-29","30-39","40-49",
                                  "50-59","60-69","70-79","80-89","90+"))) %>% 
    group_by(Country, Year, Age_cat) %>% 
    summarise(Population = sum(Total)) %>% 
    ungroup(), 
  
  es_pop_age_2020 %>% 
    mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                         include.lowest = TRUE,
                         right = FALSE,
                         labels=c("0-9","10-19","20-29","30-39","40-49",
                                  "50-59","60-69","70-79","80-89","90+"))) %>% 
    group_by(Country, Year, Age_cat) %>% 
    summarise(Population = sum(Total)) %>% 
    ungroup()
  
) %>% 
  mutate(Source = "HMD") %>% 
  bind_rows(pop_age_2020 %>% 
              mutate(Source = "Estimate"))
```

```{r}
fn_age_plot <- function(country) {
  data %>% 
    filter(Country == country) %>% 
    ggplot(data = .,
           aes(x = Year, y = Population / 1000000, 
               color = factor(Source))) +
    geom_point() +
    geom_smooth(data = . %>% 
                  filter(Source == "HMD" & Year < 2020),
                colour = "grey40", size = 0.5,
                method = "lm", 
                se = FALSE) +
    geom_smooth(data = . %>% 
                  filter(Source == "HMD" & Year < 2020),
                method = "lm", 
                # formula = y ~ poly(x, 2, raw = TRUE), 
                formula = y ~ splines::bs(x, df = 3),
                # method = "gam", 
                #   formula = y ~ s(x), 
                se = FALSE) + 
    scale_y_continuous(labels = comma) +
    theme_bw() +
    scale_fill_viridis_d(option = "E", direction = 1) +
    xlab("Age group") + ylab("Yearly population [millions]") + 
    facet_wrap(vars(Age_cat), scales = "free_y")
}
```

## Spain

```{r echo=FALSE, warning=FALSE}
fn_age_plot("Spain")
```

## Sweden 

```{r echo=FALSE, warning=FALSE}
fn_age_plot("Sweden")
```

## Switzerland

```{r echo=FALSE, warning=FALSE}
fn_age_plot("Switzerland")
```

<!-- ----------------------------------------------------- -->

# Combined analysis datasets

## Population

Merging HMD until 2019 and predictions for 2020 & 2021.  

```{r}
pop_age_sex <- bind_rows(
  
  hmd_pop_age_sex %>% 
    filter(Year < 2020) %>% 
    mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                         include.lowest = TRUE,
                         right = FALSE,
                         labels=c("0-9","10-19","20-29","30-39","40-49",
                                  "50-59","60-69","70-79","80-89","90+"))) %>% 
    group_by(Country, Year, Age_cat) %>% 
    summarise(Population = sum(Total)) %>% 
    ungroup(), 
  
  pop_age_2020 
) %>% 
  arrange(Country, Year, Age_cat)

pop_age_yearly <- pop_age_sex %>% 
  group_by(Country, Year) %>% 
  summarise(Population = sum(Population)) %>% 
  ungroup()
```


## Monthly deaths with yearly pops

Spain age&sex distribution in HMD is [available from later](https://github.com/RPanczak/ISPM_excess-mortality/issues/81)!

```{r}
deaths_monthly <- bind_rows(
  
  ### ESP
  es_deaths_month %>% 
    filter(Year >= 1908),
  
  # NAs for second half of year
  es_deaths_month %>% 
    filter(Year == 2020 & Month > 6) %>% 
    mutate(Year = as.integer(2021), 
           Deaths = NA_integer_),
  
  ### SWE
  se_deaths_month,
  
  se_deaths_month %>% 
    filter(Year == 2020 & Month > 6) %>% 
    mutate(Year = as.integer(2021), 
           Deaths = NA_integer_,
           Date = Date + years(1)),
  
  ch_deaths_month,
  
  ch_deaths_month %>% 
    filter(Year == 2020 & Month > 6) %>% 
    mutate(Year = as.integer(2021), 
           Deaths = NA_integer_,
           Date = Date + years(1))
  
) %>% 
  left_join(pop_age_yearly) %>% 
  arrange(Country, Year, Month) %>% 
  mutate(si_one = sin(2*pi*Month/12),
         si_two = sin(4*pi*Month/12),
         co_one = cos(2*pi*Month/12),
         co_two = cos(4*pi*Month/12)) 

write_rds(deaths_monthly, "data/deaths_monthly.Rds")
```

## Yearly deaths by sex and age group with pops

```{r}
deaths_yearly_age_sex <- bind_rows(
  
  hmd_deaths_age_sex,
  
  # SWE
  # 2020 is already in HMD for SWE 
  # 2021 is sadly missing for SWE 
  
  #ESP
  es_deaths_age_2019_2020,
  es_deaths_age_2021,
  
  # CHE
  # 2020 is already in HMD for CHE 
  ch_deaths_age_sex_2021
  
) %>% 
  select(-Female, -Male) %>% 
  mutate(# Age_cat = cut(Age, 
    # breaks = c(0, 1, 5, 20, 40, 60, 80, 112),
    # # labels = c("<1", "1-4", "5-19", "20-39", "40-59", "60-79","80+"), 
    # right = FALSE), 
    Age_cat = cut(Age, 
                  breaks = c(seq(0, 90, 10), 113), 
                  # labels = c("0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80+")), 
                  right = FALSE)
  ) %>%
  group_by(Country, Year, Age_cat) %>% 
  summarise(Deaths = sum(Total)) %>% 
  ungroup() %>% 
  left_join(pop_age_sex)

write_rds(deaths_yearly_age_sex, "data/deaths_yearly_age_sex.Rds")
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`
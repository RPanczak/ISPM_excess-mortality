---
title: "Excess mortality"
subtitle: "Data preparation"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, magrittr, janitor, scales, 
       readxl, haven, 
       kableExtra,
       aweek, wktmo)
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# HMD - historical data

[The Human Mortality Database](https://www.mortality.org/) data.  

Available on yearly resolution only but for one year age bands & separate by sex.  

```{r eval=FALSE}
p_load(HMDHFDplus)

password <- readr::read_file("secrets/HMD.txt")

# CH
# pop
hmd_ch_pop_raw <- readHMDweb(CNTRY = "CHE", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_pop_raw, "data-raw/mortality_org/hmd_ch_pop_raw.Rds")
write_dta(hmd_ch_pop_raw, "data-raw/mortality_org/hmd_ch_pop_raw.dta")

# deaths
hmd_ch_deaths_raw <- readHMDweb(CNTRY = "CHE", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_deaths_raw, "data-raw/mortality_org/hmd_ch_deaths_raw.Rds")
write_dta(hmd_ch_deaths_raw, "data-raw/mortality_org/hmd_ch_deaths_raw.dta")

# ES
# pop
# 1975 problem resolved in #45
hmd_es_pop_raw <- readHMDweb(CNTRY = "ESP", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble() %>% 
  mutate(Year = ifelse(Year == "1975+", 1975, Year)) %>% 
  filter(Year != "1975-") %>% 
  mutate(Year = as.numeric(Year))

write_rds(hmd_es_pop_raw, "data-raw/mortality_org/hmd_es_pop_raw.Rds")
write_dta(hmd_es_pop_raw, "data-raw/mortality_org/hmd_es_pop_raw.dta")

# deaths
hmd_es_deaths_raw <- readHMDweb(CNTRY = "ESP", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_es_deaths_raw, "data-raw/mortality_org/hmd_es_deaths_raw.Rds")
write_dta(hmd_es_deaths_raw, "data-raw/mortality_org/hmd_es_deaths_raw.dta")

# SE
# pop
hmd_se_pop_raw <- readHMDweb(CNTRY = "SWE", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_se_pop_raw, "data-raw/mortality_org/hmd_se_pop_raw.Rds")
write_dta(hmd_se_pop_raw, "data-raw/mortality_org/hmd_se_pop_raw.dta")

# deaths
hmd_se_deaths_raw <- readHMDweb(CNTRY = "SWE", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_se_deaths_raw, "data-raw/mortality_org/hmd_se_deaths_raw.Rds")
write_dta(hmd_se_deaths_raw, "data-raw/mortality_org/hmd_se_deaths_raw.dta")

p_unload(HMDHFDplus)
```

## Yearly deaths CH

```{r include=FALSE}
hmd_ch_deaths_year <- 
  read_rds("data-raw/mortality_org/hmd_ch_deaths_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  group_by(Year) %>%
  summarise(Deaths = sum(Total)) %>%
  ungroup() %>%
  mutate(Country = "Switzerland") %>% relocate(Country) 
```

Available from `r min(hmd_ch_deaths_year$Year)` to `r max(hmd_ch_deaths_year$Year)`.

```{r echo=FALSE}
hmd_ch_deaths_year %>% 
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Deaths)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

## Yearly deaths CH - with age & sex structure

```{r include=FALSE}
hmd_ch_deaths_age_sex <- 
  read_rds("data-raw/mortality_org/hmd_ch_deaths_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  mutate(Country = "Switzerland") %>% relocate(Country) 
```

```{r echo=FALSE}
hmd_ch_deaths_age_sex %>% 
  filter(Year == 1876 | Year == 2018) %>% 
  select(Year, Age, Female, Male) %>% 
  pivot_longer(c("Female", "Male"), names_to = "Sex") %>% 
  mutate(Age_cat = cut(Age, seq(0, 110, 10), 
                       include.lowest = TRUE)) %>% 
  group_by(Year, Sex, Age_cat) %>% 
  summarise(pop = sum(value)) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = ifelse(test = Sex == "Male", 
                                  yes = -pop, no = pop), 
                       y = Age_cat, fill = Sex)) +
  geom_col(width = 1) +
  lemon::scale_x_symmetric(labels = abs) +
  labs(x = "Population", y = "Age at death") +
  facet_grid(vars(Year)) +
  theme_bw() +
  scale_fill_brewer(palette = "Set1")
```

## Yearly pops CH

Similarly, population data is available with 1y age bands by year. 

```{r include=FALSE}
hmd_ch_pop_year <- 
  read_rds("data-raw/mortality_org/hmd_ch_pop_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  select(Year, Total) %>%
  group_by(Year) %>%
  summarise(Population = sum(Total)) %>%
  mutate(Country = "Switzerland") %>% relocate(Country) 

write_rds(hmd_ch_pop_year, "data/mortality_org/hmd_ch_pop_year.Rds")

hmd_ch_pop_age_sex <- 
  read_rds("data-raw/mortality_org/hmd_ch_pop_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  mutate(Country = "Switzerland") %>% relocate(Country) 

write_rds(hmd_ch_pop_age_sex, "data/mortality_org/hmd_ch_pop_age_sex.Rds")
```

Yearly totals, ignoring age

```{r echo=FALSE}
hmd_ch_pop_year  %>% 
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Population/1000000)) +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]") +
  scale_y_continuous(labels = comma)
```

## Yearly deaths ES

```{r include=FALSE}
hmd_es_deaths_year <- 
  read_rds("data-raw/mortality_org/hmd_es_deaths_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  select(Year, Total) %>%
  group_by(Year) %>%
  summarise(Deaths = sum(Total)) %>%
  mutate(Country = "Spain") %>% relocate(Country) 
```

Available yearly from `r min(hmd_es_deaths_year$Year)` to `r max(hmd_es_deaths_year$Year)`.

```{r echo=FALSE}
hmd_es_deaths_year %>% 
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Deaths)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

## Yearly deaths ES - with age & sex structure

```{r include=FALSE}
hmd_es_deaths_age_sex <- 
  read_rds("data-raw/mortality_org/hmd_es_deaths_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  mutate(Country = "Spain") %>% relocate(Country) 
```

## Yearly deaths SE

```{r include=FALSE}
hmd_se_deaths_year <- 
  read_rds("data-raw/mortality_org/hmd_se_deaths_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  select(Year, Total) %>%
  group_by(Year) %>%
  summarise(Deaths = sum(Total)) %>%
  mutate(Country = "Sweden") %>% relocate(Country) 
```

Available yearly from `r min(hmd_se_deaths_year$Year)` to `r max(hmd_se_deaths_year$Year)`.

```{r echo=FALSE}
hmd_se_deaths_year %>% 
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Deaths)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

## Yearly deaths SE - with age & sex structure

```{r include=FALSE}
hmd_se_deaths_age_sex <- 
  read_rds("data-raw/mortality_org/hmd_se_deaths_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  mutate(Country = "Sweden") %>% relocate(Country) %>% 
  as_tibble()
```

```{r}
hmd_deaths_age_sex <- bind_rows(hmd_ch_deaths_age_sex, hmd_es_deaths_age_sex, hmd_se_deaths_age_sex)

rm(hmd_ch_deaths_age_sex, hmd_es_deaths_age_sex, hmd_se_deaths_age_sex)

write_rds(hmd_deaths_age_sex, "data/mortality_org/hmd_deaths_age_sex.Rds")
write_dta(hmd_deaths_age_sex, "data/mortality_org/hmd_deaths_age_sex.dta")

hmd_deaths_year <- bind_rows(
  hmd_ch_deaths_year, hmd_es_deaths_year, hmd_se_deaths_year)

write_rds(hmd_deaths_year, "data/mortality_org/hmd_deaths_year.Rds")
write_dta(hmd_deaths_year, "data/mortality_org/hmd_deaths_year.dta")
```

<!-- ----------------------------------------------------- -->
# HMD - STMF data series

Short-term Mortality Fluctuations weekly dataset to cover 2020 data

## Weekly

```{r eval=FALSE}
download.file(url = "https://www.mortality.org/Public/STMF/Outputs/stmf.csv",
              destfile = "data-raw/mortality_org/stmf_weekly.csv",
              method = "curl")

zip(zipfile = "data-raw/mortality_org/stmf_weekly", 
    files = "data-raw/mortality_org/stmf_weekly.csv")

file.remove("data-raw/mortality_org/stmf_weekly.csv")

download.file(url = "https://www.mortality.org/Public/STMF_DOC/STMFmetadata.pdf",
              destfile = "data-raw/mortality_org/STMFmetadata.pdf",
              method = "curl")

download.file(url = "https://www.mortality.org/Public/STMF_DOC/STMFNote.pdf",
              destfile = "data-raw/mortality_org/STMFNote.pdf",
              method = "curl")

stmf_weekly <- read_csv("data-raw/mortality_org/stmf_weekly.zip", 
                        col_types = cols(Year = col_integer(), 
                                         Week = col_integer(), 
                                         Split = col_integer(), 
                                         SplitSex = col_integer(), 
                                         Forecast = col_integer()), 
                        skip = 1) %>% 
  filter(CountryCode %in% c("CHE", "ESP", "SWE")) %>% 
  filter(Sex == "b") %>% 
  select(CountryCode, Year, Week, DTotal) %>% 
  rename(Deaths = DTotal) %>%  
  mutate(Week2 = get_aweek(week = Week, year = Year, 
                           start = "Monday", week_start = "Monday"),
         Week_start = get_date(week = Week, year = Year, 
                               start = "Monday")) %>% 
  relocate(Week2, Week_start, .after = Week) %>% 
  mutate(Country = case_when(
    CountryCode == "CHE" ~ "Switzerland",
    CountryCode == "ESP" ~ "Spain",
    CountryCode == "SWE" ~ "Sweden"
  )) %>%  select(-CountryCode) %>% relocate(Country)

write_rds(stmf_weekly, "data/mortality_org/stmf_weekly.Rds")
write_dta(stmf_weekly, "data/mortality_org/stmf_weekly.dta")
```

```{r}
stmf_weekly <- read_rds("data/mortality_org/stmf_weekly.Rds")
```

```{r echo=FALSE}
stmf_weekly %>% 
  filter(Year >= 2020) %>% 
  ggplot(aes(x = Week_start)) +
  geom_line(aes(y = Deaths, group = Country, color = Country)) +
  theme_bw() +
  xlab("") + ylab("Weekly number of deaths")
```

## Monthly

Weekly data converted to monthly using [weekToMonth](https://rdrr.io/cran/wktmo/man/weekToMonth.html) function from `wktmo` package. 

```{r}
stmf_monthly <- bind_rows(
  
  weekToMonth(stmf_weekly[stmf_weekly$Country == "Switzerland", ]$Deaths, 
              datStart = "03-01-2000", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Switzerland"),
  
  weekToMonth(stmf_weekly[stmf_weekly$Country == "Spain", ]$Deaths, 
              datStart = "03-01-2000", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Spain"),
  
  weekToMonth(stmf_weekly[stmf_weekly$Country == "Sweden", ]$Deaths, 
              datStart = "03-01-2000", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Sweden") 
  
) %>% 
  separate(yearMonth, c("Year", "Month"), convert = TRUE) %>% 
  rename(deaths_month = value) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Country, Year, Month, Date)

write_rds(stmf_monthly, "data/mortality_org/stmf_monthly.Rds")
write_dta(stmf_monthly, "data/mortality_org/stmf_monthly.dta")
```

```{r echo=FALSE}
stmf_monthly %>% 
  # filter(Date != as.Date("2021-05-01")) %>% 
  filter(Year >= 2020) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = deaths_month, group = Country, color = Country)) +
  theme_bw() +
  xlab("") + ylab("Monthly number of deaths")
```

## Yearly totals

Conversions are not perfect!  

Example of 2020 totals derived from weekly data:

```{r}
stmf_weekly %>% 
  filter(Year == 2020) %>% 
  group_by(Country) %>% 
  summarise(deaths_year = round(sum(Deaths))) %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)
```

And from monthly data:

```{r}
stmf_monthly %>% 
  filter(Year == 2020) %>% 
  group_by(Country) %>% 
  summarise(deaths_year = round(sum(deaths_month))) %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)
```

<!-- ----------------------------------------------------- -->
# Switzerland 

## BfS

### Monthly deaths 

Historical data from [Todesfälle nach Monat und Sterblichkeit seit 1803](https://www.bfs.admin.ch/bfs/de/home/statistiken/kataloge-datenbanken/daten.assetdetail.14387168.html).

Using data since 1877 only where monthly registration starts.  
With important update from @Kaspar **covering missing months between 1886 and 1900**!

```{r message=FALSE, warning=FALSE, eval=FALSE}
bfs_web_deaths_yearly <- read_xlsx("data-raw/BfS/px-x-0102020206_111_20210223-102443.xlsx", 
                                   skip = 2, na = "...") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(year = x1) %>% 
  filter(!is.na(todesfalle_total)) %>% 
  select(year:todesfalle_im_dezember) %>% 
  mutate(year = as.numeric(year)) %>% 
  rename(Year = year) %>% 
  select(Year, todesfalle_total) %>% 
  rename(deaths_year = todesfalle_total)

write_rds(bfs_web_deaths_yearly, "data/BfS/bfs_web_deaths_yearly.Rds")
write_dta(bfs_web_deaths_yearly, "data/BfS/bfs_web_deaths_yearly.dta")

bfs_web_deaths_monthly <- read_xlsx("data-raw/BfS/Todesf_n_Monat_seit_1877_DEM_2.xlsx") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Year = jahr) %>% 
  pivot_longer(!Year, names_to = "Month", values_to = "deaths_month") %>% 
  mutate(Month = as.numeric(str_replace(Month, fixed("m"), "")))  %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) 

write_rds(bfs_web_deaths_monthly, "data/BfS/bfs_web_deaths_monthly.Rds")
write_dta(bfs_web_deaths_monthly, "data/BfS/bfs_web_deaths_monthly.dta")
```

```{r include=FALSE}
bfs_web_deaths_yearly <- read_rds("data/BfS/bfs_web_deaths_yearly.Rds")
bfs_web_deaths_monthly <- read_rds("data/BfS/bfs_web_deaths_monthly.Rds")
```

```{r echo=FALSE}
ggplot(data = bfs_web_deaths_monthly, 
       aes(x = Date)) +
  geom_line(aes(y = deaths_month)) +
  theme_bw() +
  xlab("") + ylab("Monthly number of deaths")
```

### Yearly deaths CH - with age & sex structure

```{r}
bfs_deaths_age_sex <- read_csv("data-raw/BfS/Lieferung_Staub_2021.csv", 
                               col_types = cols(KalJahr = col_integer(),
                                                Alter = col_integer(),
                                                COUNT = col_integer()), 
                               trim_ws = TRUE) %>% 
  rename(Year = KalJahr, Age = Alter, Sex = Geschlecht, Deaths = COUNT) %>% 
  mutate(Country = "Switzerland") %>% relocate(Country)

# bfs_deaths_age_sex %<>% 
#   mutate(Age_group = cut(Age, 
#                          breaks = c(seq(0, 90, 5), 113), 
#                          # labels = c("0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80+")), 
#                          right=FALSE)
#   ) %>% 
#   group_by(Year, Sex, Age_group) %>% 
#   summarise(Deaths = sum(Deaths)) %>% 
#   ungroup() 
```

### Pops 

[Demographic balance of the permanent resident population, 1861-2019](https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/tables.assetdetail.13707412.html)

```{r eval=FALSE}
bfs_web_pop_yearly <- read_xlsx("data-raw/BfS/su-e-01.02.04.05.xlsx", 
                                na = "...", skip = 1) %>% 
  remove_empty(c("rows", "cols")) %>%
  clean_names() %>% 
  rename(Year = x1, pop_jan = population_on_2, pop_dec = population_on_11) %>% 
  filter(!is.na(Year)) %>% 
  filter(!is.na(pop_jan)) %>% 
  mutate(Year = if_else(Year == "2010 7", "2010", Year),
         Year = as.numeric(Year), 
         pop_jan = as.numeric(pop_jan),
         pop_dec = as.numeric(pop_dec)) %>% 
  select(Year, starts_with("pop_"))

write_rds(bfs_web_pop_yearly, "data/BfS/bfs_web_pop_yearly.Rds")
write_dta(bfs_web_pop_yearly, "data/BfS/bfs_web_pop_yearly.dta")
```

```{r include=FALSE}
bfs_web_pop_yearly <- read_rds("data/BfS/bfs_web_pop_yearly.Rds")
```

```{r echo=FALSE}
ggplot(bfs_web_pop_yearly, aes(x = Year)) +
  geom_line(aes(y = pop_dec/1000000)) +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]") +
  scale_y_continuous(labels = comma)
```

## Comparison - pops

### BfS web vs HMD

```{r}
compare <- left_join(
  bfs_web_pop_yearly, 
  hmd_ch_pop_year) %>% 
  mutate(diff1 = pop_jan - pop_year) %>% 
  mutate(diff2 = pop_dec - pop_year)
```

Summary of differences between BfS figures (both Jan and Dec) and HMD

```{r}
summary(compare$diff1)
summary(compare$diff2)
```

Timeline of differences between BfS figures and HMD

```{r echo=FALSE}
compare %>% 
  rename(bfs_pop_jan = pop_jan, 
         bfs_pop_dec = pop_dec, 
         hmd_pop_year = pop_year) %>% 
  pivot_longer(bfs_pop_jan:hmd_pop_year) %>% 
  ggplot(aes(x = Year, y = value/1000000, color = name)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]")
```

Difference between Jan pop from BfS and yearly pop from HMD

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = pop_jan - pop_year)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

Difference between Dec pop from BfS and yearly pop from HMD

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = pop_dec - pop_year)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

## Comparison - deaths

### Yearly vs. monthly BfS figures

```{r}
bfs_web_deaths_monthly %>% 
  filter(!is.na(deaths_month)) %>% 
  group_by(Year) %>% 
  summarize(deaths_summed = sum(deaths_month)) %>% 
  ungroup() %>% 
  left_join(bfs_web_deaths_yearly) %>% 
  filter(deaths_year != deaths_summed) %>% 
  nrow()
```

There are no years where summed  monthly data differ from "official" yearly sums.

### BfS vs HMD

```{r}
compare <- left_join(
  bfs_web_deaths_yearly %>% 
    rename(deaths_year_bfs = deaths_year), 
  hmd_ch_deaths_year %>% 
    rename(deaths_year_hmd = deaths_year)) %>% 
  mutate(diff = deaths_year_bfs - deaths_year_hmd)
```

Summary of differences between BfS figures and HMD

```{r}
summary(compare$diff)
```

Timeline of differences between BfS figures and HMD

```{r echo=FALSE}
ggplot(compare, aes(x = Year, y = diff)) +
  geom_hline(yintercept = 0, colour = "lightblue") +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly difference in number of deaths")
```

### BfS vs STMF

Comparing monthly figures - see above for week <> month issues!  

```{r}
compare <- inner_join(
  bfs_web_deaths_monthly %>% 
    rename(deaths_bfs = deaths_month),
  stmf_monthly %>% 
    filter(Country == "Switzerland") %>% 
    rename(deaths_stmf = deaths_month) 
) %>% 
  mutate(diff = deaths_bfs - deaths_stmf)
```

Summary of differences between BfS figures and STMF

```{r}
summary(compare$diff)
```

Timeline of differences between BfS figures and STMF

```{r echo=FALSE}
ggplot(compare, aes(x = Date, y = diff)) +
  geom_hline(yintercept = 0, colour = "lightblue") +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly difference in number of deaths")
```

<!-- ----------------------------------------------------- -->

# Spain

```{r}
spain_pop <- read_xlsx("data-raw/INE/Spain_Population.xlsx") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Year = year) %>% 
  rename(population = prados_de_la_escosura2020_july) %>% 
  select(Year, population)

spain_deaths_monthly <- read_xlsx("data-raw/INE/Spain.xlsx") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Year = jahr) %>% 
  pivot_longer(!Year, names_to = "Month", values_to = "deaths_month") %>% 
  mutate(Month = as.numeric(str_replace(Month, fixed("m"), "")))  %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) %>% 
  left_join(spain_pop)

write_rds(spain_deaths_monthly, "data/INE/spain_deaths_monthly.Rds")
write_dta(spain_deaths_monthly, "data/INE/spain_deaths_monthly.dta")
```

## Deaths monthly

```{r echo=FALSE}
spain_deaths_monthly %>% 
  ggplot(aes(x = Date, y = deaths_month)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Monthly deaths")
```

## Population yearly

```{r echo=FALSE}
spain_pop %>% 
  ggplot(aes(x = Year, y = population)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population")

rm(spain_pop)
```

<!-- ----------------------------------------------------- -->

# Sweden

```{r}
sweden_pop <- read_xlsx("data-raw/SCB/be0101_tab9utveng1749-2020.xlsx",
                        skip = 4) %>% 
  remove_empty() %>% 
  clean_names() %>% 
  select(year, population) %>% 
  filter(!is.na(population)) %>% 
  mutate(year = ifelse(year == "20001)", 2000, year),
         year = as.numeric(year)) %>% 
  rename(Year = year) 

sweden_deaths_monthly <- read_csv("data-raw/SCB/000000NF_20210315-164930.csv",
                                  skip = 2) %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Month_txt = month) %>% 
  filter(Month_txt != "Unknown") %>% 
  select(-sex) %>% 
  pivot_longer(!Month_txt, names_to = "Year", values_to = "deaths_month") %>% 
  group_by(Year, Month_txt) %>% 
  summarise(deaths_month = sum(deaths_month)) %>% 
  ungroup() %>% 
  mutate(Year = as.numeric(str_replace(Year, fixed("x"), "")),
         Month = match(Month_txt, month.name)) %>% 
  select(-Month_txt) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) %>% 
  left_join(sweden_pop) %>% 
  arrange(Year, Month)

write_rds(sweden_deaths_monthly, "data/SCB/sweden_deaths_monthly.Rds")
write_dta(sweden_deaths_monthly, "data/SCB/sweden_deaths_monthly.dta")
```

## Deaths monthly

```{r echo=FALSE}
sweden_deaths_monthly %>% 
  ggplot(aes(x = Date, y = deaths_month)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Monthly deaths")
```

## Population yearly monthly

```{r echo=FALSE}
sweden_pop %>% 
  ggplot(aes(x = Year, y = population)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population")

rm(sweden_pop)
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`
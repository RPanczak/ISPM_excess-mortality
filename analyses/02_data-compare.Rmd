---
title: "Excess mortality: data preparation"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---


```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

options(scipen=999)
set.seed(12345)

library(pacman)
p_load(knitr, rmdformats, 
       tidyverse, scales, readxl, haven, janitor, kableExtra)

options(max.print = "75")
opts_chunk$set(cache = FALSE,
               prompt = FALSE,
               tidy = FALSE,
               comment = NA,
               message = FALSE,
               warning = FALSE)
opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# HMD

[The Human Mortality Database](https://www.mortality.org/) data. 

```{r eval=FALSE}
p_load(HMDHFDplus)

password <- readr::read_file("secrets/HMD.txt")

# pop
hmd_ch_pop_raw <- readHMDweb(CNTRY = "CHE", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_pop_raw, "data-raw/mortality_org/hmd_ch_pop_raw.Rds")
write_dta(hmd_ch_pop_raw, "data-raw/mortality_org/hmd_ch_pop_raw.dta")

# deaths
hmd_ch_deaths_raw <- readHMDweb(CNTRY = "CHE", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_deaths_raw, "data-raw/mortality_org/hmd_ch_deaths_raw.Rds")
write_dta(hmd_ch_deaths_raw, "data-raw/mortality_org/hmd_ch_deaths_raw.dta")

hmd_ch_deaths <- hmd_ch_deaths_raw %>% 
  select(Year, Total) %>% 
  rename(year = Year) %>% 
  group_by(year) %>% 
  summarise(deaths_year = sum(Total)) %>% 
  as_tibble()

write_rds(hmd_ch_deaths, "data/mortality_org/hmd_ch_deaths.Rds")
write_dta(hmd_ch_deaths, "data/mortality_org/hmd_ch_deaths.dta")
p_unload(HMDHFDplus)
```

## Deaths 

```{r include=FALSE}
hmd_ch_deaths_raw <- read_rds("data-raw/mortality_org/hmd_ch_deaths_raw.Rds")
hmd_ch_deaths <- read_rds("data/mortality_org/hmd_ch_deaths.Rds")
```

Available only yearly but for one year age bands & separate by sex. Time from `r min(hmd_ch_deaths_raw$Year)` to `r max(hmd_ch_deaths_raw$Year)`.

Data is in yearly resolution. 

```{r echo=FALSE}
ggplot(hmd_ch_deaths, aes(x = year)) +
  geom_line(aes(y = deaths_year)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

## Pops 

Similarly, population data is aggregated by year. 

```{r include=FALSE}
hmd_ch_pop_raw <- read_rds("data-raw/mortality_org/hmd_ch_pop_raw.Rds")

hmd_ch_pop_year <- hmd_ch_pop_raw %>% 
  select(Year, Total) %>% 
  rename(year = Year) %>% 
  group_by(year) %>% 
  summarise(pop_year = sum(Total)) %>% 
  as_tibble()

write_rds(hmd_ch_pop_year, "data/mortality_org/hmd_ch_pop_year.Rds")
```

```{r echo=FALSE}
ggplot(hmd_ch_pop_year, aes(x = year)) +
  geom_line(aes(y = pop_year/1000000)) +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]") +
  scale_y_continuous(labels = comma)
```

Advantage of data is availability of age bands (1 year!)

```{r echo=FALSE}
hmd_ch_pop_raw %>% 
  filter(Year == 1876 | Year == 2019) %>% 
  select(Year, Age, Female, Male) %>% 
  rename(year = Year, age = Age) %>% 
  pivot_longer(c("Female", "Male"), names_to = "sex") %>% 
  mutate(age = if_else(age == "110+", "110", age)) %>% 
  mutate(age = as.numeric(age)) %>% 
  mutate(age_cat = cut(age, seq(0, 110, 5), include.lowest = TRUE)) %>% 
  group_by(year, sex, age_cat) %>% 
  summarise(pop = sum(value)) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = ifelse(test = sex == "Male", yes = -pop, no = pop), 
                       y = age_cat, fill = sex)) +
  geom_col(width = 1) +
  lemon::scale_x_symmetric(labels = abs) +
  labs(x = "Population", y = "Age") +
  facet_grid(vars(year)) +
  theme_bw() +
  scale_fill_brewer(palette = "Set1")
```

<!-- ----------------------------------------------------- -->

# BfS

## Deaths 

Historical data from [Todesf√§lle nach Monat und Sterblichkeit seit 1803](https://www.bfs.admin.ch/bfs/de/home/statistiken/kataloge-datenbanken/daten.assetdetail.14387168.html).

With update from @Kaspar covering missing months between 1886 and 1900!

```{r message=FALSE, warning=FALSE, eval=FALSE}
bfs_web_raw <- read_xlsx("data-raw/BfS/px-x-0102020206_111_20210223-102443.xlsx", 
                         skip = 2, na = "...") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(year = x1) %>% 
  filter(!is.na(todesfalle_total)) %>% 
  select(year:todesfalle_im_dezember) %>% 
  mutate(year = as.numeric(year)) %>% 
  rename(Year = year)

bfs_web_deaths_yearly <- bfs_web_raw %>% 
  select(Year, todesfalle_total) %>% 
  rename(deaths_year = todesfalle_total)

p1 <- bfs_web_raw %>% 
  select(Year, todesfalle_total) %>% 
  rename(deaths_year = todesfalle_total) %>% 
  filter(Year < 1877) %>% 
  uncount(12) %>% 
  group_by(Year) %>% 
  mutate(Month = row_number()) %>% 
  ungroup() %>% 
  mutate(deaths_month = NA,
         type = "yearly")

bfs_2_web_raw <- read_xlsx("data-raw/BfS/Todesf_n_Monat_seit_1877_DEM_2.xlsx") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Year = jahr) 

p2 <- bfs_2_web_raw %>% 
  pivot_longer(!Year, names_to = "Month", values_to = "deaths_month") %>% 
  mutate(Month = as.numeric(str_replace(Month, fixed("m"), "")))  %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) %>% 
  mutate(type = "monthly")

bfs_web_deaths_monthly <- p1 %>% 
  bind_rows(p2) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) 

write_rds(bfs_web_deaths_monthly, "data/BfS/bfs_web_deaths_monthly.Rds")
write_dta(bfs_web_deaths_monthly, "data/BfS/bfs_web_deaths_monthly.dta")

write_rds(bfs_web_deaths_yearly, "data/BfS/bfs_web_deaths_yearly.Rds")
write_dta(bfs_web_deaths_yearly, "data/BfS/bfs_web_deaths_yearly.dta")
```

```{r include=FALSE}
bfs_web_deaths_yearly <- read_rds("data/BfS/bfs_web_deaths_yearly.Rds")
bfs_web_deaths_monthly <- read_rds("data/BfS/bfs_web_deaths_monthly.Rds")
```

Yearly deaths for period 1803 to 1876; monthly deaths thereafter.

```{r echo=FALSE}
ggplot(data = filter(bfs_web_deaths_monthly, 
                     year < 1877), 
       aes(x = date)) +
  geom_line(aes(y = deaths_year)) +
  geom_line(data = filter(bfs_web_deaths_monthly, 
                          year >= 1877), 
            aes(y = deaths_month)) +
  facet_grid(vars(type), scales = "free_y") +
  theme_bw() +
  xlab("") + ylab("Monthly/yearly number of deaths")
```

Note different `y` scales! 

## Pops 

[Demographic balance of the permanent resident population, 1861-2019](https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/tables.assetdetail.13707412.html)

```{r}
bfs_web_pop_yearly <- read_xlsx("data-raw/BfS/su-e-01.02.04.05.xlsx", 
                                na = "...", skip = 1) %>% 
  remove_empty(c("rows", "cols")) %>%
  clean_names() %>% 
  rename(Year = x1, pop_jan = population_on_2, pop_dec = population_on_11) %>% 
  filter(!is.na(Year)) %>% 
  filter(!is.na(pop_jan)) %>% 
  mutate(Year = if_else(Year == "2010 7", "2010", Year),
         Year = as.numeric(Year), 
         pop_jan = as.numeric(pop_jan),
         pop_dec = as.numeric(pop_dec)) %>% 
  select(Year, starts_with("pop_"))

write_rds(bfs_web_pop_yearly, "data/BfS/bfs_web_pop_yearly.Rds")
write_dta(bfs_web_pop_yearly, "data/BfS/bfs_web_pop_yearly.dta")
```

```{r echo=FALSE}
ggplot(bfs_web_pop_yearly, aes(x = year)) +
  geom_line(aes(y = pop_dec/1000000)) +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]") +
  scale_y_continuous(labels = comma)
```

<!-- ----------------------------------------------------- -->

# SNC

SNC aggregated data. Has limitations of only being available since `1971` but has advantage of possibility to split by sex & age groups since we can aggregate individual records to whatever strata we wish to use. 

## Deaths monthly

```{r}
bfs_snc_deaths_monthly <- read_dta("data-raw/SNC/mortCHmonthly.dta") %>% 
  zap_label() %>% zap_labels() %>% 
  mutate(sex = factor(sex, labels = c("Male", "Female")),
         young = factor(young, labels = c("65+", "0-64"))) %>%   
  rename(Month = month, 
         deaths_month = count) %>% 
  mutate(date = anytime::anydate(paste0(year, "-", Month))) %>% 
  relocate(year, Month, date) %>% 
  mutate(type = "monthly")


write_rds(bfs_snc_deaths_monthly, "data/SNC/bfs_snc_deaths_monthly.Rds")
write_dta(bfs_snc_deaths_monthly, "data/SNC/bfs_snc_deaths_monthly.dta")
```

```{r echo=FALSE}
ggplot(bfs_snc_deaths_monthly, aes(x = date, y = deaths_month, colour = interaction(sex, young))) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

## Deaths weekly

```{r}
bfs_snc_deaths_weekly <- read_dta("data-raw/SNC/mortCHweely.dta") %>% 
  zap_label() %>% zap_labels() %>% 
  mutate(sex = factor(sex, labels = c("Male", "Female")),
         young = factor(young, labels = c("65+", "0-64"))) %>% 
  rename(week_num = week,
         deaths_week = count) %>% 
  # mutate(date = ISOweek::ISOweek2date(paste0(year, "-", week_num))) %>% 
  relocate(year, week_num) %>% 
  mutate(type = "weekly")

write_rds(bfs_snc_deaths_weekly, "data/SNC/bfs_snc_deaths_weekly.Rds")
write_dta(bfs_snc_deaths_weekly, "data/SNC/bfs_snc_deaths_weekly.dta")
```

```{r echo=FALSE}
ggplot(bfs_snc_deaths_weekly, aes(x = week_num, y = deaths_week, colour = year, group = year)) +
  geom_line() +
  theme_bw() +
  scale_color_viridis_c(option = "E") +
  facet_grid(vars(sex, young)) + 
  xlab("") + ylab("Weekly number of deaths")
```

## Population

```{r}
bfs_snc_pop_yearly_mid <- read_dta("data-raw/SNC/staend_wb_jahresmitte_71_18.dta") %>% 
  zap_label() %>% 
  select(sex, year, agegrp07, npop07) %>% 
  filter(!is.na(agegrp07)) %>% 
  mutate(sex = labelled::to_factor(sex)) %>% 
  mutate(age_bin = ifelse(agegrp07 <= 6, 0, 1)) %>% 
  mutate(age_bin = factor(age_bin, labels = c("0-64", "65+"))) %>% 
  group_by(year, sex, age_bin) %>% 
  summarise(population = sum(npop07)) %>% 
  ungroup()

write_rds(bfs_snc_pop_yearly_mid, "data/SNC/bfs_snc_pop_yearly_mid.Rds")
write_dta(bfs_snc_pop_yearly_mid, "data/SNC/bfs_snc_pop_yearly_mid.dta")

bfs_snc_pop_yearly_end <- read_dta("data-raw/SNC/staend_wb_jahresende_71_18.dta") %>% 
  zap_label() %>% 
  select(sex, year, agegrp07, npop07) %>% 
  filter(!is.na(agegrp07)) %>% 
  mutate(sex = labelled::to_factor(sex)) %>% 
  mutate(age_bin = ifelse(agegrp07 <= 6, 0, 1)) %>% 
  mutate(age_bin = factor(age_bin, labels = c("0-64", "65+"))) %>% 
  group_by(year, sex, age_bin) %>% 
  summarise(population = sum(npop07)) %>% 
  ungroup()

write_rds(bfs_snc_pop_yearly_end, "data/SNC/bfs_snc_pop_yearly_end.Rds")
write_dta(bfs_snc_pop_yearly_end, "data/SNC/bfs_snc_pop_yearly_end.dta")
```

```{r eval=FALSE, include=FALSE}
bfs_snc_pop_yearly_end %>% 
  select(year, sex, age_bin, population) %>% 
  rename(pop_end = population) %>% 
  left_join(bfs_snc_pop_yearly_mid %>% 
              select(year, sex, age_bin, population) %>% 
              rename(pop_mid = population))
```

```{r}
bfs_snc_pop_yearly_end %>% 
  ggplot(aes(x = year, y = population, 
             colour = interaction(sex, age_bin))) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population")
```

<!-- ----------------------------------------------------- -->

# Russian Flu

```{r message=FALSE, warning=FALSE}
extra_1889 <- read_xlsx("data-raw/Kaspar/1889 CH.xlsx") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(year = x1) %>% 
  pivot_longer(-year, values_to = "deaths_month") %>% 
  mutate(Month = rep(1:12, length(unique(year))),
         type = "monthly",
         date = anytime::anydate(paste0(year, "-", Month))) 
```

Extra monthly dataset covering "Russian Flu" between `r min(extra_1889$year)` and `r max(extra_1889$year)`. 

```{r echo=FALSE}
ggplot(extra_1889) +
  geom_line(aes(x = date, y = deaths_month)) +
  theme_bw() +
  xlab("") + ylab("Monthly number of deaths")
```

<!-- ----------------------------------------------------- -->

# Comparison - pops

## BfS web vs BfS SNC

```{r}
compare <- full_join(
  bfs_web_pop_yearly, 
  bfs_snc_pop_yearly_end %>% 
    group_by(year) %>% 
    summarize(population = sum(population))) %>% 
  mutate(diff = pop_dec - population) %>% 
  filter(!is.na(population))
```

Summary of differences between BfS figures (both Jan and Dec) and HMD

```{r}
summary(compare$diff)
```

## BfS web vs HMD

```{r}
compare <- left_join(
  bfs_web_pop_yearly, 
  hmd_ch_pop_year) %>% 
  mutate(diff1 = pop_jan - pop_year) %>% 
  mutate(diff2 = pop_dec - pop_year)
```

Summary of differences between BfS figures (both Jan and Dec) and HMD

```{r}
summary(compare$diff1)
summary(compare$diff2)
```

Timeline of differences between BfS figures and HMD

```{r echo=FALSE}
compare %>% 
  rename(bfs_pop_jan = pop_jan, 
         bfs_pop_dec = pop_dec, 
         hmd_pop_year = pop_year) %>% 
  pivot_longer(bfs_pop_jan:hmd_pop_year) %>% 
  ggplot(aes(x = year, y = value/1000000, color = name)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]")
```

Difference between Jan pop from BfS and yearly pop from HMD

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = year, y = pop_jan - pop_year)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

Difference between Dec pop from BfS and yearly pop from HMD

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = year, y = pop_dec - pop_year)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

## BfS SNC vs HMD

```{r}
compare <- 
  left_join(
    
    bfs_snc_pop_yearly_end %>% 
      group_by(year) %>% 
      summarize(bfs_end = sum(population)),
    
    bfs_snc_pop_yearly_mid %>% 
      group_by(year) %>% 
      summarize(bfs_mid = sum(population))
    
  ) %>% 
  left_join(  
    
    hmd_ch_pop_year %>% 
      rename(hmd = pop_year) 
    
  ) %>% 
  mutate(diff1 = bfs_end - hmd) %>% 
  mutate(diff2 = bfs_mid - hmd)
```

Summary of differences between BfS figures (both Jan and Dec) and HMD

```{r}
summary(compare$diff1)
summary(compare$diff2)
```

Timeline of differences between BfS figures and HMD

```{r echo=FALSE}
compare %>% 
  select(-diff1, -diff2) %>% 
  pivot_longer(bfs_end:hmd) %>% 
  ggplot(aes(x = year, y = value/1000000, color = name)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]")
```

Difference between mid pop from BfS and yearly pop from HMD

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = year, y = bfs_mid - hmd)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(-40000, 120000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

Difference between Dec pop from BfS and yearly pop from HMD

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = year, y = bfs_end - hmd)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(-40000, 120000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

<!-- ----------------------------------------------------- -->

# Comparison - deaths

## Yearly vs. monthly figures

```{r}
bfs_web_deaths_monthly %>% 
  filter(!is.na(deaths_month)) %>% 
  group_by(year) %>% 
  summarize(deaths_summed = sum(deaths_month)) %>% 
  ungroup() %>% 
  left_join(bfs_web_deaths_yearly) %>% 
  filter(deaths_year != deaths_summed) %>% 
  nrow()
```

There are no years where summed monthly data differ from "official" yearly sums.

## Russian Flu vs BfS

```{r}
compare <- extra_1889 %>% 
  select(date, deaths_month) %>% 
  rename(deaths_month_russian = deaths_month) %>% 
  left_join(bfs_web_deaths_monthly %>% 
              select(date, deaths_month) %>% 
              rename(deaths_month_bfs = deaths_month)) %>% 
  mutate(diff = deaths_month_bfs - deaths_month_russian)
```

Summary of differences between BfS figures and HMD

```{r}
summary(compare$diff)
```

Timeline of differences between BfS figures and HMD

```{r echo=FALSE}
ggplot(compare, aes(x = date, y = diff)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly difference in number of deaths")
```

## BfS vs HMD

```{r}
compare <- left_join(
  bfs_web_deaths_yearly %>% 
    rename(deaths_year_bfs = deaths_year), 
  hmd_ch_deaths %>% 
    rename(deaths_year_hmd = deaths_year)) %>% 
  mutate(diff = deaths_year_bfs - deaths_year_hmd)
```

Summary of differences between BfS figures and HMD

```{r}
summary(compare$diff)
```

Timeline of differences between BfS figures and HMD

```{r echo=FALSE}
ggplot(compare, aes(x = year, y = diff)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly difference in number of deaths")
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`
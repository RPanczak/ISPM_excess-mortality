---
title: "Excess mortality"
subtitle: "Data preparation"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../docs") })
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, magrittr, janitor, scales,
       readxl, lubridate, aweek, wktmo,
       kableExtra, lemon)

# import::from("lemon", "scale_x_symmetric")
# import::from("wktmo", "weekToMonth")
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# HMD - yearly data with age & sex structure

[The Human Mortality Database](https://www.mortality.org/) is the source of the data.  

Available on yearly resolution only but for one year age bands & separate by sex.  

In order to download the [chunk option](https://yihui.org/knitr/options/) of the code snippet below has to be changed to `eval=TRUE` and a password to user account on mortality.org website stored in plain text file `HMD.txt` in `secrets` directory of the project.  

```{r eval=FALSE}
p_load(HMDHFDplus)

# text file with password or modify password in calls below
password <- readr::read_file("secrets/HMD.txt")

# CH
# pop
hmd_ch_pop_raw <- readHMDweb(CNTRY = "CHE", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_pop_raw, "data-raw/mortality_org/hmd_ch_pop_raw.Rds")

# deaths
hmd_ch_deaths_raw <- readHMDweb(CNTRY = "CHE", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_deaths_raw, "data-raw/mortality_org/hmd_ch_deaths_raw.Rds")

# ES
# pop
# 1975 problem resolved in issue #45
hmd_es_pop_raw <- readHMDweb(CNTRY = "ESP", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble() %>% 
  mutate(Year = ifelse(Year == "1975+", 1975, Year)) %>% 
  filter(Year != "1975-") %>% 
  mutate(Year = as.numeric(Year))

write_rds(hmd_es_pop_raw, "data-raw/mortality_org/hmd_es_pop_raw.Rds")

# deaths
hmd_es_deaths_raw <- readHMDweb(CNTRY = "ESP", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_es_deaths_raw, "data-raw/mortality_org/hmd_es_deaths_raw.Rds")

# SE
# pop
hmd_se_pop_raw <- readHMDweb(CNTRY = "SWE", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_se_pop_raw, "data-raw/mortality_org/hmd_se_pop_raw.Rds")

# deaths
hmd_se_deaths_raw <- readHMDweb(CNTRY = "SWE", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_se_deaths_raw, "data-raw/mortality_org/hmd_se_deaths_raw.Rds")

p_unload(HMDHFDplus)
```

## Yearly deaths

Combining three countries into one dataset.  

```{r}
hmd_deaths_age_sex <- 
  bind_rows(
    read_rds("data-raw/mortality_org/hmd_es_deaths_raw.Rds") %>% mutate(Country = "Spain"), 
    read_rds("data-raw/mortality_org/hmd_se_deaths_raw.Rds") %>% mutate(Country = "Sweden"), 
    read_rds("data-raw/mortality_org/hmd_ch_deaths_raw.Rds") %>% mutate(Country = "Switzerland")
  ) %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Year = as.integer(Year),
         Age = as.integer(Age),
         Female = as.integer(round(Female)),
         Male = as.integer(round(Male)), 
         Total = as.integer(round(Total))) %>% 
  relocate(Country) 

hmd_deaths_year <- hmd_deaths_age_sex %>% 
  group_by(Country, Year) %>%
  summarise(Deaths = as.integer(round(sum(Total)))) %>% 
  ungroup()
```

Note: Spain has *two years less* of data than other two countries:   

```{r echo=FALSE}
hmd_deaths_age_sex %>% 
  group_by(Country) %>% 
  summarize(Max = max(Year)) %>% 
  ungroup()
```

Yearly totals per country indicating different time frames of data.  

```{r echo=FALSE}
hmd_deaths_year %>%
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Deaths, color = Country)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

Example of age & sex breakdown for Switzerland.

```{r echo=FALSE}
hmd_deaths_age_sex %>% 
  filter(Country == "Switzerland") %>% 
  filter(Year == 1876 | Year == 2019 | Year == 2020) %>% 
  select(Year, Age, Female, Male) %>% 
  pivot_longer(c("Female", "Male"), names_to = "Sex") %>% 
  mutate(Age_cat = cut(Age, seq(0, 110, 10), 
                       include.lowest = TRUE)) %>% 
  group_by(Year, Sex, Age_cat) %>% 
  summarise(pop = sum(value)) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = ifelse(test = Sex == "Male", 
                                  yes = -pop, no = pop), 
                       y = Age_cat, fill = Sex)) +
  geom_col() +
  scale_x_symmetric(labels = abs) +
  labs(x = "Deaths", y = "Age at death") +
  facet_grid(vars(Year)) +
  theme_bw() +
  scale_fill_brewer(palette = "Set1")
```

## Yearly population

Similarly, population data is available with 1y age bands by year. 

```{r include=FALSE}
hmd_pop_age_sex <- 
  bind_rows(
    read_rds("data-raw/mortality_org/hmd_es_pop_raw.Rds") %>%
      mutate(Country = "Spain"),
    read_rds("data-raw/mortality_org/hmd_se_pop_raw.Rds") %>%
      mutate(Country = "Sweden"),
    read_rds("data-raw/mortality_org/hmd_ch_pop_raw.Rds") %>%
      mutate(Country = "Switzerland")
  ) %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.integer(Age),
         Year = as.integer(Year),
         Female = as.integer(round(Female)),
         Male = as.integer(round(Male)), 
         Total = as.integer(round(Total))) %>% 
  relocate(Country) 

hmd_pop_year <- hmd_pop_age_sex %>% 
  group_by(Country, Year) %>%
  summarise(Population = as.integer(round(sum(Total)))) %>% 
  ungroup()
```

Again, *Spain has less data* - and already includes 2020:  

```{r echo=FALSE}
hmd_pop_age_sex %>% 
  group_by(Country) %>% 
  summarize(Max = max(Year)) %>% 
  ungroup()
```

Yearly totals  

```{r echo=FALSE}
hmd_pop_year  %>% 
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Population/1000000, colour = Country)) +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]") +
  scale_y_continuous(labels = comma)
```

Again, age structure is available on yearly resolution.  

```{r echo=FALSE}
hmd_pop_age_sex %>% 
  filter(Country == "Switzerland") %>% 
  filter(Year == 1876 | Year == 2019) %>% 
  select(Year, Age, Female, Male) %>% 
  pivot_longer(c("Female", "Male"), names_to = "Sex") %>% 
  mutate(Age_cat = cut(Age, seq(0, 110, 10), 
                       include.lowest = TRUE)) %>% 
  group_by(Year, Sex, Age_cat) %>% 
  summarise(pop = sum(value)) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = ifelse(test = Sex == "Male", 
                                  yes = -pop, no = pop), 
                       y = Age_cat, fill = Sex)) +
  geom_col() +
  scale_x_symmetric(labels = abs) +
  labs(x = "Population", y = "Age") +
  facet_grid(vars(Year)) +
  theme_bw() +
  scale_fill_brewer(palette = "Set1")
```

<!-- ----------------------------------------------------- -->

# HMD - STMF monthly data series

Short-term Mortality Fluctuations weekly dataset covering 2000-2020 period.  

```{r eval=FALSE}
download.file(url = "https://www.mortality.org/Public/STMF/Outputs/stmf.csv",
              destfile = "data-raw/mortality_org/stmf_week.csv",
              method = "curl")

zip(zipfile = "data-raw/mortality_org/stmf_week", 
    files = "data-raw/mortality_org/stmf_week.csv")

file.remove("data-raw/mortality_org/stmf_week.csv")

download.file(url = "https://www.mortality.org/Public/STMF_DOC/STMFmetadata.pdf",
              destfile = "data-raw/mortality_org/STMFmetadata.pdf",
              method = "curl")

download.file(url = "https://www.mortality.org/Public/STMF_DOC/STMFNote.pdf",
              destfile = "data-raw/mortality_org/STMFNote.pdf",
              method = "curl")
```

## Weekly

```{r}
stmf_week <- read_csv("data-raw/mortality_org/stmf_week.zip", 
                      col_types = cols(Year = col_integer(), 
                                       Week = col_integer(), 
                                       Split = col_integer(), 
                                       SplitSex = col_integer(), 
                                       Forecast = col_integer()), 
                      skip = 1) %>% 
  filter(CountryCode %in% c("CHE", "ESP", "SWE")) %>% 
  filter(Sex == "b") %>% 
  select(CountryCode, Year, Week, DTotal) %>% 
  rename(Deaths = DTotal) %>%  
  mutate(Week2 = get_aweek(week = Week, year = Year, 
                           start = "Monday", week_start = "Monday"),
         Week_start = get_date(week = Week, year = Year, 
                               start = "Monday"),
         Deaths = as.integer(Deaths)) %>% 
  relocate(Week2, Week_start, .after = Week) %>% 
  mutate(Country = case_when(
    CountryCode == "CHE" ~ "Switzerland",
    CountryCode == "ESP" ~ "Spain",
    CountryCode == "SWE" ~ "Sweden"
  )) %>% select(-CountryCode) %>% relocate(Country)

write_rds(stmf_week, "data/mortality_org/stmf_week.Rds")
```

```{r echo=FALSE}
stmf_week %>% 
  filter(Year >= 2019) %>% 
  ggplot(aes(x = Week_start)) +
  geom_line(aes(y = Deaths, group = Country, color = Country)) +
  theme_bw() +
  xlab("") + ylab("Weekly number of deaths")
```

Switzerland & Sweden have slightly more data:  

```{r}
stmf_week %>% 
  filter(Year == 2021) %>% 
  group_by(Country) %>% 
  summarize(Max_week = max(Week)) %>% 
  ungroup()
```

## Monthly

Weekly data converted to monthly using [weekToMonth](https://rdrr.io/cran/wktmo/man/weekToMonth.html) function from `wktmo` package.  

```{r}
stmf_month <- bind_rows(
  
  weekToMonth(stmf_week[stmf_week$Country == "Switzerland", ]$Deaths, 
              datStart = "03-01-2000", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Switzerland"),
  
  weekToMonth(stmf_week[stmf_week$Country == "Spain", ]$Deaths, 
              datStart = "03-01-2000", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Spain"),
  
  weekToMonth(stmf_week[stmf_week$Country == "Sweden", ]$Deaths, 
              datStart = "03-01-2000", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Sweden") 
  
) %>% 
  separate(yearMonth, c("Year", "Month"), convert = TRUE) %>% 
  rename(Deaths = value) %>% 
  mutate(Date = ymd(paste0(Year, "-", Month, "-01")),
         Deaths = as.integer(Deaths)) %>% 
  relocate(Country, Year, Month, Date)

write_rds(stmf_month, "data/mortality_org/stmf_month.Rds")
```

```{r echo=FALSE}
stmf_month %>% 
  filter(
    (Date <= as.Date("2021-08-01") & Country == "Spain") |
    (Date <= as.Date("2021-09-01") & Country != "Spain") 
  ) %>%
  filter(Year >= 2019) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Deaths, group = Country, color = Country)) +
  theme_bw() +
  xlab("") + ylab("Monthly number of deaths")
```

*Note: Only showing data till Aug 2021 for Spain (data is available only till week 38 which ends on `2021-09-26`). Data till Sept for Switzerland and Sweden.*  

## Yearly totals

Conversions are not perfect!  

Example of 2019+ totals derived from weekly data:

```{r}
differences <- left_join(
  stmf_week %>% 
    filter(Year >= 2019) %>% 
    group_by(Country, Year) %>% 
    summarise(Weekly = round(sum(Deaths))) %>% 
    ungroup(),
  
  stmf_month %>% 
    filter(Year >= 2019) %>% 
    group_by(Country, Year) %>% 
    summarise(Monthly = round(sum(Deaths))) %>% 
    ungroup()
) %>% 
  mutate(Difference = Weekly - Monthly,
         Perc_weekly = percent((Weekly - Monthly) / Weekly, accuracy = 0.01))
```

```{r echo=FALSE}
differences %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)  %>% 
  column_spec(c(5,6), 
              color = ifelse(differences$Difference > 0, 
                             "#EF8A62", "#67A9CF"))
```

```{r include=FALSE}
rm(differences)
```

Showing small imperfections of the `week -> month` transition! 2020 seems to be always a bit in `+` and 2021 in `-`.  

<!-- ----------------------------------------------------- -->

# Switzerland 

## Monthly deaths until 2020

~~Historical data from [Todesfälle nach Monat und Sterblichkeit seit 1803](https://www.bfs.admin.ch/bfs/de/home/statistiken/kataloge-datenbanken/daten.assetdetail.14387168.html).~~  

**Updated** historical data from [Todesfälle nach Monat und Sterblichkeit seit 1803](https://www.bfs.admin.ch/bfs/de/home/statistiken/kataloge-datenbanken/daten.assetdetail.16664926.html).  

Using data since 1877 only where monthly registration starts.  
With important update from @Christof **covering missing months between 1886 and 1900**!  

```{r message=FALSE, warning=FALSE}
ch_deaths_month <- read_xlsx("data-raw/BfS/Todesf_n_Monat_seit_1877_DEM_2.xlsx") %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Year = jahr) %>% 
  mutate(Year = as.integer(Year)) %>% 
  pivot_longer(!Year, names_to = "Month", values_to = "Deaths") %>% 
  mutate(Month = as.numeric(str_replace(Month, fixed("m"), "")))  %>% 
  mutate(Date = ymd(paste0(Year, "-", Month, "-01"))) %>% 
  relocate(Year, Month, Date) %>% 
  mutate(Date = ymd(paste0(Year, "-", Month, "-01")),
         Year = as.integer(Year),
         Month = as.integer(Month),
         Deaths = as.integer(Deaths)) %>% 
  relocate(Year, Month, Date)
```

## Monthly 2021 deaths 

BfS delivered data to supplement missing six months of 2021.  

```{r}
ch_deaths_2021 <- read_csv("data-raw/BfS/Lieferung_Staub_2021_MonatsdatenJANbisJUN.csv", col_types = cols(TodJahr = col_integer(), TodMonat = col_integer(), Alter = col_integer(), COUNT = col_integer()), trim_ws = TRUE) %>% 
  rename(Year = TodJahr, Month = TodMonat, Deaths = COUNT) %>% 
  filter(Year == 2021) %>% 
  group_by(Year, Month) %>% 
  summarise(Deaths = sum(Deaths)) %>% 
  ungroup() %>% 
  mutate(Date = ymd(paste0(Year, "-", Month, "-01")),
         Deaths = as.integer(round(Deaths))) %>% 
  select(Year, Month, Date, Deaths)

ch_deaths_month %<>% 
  bind_rows(ch_deaths_2021) %>% 
  mutate(Country = "Switzerland") %>% 
  relocate(Country)

rm(ch_deaths_2021)
```

## Monthly datasets combined 

```{r echo=FALSE}
ggplot(data = ch_deaths_month, 
       aes(x = Date)) +
  geom_line(aes(y = Deaths)) +
  theme_bw() +
  xlab("") + ylab("Monthly number of deaths")
```

## Yearly 2019-2020 deaths with age & sex structure

BfS delivered data to supplement missing last two years in HMD.  

Note: data now seem to be now publicly available [here](https://www.bfs.admin.ch/bfs/en/home/statistics/population.assetdetail.17664400.html) or in custom tabs [here](https://www.pxweb.bfs.admin.ch/pxweb/en/px-x-0102020206_103/px-x-0102020206_103/px-x-0102020206_103.px/).  

```{r}
ch_deaths_age_sex_2019_2020 <- read_csv("data-raw/BfS/Lieferung_Staub_2021.csv", col_types = cols(KalJahr = col_integer(), Alter = col_integer(), COUNT = col_integer()), trim_ws = TRUE) %>% 
  rename(Year = KalJahr, Age = Alter, Sex = Geschlecht, Deaths = COUNT) %>% 
  pivot_wider(names_from = Sex, values_from = Deaths) %>% 
  rename(Female = F, Male = M) %>% 
  mutate_at(vars(Female:Male), ~replace(., is.na(.), 0)) %>% 
  mutate(Country = "Switzerland",
         Female = as.integer(round(Female)),
         Male = as.integer(round(Male)), 
         Total = Female + Male) %>% 
  relocate(Country)
```

## Yearly 2021 deaths with age & sex structure

BfS delivered data to supplement missing six months of 2021.  

```{r}
ch_deaths_age_sex_2021 <- read_csv("data-raw/BfS/Lieferung_Staub_2021_MonatsdatenJANbisJUN.csv", col_types = cols(TodJahr = col_integer(), TodMonat = col_integer(), Alter = col_integer(), COUNT = col_integer()), trim_ws = TRUE) %>% 
  rename(Year = TodJahr, Age = Alter, Sex = Geschlecht, Deaths = COUNT) %>% 
  select(-TodMonat) %>% 
  group_by(Year, Age) %>% 
  summarise(Total = sum(Deaths)) %>% 
  ungroup() %>% 
  mutate(Country = "Switzerland",
         Total = as.integer(round(Total))) %>% 
  relocate(Country)
```

## Yearly pops untill 2019

[Demographic balance of the permanent resident population, 1861-2019](https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/tables.assetdetail.13707412.html). Population of Jan and Dec averaged.  

<!-- Alternative source might be [here](https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/data.assetdetail.14819631.html).   -->

```{r}
ch_pop_year <- read_xlsx("data-raw/BfS/su-e-01.02.04.05.xlsx", 
                         na = "...", skip = 1) %>% 
  remove_empty(c("rows", "cols")) %>%
  clean_names() %>% 
  rename(Year = x1, pop_jan = population_on_2, pop_dec = population_on_11) %>%
  filter(!is.na(Year)) %>% 
  filter(!is.na(pop_jan)) %>% 
  mutate(Year = if_else(Year == "2010 7", "2010", Year),
         Year = as.integer(Year), 
         pop_jan = as.integer(pop_jan),
         pop_dec = as.integer(pop_dec)) %>% 
  select(Year, starts_with("pop_"))
```

## Yearly pops 2020 

2020 data from [Demographic balance by age and canton](https://www.pxweb.bfs.admin.ch/pxweb/en/px-x-0102020000_104/-/px-x-0102020000_104.px/)(`px-x-0102020000_104` table).     

```{r}
pop_2020 <- read_xlsx("data-raw/BfS/px-x-0102020000_104_ALL.xlsx", 
                      skip = 2) %>% 
  filter(! is.na(`...2`)) %>% 
  select(`Population on 1 January`, `Population on 31 December`) %>% 
  mutate(Year = 2020) %>% 
  rename(pop_jan = `Population on 1 January`, 
         pop_dec = `Population on 31 December`)

pop_2021 <- pop_2020 %>% 
  mutate(Year = as.integer(2021))

ch_pop_year %<>% 
  bind_rows(pop_2020) %>% 
  bind_rows(pop_2021) %>% 
  mutate(Population = as.integer(round((pop_jan + pop_dec) / 2))) %>% 
  relocate(Year)
```

```{r include=FALSE}
rm(pop_2020, pop_2021)

ch_deaths_month %<>% 
  left_join(ch_pop_year %>% select(Year, Population))
```

## Monthly pops datasets combined 

```{r echo=FALSE}
ggplot(ch_pop_year, aes(x = Year)) +
  geom_line(aes(y = Population)) +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]") +
  scale_y_continuous(labels = comma)
```

## 2020 pops with age structure

Using `px-x-0102020000_104` figures - see above for source. Same as previously mean of Jan and Dec is taken, apart from `0 Jahre` age group where only figures from `31 Dec` are taken (`1st Jan` value is `0` for this group).  

```{r}
ch_pop_age_sex_2020 <- read_xlsx("data-raw/BfS/px-x-0102020000_104_AGE.xlsx", 
                                 col_types = c("skip", "skip", "skip", 
                                               "skip", "skip", "text", "numeric", 
                                               "numeric"), skip = 2) %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Age = x1) %>% 
  mutate(Age = str_replace(Age, fixed(" years"), "")) %>% 
  mutate(Age = str_replace(Age, fixed(" year"), "")) %>% 
  mutate(Age = str_replace(Age, fixed(" or older"), "")) %>% 
  mutate(Age = as.integer(Age)) %>% 
  mutate(Total = as.integer(round((population_on_1_january +  population_on_31_december) / 2))) %>% 
  mutate(Total = ifelse(Age == 0, population_on_31_december, Total)) %>% 
  mutate(Country = "Switzerland", 
         Year = as.integer(2020)) %>% 
  relocate(Country, Year, Age, Total)
```

## Comparison - total pops {.tabset}

BfS vs HMD  

```{r}
compare <- left_join(
  ch_pop_year %>% rename(BfS_pop = Population), 
  hmd_pop_year %>% filter(Country == "Switzerland") %>% rename(HMD_pop = Population)) %>% 
  select(-Country) %>% 
  mutate(diff1 = pop_jan - HMD_pop,
         diff2 = pop_dec - HMD_pop,
         diff3 = BfS_pop - HMD_pop)
```

### January

Difference between **Jan** pop from BfS and **yearly** pop from HMD

```{r}
summary(compare$diff1)
```

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = diff1)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_vline(aes(xintercept = 1990), color = "lightblue") +
  geom_col() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

### Mean 

Difference between **mean** pop from BfS and **yearly** pop from HMD

```{r}
summary(compare$diff3)
```

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = diff3)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_vline(aes(xintercept = 1990), color = "lightblue") +
  geom_col() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

### Dec 

Difference between **Dec** pop from BfS and **yearly** pop from HMD

```{r}
summary(compare$diff2)
```

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = diff2)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_vline(aes(xintercept = 1990), color = "lightblue") +
  geom_col() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

```{r include=FALSE}
rm(compare)
```

## Comparison - age groups 

@Julien tracked down some weird patterns in population estimates for 2020.  

Particularly in older age groups we have some serious +++jumps in N!?  

```{r}
hmd_pop_age_sex %>% 
  filter(Country == "Switzerland") %>% 
  filter(Year >= 2010) %>% 
  mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                       include.lowest = TRUE,
                       right = FALSE,
                       labels=c("0-9","10-19","20-29","30-39","40-49",
                                "50-59","60-69","70-79","80-89","90+"))) %>% 
  group_by(Year, Age_cat) %>% 
  summarise(Population = sum(Total)) %>% 
  ungroup() %>% 
  bind_rows(
    ch_pop_age_sex_2020 %>% 
      mutate(Age_cat = cut(Age, c(seq(0, 90, 10),120),
                           include.lowest = TRUE,
                           right = FALSE,
                           labels=c("0-9","10-19","20-29","30-39","40-49",
                                    "50-59","60-69","70-79","80-89","90+"))) %>% 
      group_by(Year, Age_cat) %>% 
      summarise(Population = sum(
        # population_on_1_january
        Total
        # population_on_31_december
      )) %>% 
      ungroup()
  ) %>% 
  ggplot(
    aes(x = Age_cat, y = Population, 
        fill = factor(Year), factor(Year))) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = comma) +
  theme_bw() +
  scale_fill_viridis_d(option = "E", direction = -1) +
  xlab("") + ylab("Yearly population by age group")
```

## Comparison - deaths

### BfS vs HMD {.tabset}

```{r}
compare <- left_join(
  ch_deaths_month %>% group_by(Year) %>% 
    summarise(deaths_year_bfs = sum(Deaths)), 
  hmd_deaths_year %>% 
    filter(Country == "Switzerland") %>% 
    rename(deaths_year_hmd = Deaths)) %>% 
  mutate(diff = deaths_year_bfs - deaths_year_hmd,
         perc = (deaths_year_bfs - deaths_year_hmd) / deaths_year_bfs)

rm(hmd_deaths_year)
```

Timeline of differences between yearly BfS and HMD figures. 

#### Absolute

```{r}
summary(compare$diff)
```

```{r echo=FALSE}
ggplot(compare, aes(x = Year, y = diff)) +
  geom_hline(yintercept = 0, colour = "lightblue") +
  geom_col() +
  theme_bw() +
  xlab("") + ylab("Yearly difference in number of deaths")
```

#### Percentage

```{r}
summary(compare$perc*100)
```

```{r echo=FALSE}
ggplot(compare, aes(x = Year, y = perc*100)) +
  geom_hline(yintercept = 0, colour = "lightblue") +
  geom_col() +
  theme_bw() +
  xlab("") + ylab("Yearly difference in number of deaths")
```

### BfS vs STMF  {.tabset}

Comparing monthly figures - see above for week <> month issues!  

```{r}
compare <- inner_join(
  ch_deaths_month %>% 
    rename(deaths_bfs = Deaths),
  stmf_month %>% 
    filter(Country == "Switzerland") %>% 
    rename(deaths_stmf = Deaths) 
) %>% 
  mutate(diff = deaths_bfs - deaths_stmf,
         perc = (deaths_bfs - deaths_stmf) / deaths_bfs)
```

Summary of differences between monthly BfS and STMF figures. 

#### Absolute

```{r}
summary(compare$diff)
```

```{r echo=FALSE}
ggplot(compare, aes(x = Date, y = diff)) +
  geom_hline(yintercept = 0, colour = "lightblue") +
  geom_col() +
  theme_bw() +
  xlab("") + ylab("Absolute difference in number of deaths")
```

#### Percentage

```{r}
summary(compare$perc*100)
```

```{r echo=FALSE}
ggplot(compare, aes(x = Date, y = perc*100)) +
  geom_hline(yintercept = 0, colour = "lightblue") +
  geom_col() +
  theme_bw() +
  xlab("") + ylab("% difference in number of deaths")
```

```{r include=FALSE}
rm(compare)
```

<!-- ----------------------------------------------------- -->

# Spain

## Monthly deaths till 2019

Data from INE [since 1975 here](https://www.ine.es/jaxiT3/Tabla.htm?t=6561&L=1) and [1941-1974 here](https://www.ine.es/jaxiT3/Tabla.htm?t=6563&L=1); data prior to 1940 was transcribed from PDFs available from INE.  

```{r}
es_deaths_month <- read_xlsx("data-raw/INE/Spain.xlsx") %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Year = jahr) %>% 
  pivot_longer(!Year, names_to = "Month", values_to = "Deaths") %>% 
  mutate(Month = as.integer(str_replace(Month, fixed("m"), "")),
         Year = as.integer(Year),
         Deaths = as.integer(round(Deaths)))  %>%
  mutate(Date = ymd(paste0(Year, "-", Month, "-01"))) %>% 
  relocate(Year, Month, Date) %>% 
  filter(Year != 2020)
```

## Monthly 2020 deaths 

2020 update (*still labelled as provisional!*) is from  [here](https://www.ine.es/jaxi/Tabla.htm?path=/t20/e301/provi/l1/&file=02001.px&L=1)

```{r}
source("R/fn_get_death_data_spain.R")

es_2020 <- fn_get_death_data_spain("data-raw/INE/Spain_2020.xlsx") %>%
  gather(., Month, Deaths, January:December, factor_key = TRUE) %>%
  group_by(Month) %>%
  summarize(Deaths = sum(Deaths, na.rm = TRUE)) %>%
  ungroup() %>% 
  mutate(Year = as.integer(2020),
         Deaths = as.integer(Deaths),
         Date = ymd(paste0(Year, Month, "-01")),
         Month = as.integer(Month)) %>% 
  relocate(Year, Month, Date, Deaths)
```

## Monthly 2021 deaths 

2021 data available from [here](https://www.ine.es/en/experimental/defunciones/experimental_defunciones.htm#tablas_resultados).  

Note: data are in weekly format and converted with methods (and caveats!) described above in STMF chapter.  

```{r}
temp <- read_xlsx("data-raw/INE/Spain_2021_death.xlsx", skip = 9) %>%   
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Week = x1) %>% 
  filter(!is.na(de_0_a_4_anos)) %>% 
  mutate(Deaths = rowSums(.[-1])) %>% 
  select(Week, Deaths)

es_2021 <- weekToMonth(rev(temp$Deaths), datStart = "31-12-2018") %>% 
  as_tibble() %>% 
  as_tibble() %>% 
  separate(yearMonth, c("Year", "Month"), convert = TRUE) %>% 
  rename(Deaths = value) %>% 
  mutate(Date = ymd(paste0(Year, "-", Month, "-01")),
         Deaths = as.integer(Deaths)) %>% 
  relocate(Year, Month, Date) %>% 
  filter(Year == 2021) %>% 
  filter(Month <= 6)
```

```{r include=FALSE}
es_deaths_month %<>% 
  bind_rows(es_2020) %>% 
  bind_rows(es_2021) %>% 
  mutate(Country = "Spain") %>% 
  relocate(Country)

rm(es_2020, es_2021, temp)
```

## Yearly 2019-2020 deaths with age structure

INE data to supplement missing last two years in HMD.  

2019 data available [here](https://www.ine.es/jaxiT3/Tabla.htm?t=6547&L=1) and 2020 data available from [here](https://www.ine.es/jaxi/Tabla.htm?path=/t20/e301/provi/l1/&file=02001.px&L=1).  

```{r}
es_deaths_age_2019_2020 <- bind_rows(
  
  read_delim("data-raw/INE/Spain2019age.csv",
             delim = ";",
             locale = locale(grouping_mark = "."),
             trim_ws = TRUE) %>% 
    mutate(Year = as.integer(2019)) %>% 
    mutate(Age = word(Edad, 1),
           Age = str_replace(Age, fixed("Menores"), "0"),
           Age = as.integer(Age)
    ) %>% 
    select(Year, Age, Total) %>% 
    mutate(Total = as.integer(round(Total))), 
  
  fn_get_death_data_spain("data-raw/INE/Spain_2020.xlsx") %>%
    gather(., Month, Deaths, January:December, factor_key = TRUE) %>%
    group_by(Age) %>%
    dplyr::summarize(Deaths = sum(Deaths, na.rm = TRUE))%>%
    mutate(Year = as.integer(2020),
           Total = as.integer(Deaths)) %>%
    select(Year, Age, Total)
  
) %>% 
  mutate(Country = "Spain") %>% relocate(Country)
```

## Yearly 2021 deaths with age structure

INE data to supplement missing last two years in HMD.  

2021 data available from [here](https://www.ine.es/en/experimental/defunciones/experimental_defunciones.htm#tablas_resultados).  

Note: data are in weekly format and converted with methods (and caveats!) described above in STMF chapter.  

```{r}
temp <- read_xlsx("data-raw/INE/Spain_2021_death.xlsx", skip = 9) %>%   
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Week = x1) %>% 
  filter(!is.na(de_0_a_4_anos))

es_deaths_age_2021 <- bind_rows(
  
  weekToMonth(rev(temp$de_0_a_4_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 0) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_5_a_9_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 5) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_10_a_14_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 10) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_15_a_19_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 15) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_20_a_24_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 20) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_25_a_29_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 25) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_30_a_34_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 30) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_35_a_39_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 35) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_40_a_44_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 40) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_45_a_49_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 45) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_50_a_54_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 50) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_0_a_4_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 0) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_55_a_59_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 55) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_60_a_64_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 60) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_65_a_69_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 65) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_70_a_74_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 70) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_75_a_79_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 75) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_80_a_84_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 80) %>% as_tibble(),
  
  weekToMonth(rev(temp$de_85_a_89_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 85) %>% as_tibble(),
  
  weekToMonth(rev(temp$x90_y_mas_anos), datStart = "31-12-2018") %>% 
    mutate(Age = 90) %>% as_tibble()
  
) %>% 
  as_tibble() %>% 
  mutate(Country = "Spain") %>%
  separate(yearMonth, c("Year", "Month"), convert = TRUE) %>% 
  rename(Total = value) %>% 
  mutate(Total = as.integer(Total)) %>% 
  relocate(Country, Year, Month) %>% 
  filter(Year == 2021) %>% 
  filter(! (Month == 8)) %>% 
  filter(! (Month == 7))

rm(temp)
```

## Monthly datasets combined 

```{r echo=FALSE}
es_deaths_month %>% 
  ggplot(aes(x = Date, y = Deaths)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Monthly deaths")
```

## Yearly pops 

With update for 2020 from provisional data (see below for source).  

```{r}
es_pop_year <- read_xlsx("data-raw/INE/Spain_population.xlsx") %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Year = year) %>% 
  rename(Population = prados_de_la_escosura2020_july) %>% 
  select(Year, Population) %>% 
  mutate(Year = as.integer(Year),
         Population = as.integer(round(Population))) %>% 
  filter(Year != 2020)

source("R/fn_get_spain_population.R")

es_pop_2020 <- fn_get_spain_population("data-raw/INE/Spain_Population_age-2019.xlsx") %>%
  summarize(Population = sum(Population, na.rm = TRUE))%>%
  mutate(Year = as.integer(2020),
         Population = as.integer(Population)) %>% 
  relocate(Year)

es_pop_2021 <- es_pop_2020 %>% 
  mutate(Year = as.integer(2021))

es_pop_year %<>% 
  bind_rows(es_pop_2020) %>% 
  bind_rows(es_pop_2021)

es_deaths_month %<>% 
  left_join(es_pop_year)

rm(es_pop_2020, es_pop_2021)
```

```{r echo=FALSE}
es_pop_year %>% 
  ggplot(aes(x = Year, y = Population)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population")
```

### Comparison with HMD {.tabset}

INE vs HMD  

```{r}
compare <- left_join(
  es_pop_year %>% rename(INE_pop = Population), 
  hmd_pop_year %>% filter(Country == "Spain") %>% rename(HMD_pop = Population)) %>% 
  select(-Country) %>% 
  mutate(diff = INE_pop - HMD_pop,
         diff_perc = (INE_pop - HMD_pop) / INE_pop)
```

Difference between yearly INE and HMD pops.  

#### Absolute

```{r}
summary(compare$diff)
```

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = diff)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_col() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

#### Realtive 

```{r}
summary(compare$diff_perc)
```

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = diff_perc)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_col() +
  scale_y_continuous(labels = percent) +
  theme_bw() +
  xlab("") + ylab("% yearly difference in population estimates")
```

## 2020 pops with age structure

2020 data available from [here](https://www.ine.es/jaxiT3/Tabla.htm?t=31304).  

```{r echo=FALSE}
es_pop_age_2020 <- fn_get_spain_population("data-raw/INE/Spain_Population_age-2019.xlsx") %>%
  mutate(Year = as.integer(2020),
         Age = as.integer(Age),
         Population = as.integer(Population),
         Country = "Spain") %>% 
  rename(Total = Population) %>% 
  relocate(Country, Year)
```

<!-- ----------------------------------------------------- -->

# Sweden

## Monthly deaths 

```{r}
se_deaths_month <- read_csv("data-raw/SCB/000000NF_20210315-164930.csv",
                            skip = 2) %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Month_txt = month) %>% 
  filter(Month_txt != "Unknown") %>% 
  select(-sex) %>% 
  pivot_longer(!Month_txt, names_to = "Year", values_to = "Deaths") %>% 
  group_by(Year, Month_txt) %>% 
  summarise(Deaths = sum(Deaths)) %>% 
  ungroup() %>% 
  mutate(Year = as.integer(str_replace(Year, fixed("x"), "")),
         Month = match(Month_txt, month.name),
         Deaths = as.integer(round(Deaths))) %>% 
  select(-Month_txt) %>% 
  mutate(Date = ymd(paste0(Year, "-", Month, "-01"))) %>% 
  relocate(Year, Month, Date) %>% 
  arrange(Year, Month)
```

## Monthly 2021 deaths

[Preliminär statistik över döda (Excel)](https://www.scb.se/hitta-statistik/sverige-i-siffror/manniskorna-i-sverige/doda-i-sverige/) file is available from SCB. 

```{r eval=FALSE}
# doesn't work with this url
download.file(url = "https://www.scb.se/hitta-statistik/statistik-efter-amne/befolkning/befolkningens-sammansattning/befolkningsstatistik/pong/tabell-och-diagram/preliminar-statistik-over-doda/",
              destfile = "data-raw/SCB/2021-08-23-preliminar_statistik_over_doda_inkl_eng.xlsx",
              method = "curl")
```

```{r}
se_deaths_month_2021 <- read_excel("data-raw/SCB/2021-08-23-preliminar_statistik_over_doda_inkl_eng.xlsx", sheet = "Tabell 10", skip = 10) %>% 
  filter(Region == "Hela riket" & Period == "2021 antal") %>% 
  select(Januari:Juni) %>% 
  pivot_longer(Januari:Juni) %>% 
  mutate(Year = 2021,
         Month = 1:6,
         Date = ymd(paste0(Year, "-", Month, "-01")),
         Deaths = as.integer(value)
  ) %>% 
  select(-name, -value)

se_deaths_month %<>% 
  bind_rows(se_deaths_month_2021) %>% 
  mutate(Country = "Sweden") %>% relocate(Country)

rm(se_deaths_month_2021)
```

## Monthly datasets combined 

```{r echo=FALSE}
se_deaths_month %>% 
  ggplot(aes(x = Date, y = Deaths)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Monthly deaths")
```

## 2020 deaths with age & sex structure

2019 is already in HMD for Sweden so getting only 2020.  

```{r}
se_deaths_age_sex_2020 <- read_xlsx("data-raw/SCB/BE0101D9_20210429-200440.xlsx", 
                                    col_types = c("text", "text", "text", "numeric", "numeric"), 
                                    skip = 2) %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  filter(!is.na(x2020)) %>% 
  select(-x1, -x2019) %>% 
  mutate(x3 = if_else(x3 == "men", "Male", "Female")) %>% 
  fill(x2) %>% 
  pivot_longer(cols = x2020, names_to = "Year") %>% 
  rename(Age = x2, Sex = x3) %>% 
  mutate(Year = as.integer(str_replace(Year, fixed("x"), "")),
         Age = word(Age, 1),
         Age = str_replace(Age, fixed("100+"), "100"),
         Age = as.integer(Age)) %>% 
  pivot_wider(names_from = Sex, values_from = value) %>% 
  mutate(Male = as.integer(round(Male)),
         Female = as.integer(round(Female))) %>% 
  mutate(Total = Male + Female) %>% 
  arrange(Year, Age) %>% 
  mutate(Country = "Sweden") %>% relocate(Country)
```

## Yearly pops 

```{r}
se_pop_year <- read_xlsx("data-raw/SCB/be0101_tab9utveng1749-2020.xlsx",
                         skip = 4) %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  clean_names() %>% 
  rename(Population = population) %>% 
  select(year, Population) %>% 
  filter(!is.na(Population)) %>% 
  mutate(year = ifelse(year == "20001)", 2000, year),
         year = as.integer(year),
         Population = as.integer(round(Population))) %>% 
  rename(Year = year) 

se_pop_2021 <- se_pop_year %>% 
  filter(Year == 2020) %>% 
  mutate(Year = as.integer(2021))

se_pop_year %<>% 
  bind_rows(se_pop_2021)

rm(se_pop_2021)

se_deaths_month %<>% 
  left_join(se_pop_year)
```

```{r echo=FALSE}
se_pop_year %>% 
  ggplot(aes(x = Year, y = Population)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population")
```

### Comparison with HMD {.tabset}

SCB vs HMD  

```{r}
compare <- left_join(
  se_pop_year %>% rename(SCB_pop = Population), 
  hmd_pop_year %>% filter(Country == "Sweden") %>% rename(HMD_pop = Population)) %>% 
  select(-Country) %>% 
  mutate(diff = SCB_pop - HMD_pop,
         diff_perc = (SCB_pop - HMD_pop) / SCB_pop)
```

Difference between yearly SCB and HMD pops.  

#### Absolute

```{r}
summary(compare$diff)
```

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = diff)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_col() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

#### Realtive 

```{r}
summary(compare$diff_perc)
```

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = diff_perc)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_col() +
  scale_y_continuous(labels = percent) +
  theme_bw() +
  xlab("") + ylab("% yearly difference in population estimates")
```


<!-- ----------------------------------------------------- -->

# Combined analysis datasets

## Monthly deaths with yearly pops

Spain age&sex distribution in HMD is [available from later](https://github.com/RPanczak/ISPM_excess-mortality/issues/81)!

```{r}
deaths_monthly <- bind_rows(
  
  ### ESP
  es_deaths_month %>% 
    filter(Year >= 1908),
  
  # NAs for second half of year
  es_deaths_month %>% 
    filter(Year == 2020 & Month > 6) %>% 
    mutate(Year = as.integer(2021), 
           Deaths = NA_integer_),
  
  ### SWE
  se_deaths_month,
  
  se_deaths_month %>% 
    filter(Year == 2020 & Month > 6) %>% 
    mutate(Year = as.integer(2021), 
           Deaths = NA_integer_,
           Date = Date + years(1)),
  
  ch_deaths_month,
  
  ch_deaths_month %>% 
    filter(Year == 2020 & Month > 6) %>% 
    mutate(Year = as.integer(2021), 
           Deaths = NA_integer_,
           Date = Date + years(1))
  
) %>% 
  arrange(Country, Year, Month) %>% 
  mutate(si_one = sin(2*pi*Month/12),
         si_two = sin(4*pi*Month/12),
         co_one = cos(2*pi*Month/12),
         co_two = cos(4*pi*Month/12)) 

write_rds(deaths_monthly, "data/deaths_monthly.Rds")
```

## Yearly deaths by sex and age group with pops

```{r}
pop_yearly_age_sex <- bind_rows(
  
  hmd_pop_age_sex %>% 
    select(-Female, -Male),
  
  # 2020 is already in HMD for Sweden so only using HMD
  
  # 2021 is derived from 2020 HMD for SWE
  hmd_pop_age_sex %>% 
    select(-Female, -Male) %>% 
    filter(Country == "Sweden") %>% 
    filter(Year == 2020) %>% 
    mutate(Year = as.integer(2021)), 
  
  # 2020 for ESP
  es_pop_age_2020,
  
  # 2021 for ESP
  es_pop_age_2020 %>% 
    mutate(Year = as.integer(2021)),
  
  # !!! temp solution for CH for 2020 !!!
  hmd_pop_age_sex %>% 
    select(-Female, -Male) %>% 
    filter(Country == "Switzerland" & Year == 2019) %>% 
    mutate(Year = as.integer(2020)),
  
  # and once again for 2021
  hmd_pop_age_sex %>% 
    select(-Female, -Male) %>% 
    filter(Country == "Switzerland" & Year == 2019) %>% 
    mutate(Year = as.integer(2021))
  
) %>% 
  mutate(# Age_cat = cut(Age, 
    # breaks = c(0, 1, 5, 20, 40, 60, 80, 112),
    # # labels = c("<1", "1-4", "5-19", "20-39", "40-59", "60-79","80+"), 
    # right = FALSE), 
    Age_cat = cut(Age, 
                  breaks = c(seq(0, 90, 10), 113), 
                  # labels = c("0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80+")), 
                  right = FALSE)
  ) %>%
  group_by(Country, Year, Age_cat) %>% 
  summarise(Population = sum(Total)) %>% 
  ungroup() 

deaths_yearly_age_sex <- bind_rows(
  
  hmd_deaths_age_sex,
  
  # 2019 is already in HMD for Sweden so only using SCD for 2020
  se_deaths_age_sex_2020,
  
  es_deaths_age_2019_2020,
  
  es_deaths_age_2021,
  
  ch_deaths_age_sex_2019_2020,
  
  ch_deaths_age_sex_2021
  
) %>% 
  select(-Female, -Male) %>% 
  mutate(# Age_cat = cut(Age, 
    # breaks = c(0, 1, 5, 20, 40, 60, 80, 112),
    # # labels = c("<1", "1-4", "5-19", "20-39", "40-59", "60-79","80+"), 
    # right = FALSE), 
    Age_cat = cut(Age, 
                  breaks = c(seq(0, 90, 10), 113), 
                  # labels = c("0-9","10-19","20-29","30-39","40-49","50-59","60-69","70-79","80+")), 
                  right = FALSE)
  ) %>%
  group_by(Country, Year, Age_cat) %>% 
  summarise(Deaths = sum(Total)) %>% 
  ungroup() %>% 
  left_join(pop_yearly_age_sex)

rm(pop_yearly_age_sex)

write_rds(deaths_yearly_age_sex, "data/deaths_yearly_age_sex.Rds")
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`
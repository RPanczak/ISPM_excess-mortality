---
title: "Excess mortality"
subtitle: "Data preparation"
author: "Radek Panczak"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

<!-- ----------------------------------------------------- -->

```{r setup, include = FALSE}
set.seed(12345)
options(scipen = 999)
options(max.print = "75")

library(pacman)
p_load(tidyverse, magrittr, janitor, scales, 
       readxl, haven, 
       kableExtra,
       aweek, wktmo)
```

```{r knit-setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

knitr::opts_chunk$set(cache = FALSE,
                      prompt = FALSE,
                      tidy = FALSE,
                      comment = NA,
                      message = FALSE,
                      warning = FALSE)

knitr::opts_knit$set(width = 75)

mu <- Hmisc::markupSpecs$html
```

<!-- ----------------------------------------------------- -->

# HMD - historical data

[The Human Mortality Database](https://www.mortality.org/) data.  

Available on yearly resolution only but for one year age bands & separate by sex.  

```{r eval=FALSE}
p_load(HMDHFDplus)

password <- readr::read_file("secrets/HMD.txt")

# CH
# pop
hmd_ch_pop_raw <- readHMDweb(CNTRY = "CHE", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_pop_raw, "data-raw/mortality_org/hmd_ch_pop_raw.Rds")
write_dta(hmd_ch_pop_raw, "data-raw/mortality_org/hmd_ch_pop_raw.dta")

# deaths
hmd_ch_deaths_raw <- readHMDweb(CNTRY = "CHE", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_ch_deaths_raw, "data-raw/mortality_org/hmd_ch_deaths_raw.Rds")
write_dta(hmd_ch_deaths_raw, "data-raw/mortality_org/hmd_ch_deaths_raw.dta")

# ES
# pop
# 1975 problem resolved in #45
hmd_es_pop_raw <- readHMDweb(CNTRY = "ESP", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble() %>% 
  mutate(Year = ifelse(Year == "1975+", 1975, Year)) %>% 
  filter(Year != "1975-") %>% 
  mutate(Year = as.numeric(Year))

write_rds(hmd_es_pop_raw, "data-raw/mortality_org/hmd_es_pop_raw.Rds")
write_dta(hmd_es_pop_raw, "data-raw/mortality_org/hmd_es_pop_raw.dta")

# deaths
hmd_es_deaths_raw <- readHMDweb(CNTRY = "ESP", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_es_deaths_raw, "data-raw/mortality_org/hmd_es_deaths_raw.Rds")
write_dta(hmd_es_deaths_raw, "data-raw/mortality_org/hmd_es_deaths_raw.dta")

# SE
# pop
hmd_se_pop_raw <- readHMDweb(CNTRY = "SWE", item ="Population" , 
                             username = "r.panczak@gmail.com", password = password,
                             fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_se_pop_raw, "data-raw/mortality_org/hmd_se_pop_raw.Rds")
write_dta(hmd_se_pop_raw, "data-raw/mortality_org/hmd_se_pop_raw.dta")

# deaths
hmd_se_deaths_raw <- readHMDweb(CNTRY = "SWE", item = "Deaths_1x1",
                                username = "r.panczak@gmail.com", password = password,
                                fixup = FALSE) %>% 
  as_tibble()

write_rds(hmd_se_deaths_raw, "data-raw/mortality_org/hmd_se_deaths_raw.Rds")
write_dta(hmd_se_deaths_raw, "data-raw/mortality_org/hmd_se_deaths_raw.dta")

p_unload(HMDHFDplus)
```

## Yearly deaths CH

```{r include=FALSE}
hmd_ch_deaths_year <- 
  read_rds("data-raw/mortality_org/hmd_ch_deaths_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  group_by(Year) %>%
  summarise(Deaths = sum(Total)) %>%
  ungroup() %>%
  mutate(Country = "Switzerland") %>% relocate(Country) 
```

Available from `r min(hmd_ch_deaths_year$Year)` to `r max(hmd_ch_deaths_year$Year)`.

```{r echo=FALSE}
hmd_ch_deaths_year %>% 
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Deaths)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

## Yearly deaths CH - with age & sex structure

```{r include=FALSE}
hmd_ch_deaths_age_sex <- 
  read_rds("data-raw/mortality_org/hmd_ch_deaths_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  mutate(Country = "Switzerland") %>% relocate(Country) 
```

```{r echo=FALSE}
hmd_ch_deaths_age_sex %>% 
  filter(Year == 1876 | Year == 2018) %>% 
  select(Year, Age, Female, Male) %>% 
  pivot_longer(c("Female", "Male"), names_to = "Sex") %>% 
  mutate(Age_cat = cut(Age, seq(0, 110, 10), 
                       include.lowest = TRUE)) %>% 
  group_by(Year, Sex, Age_cat) %>% 
  summarise(pop = sum(value)) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = ifelse(test = Sex == "Male", 
                                  yes = -pop, no = pop), 
                       y = Age_cat, fill = Sex)) +
  geom_col(width = 1) +
  lemon::scale_x_symmetric(labels = abs) +
  labs(x = "Deaths", y = "Age at death") +
  facet_grid(vars(Year)) +
  theme_bw() +
  scale_fill_brewer(palette = "Set1")
```

## Yearly pops CH

Similarly, population data is available with 1y age bands by year. 

```{r include=FALSE}
hmd_ch_pop_year <- 
  read_rds("data-raw/mortality_org/hmd_ch_pop_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  select(Year, Total) %>%
  group_by(Year) %>%
  summarise(Population = sum(Total)) %>%
  mutate(Country = "Switzerland") %>% relocate(Country) 

write_rds(hmd_ch_pop_year, "data/mortality_org/hmd_ch_pop_year.Rds")

hmd_ch_pop_age_sex <- 
  read_rds("data-raw/mortality_org/hmd_ch_pop_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  mutate(Country = "Switzerland") %>% relocate(Country) 

write_rds(hmd_ch_pop_age_sex, "data/mortality_org/hmd_ch_pop_age_sex.Rds")
```

Yearly totals, ignoring age

```{r echo=FALSE}
hmd_ch_pop_year  %>% 
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Population/1000000)) +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]") +
  scale_y_continuous(labels = comma)
```

Again, age structure is available but only yearly

```{r echo=FALSE}
hmd_ch_pop_age_sex %>% 
  filter(Year == 1876 | Year == 2019) %>% 
  select(Year, Age, Female, Male) %>% 
  pivot_longer(c("Female", "Male"), names_to = "Sex") %>% 
  mutate(Age_cat = cut(Age, seq(0, 110, 10), 
                       include.lowest = TRUE)) %>% 
  group_by(Year, Sex, Age_cat) %>% 
  summarise(pop = sum(value)) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = ifelse(test = Sex == "Male", 
                                  yes = -pop, no = pop), 
                       y = Age_cat, fill = Sex)) +
  geom_col(width = 1) +
  lemon::scale_x_symmetric(labels = abs) +
  labs(x = "Population", y = "Age") +
  facet_grid(vars(Year)) +
  theme_bw() +
  scale_fill_brewer(palette = "Set1")
```

## Yearly deaths ES

```{r include=FALSE}
hmd_es_deaths_year <- 
  read_rds("data-raw/mortality_org/hmd_es_deaths_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  select(Year, Total) %>%
  group_by(Year) %>%
  summarise(Deaths = sum(Total)) %>%
  mutate(Country = "Spain") %>% relocate(Country) 
```

Available yearly from `r min(hmd_es_deaths_year$Year)` to `r max(hmd_es_deaths_year$Year)`.

```{r echo=FALSE}
hmd_es_deaths_year %>% 
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Deaths)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

## Yearly deaths ES - with age & sex structure

```{r include=FALSE}
hmd_es_deaths_age_sex <- 
  read_rds("data-raw/mortality_org/hmd_es_deaths_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  mutate(Country = "Spain") %>% relocate(Country) 
```

## Yearly deaths SE

```{r include=FALSE}
hmd_se_deaths_year <- 
  read_rds("data-raw/mortality_org/hmd_se_deaths_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  select(Year, Total) %>%
  group_by(Year) %>%
  summarise(Deaths = sum(Total)) %>%
  mutate(Country = "Sweden") %>% relocate(Country) 
```

Available yearly from `r min(hmd_se_deaths_year$Year)` to `r max(hmd_se_deaths_year$Year)`.

```{r echo=FALSE}
hmd_se_deaths_year %>% 
  ggplot(aes(x = Year)) +
  geom_line(aes(y = Deaths)) +
  theme_bw() +
  xlab("") + ylab("Yearly number of deaths")
```

## Yearly deaths SE - with age & sex structure

```{r include=FALSE}
hmd_se_deaths_age_sex <- 
  read_rds("data-raw/mortality_org/hmd_se_deaths_raw.Rds") %>% 
  mutate(Age = if_else(Age == "110+", "110", Age)) %>% 
  mutate(Age = as.numeric(Age)) %>% 
  mutate(Country = "Sweden") %>% relocate(Country) %>% 
  as_tibble()
```

```{r}
hmd_deaths_age_sex <- bind_rows(hmd_ch_deaths_age_sex, hmd_es_deaths_age_sex, hmd_se_deaths_age_sex)

rm(hmd_ch_deaths_age_sex, hmd_es_deaths_age_sex, hmd_se_deaths_age_sex)

write_rds(hmd_deaths_age_sex, "data/mortality_org/hmd_deaths_age_sex.Rds")
write_dta(hmd_deaths_age_sex, "data/mortality_org/hmd_deaths_age_sex.dta")

hmd_deaths_year <- bind_rows(hmd_ch_deaths_year, hmd_es_deaths_year, hmd_se_deaths_year)

rm(hmd_ch_deaths_year, hmd_es_deaths_year, hmd_se_deaths_year)

write_rds(hmd_deaths_year, "data/mortality_org/hmd_deaths_year.Rds")
write_dta(hmd_deaths_year, "data/mortality_org/hmd_deaths_year.dta")
```

<!-- ----------------------------------------------------- -->

# HMD - STMF data series

Short-term Mortality Fluctuations weekly dataset to cover 2020 data

```{r eval=FALSE}
download.file(url = "https://www.mortality.org/Public/STMF/Outputs/stmf.csv",
              destfile = "data-raw/mortality_org/stmf_week.csv",
              method = "curl")

zip(zipfile = "data-raw/mortality_org/stmf_week", 
    files = "data-raw/mortality_org/stmf_week.csv")

file.remove("data-raw/mortality_org/stmf_week.csv")

download.file(url = "https://www.mortality.org/Public/STMF_DOC/STMFmetadata.pdf",
              destfile = "data-raw/mortality_org/STMFmetadata.pdf",
              method = "curl")

download.file(url = "https://www.mortality.org/Public/STMF_DOC/STMFNote.pdf",
              destfile = "data-raw/mortality_org/STMFNote.pdf",
              method = "curl")
```

## Weekly

```{r}
stmf_week <- read_csv("data-raw/mortality_org/stmf_week.zip", 
                      col_types = cols(Year = col_integer(), 
                                       Week = col_integer(), 
                                       Split = col_integer(), 
                                       SplitSex = col_integer(), 
                                       Forecast = col_integer()), 
                      skip = 1) %>% 
  filter(CountryCode %in% c("CHE", "ESP", "SWE")) %>% 
  filter(Sex == "b") %>% 
  select(CountryCode, Year, Week, DTotal) %>% 
  rename(Deaths = DTotal) %>%  
  mutate(Week2 = get_aweek(week = Week, year = Year, 
                           start = "Monday", week_start = "Monday"),
         Week_start = get_date(week = Week, year = Year, 
                               start = "Monday")) %>% 
  relocate(Week2, Week_start, .after = Week) %>% 
  mutate(Country = case_when(
    CountryCode == "CHE" ~ "Switzerland",
    CountryCode == "ESP" ~ "Spain",
    CountryCode == "SWE" ~ "Sweden"
  )) %>% select(-CountryCode) %>% relocate(Country)

write_rds(stmf_week, "data/mortality_org/stmf_week.Rds")
write_dta(stmf_week, "data/mortality_org/stmf_week.dta")
```

```{r echo=FALSE}
stmf_week %>% 
  filter(Year >= 2019) %>% 
  ggplot(aes(x = Week_start)) +
  geom_line(aes(y = Deaths, group = Country, color = Country)) +
  theme_bw() +
  xlab("") + ylab("Weekly number of deaths")
```

## Monthly

Weekly data converted to monthly using [weekToMonth](https://rdrr.io/cran/wktmo/man/weekToMonth.html) function from `wktmo` package. 

```{r}
stmf_month <- bind_rows(
  
  weekToMonth(stmf_week[stmf_week$Country == "Switzerland", ]$Deaths, 
              datStart = "03-01-2000", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Switzerland"),
  
  weekToMonth(stmf_week[stmf_week$Country == "Spain", ]$Deaths, 
              datStart = "03-01-2000", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Spain"),
  
  weekToMonth(stmf_week[stmf_week$Country == "Sweden", ]$Deaths, 
              datStart = "03-01-2000", wkMethod = "ISO") %>% 
    as_tibble() %>% 
    mutate(Country = "Sweden") 
  
) %>% 
  separate(yearMonth, c("Year", "Month"), convert = TRUE) %>% 
  rename(Deaths = value) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Country, Year, Month, Date)

write_rds(stmf_month, "data/mortality_org/stmf_month.Rds")
write_dta(stmf_month, "data/mortality_org/stmf_month.dta")
```

```{r echo=FALSE}
stmf_month %>% 
  filter(Date != as.Date("2021-06-01")) %>%
  filter(Year >= 2019) %>% 
  ggplot(aes(x = Date)) +
  geom_line(aes(y = Deaths, group = Country, color = Country)) +
  theme_bw() +
  xlab("") + ylab("Monthly number of deaths")
```

*Note: Excluding June 2021.*  

## Yearly totals

Conversions are not perfect!  

Example of 2020 totals derived from weekly data:

```{r}
stmf_week %>% 
  filter(Year == 2020) %>% 
  group_by(Country) %>% 
  summarise(deaths_year = round(sum(Deaths))) %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)
```

And from monthly data:

```{r}
stmf_month %>% 
  filter(Year == 2020) %>% 
  group_by(Country) %>% 
  summarise(Deaths = round(sum(Deaths))) %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>% 
  column_spec(1, italic = TRUE) %>%
  row_spec(1, italic = FALSE)
```

Showing small imperfections of the `week -> month` transition!

<!-- ----------------------------------------------------- -->

# Switzerland 

## BfS

### Monthly deaths 

Historical data from [Todesfälle nach Monat und Sterblichkeit seit 1803](https://www.bfs.admin.ch/bfs/de/home/statistiken/kataloge-datenbanken/daten.assetdetail.14387168.html).

Using data since 1877 only where monthly registration starts.  
With important update from @Kaspar **covering missing months between 1886 and 1900**!

```{r message=FALSE, warning=FALSE}
bfs_deaths_year <- read_xlsx("data-raw/BfS/px-x-0102020206_111_20210223-102443.xlsx", 
                             skip = 2, na = "...") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(year = x1) %>% 
  filter(!is.na(todesfalle_total)) %>% 
  select(year:todesfalle_im_dezember) %>% 
  mutate(year = as.numeric(year)) %>% 
  rename(Year = year) %>% 
  select(Year, todesfalle_total) %>% 
  rename(Deaths = todesfalle_total)

write_rds(bfs_deaths_year, "data/BfS/bfs_deaths_year.Rds")
write_dta(bfs_deaths_year, "data/BfS/bfs_deaths_year.dta")

bfs_deaths_month <- read_xlsx("data-raw/BfS/Todesf_n_Monat_seit_1877_DEM_2.xlsx") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Year = jahr) %>% 
  pivot_longer(!Year, names_to = "Month", values_to = "Deaths") %>% 
  mutate(Month = as.numeric(str_replace(Month, fixed("m"), "")))  %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) 

write_rds(bfs_deaths_month, "data/BfS/bfs_deaths_month.Rds")
write_dta(bfs_deaths_month, "data/BfS/bfs_deaths_month.dta")
```

```{r echo=FALSE}
ggplot(data = bfs_deaths_month, 
       aes(x = Date)) +
  geom_line(aes(y = Deaths)) +
  theme_bw() +
  xlab("") + ylab("Monthly number of deaths")
```

### 2019-2020 deaths with age & sex structure

To supplement HMD.  

```{r}
bfs_deaths_age_sex <- read_csv("data-raw/BfS/Lieferung_Staub_2021.csv", 
                               col_types = cols(KalJahr = col_integer(),
                                                Alter = col_integer(),
                                                COUNT = col_integer()), 
                               trim_ws = TRUE) %>% 
  rename(Year = KalJahr, Age = Alter, Sex = Geschlecht, Deaths = COUNT) %>% 
  pivot_wider(names_from = Sex, values_from = Deaths) %>% 
  rename(Female = F, Male = M) %>% 
  mutate_at(vars(Female:Male), ~replace(., is.na(.), 0)) %>% 
  mutate(Total = Female + Male) %>% 
  mutate(Country = "Switzerland") %>% relocate(Country)

write_rds(bfs_deaths_age_sex, "data/BfS/bfs_deaths_age_sex.Rds")
write_dta(bfs_deaths_age_sex, "data/BfS/bfs_deaths_age_sex.dta")
```

### Yearly pops 

[Demographic balance of the permanent resident population, 1861-2019](https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/tables.assetdetail.13707412.html)

```{r}
bfs_pop_year <- read_xlsx("data-raw/BfS/su-e-01.02.04.05.xlsx", 
                          na = "...", skip = 1) %>% 
  remove_empty(c("rows", "cols")) %>%
  clean_names() %>% 
  rename(Year = x1, pop_jan = population_on_2, pop_dec = population_on_11) %>% 
  filter(!is.na(Year)) %>% 
  filter(!is.na(pop_jan)) %>% 
  mutate(Year = if_else(Year == "2010 7", "2010", Year),
         Year = as.numeric(Year), 
         pop_jan = as.numeric(pop_jan),
         pop_dec = as.numeric(pop_dec)) %>% 
  select(Year, starts_with("pop_"))

write_rds(bfs_pop_year, "data/BfS/bfs_pop_year.Rds")
write_dta(bfs_pop_year, "data/BfS/bfs_pop_year.dta")
```

```{r echo=FALSE}
ggplot(bfs_pop_year, aes(x = Year)) +
  geom_line(aes(y = pop_dec/1000000)) +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]") +
  scale_y_continuous(labels = comma)
```

### 2020 pops

[Provisional demographic balance of the permanent resident population 2020 by canton, citizenship (category), sex, age and demographic component](https://www.bfs.admin.ch/bfs/en/home/statistics/catalogues-databases/data.assetdetail.16224502.html). In comparisons (*below*) it looks like HMD is using Jan pops so those are preserved from the source. Apart from `0 Jahre` age group that is strangely `0` so figures from `31 Dec` are taken.

```{r eval=FALSE}
download.file(url = "https://www.bfs.admin.ch/bfsstatic/dam/assets/16224502/master",
              destfile = "data-raw/BfS/px-x-0102020000_202.px",
              method = "curl")

bfs_pop_2020 <- pxR::read.px("data-raw/BfS/px-x-0102020000_202.px") %>% 
  as_tibble() %>% 
  remove_empty() %>% 
  clean_names() %>% 
  # filter(demografische_komponente %in% c("Bestand am 1. Januar", "Bestand am 31. Dezember")) %>% 
  filter(
    (demografische_komponente == "Bestand am 1. Januar" & 
       alter != "0 Jahre") | 
      (demografische_komponente == "Bestand am 31. Dezember" & 
         alter == "0 Jahre")) %>% 
  filter(alter != "Alter - Total") %>% 
  filter(kanton == "Schweiz") %>% 
  filter(staatsangehorigkeit_kategorie == "Staatsangehörigkeit (Kategorie) - Total") %>% 
  select(-kanton, -jahr, -staatsangehorigkeit_kategorie, -demografische_komponente) %>%   mutate(alter = str_replace(alter, fixed(" Jahre"), "")) %>% 
  mutate(alter = str_replace(alter, fixed(" Jahr"), "")) %>% 
  mutate(alter = str_replace(alter, fixed(" und mehr"), "")) %>% 
  mutate(Age = as.numeric(alter)) %>% 
  select(-alter) %>% 
  mutate(geschlecht = str_replace(geschlecht, fixed("Geschlecht - "), "")) %>% 
  mutate(geschlecht = str_replace(geschlecht, fixed("Frau"), "Female")) %>% 
  mutate(geschlecht = str_replace(geschlecht, fixed("Mann"), "Male")) %>% 
  pivot_wider(names_from = geschlecht, values_from = value) %>% 
  mutate(Country = "Switzerland", Year = 2020) %>% 
  relocate(Country, Year, Age, Female, Male, Total)

write_rds(bfs_pop_2020, "data/BfS/bfs_pop_2020.Rds")
haven::write_dta(bfs_pop_2020, "data/BfS/bfs_pop_2020.dta")
```

## Comparison - pops

BfS web vs HMD  

```{r}
compare <- left_join(
  bfs_pop_year, 
  hmd_ch_pop_year) %>% 
  select(-Country) %>% 
  mutate(diff1 = pop_jan - Population) %>% 
  mutate(diff2 = pop_dec - Population)
```

Summary of differences between BfS figures and HMD. Jan:  

```{r}
summary(compare$diff1)
```

and Dec:

```{r}
summary(compare$diff2)
```

Timeline of differences between BfS figures and HMD

```{r echo=FALSE}
compare %>% 
  rename(bfs_pop_jan = pop_jan, 
         bfs_pop_dec = pop_dec, 
         hmd_pop_year = Population) %>% 
  pivot_longer(bfs_pop_jan:hmd_pop_year) %>% 
  ggplot(aes(x = Year, y = value/1000000, color = name)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population [million]")
```

Difference between **Jan** pop from BfS and **yearly** pop from HMD

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = diff1)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

Difference between **Dec** pop from BfS and **yearly** pop from HMD

```{r echo=FALSE}
compare %>% 
  ggplot(aes(x = Year, y = diff2)) +
  geom_hline(aes(yintercept = 0), color = "lightblue") +
  geom_line() +
  scale_y_continuous(labels = comma, limits = c(-50000, 150000)) +
  theme_bw() +
  xlab("") + ylab("Yearly difference in population estimates")
```

## Comparison - deaths

### Yearly vs. monthly BfS figures

```{r}
bfs_deaths_month %>% 
  filter(!is.na(Deaths)) %>% 
  group_by(Year) %>% 
  summarize(deaths_summed = sum(Deaths)) %>% 
  ungroup() %>% 
  left_join(bfs_deaths_year) %>% 
  filter(Deaths != deaths_summed) %>% 
  nrow()
```

*There are no years where summed  monthly data differ from "official" yearly sums.*

### BfS vs HMD

```{r}
compare <- left_join(
  bfs_deaths_year %>% 
    rename(deaths_year_bfs = Deaths), 
  hmd_deaths_year %>% 
    filter(Country == "Switzerland") %>% 
    rename(deaths_year_hmd = Deaths)) %>% 
  mutate(diff = deaths_year_bfs - deaths_year_hmd)
```

Summary of differences between BfS figures and HMD

```{r}
summary(compare$diff)
```

Timeline of differences between BfS figures and HMD

```{r echo=FALSE}
ggplot(compare, aes(x = Year, y = diff)) +
  geom_hline(yintercept = 0, colour = "lightblue") +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly difference in number of deaths")
```

### BfS vs STMF

Comparing monthly figures - see above for week <> month issues!  

```{r}
compare <- inner_join(
  bfs_deaths_month %>% 
    rename(deaths_bfs = Deaths),
  stmf_month %>% 
    filter(Country == "Switzerland") %>% 
    rename(deaths_stmf = Deaths) 
) %>% 
  mutate(diff = deaths_bfs - deaths_stmf)
```

Summary of differences between BfS figures and STMF

```{r}
summary(compare$diff)
```

Timeline of differences between BfS figures and STMF

```{r echo=FALSE}
ggplot(compare, aes(x = Date, y = diff)) +
  geom_hline(yintercept = 0, colour = "lightblue") +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly difference in number of deaths")
```

<!-- ----------------------------------------------------- -->

# Spain

```{r}
spain_pop <- read_xlsx("data-raw/INE/Spain_Population.xlsx") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Year = year) %>% 
  rename(Population = prados_de_la_escosura2020_july) %>% 
  select(Year, Population)

spain_deaths_month <- read_xlsx("data-raw/INE/Spain.xlsx") %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Year = jahr) %>% 
  pivot_longer(!Year, names_to = "Month", values_to = "Deaths") %>% 
  mutate(Month = as.numeric(str_replace(Month, fixed("m"), "")))  %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) %>% 
  left_join(spain_pop)

write_rds(spain_deaths_month, "data/INE/spain_deaths_month.Rds")
write_dta(spain_deaths_month, "data/INE/spain_deaths_month.dta")
rm(spain_pop)
```

### Monthly deaths 

```{r echo=FALSE}
spain_deaths_month %>% 
  ggplot(aes(x = Date, y = Deaths)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Monthly deaths")
```

### 2019-2020 deaths with age & sex structure

```{r}
scb_deaths_age_sex <- read_xlsx("data-raw/SCB/BE0101D9_20210429-200440.xlsx", 
                                col_types = c("text", "text", "text", "numeric", "numeric"), 
                                skip = 2) %>% 
  remove_empty() %>% 
  clean_names() %>% 
  filter(!is.na(x2019)) %>% 
  select(-x1) %>% 
  mutate(x3 = if_else(x3 == "men", "Male", "Female")) %>% 
  fill(x2) %>% 
  pivot_longer(cols = x2019:x2020, names_to = "Year") %>% 
  rename(Age = x2, Sex = x3) %>% 
  mutate(Year = as.integer(str_replace(Year, fixed("x"), "")),
         Age = word(Age, 1),
         Age = str_replace(Age, fixed("100+"), "100"),
         Age = as.integer(Age)) %>% 
  pivot_wider(names_from = Sex, values_from = value) %>% 
  mutate(Total = Male + Female) %>% 
  arrange(Year, Age) %>% 
  mutate(Country = "Sweden") %>% relocate(Country)

write_rds(scb_deaths_age_sex, "data/SCB/scb_deaths_age_sex.Rds")
write_dta(scb_deaths_age_sex, "data/SCB/scb_deaths_age_sex.dta")
```

### Yearly pops 

```{r echo=FALSE}
spain_deaths_month %>% 
  filter(Month == 12) %>% 
  ggplot(aes(x = Year, y = Population)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population")
```

<!-- ----------------------------------------------------- -->

# Sweden

```{r}
sweden_pop <- read_xlsx("data-raw/SCB/be0101_tab9utveng1749-2020.xlsx",
                        skip = 4) %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Population = population) %>% 
  select(year, Population) %>% 
  filter(!is.na(Population)) %>% 
  mutate(year = ifelse(year == "20001)", 2000, year),
         year = as.numeric(year)) %>% 
  rename(Year = year) 

sweden_deaths_month <- read_csv("data-raw/SCB/000000NF_20210315-164930.csv",
                                skip = 2) %>% 
  remove_empty() %>% 
  clean_names() %>% 
  rename(Month_txt = month) %>% 
  filter(Month_txt != "Unknown") %>% 
  select(-sex) %>% 
  pivot_longer(!Month_txt, names_to = "Year", values_to = "Deaths") %>% 
  group_by(Year, Month_txt) %>% 
  summarise(Deaths = sum(Deaths)) %>% 
  ungroup() %>% 
  mutate(Year = as.numeric(str_replace(Year, fixed("x"), "")),
         Month = match(Month_txt, month.name)) %>% 
  select(-Month_txt) %>% 
  mutate(Date = anytime::anydate(paste0(Year, "-", Month))) %>% 
  relocate(Year, Month, Date) %>% 
  left_join(sweden_pop) %>% 
  arrange(Year, Month)

write_rds(sweden_deaths_month, "data/SCB/sweden_deaths_month.Rds")
write_dta(sweden_deaths_month, "data/SCB/sweden_deaths_month.dta")
rm(sweden_pop)
```

### Monthly deaths 

```{r echo=FALSE}
sweden_deaths_month %>% 
  ggplot(aes(x = Date, y = Deaths)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Monthly deaths")
```

### 2020 deaths with age structure

```{r}
ine_2019 <- read_delim("data-raw/INE/Spain2019age.csv",
                       delim = ";",
                       locale = locale(grouping_mark = "."),
                       trim_ws = TRUE) %>% 
  mutate(Year = as.integer(2019)) %>% 
  mutate(Age = word(Edad, 1),
         Age = str_replace(Age, fixed("Menores"), "0"),
         Age = as.integer(Age)
  ) %>% 
  select(Year, Age, Total) 

ine_2020 <- read_delim("data-raw/INE/Spain2020weeklyage.csv",
                       delim = ";",
                       locale = locale(grouping_mark = "."),
                       trim_ws = TRUE) %>% 
  rename(Edad = `Edad (grupos quinquenales)`) %>% 
  filter(Edad != "Todas las edades") %>% 
  filter(Edad != "No consta") %>% 
  mutate(Year = as.integer(2020)) %>% 
  mutate(Age = str_replace(Edad, fixed("De "), ""),
         Age = word(Age, 1),
         Age = as.numeric(Age)
  ) %>% 
  group_by(Year, Age) %>% 
  summarize(Total = sum(Total)) %>% 
  ungroup() 

ine_deaths_age_sex <- bind_rows(ine_2019, ine_2020) %>% 
  mutate(Country = "Spain") %>% relocate(Country)

write_rds(ine_deaths_age_sex, "data/INE/ine_deaths_age_sex.Rds")
write_dta(ine_deaths_age_sex, "data/INE/ine_deaths_age_sex.dta")
```

### Yearly pops 

```{r echo=FALSE}
sweden_deaths_month %>% 
  filter(Month == 12) %>% 
  ggplot(aes(x = Year, y = Population)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly population")
```

<!-- ----------------------------------------------------- -->

# Computing Environment

`r mu$session()`